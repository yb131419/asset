<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSONP 跨域請求示範</title>
</head>
<body>
  <h2>JSONP 跨域請求示範</h2>

  <form id="infoForm">
    <input type="hidden" id="pageId" value="Page_001" />
    <label>姓名：</label><br>
    <input type="text" id="name" required /><br><br>
    <label>日期：</label><br>
    <input type="text" id="date" readonly /><br><br>
    <label>LINE ID：</label><br>
    <input type="text" id="lineId" /><br><br>
    <label>電話：</label><br>
    <input type="tel" id="phone" /><br><br>
    <label>信箱：</label><br>
    <input type="email" id="email" /><br><br>
    <button type="submit">送出</button>
  </form>

  <script>
    document.getElementById('date').value = new Date().toISOString().slice(0, 10);

    function jsonpRequest(url, callbackName) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        window[callbackName] = function(data) {
          resolve(data);
          document.body.removeChild(script);
          delete window[callbackName];
        };
        script.src = url;
        script.onerror = reject;
        document.body.appendChild(script);
      });
    }

    document.getElementById('infoForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const data = {
        pageId: encodeURIComponent(document.getElementById('pageId').value),
        name: encodeURIComponent(document.getElementById('name').value),
        date: encodeURIComponent(document.getElementById('date').value),
        lineId: encodeURIComponent(document.getElementById('lineId').value),
        phone: encodeURIComponent(document.getElementById('phone').value),
        email: encodeURIComponent(document.getElementById('email').value)
      };

      // 組合 URL，包含 callback 參數（JSONP）
      const callbackName = 'handleResponse';
      const params = Object.keys(data).map(k => `${k}=${data[k]}`).join('&');
      const url = `https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?${params}&callback=${callbackName}`;

      try {
        const res = await jsonpRequest(url, callbackName);
        if (res.status === "success") {
          alert("✅ 資料已成功送出！");
        } else {
          alert("❌ 發生錯誤：" + res.message);
        }
      } catch (error) {
        alert("⚠️ JSONP 請求失敗：" + error);
      }
    });
  </script>
</body>
</html>

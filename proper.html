<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<title>ğŸ¬ å¹¸ç¦ç³»çµ±_åå¤§æŠ—æ‹’ </title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0"/>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
tailwind.config={theme:{extend:{colors:{primary:'#008C76',secondary:'#E8F9F7',accent:'#FFD700',dark:'#1A202C',lightBg:'#F9FAFB',neutral:'#F3F4F6',cardBg:'#FFFFFF',textPrimary:'#1E293B',textSecondary:'#64748B'},fontFamily:{sans:['Noto Sans TC','sans-serif','system-ui'],display:['Noto Sans TC','sans-serif','system-ui']},boxShadow:{'elevation-1':'0 2px 8px rgba(0,0,0,0.06)','elevation-2':'0 4px 16px rgba(0,0,0,0.08)','elevation-3':'0 8px 24px rgba(0,0,0,0.12)'}}}};
</script>
<style type="text/tailwindcss">
@layer utilities{.fade-in{animation:fadeIn 0.6s cubic-bezier(0.4,0,0.2,1);}.pulse-subtle{animation:pulseSubtle 2s infinite;}.gradient-text{background-clip:text;-webkit-background-clip:text;color:transparent;}.slide-in{animation:slideIn 0.4s cubic-bezier(0.4,0,0.2,1);}.scale-in{animation:scaleIn 0.3s cubic-bezier(0.4,0,0.2,1);}.slide-up{animation:slideUp 0.3s ease-out;}}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes pulseSubtle{0%,100%{opacity:1;}50%{opacity:0.8;}}
@keyframes slideIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes scaleIn{from{transform:scale(0.95);opacity:0;}to{transform:scale(1);opacity:1;}}
@keyframes slideUp{from{transform:translateY(10px);opacity:0;}to{transform:translateY(0);opacity:1;}}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:#F1F5F9;border-radius:3px;}
::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:#94A3B8;}
body{font-feature-settings:"palt";letter-spacing:0.02em;}
.video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:8px;background-color:#0F172A;min-height:280px;}
.audio-container{position:relative;height:120px;border-radius:8px;background-color:#E8F9F7;border:1px solid #008C76;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;margin-bottom:16px;}
.document-container{position:relative;padding-bottom:150%;height:0;overflow:hidden;border-radius:8px;background-color:#F1F5F9;border:1px solid #CBD5E1;min-height:300px;}
.audio-player{width:100%;height:48px;margin-top:10px;}
.link-container{position:relative;height:280px;border-radius:8px;background-color:#F1F5F9;border:2px dashed #008C76;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;text-align:center;}
.upload-container{position:relative;height:100px;border-radius:8px;background-color:#F1F5F9;border:2px dashed #008C76;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;margin-bottom:12px;cursor:pointer;transition:all 0.3s ease;}
.upload-container:hover{background-color:#E8F9F7;}
.upload-input{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;}
.video-container iframe,.document-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;opacity:0;transition:opacity 0.3s ease;}
.video-container iframe.loaded,.document-container iframe.loaded{opacity:1;}
.btn-disabled{opacity:0.7;cursor:not-allowed;pointer-events:none;}
.video-item{transition:all 0.2s ease;cursor:grab;}
.video-item:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.08);}
.video-item.dragging{opacity:0.5;border:2px dashed #008C76;cursor:grabbing;}
.video-item.pro-user{cursor:pointer;}
.video-item.pro-user:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.08);}
.drop-zone{border:2px dashed #008C76 !important;background-color:#E8F9F7 !important;}
.thumbnail-container{width:80px;height:50px;border-radius:4px;overflow:hidden;background:#f1f1f1;flex-shrink:0;}
.thumbnail-img{width:100%;height:100%;object-fit:cover;}
.viewer-card{transition:all 0.3s ease;}
.viewer-card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.watch-btn{padding:8px 16px !important;font-size:14px !important;font-weight:600 !important;border-radius:8px !important;}
.mobile-btn{min-height:48px !important;padding:12px 20px !important;font-size:16px !important;border-radius:10px !important;}
.mobile-btn-sm{min-height:40px !important;padding:8px 16px !important;font-size:15px !important;border-radius:8px !important;}
.link-card-icon{font-size:48px;color:#008C76;margin-bottom:16px;}
.link-card-title{font-size:18px;font-weight:600;color:#1E293B;margin-bottom:8px;}
.link-card-desc{font-size:14px;color:#64748B;margin-bottom:20px;}
.link-card-btn{background:#008C76;color:white;padding:10px 20px;border-radius:8px;font-weight:600;transition:background 0.3s;}
.link-card-btn:hover{background:#007A69;}
.audio-card-icon{font-size:48px;color:#008C76;margin-bottom:16px;}
.document-card-icon{font-size:48px;color:#008C76;margin-bottom:16px;}
.upload-info{font-size:12px;color:#64748B;margin-top:8px;}
.file-name-tag{display:inline-block;padding:2px 8px;background-color:#E8F9F7;color:#008C76;border-radius:4px;font-size:12px;margin-top:8px;}
</style>
</head>
<body class="bg-lightBg min-h-screen flex flex-col p-2 md:p-4">
<div class="max-w-5xl w-full bg-cardBg rounded-xl shadow-elevation-2 overflow-hidden fade-in self-center">
  <div class="bg-gradient-to-r from-primary to-[#006658] p-4 md:p-6 text-white text-center relative overflow-hidden">
    <div class="absolute top-0 left-0 w-24 h-24 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/3"></div>
    <div class="absolute bottom-0 right-0 w-32 h-32 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3"></div>
    <div class="relative z-10">
      <div class="inline-flex items-center justify-center w-12 h-12 bg-white/10 backdrop-blur-sm rounded-full mb-2 pulse-subtle">
        <i class="fa fa-film text-2xl text-accent"></i>
      </div>
      <h1 class="text-2xl md:text-3xl font-bold mb-1 tracking-wide"> ğŸ¬ å¹¸ç¦ç³»çµ±_åå¤§æŠ—æ‹’ </h1>
      <p class="text-white/90 text-sm md:text-base font-light">å½¥å½¬ å¹¸ç¦ç³»çµ±</p>
    </div>
  </div>
  <div class="p-3 md:p-5">
    <div id="status" class="flex items-center justify-center py-6 text-textPrimary text-center">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-2"></div>
        <p id="status-text" class="text-base">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±ï¼Œè«‹ç¨å€™...</p>
      </div>
    </div>
    <div id="error-message" class="hidden bg-red-50 border border-red-100 text-red-700 px-4 py-3 rounded-lg mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-exclamation-circle text-red-500 mt-1 mr-2 text-lg"></i>
        <div id="error-content" class="text-sm"></div>
      </div>
    </div>
    <div id="success-message" class="hidden bg-green-50 border border-green-100 text-green-700 px-4 py-3 rounded-lg mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-check-circle text-green-500 mt-1 mr-2 text-lg"></i>
        <div id="success-content" class="text-sm"></div>
      </div>
    </div>
    <div id="result-card" class="hidden bg-gradient-to-r from-secondary to-[#F0FAF8] border border-primary/15 rounded-xl p-4 mb-4 text-center fade-in relative overflow-hidden">
      <div class="absolute top-0 right-0 w-16 h-16 bg-primary/5 rounded-full translate-x-1/2 -translate-y-1/2"></div>
      <div class="relative z-10">
        <div id="result-main" class="text-lg md:text-xl font-bold mb-2 text-textPrimary"></div>
        <div id="result-details" class="text-sm text-textSecondary space-y-1 md:space-y-1.5"></div>
        <div id="video-count-display" class="mt-2 text-sm font-medium text-primary">
          <i class="fa fa-play-circle mr-1"></i> å¯è§€çœ‹å…§å®¹æ•¸ï¼š<span id="video-count-num">0</span>
        </div>
        <div class="w-20 h-0.5 bg-primary/20 mx-auto my-2"></div>
      </div>
    </div>
    <div id="video-viewer-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å¯è§€çœ‹å…§å®¹åˆ—è¡¨
        </h2>
        <div id="manage-btn-container" class="flex gap-2 hidden">
          <button onclick="toggleVideoListSection()" class="mobile-btn-sm bg-primary hover:bg-[#007A69] text-white text-sm font-medium px-4 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center gap-1">
            <i class="fa fa-cog text-sm"></i> å…§å®¹ç®¡ç†
          </button>
        </div>
      </div>
      <div id="viewer-video-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-2"></div>
      <div id="viewer-empty-list" class="py-8 text-center text-textSecondary hidden">
        <i class="fa fa-film text-3xl mb-3 text-gray-300"></i>
        <p class="text-base">æš«ç„¡å¯è§€çœ‹çš„æ•™å­¸å…§å®¹</p>
        <p class="text-xs mt-1 text-textSecondary/70">è«‹è¯ç¹«ç®¡ç†å“¡æ·»åŠ å…§å®¹</p>
      </div>
    </div>
    <div id="video-list-section" class="bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100 hidden">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-th-list text-primary mr-2 text-sm"></i> å…§å®¹åˆ—è¡¨
        </h2>
        <div id="add-video-btn-container" class="flex gap-2 w-full md:w-auto">
          <button onclick="addNewVideo()" class="mobile-btn bg-primary hover:bg-[#007A69] text-white text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-plus text-lg"></i> æ–°å¢
          </button>
          <button onclick="toggleVideoListSection()" class="mobile-btn bg-gray-200 hover:bg-gray-300 text-textPrimary text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-lg"></i> è¿”å›
          </button>
        </div>
      </div>
      <div id="video-list-container" class="space-y-2.5 mb-2"></div>
      <div id="empty-video-list" class="py-5 text-center text-textSecondary hidden">
        <i class="fa fa-film text-2xl mb-2 text-gray-300"></i>
        <p class="text-sm">å°šæœªæ·»åŠ ä»»ä½•æ•™å­¸å…§å®¹</p>
        <p id="empty-tip" class="text-xs mt-1">é»æ“Šã€Œæ–°å¢ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ </p>
      </div>
    </div>
    <div id="edit-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 id="edit-title" class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢å…§å®¹
        </h2>
        <button onclick="hideEditSection()" class="text-textSecondary hover:text-textPrimary transition-colors p-2 rounded-full hover:bg-gray-100">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="content-form" onsubmit="saveVideo(event)">
        <input type="hidden" id="video-id" value="">
        <input type="hidden" id="file-type" value="">
        <input type="hidden" id="file-name" value="">
        <div class="space-y-3">
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> å…§å®¹åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="content-name" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm" placeholder="è«‹è¼¸å…¥å…§å®¹åç¨±" required>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-upload text-primary mr-2 text-xs"></i> ä¸Šå‚³æ–‡ä»¶ (å„ªå…ˆæ–¼ç¶²å€)
            </label>
            <!-- âœ… ä¿®å¤ï¼šç»™ä¸Šä¼ å®¹å™¨ç»‘å®šæ‹–æ‹½äº‹ä»¶ -->
            <div id="upload-container" class="upload-container" ondragover="handleDragOverUpload(event)" ondrop="handleDropUpload(event)" ondragleave="handleDragLeaveUpload(event)">
              <i class="fa fa-cloud-upload text-2xl text-primary mb-2"></i>
              <p class="text-sm text-textPrimary">é»æ“Šæˆ–æ‹–å‹•æ–‡ä»¶åˆ°æ­¤å€åŸŸä¸Šå‚³</p>
              <p class="upload-info">æ”¯æ´éŸ³é »ã€è¦–é »ã€PDFã€æ–‡æª”ç­‰æ ¼å¼</p>
              <!-- âœ… ä¿®å¤ï¼šç»™æ–‡ä»¶è¾“å…¥æ¡†ç»‘å®šchangeäº‹ä»¶ -->
              <input type="file" id="content-file" class="upload-input" accept="audio/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" onchange="handleFileUpload(event)">
            </div>
            <div id="uploaded-file-info" class="hidden">
              <span class="file-name-tag" id="uploaded-file-name"></span>
              <button type="button" onclick="clearUploadedFile()" class="text-xs text-red-500 ml-2 hover:underline">ç§»é™¤</button>
            </div>
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-video-camera text-primary mr-2 text-xs"></i> é€£çµç¶²å€ (é¸å¡«ï¼Œæ–‡ä»¶ä¸Šå‚³å¾Œç„¡éœ€å¡«å¯«)
            </label>
            <input type="url" id="content-video" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm" placeholder="æ”¯æ´ä»»æ„ç¶²å€ï¼ˆå½±ç‰‡/éŸ³è¨Š/ç¶²é é€£çµç­‰ï¼‰">
            <p class="text-xs text-textSecondary mt-1">
              <i class="fa fa-lightbulb-o text-accent mr-1"></i> æ”¯æ´ YouTubeã€é¨°è¨Šæœƒè­°ã€éŸ³è¨Šæª”ã€æ™®é€šç¶²é ç­‰ä»»æ„åˆæ³•ç¶²å€
            </p>
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™è¨»è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="content-note" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š"></textarea>
          </div>
          <div class="pt-1 flex gap-2">
            <button type="button" onclick="hideEditSection()" class="mobile-btn-sm w-1/3 bg-gray-200 hover:bg-gray-300 text-textPrimary font-medium px-3 py-2 rounded-lg transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="save-btn" class="mobile-btn-sm w-2/3 bg-primary hover:bg-[#007A69] text-white font-medium px-3 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="save-btn-text">å„²å­˜å…§å®¹</span>
              <div id="save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    <div id="video-preview" class="hidden bg-cardBg rounded-xl p-2 md:p-4 mb-4 scale-in border border-primary/20 shadow-elevation-1">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å…§å®¹é è¦½
        </h2>
        <div id="preview-action-btns" class="flex gap-1 hidden">
          <button onclick="editCurrentVideo()" class="mobile-btn-sm text-primary hover:text-[#007A69] text-sm font-medium flex items-center gap-1 bg-primary/5 px-3 py-2 rounded-lg">
            <i class="fa fa-pencil text-sm"></i> ç·¨è¼¯
          </button>
          <button onclick="event.stopPropagation();deleteCurrentVideo()" class="mobile-btn-sm text-red-500 hover:text-red-600 text-sm font-medium flex items-center gap-1 bg-red-50 px-3 py-2 rounded-lg">
            <i class="fa fa-trash text-sm"></i> åˆªé™¤
          </button>
          <button onclick="hideVideoPreview()" class="text-textSecondary hover:text-textPrimary transition-colors p-2 rounded-full hover:bg-gray-100">
            <i class="fa fa-times-circle text-lg"></i>
          </button>
        </div>
      </div>
      <div id="preview-content" class="space-y-3">
        <h3 id="preview-title" class="text-sm md:text-base font-medium text-textPrimary text-center mb-2"></h3>
        <div id="preview-container" class="mb-3">
          <div id="video-container" class="video-container mb-3 flex items-center justify-center hidden">
            <div id="video-loading" class="absolute text-white/70">
              <i class="fa fa-spinner animate-spin text-xl mb-1"></i>
              <p class="text-xs">è¼‰å…¥å½±ç‰‡ä¸­...</p>
            </div>
            <iframe id="preview-video" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" onload="this.classList.add('loaded'); const el = document.getElementById('video-loading'); if(el) el.classList.add('hidden');"></iframe>
            <!-- âœ… ä¿®å¤ï¼šç»Ÿä¸€æœ¬åœ°è§†é¢‘å®¹å™¨IDï¼Œä¸é¢„è§ˆé€»è¾‘åŒ¹é… -->
            <video id="preview-local-video" class="absolute w-full h-full object-contain hidden" controls controlsList="nodownload">
              <source id="local-video-source" src="" type="video/mp4">
              æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è¦–é »æ’­æ”¾
            </video>
          </div>
          <div id="audio-container" class="audio-container mb-3 hidden">
            <i class="fa fa-volume-up audio-card-icon"></i>
            <p class="text-textPrimary font-medium mb-2">éŸ³è¨Šæ’­æ”¾</p>
            <audio id="preview-audio" class="audio-player" controls controlsList="nodownload">
              <source id="audio-source" src="" type="audio/mpeg">
              æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³è¨Šæ’­æ”¾
            </audio>
          </div>
          <div id="document-container" class="document-container mb-3 hidden">
            <div id="document-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/80">
              <i class="fa fa-spinner animate-spin text-xl text-primary mb-1"></i>
              <p class="text-xs text-textPrimary">è¼‰å…¥æ–‡æª”ä¸­...</p>
            </div>
            <iframe id="preview-document" src="" onload="this.classList.add('loaded'); const el = document.getElementById('document-loading'); if(el) el.classList.add('hidden');"></iframe>
          </div>
          <div id="link-container" class="link-container hidden">
            <i id="link-icon" class="link-card-icon"></i>
            <h3 id="link-title" class="link-card-title"></h3>
            <p id="link-desc" class="link-card-desc"></p>
            <a id="link-btn" href="" target="_blank" class="link-card-btn">
              <i class="fa fa-external-link mr-2"></i> é–‹å•Ÿé€£çµ
            </a>
          </div>
          <div id="file-download-container" class="hidden bg-neutral rounded-lg p-4 text-center mb-3">
            <i class="fa fa-file document-card-icon"></i>
            <h3 class="link-card-title" id="file-download-title"></h3>
            <p class="link-card-desc" id="file-download-desc"></p>
            <a id="file-download-btn" href="" download target="_blank" class="link-card-btn">
              <i class="fa fa-download mr-2"></i> ä¸‹è¼‰/æŸ¥çœ‹æ–‡ä»¶
            </a>
          </div>
        </div>
        <div class="bg-neutral rounded-lg p-3 text-xs md:text-sm text-textSecondary">
          <div class="grid grid-cols-1 gap-2 mb-2">
            <div id="preview-link-container" class="block">
              <div class="flex items-center justify-between">
                <span class="font-medium text-textPrimary text-xs md:text-sm"><i class="fa fa-link text-primary mr-1.5 text-xs"></i> è³‡æºä¾†æºï¼š</span>
                <button onclick="copyVideoLink()" class="mobile-btn-sm text-primary hover:text-[#007A69] text-sm font-medium">
                  <i class="fa fa-copy text-sm"></i> è¤‡è£½
                </button>
              </div>
              <p id="preview-link" class="mt-1 break-all font-mono text-xs md:text-sm"></p>
            </div>
            <div>
              <span class="font-medium text-textPrimary text-xs md:text-sm"><i class="fa fa-clock-o text-primary mr-1.5 text-xs"></i> æœ€å¾Œæ›´æ–°ï¼š</span>
              <p id="preview-updated" class="mt-1 text-xs md:text-sm"></p>
            </div>
            <div>
              <span class="font-medium text-textPrimary text-xs md:text-sm"><i class="fa fa-sticky-note text-primary mr-1.5 text-xs"></i> å‚™è¨»ï¼š</span>
              <p id="preview-note" class="mt-1 text-xs md:text-sm">- ç„¡å‚™è¨» -</p>
            </div>
          </div>
        </div>
        <div class="flex justify-center mt-2">
          <button onclick="hideVideoPreview()" class="mobile-btn bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium px-6 py-3 rounded-lg flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-sm"></i> è¿”å›åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
const CONFIG={LIFF_ID:"2008578880-kzWN1hOE",GAS_URL:"https://script.google.com/macros/s/AKfycbyzLwZHrJaDH-QqAqvqpFLvttidgDcyeehwYgyIyMTMUbYmZEom9YhTs3HUX0sPppNh/exec",JSONP_TIMEOUT:20000,PERMANENT_EXPIRY_DATE:"9999/12/31",STORAGE_KEY_PREFIX:"yanbin_video_manager_"};
let appState={currentUser:null,videoList:[],currentViewingVideoId:null,currentEditingVideoId:null,isSubmitting:false,draggingItem:null,userRole:'',uploadedFile:null,uploadedFileBlobUrl:''};
const convertUTCToTaiwanTime=(utcStr)=>{
  if(!utcStr)return new Date().toLocaleString('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const date=new Date(utcStr);
  return date.toLocaleString('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
};
const setStatus=(text)=>{
  const statusText=document.getElementById('status-text');
  if(statusText)statusText.textContent=text;
};
const showError=(msg)=>{
  const statusEl=document.getElementById('status');
  const resultCardEl=document.getElementById('result-card');
  const videoViewerEl=document.getElementById('video-viewer-section');
  const videoListEl=document.getElementById('video-list-section');
  const editEl=document.getElementById('edit-section');
  const videoPreviewEl=document.getElementById('video-preview');
  const successMsgEl=document.getElementById('success-message');
  if(statusEl)statusEl.classList.add('hidden');
  if(resultCardEl)resultCardEl.classList.add('hidden');
  if(videoViewerEl)videoViewerEl.classList.add('hidden');
  if(videoListEl)videoListEl.classList.add('hidden');
  if(editEl)editEl.classList.add('hidden');
  if(videoPreviewEl)videoPreviewEl.classList.add('hidden');
  if(successMsgEl)successMsgEl.classList.add('hidden');
  const el=document.getElementById('error-message');
  const contentEl=document.getElementById('error-content');
  if(el&&contentEl){
    contentEl.innerHTML=`<p class="font-medium">${msg}</p><div class="mt-2 flex justify-center"><button onclick="window.location.reload()" class="text-primary hover:text-[#007A69] font-medium flex items-center gap-1 text-xs"><i class="fa fa-refresh text-xs"></i> é‡æ–°å˜—è©¦</button></div>`;
    el.classList.remove('hidden');
  }
  resetSubmitState();
};
const showSuccess=(msg)=>{
  const errorEl=document.getElementById('error-message');
  if(errorEl)errorEl.classList.add('hidden');
  const el=document.getElementById('success-message');
  const contentEl=document.getElementById('success-content');
  if(el&&contentEl){
    contentEl.innerHTML=`<p class="font-medium">${msg}</p>`;
    el.classList.remove('hidden');
    setTimeout(()=>{if(el)el.classList.add('hidden');},4000);
  }
};
const setSubmitState=(isSubmitting)=>{
  appState.isSubmitting=isSubmitting;
  const saveBtn=document.getElementById('save-btn');
  const saveBtnText=document.getElementById('save-btn-text');
  const saveLoading=document.getElementById('save-loading');
  if(isSubmitting){
    if(saveBtn)saveBtn.classList.add('btn-disabled');
    if(saveBtnText)saveBtnText.textContent="å„²å­˜ä¸­...";
    if(saveLoading)saveLoading.classList.remove('hidden');
  }else{
    if(saveBtn)saveBtn.classList.remove('btn-disabled');
    if(saveBtnText)saveBtnText.textContent=appState.currentEditingVideoId?"æ›´æ–°å…§å®¹":"å„²å­˜å…§å®¹";
    if(saveLoading)saveLoading.classList.add('hidden');
  }
};
const resetSubmitState=()=>{setSubmitState(false);};
const getFileCategory=(fileType,fileName)=>{
  if(!fileType&&!fileName)return 'unknown';
  const lowerType=fileType?fileType.toLowerCase():'';
  const lowerName=fileName?fileName.toLowerCase():'';
  if(lowerType.includes('audio')||lowerName.match(/\.(mp3|wav|ogg|m4a|flac|aac|wma)$/))return 'audio';
  if(lowerType.includes('video')||lowerName.match(/\.(mp4|webm|avi|mov|mkv|flv)$/))return 'video';
  if(lowerName.endsWith('.pdf'))return 'pdf';
  if(lowerName.match(/\.(doc|docx|xls|xlsx|ppt|pptx)$/))return 'office';
  if(lowerName.endsWith('.txt'))return 'text';
  if(lowerType.includes('youtube')||lowerName.includes('youtube')||lowerType.includes('youtu.be'))return 'youtube';
  if(lowerType.includes('vimeo'))return 'vimeo';
  if(lowerType.includes('tencent_meeting')||lowerName.includes('meeting.tencent.com'))return 'tencent_meeting';
  return 'general';
};
const getUrlType=(url)=>{
  if(!url)return 'unknown';
  const lowerUrl=url.toLowerCase().trim();
  if(url.startsWith('blob:')){
    const videoId=appState.videoList.find(v=>v.video===url);
    if(videoId)return getFileCategory(videoId.fileType,videoId.fileName);
    return 'blob';
  }
  if(lowerUrl.includes('youtube.com')||lowerUrl.includes('youtu.be'))return 'youtube';
  else if(lowerUrl.includes('vimeo.com'))return 'vimeo';
  else if(lowerUrl.includes('meeting.tencent.com'))return 'tencent_meeting';
  else if(lowerUrl.match(/\.(mp3|wav|ogg|m4a|flac|aac|wma)$/))return 'audio';
  else if(lowerUrl.match(/\.(mp4|webm|avi|mov|mkv|flv)$/))return 'video';
  else if(lowerUrl.match(/\.pdf$/))return 'pdf';
  else return 'general';
};
const convertToEmbedUrl=(url)=>{
  const urlType=getUrlType(url);
  if(urlType==='youtube'){
    const youtubeRegex=/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/|live\/|playlist\?list=))([\w-]+)/;
    const youtubeMatch=url.match(youtubeRegex);
    if(youtubeMatch&&youtubeMatch[1]){
      const isShort=url.includes('shorts/');
      return `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=0&rel=0${isShort?'&enablejsapi=1':''}`;
    }
  }else if(urlType==='vimeo'){
    const vimeoRegex=/vimeo\.com\/(\d+)/;
    const vimeoMatch=url.match(vimeoRegex);
    if(vimeoMatch&&vimeoMatch[1])return `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=0`;
  }else if(urlType==='pdf'){
    return url;
  }
  return '';
};
const validateVideoUrl=(url)=>{
  if(!url)return true;
  try{new URL(url);return true;}
  catch(e){return url.startsWith('blob:');}
};
const calculateRemainingDaysByDate=(expiryDateStr)=>{
  try{
    if(expiryDateStr===CONFIG.PERMANENT_EXPIRY_DATE)return{displayDate:"æ°¸ä¹…æœ‰æ•ˆ",remainingDays:"æ°¸ä¹…æœ‰æ•ˆ"};
    const dateTimeRegex=/^\d{4}[-\/]\d{2}[-\/]\d{2}(?:\s+\d{1,2}:\d{1,2}(?::\d{1,2})?)?$/;
    if(!dateTimeRegex.test(expiryDateStr))return{displayDate:"æ ¼å¼éŒ¯èª¤",remainingDays:"æ ¼å¼éŒ¯èª¤"};
    const normalizedDateStr=expiryDateStr.replace(/-/g,'/');
    let expiryDate;
    if(normalizedDateStr.includes(' ')){
      const[datePart,timePart]=normalizedDateStr.split(' ');
      const[year,month,day]=datePart.split('/').map(Number);
      const timeParts=timePart.split(':').map(Number);
      const hour=timeParts[0]||0;
      const minute=timeParts[1]||0;
      const second=timeParts[2]||0;
      expiryDate=new Date(Date.UTC(year,month-1,day,hour,minute,second));
    }else{
      const[year,month,day]=normalizedDateStr.split('/').map(Number);
      expiryDate=new Date(Date.UTC(year,month-1,day));
    }
    const today=new Date();
    const taipeiOffset=8*60*60*1000;
    const todayTaipei=new Date(today.getTime()+taipeiOffset);
    const todayUTC=new Date(Date.UTC(todayTaipei.getFullYear(),todayTaipei.getMonth(),todayTaipei.getDate()));
    if(isNaN(expiryDate.getTime()))return{displayDate:"æ—¥æœŸç„¡æ•ˆ",remainingDays:"æ—¥æœŸç„¡æ•ˆ"};
    const timeDiff=expiryDate-todayUTC;
    const remainingDays=Math.ceil(timeDiff/(1000*3600*24));
    const formattedDate=new Date(expiryDate).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).replace(/\//g,'/').replace(' ',' ');
    let remainingDaysText;
    if(remainingDays<0)remainingDaysText="<span class='text-red-500 font-medium'>å·²éæœŸ</span>";
    else if(remainingDays===0)remainingDaysText="<span class='text-orange-500 font-medium'>æœ€å¾Œ1å¤©</span>";
    else if(remainingDays<=30)remainingDaysText=`<span class='text-orange-500 font-medium'>${remainingDays} å¤©</span>`;
    else remainingDaysText=`${remainingDays} å¤©`;
    return{displayDate:formattedDate,remainingDays:remainingDaysText};
  }catch(error){
    console.error("è¨ˆç®—å‰©é¤˜å¤©æ•¸å¤±æ•—ï¼š",error);
    return{displayDate:"è¨ˆç®—éŒ¯èª¤",remainingDays:"è¨ˆç®—éŒ¯èª¤"};
  }
};
const getVideoThumbnail=(url,fileType,fileName)=>{
  if(!url)return 'https://via.placeholder.com/300x180?text=No+Preview';
  if(url.startsWith('blob:')){
    const fileCat=getFileCategory(fileType,fileName);
    switch(fileCat){
      case 'audio':return 'https://via.placeholder.com/300x180?text=éŸ³è¨Šæª”&bgcolor=e8f9f7&color=008c76';
      case 'video':return 'https://via.placeholder.com/300x180?text=æœ¬åœ°å½±ç‰‡&bgcolor=e8f9f7&color=008c76';
      case 'pdf':return 'https://via.placeholder.com/300x180?text=PDFæ–‡ä»¶&bgcolor=f1f5f9&color=008c76';
      case 'office':return 'https://via.placeholder.com/300x180?text=è¾¦å…¬æ–‡æª”&bgcolor=f1f5f9&color=64748b';
      case 'text':return 'https://via.placeholder.com/300x180?text=æ–‡æœ¬æ–‡ä»¶&bgcolor=f1f5f9&color=64748b';
      default:return 'https://via.placeholder.com/300x180?text=æœ¬åœ°æ–‡ä»¶&bgcolor=f1f5f9&color=64748b';
    }
  }
  const urlType=getUrlType(url);
  switch(urlType){
    case 'youtube':
      const youtubeRegex=/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/))([\w-]+)/;
      const youtubeMatch=url.match(youtubeRegex);
      if(youtubeMatch&&youtubeMatch[1])return `https://img.youtube.com/vi/${youtubeMatch[1]}/mqdefault.jpg`;
      break;
    case 'vimeo':return 'https://via.placeholder.com/300x180?text=Vimeo';
    case 'tencent_meeting':return 'https://via.placeholder.com/300x180?text=é¨°è¨Šæœƒè­°&bgcolor=e8f9f7&color=008c76';
    case 'audio':return 'https://via.placeholder.com/300x180?text=éŸ³è¨Šæª”&bgcolor=e8f9f7&color=008c76';
    case 'video':return 'https://via.placeholder.com/300x180?text=é ç«¯å½±ç‰‡&bgcolor=e8f9f7&color=008c76';
    case 'pdf':return 'https://via.placeholder.com/300x180?text=PDFæ–‡ä»¶&bgcolor=f1f5f9&color=008c76';
    default:return 'https://via.placeholder.com/300x180?text=å¤–éƒ¨é€£çµ&bgcolor=f1f5f9&color=64748b';
  }
  return 'https://via.placeholder.com/300x180?text=Link';
};
const isManageUser=()=>{return appState.userRole==='admin';};
const isProUser=()=>{return appState.userRole==='pro';};
const handleDragStart=(e)=>{
  if(!isManageUser())return;
  appState.draggingItem=e.target;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain',e.target.getAttribute('data-id'));
  e.target.style.opacity='0.5';
};
const handleDragOver=(e)=>{
  if(!isManageUser())return;
  e.preventDefault();
  const currentItem=e.target.closest('.video-item');
  if(!currentItem||currentItem===appState.draggingItem)return;
  currentItem.classList.add('drop-zone');
};
const handleDragLeave=(e)=>{
  if(!isManageUser())return;
  const currentItem=e.target.closest('.video-item');
  if(currentItem)currentItem.classList.remove('drop-zone');
};
const handleDrop=(e)=>{
  if(!isManageUser())return;
  e.preventDefault();
  const draggedId=e.dataTransfer.getData('text/plain');
  const targetItem=e.target.closest('.video-item');
  if(!targetItem||targetItem.getAttribute('data-id')===draggedId)return;
  const draggedIndex=appState.videoList.findIndex(v=>v.id===draggedId);
  const targetIndex=appState.videoList.findIndex(v=>v.id===targetItem.getAttribute('data-id'));
  if(draggedIndex!==-1&&targetIndex!==-1){
    const draggedItem=appState.videoList[draggedIndex];
    appState.videoList.splice(draggedIndex,1);
    appState.videoList.splice(targetIndex,0,draggedItem);
    syncVideoListOrderToGAS();
    renderVideoList();
    renderViewerVideoList();
    showSuccess('å…§å®¹é †åºå·²å³æ™‚æ›´æ–°ï¼');
  }
  targetItem.classList.remove('drop-zone');
  if(appState.draggingItem){
    appState.draggingItem.classList.remove('dragging');
    appState.draggingItem.style.opacity='1';
  }
  appState.draggingItem=null;
};
const handleDragEnd=(e)=>{
  if(!isManageUser())return;
  e.target.classList.remove('dragging');
  e.target.style.opacity='1';
  document.querySelectorAll('.video-item').forEach(item=>item.classList.remove('drop-zone'));
  appState.draggingItem=null;
};
const handleFileUpload=(e)=>{
  const files=e.target.files||e.dataTransfer.files;
  if(!files||files.length===0)return;
  const file=files[0];
  appState.uploadedFile=file;
  const blobUrl=URL.createObjectURL(file);
  appState.uploadedFileBlobUrl=blobUrl;
  document.getElementById('file-type').value=file.type;
  document.getElementById('file-name').value=file.name;
  document.getElementById('uploaded-file-name').textContent=file.name;
  document.getElementById('uploaded-file-info').classList.remove('hidden');
  document.getElementById('content-video').value=''; // ä¸Šä¼ æ–‡ä»¶åæ¸…ç©ºç½‘å€è¾“å…¥æ¡†
};
// âœ… ä¿®å¤ï¼šæ–°å¢ä¸Šä¼ å®¹å™¨çš„æ‹–æ‹½äº‹ä»¶å¤„ç†å‡½æ•°
const handleDragOverUpload=(e)=>{
  e.preventDefault();
  e.currentTarget.classList.add('drop-zone');
};
const handleDragLeaveUpload=(e)=>{
  e.currentTarget.classList.remove('drop-zone');
};
const handleDropUpload=(e)=>{
  e.preventDefault();
  e.currentTarget.classList.remove('drop-zone');
  handleFileUpload(e); // å¤ç”¨æ–‡ä»¶ä¸Šä¼ é€»è¾‘
};
const clearUploadedFile=()=>{
  if(appState.uploadedFileBlobUrl)URL.revokeObjectURL(appState.uploadedFileBlobUrl);
  appState.uploadedFile=null;
  appState.uploadedFileBlobUrl='';
  document.getElementById('content-file').value='';
  document.getElementById('file-type').value='';
  document.getElementById('file-name').value='';
  document.getElementById('uploaded-file-info').classList.add('hidden');
};
const updateVideoCountDisplay=()=>{
  const countNumEl=document.getElementById('video-count-num');
  if(countNumEl)countNumEl.textContent=appState.videoList.length;
};
const fetchVideoListFromGAS=()=>{
  setStatus('è¼‰å…¥å…§å®¹åˆ—è¡¨ä¸­...');
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{action:'getVideoList'},
    success:function(resp){
      if(resp.status==="success"&&Array.isArray(resp.data)){
        appState.videoList=resp.data.map(v=>({
          id:v.id||`vid_${new Date().getTime()}_${Math.floor(Math.random()*1000)}`,
          name:v.name||'',
          video:v.video||'',
          note:v.note||'',
          updatedAt:convertUTCToTaiwanTime(v.updatedAt)||convertUTCToTaiwanTime(new Date().toISOString()),
          fileType:v.fileType||'',
          fileName:v.fileName||''
        })).filter(v=>v.video&&v.id);
        updateVideoCountDisplay();
        renderViewerVideoList();
        renderVideoList();
        setStatus('è¼‰å…¥å®Œæˆ');
      }else{
        appState.videoList=[];
        updateVideoCountDisplay();
        renderViewerVideoList();
        renderVideoList();
      }
    },
    error:function(xhr,status,error){
      console.error("ç²å–å…§å®¹åˆ—è¡¨å¤±æ•—ï¼š",status,error);
      appState.videoList=[];
      updateVideoCountDisplay();
      renderViewerVideoList();
      renderVideoList();
    }
  });
};
const syncVideoToGAS=(videoData,callback)=>{
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action:'saveVideo',
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      videoId:videoData.id,
      name:videoData.name,
      video:videoData.video,
      note:videoData.note,
      updatedAt:videoData.updatedAt,
      fileType:videoData.fileType||'',
      fileName:videoData.fileName||''
    },
    success:function(resp){
      if(resp.status==="success"){
        if(callback)callback(true);
      }else{
        showError(`åŒæ­¥å…§å®¹å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
        if(callback)callback(false);
      }
    },
    error:function(xhr,status,error){
      console.error("åŒæ­¥å…§å®¹å¤±æ•—ï¼š",status,error);
      showError(`åŒæ­¥å…§å®¹å¤±æ•—ï¼š${status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
      if(callback)callback(false);
    }
  });
};
const deleteVideoFromGAS=(videoId,callback)=>{
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action:'deleteVideo',
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      videoId:videoId
    },
    success:function(resp){
      if(resp.status==="success"){
        const video=appState.videoList.find(v=>v.id===videoId);
        if(video&&video.video.startsWith('blob:'))URL.revokeObjectURL(video.video);
        if(callback)callback(true);
      }else{
        showError(`åˆªé™¤å…§å®¹å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
        if(callback)callback(false);
      }
    },
    error:function(xhr,status,error){
      console.error("åˆªé™¤å…§å®¹å¤±æ•—ï¼š",status,error);
      showError(`åˆªé™¤å…§å®¹å¤±æ•—ï¼š${status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
      if(callback)callback(false);
    }
  });
};
const syncVideoListOrderToGAS=()=>{
  const videoIds=appState.videoList.map(v=>v.id);
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action:'updateVideoOrder',
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      videoIds:JSON.stringify(videoIds)
    },
    success:function(resp){
      if(resp.status!=="success")console.warn("åŒæ­¥å…§å®¹é †åºå¤±æ•—ï¼š",resp.message);
    },
    error:function(xhr,status,error){
      console.error("åŒæ­¥å…§å®¹é †åºå¤±æ•—ï¼š",status,error);
    }
  });
};
function renderVideoList(){
  const container=document.getElementById('video-list-container');
  const emptyEl=document.getElementById('empty-video-list');
  if(!container||!emptyEl)return;
  container.innerHTML='';
  const isManage=isManageUser();
  if(appState.videoList.length===0){
    emptyEl.classList.remove('hidden');
    document.getElementById('empty-tip').textContent=isManage?'é»æ“Šã€Œæ–°å¢ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ ':'æš«ç„¡å¯ç”¨çš„æ•™å­¸å…§å®¹';
    return;
  }
  emptyEl.classList.add('hidden');
  appState.videoList.forEach((video,index)=>{
    const videoItem=document.createElement('div');
    videoItem.className=isManage?'video-item bg-cardBg rounded-lg p-2 border border-gray-100 shadow-elevation-1 slide-up cursor-pointer':'video-item pro-user bg-cardBg rounded-lg p-2 border border-gray-100 shadow-elevation-1 slide-up';
    videoItem.setAttribute('data-id',video.id);
    videoItem.onclick=(e)=>{
      if(!e.target.closest('button')){
        viewVideo(video.id);
      }
    };
    if(isManage){
      videoItem.setAttribute('draggable','true');
      videoItem.addEventListener('dragstart',handleDragStart);
      videoItem.addEventListener('dragover',handleDragOver);
      videoItem.addEventListener('dragleave',handleDragLeave);
      videoItem.addEventListener('drop',handleDrop);
      videoItem.addEventListener('dragend',handleDragEnd);
    }
    const shortTitle=video.name.length>25?`${video.name.substring(0,25)}...`:video.name;
    const shortLink=video.fileName?video.fileName:(video.video.length>35?`${video.video.substring(0,35)}...`:video.video);
    const thumbnailUrl=getVideoThumbnail(video.video,video.fileType,video.fileName).replace('300x180','80x50');
    const actionBtns=isManage?`
      <div class="flex flex-col gap-1 ml-2">
        <button onclick="event.stopPropagation();viewVideo('${video.id}')" class="p-2 text-primary hover:bg-primary/5 rounded-lg transition-colors" title="é è¦½å…§å®¹">
          <i class="fa fa-eye text-base"></i>
        </button>
        <button onclick="event.stopPropagation();editVideo('${video.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors" title="ç·¨è¼¯å…§å®¹">
          <i class="fa fa-pencil text-base"></i>
        </button>
        <button onclick="event.stopPropagation();deleteVideoConfirm('${video.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="åˆªé™¤å…§å®¹">
          <i class="fa fa-trash text-base"></i>
        </button>
      </div>
    `:`
      <div class="flex flex-col gap-1 ml-2">
        <button onclick="event.stopPropagation();viewVideo('${video.id}')" class="p-2 text-primary hover:bg-primary/5 rounded-lg transition-colors" title="é è¦½å…§å®¹">
          <i class="fa fa-eye text-base"></i>
        </button>
      </div>
    `;
    videoItem.innerHTML=`
      <div class="flex items-start gap-2">
        <div class="thumbnail-container">
          <img src="${thumbnailUrl}" alt="${video.name}" class="thumbnail-img" loading="lazy">
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center mb-1">
            <span class="inline-flex items-center justify-center w-4 h-4 bg-primary/10 text-primary rounded-full text-xs mr-1">${index+1}</span>
            <h4 class="font-medium text-textPrimary truncate text-xs md:text-sm">${shortTitle}</h4>
          </div>
          <p class="text-xs text-textSecondary break-all mb-1">${shortLink}</p>
          ${video.note?`<p class="text-xs text-textSecondary/80 mb-1"><i class="fa fa-sticky-note-o mr-1 text-xs"></i>${video.note.substring(0,20)}${video.note.length>20?'...':''}</p>`:''}
          <p class="text-xs text-textSecondary/70"><i class="fa fa-clock-o mr-1 text-xs"></i>${video.updatedAt}</p>
        </div>
        ${actionBtns}
      </div>
    `;
    container.appendChild(videoItem);
  });
}
function renderViewerVideoList(){
  const container=document.getElementById('viewer-video-list');
  const emptyEl=document.getElementById('viewer-empty-list');
  if(!container||!emptyEl)return;
  container.innerHTML='';
  if(appState.videoList.length===0){
    emptyEl.classList.remove('hidden');
    return;
  }
  emptyEl.classList.add('hidden');
  appState.videoList.forEach((video,index)=>{
    const viewerCard=document.createElement('div');
    viewerCard.className='viewer-card bg-cardBg rounded-xl overflow-hidden shadow-elevation-2 slide-up';
    viewerCard.onclick=()=>{viewVideo(video.id);};
    const fullTitle=video.name||'æœªå‘½åå…§å®¹';
    const thumbnailUrl=getVideoThumbnail(video.video,video.fileType,video.fileName);
    const cardContent=`
      <div class="relative">
        <img src="${thumbnailUrl}" alt="${fullTitle}" class="w-full h-48 object-cover">
        <div class="absolute top-2 right-2 bg-primary/80 text-white text-xs px-2 py-1 rounded-full">
          ${index+1}
        </div>
        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3">
          <h3 class="text-white font-medium text-sm md:text-base truncate">${fullTitle}</h3>
        </div>
      </div>
      <div class="p-3">
        <p class="text-xs text-textSecondary mb-2"><i class="fa fa-sticky-note-o mr-1"></i>${video.note||'ç„¡å‚™è¨»è³‡è¨Š'}</p>
        <div class="flex justify-between items-center">
          <span class="text-xs text-textSecondary/70"><i class="fa fa-clock-o mr-1"></i>${video.updatedAt}</span>
          <button onclick="event.stopPropagation();viewVideo('${video.id}')" class="watch-btn bg-primary/10 text-primary hover:bg-primary/20 transition-colors">
            <i class="fa fa-play mr-1"></i> ç«‹å³æŸ¥çœ‹
          </button>
        </div>
      </div>
    `;
    viewerCard.innerHTML=cardContent;
    container.appendChild(viewerCard);
  });
}
function toggleVideoListSection(){
  const viewerEl=document.getElementById('video-viewer-section');
  const managerEl=document.getElementById('video-list-section');
  const editEl=document.getElementById('edit-section');
  if(editEl)editEl.classList.add('hidden');
  if(viewerEl.classList.contains('hidden')){
    viewerEl.classList.remove('hidden');
    managerEl.classList.add('hidden');
  }else{
    viewerEl.classList.add('hidden');
    managerEl.classList.remove('hidden');
  }
}
function renderResult(resp){
  console.log("æ¸²æŸ“ç”¨æˆ¶é©—è­‰çµæœï¼š",resp);
  const statusEl=document.getElementById('status');
  const errorMsgEl=document.getElementById('error-message');
  if(statusEl)statusEl.classList.add('hidden');
  if(errorMsgEl)errorMsgEl.classList.add('hidden');
  if(!resp.isAuthorized){
    showError('æœªæˆæ¬Šä½¿ç”¨ï¼Œåƒ…ç®¡ç†/å°ˆæ¥­ç”¨æˆ¶å¯è¨ªå•');
    return;
  }
  const isAdmin=Boolean(resp.isAdmin);
  const isPro=Boolean(resp.isPro)&&!isAdmin;
  appState.userRole=isAdmin?'admin':isPro?'pro':'guest';
  const actualUserName=resp.displayName || appState.currentUser?.displayName || 'æœªçŸ¥ç”¨æˆ¶';
  appState.currentUser={
    userId:resp.userId,
    displayName:actualUserName,
    isAdmin:isAdmin,
    isPro:isPro,
    expiryDate:resp.expiryDate
  };
  const card=document.getElementById('result-card');
  const main=document.getElementById('result-main');
  const details=document.getElementById('result-details');
  if(!card||!main||!details)return;
  const userName=actualUserName;
  const expiryDateStr=resp.expiryDate||resp.endDate||resp.expireDate||'';
  if(isAdmin){
    const{displayDate,remainingDays}=calculateRemainingDaysByDate(expiryDateStr);
    main.innerHTML=`<span class="text-primary"><i class="fa fa-check-circle mr-2 text-sm"></i>ç®¡ç†ç”¨æˆ¶é©—è­‰é€šé</span>`;
    details.innerHTML=`
      <div><i class="fa fa-user-circle text-primary mr-1.5 text-xs"></i>ç”¨æˆ¶åç¨±ï¼š<span class="font-medium">${userName}</span></div>
      <div><i class="fa fa-user text-primary mr-1.5 text-xs"></i>ç”¨æˆ¶é¡å‹ï¼š<span class="font-medium">ç®¡ç†ç”¨æˆ¶</span></div>
      <div><i class="fa fa-calendar-check-o text-primary mr-1.5 text-xs"></i>ä½¿ç”¨æœŸé™ï¼š<span class="font-medium">${displayDate}</span></div>
      <div><i class="fa fa-clock-o text-primary mr-1.5 text-xs"></i>å‰©é¤˜å¤©æ•¸ï¼š${remainingDays}</div>
    `;
    document.getElementById('manage-btn-container').style.display='flex';
    document.getElementById('preview-action-btns').style.display='flex';
  }else if(isPro){
    const{displayDate,remainingDays}=calculateRemainingDaysByDate(expiryDateStr);
    main.innerHTML=`<span class="text-textPrimary"><i class="fa fa-user mr-2 text-sm"></i>å°ˆæ¥­ç”¨æˆ¶é©—è­‰é€šé</span>`;
    details.innerHTML=`
      <div><i class="fa fa-user-circle text-textPrimary mr-1.5 text-xs"></i>ç”¨æˆ¶åç¨±ï¼š<span class="font-medium">${userName}</span></div>
      <div><i class="fa fa-user text-textPrimary mr-1.5 text-xs"></i>ç”¨æˆ¶é¡å‹ï¼š<span class="font-medium">å°ˆæ¥­ç”¨æˆ¶</span></div>
      <div><i class="fa fa-calendar-o text-textPrimary mr-1.5 text-xs"></i>ä½¿ç”¨æœŸé™ï¼š<span class="font-medium">${displayDate}</span></div>
      <div><i class="fa fa-clock-o text-textPrimary mr-1.5 text-xs"></i>å‰©é¤˜å¤©æ•¸ï¼š${remainingDays}</div>
    `;
    document.getElementById('manage-btn-container').style.display='none';
    document.getElementById('preview-action-btns').style.display='none';
  }else{
    showError('ç”¨æˆ¶æ¬Šé™ç•°å¸¸ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡');
    return;
  }
  card.classList.remove('hidden');
  document.getElementById('video-viewer-section').classList.remove('hidden');
  fetchVideoListFromGAS();
}
function addNewVideo(){
  if(appState.isSubmitting||!isManageUser()){
    if(!isManageUser())showError('åƒ…ç®¡ç†ç”¨æˆ¶å¯æ–°å¢å…§å®¹');
    return;
  }
  appState.currentEditingVideoId=null;
  const editTitleEl=document.getElementById('edit-title');
  const videoIdEl=document.getElementById('video-id');
  const contentNameEl=document.getElementById('content-name');
  const contentVideoEl=document.getElementById('content-video');
  const contentNoteEl=document.getElementById('content-note');
  const videoListEl=document.getElementById('video-list-section');
  const editEl=document.getElementById('edit-section');
  clearUploadedFile();
  if(editTitleEl)editTitleEl.innerHTML='<i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢å…§å®¹';
  if(videoIdEl)videoIdEl.value='';
  if(contentNameEl)contentNameEl.value='';
  if(contentVideoEl)contentVideoEl.value='';
  if(contentNoteEl)contentNoteEl.value='';
  setSubmitState(false);
  if(videoListEl)videoListEl.classList.add('hidden');
  if(editEl){
    editEl.classList.remove('hidden');
    editEl.scrollIntoView({behavior:'smooth'});
  }
}
function editVideo(videoId){
  if(appState.isSubmitting||!isManageUser()){
    if(!isManageUser())showError('åƒ…ç®¡ç†ç”¨æˆ¶å¯ç·¨è¼¯å…§å®¹');
    return;
  }
  const video=appState.videoList.find(v=>v.id===videoId);
  if(!video)return;
  appState.currentEditingVideoId=videoId;
  const editTitleEl=document.getElementById('edit-title');
  const videoIdEl=document.getElementById('video-id');
  const contentNameEl=document.getElementById('content-name');
  const contentVideoEl=document.getElementById('content-video');
  const contentNoteEl=document.getElementById('content-note');
  const fileTypeEl=document.getElementById('file-type');
  const fileNameEl=document.getElementById('file-name');
  const uploadedFileInfoEl=document.getElementById('uploaded-file-info');
  const uploadedFileNameEl=document.getElementById('uploaded-file-name');
  const videoListEl=document.getElementById('video-list-section');
  const editEl=document.getElementById('edit-section');
  clearUploadedFile();
  if(editTitleEl)editTitleEl.innerHTML='<i class="fa fa-edit text-primary mr-2 text-sm"></i> ç·¨è¼¯å…§å®¹';
  if(videoIdEl)videoIdEl.value=video.id;
  if(contentNameEl)contentNameEl.value=video.name;
  // âœ… ä¿®å¤ï¼šç¼–è¾‘æ—¶ï¼Œè‹¥ä¸ºæœ¬åœ°æ–‡ä»¶ï¼ˆblobUrlï¼‰ï¼Œåˆ™ä¸å¡«å……ç½‘å€ï¼Œè€Œæ˜¯æ˜¾ç¤ºæ–‡ä»¶å
  if(video.video.startsWith('blob:')){
    if(contentVideoEl)contentVideoEl.value='';
  }else{
    if(contentVideoEl)contentVideoEl.value=video.video;
  }
  
    // è¡¥å…¨ editVideo å‡½æ•°å‰©ä½™éƒ¨åˆ†
  if(contentNoteEl)contentNoteEl.value=video.note||'';
  if(fileTypeEl)fileTypeEl.value=video.fileType||'';
  if(fileNameEl)fileNameEl.value=video.fileName||'';
  
  // è‹¥ä¸ºæœ¬åœ°æ–‡ä»¶ï¼Œæ˜¾ç¤ºå·²ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯
  if(video.fileName){
    if(uploadedFileNameEl)uploadedFileNameEl.textContent=video.fileName;
    if(uploadedFileInfoEl)uploadedFileInfoEl.classList.remove('hidden');
  }else{
    if(uploadedFileInfoEl)uploadedFileInfoEl.classList.add('hidden');
  }
  
  setSubmitState(false);
  if(videoListEl)videoListEl.classList.add('hidden');
  if(editEl){
    editEl.classList.remove('hidden');
    editEl.scrollIntoView({behavior:'smooth'});
  }
}

// éšè—ç¼–è¾‘åŒºåŸŸ
function hideEditSection(){
  const editEl=document.getElementById('edit-section');
  const videoListEl=document.getElementById('video-list-section');
  const isManage=isManageUser();
  
  if(editEl)editEl.classList.add('hidden');
  // ç®¡ç†ç”¨æˆ·è¿”å›å†…å®¹ç®¡ç†åˆ—è¡¨ï¼Œæ™®é€šç”¨æˆ·è¿”å›æŸ¥çœ‹åˆ—è¡¨
  if(isManage && videoListEl)videoListEl.classList.remove('hidden');
  if(!isManage)document.getElementById('video-viewer-section').classList.remove('hidden');
  
  // æ¸…ç©ºç¼–è¾‘çŠ¶æ€
  appState.currentEditingVideoId=null;
  clearUploadedFile();
  resetSubmitState();
}

// ä¿å­˜/æ›´æ–°å†…å®¹
function saveVideo(event){
  event.preventDefault();
  if(appState.isSubmitting||!isManageUser()){
    if(!isManageUser())showError('åƒ…ç®¡ç†ç”¨æˆ¶å¯ä¿å­˜å…§å®¹');
    return;
  }
  
  const videoIdEl=document.getElementById('video-id');
  const contentNameEl=document.getElementById('content-name');
  const contentVideoEl=document.getElementById('content-video');
  const contentNoteEl=document.getElementById('content-note');
  const fileTypeEl=document.getElementById('file-type');
  const fileNameEl=document.getElementById('file-name');
  
  // è·å–è¡¨å•å€¼
  const videoId=videoIdEl.value||`vid_${new Date().getTime()}_${Math.floor(Math.random()*1000)}`;
  const name=contentNameEl.value.trim();
  let videoUrl=contentVideoEl.value.trim();
  const note=contentNoteEl.value.trim();
  const fileType=fileTypeEl.value||'';
  const fileName=fileNameEl.value||'';
  
  // è¡¨å•éªŒè¯
  if(!name){
    showError('è«‹è¼¸å…¥å…§å®¹åç¨±');
    return;
  }
  
  // ä¼˜å…ˆä½¿ç”¨ä¸Šä¼ æ–‡ä»¶çš„blobåœ°å€
  if(appState.uploadedFileBlobUrl){
    videoUrl=appState.uploadedFileBlobUrl;
  }else if(videoUrl&&!validateVideoUrl(videoUrl)){
    showError('è«‹è¼¸å…¥åˆæ³•çš„ç¶²å€');
    return;
  }else if(!videoUrl&&!fileName){
    showError('è«‹ä¸Šå‚³æ–‡ä»¶æˆ–å¡«å¯«ç¶²å€');
    return;
  }
  
  setSubmitState(true);
  
  // æ„é€ è§†é¢‘æ•°æ®
  const videoData={
    id:videoId,
    name:name,
    video:videoUrl,
    note:note,
    updatedAt:convertUTCToTaiwanTime(new Date().toISOString()),
    fileType:fileType,
    fileName:fileName
  };
  
  // åŒæ­¥åˆ°GAS
  syncVideoToGAS(videoData,(isSuccess)=>{
    if(isSuccess){
      // æ›´æ–°æœ¬åœ°åˆ—è¡¨
      const existingIndex=appState.videoList.findIndex(v=>v.id===videoId);
      if(existingIndex!==-1){
        // ç¼–è¾‘ï¼šæ›¿æ¢åŸæœ‰æ•°æ®
        appState.videoList[existingIndex]=videoData;
        showSuccess('å…§å®¹å·²æˆåŠŸæ›´æ–°ï¼');
      }else{
        // æ–°å¢ï¼šæ·»åŠ åˆ°åˆ—è¡¨
        appState.videoList.push(videoData);
        showSuccess('å…§å®¹å·²æˆåŠŸæ–°å¢ï¼');
      }
      
      // åˆ·æ–°åˆ—è¡¨
      updateVideoCountDisplay();
      renderVideoList();
      renderViewerVideoList();
      
      // éšè—ç¼–è¾‘åŒºåŸŸ
      hideEditSection();
    }
    resetSubmitState();
  });
}

// æŸ¥çœ‹è§†é¢‘/å†…å®¹è¯¦æƒ…
function viewVideo(videoId){
  const video=appState.videoList.find(v=>v.id===videoId);
  if(!video)return;
  
  appState.currentViewingVideoId=videoId;
  const videoPreviewEl=document.getElementById('video-preview');
  const previewTitleEl=document.getElementById('preview-title');
  const previewLinkEl=document.getElementById('preview-link');
  const previewUpdatedEl=document.getElementById('preview-updated');
  const previewNoteEl=document.getElementById('preview-note');
  
  // éšè—å…¶ä»–åŒºåŸŸ
  document.getElementById('edit-section').classList.add('hidden');
  document.getElementById('video-list-section').classList.add('hidden');
  
  // å¡«å……é¢„è§ˆåŸºæœ¬ä¿¡æ¯
  if(previewTitleEl)previewTitleEl.textContent=video.name;
  if(previewLinkEl)previewLinkEl.textContent=video.fileName?video.fileName:video.video;
  if(previewUpdatedEl)previewUpdatedEl.textContent=video.updatedAt;
  if(previewNoteEl)previewNoteEl.textContent=video.note||'- ç„¡å‚™è¨» -';
  
  // è·å–å†…å®¹ç±»å‹å¹¶æ¸²æŸ“å¯¹åº”é¢„è§ˆå®¹å™¨
  const fileCategory=video.video.startsWith('blob:')
    ? getFileCategory(video.fileType,video.fileName)
    : getUrlType(video.video);
  
  // éšè—æ‰€æœ‰é¢„è§ˆå®¹å™¨
  document.getElementById('video-container').classList.add('hidden');
  document.getElementById('audio-container').classList.add('hidden');
  document.getElementById('document-container').classList.add('hidden');
  document.getElementById('link-container').classList.add('hidden');
  document.getElementById('file-download-container').classList.add('hidden');
  
  // é‡ç½®é¢„è§ˆåŠ è½½çŠ¶æ€
  const videoLoadingEl=document.getElementById('video-loading');
  const documentLoadingEl=document.getElementById('document-loading');
  if(videoLoadingEl)videoLoadingEl.classList.remove('hidden');
  if(documentLoadingEl)documentLoadingEl.classList.remove('hidden');
  
  switch(fileCategory){
    case 'video':
      const previewVideoEl=document.getElementById('preview-video');
      const previewLocalVideoEl=document.getElementById('preview-local-video');
      const localVideoSourceEl=document.getElementById('local-video-source');
      const videoContainerEl=document.getElementById('video-container');
      
      if(video.video.startsWith('blob:')){
        // æœ¬åœ°è§†é¢‘
        if(localVideoSourceEl)localVideoSourceEl.src=video.video;
        if(localVideoSourceEl)localVideoSourceEl.type=video.fileType||'video/mp4';
        if(previewLocalVideoEl)previewLocalVideoEl.classList.remove('hidden');
        if(previewVideoEl)previewVideoEl.classList.add('hidden');
      }else{
        // è¿œç¨‹è§†é¢‘ï¼ˆè½¬åµŒå…¥åœ°å€ï¼‰
        const embedUrl=convertToEmbedUrl(video.video)||video.video;
        if(previewVideoEl)previewVideoEl.src=embedUrl;
        if(previewLocalVideoEl)previewLocalVideoEl.classList.add('hidden');
        if(previewVideoEl)previewVideoEl.classList.remove('hidden');
      }
      
      if(videoContainerEl)videoContainerEl.classList.remove('hidden');
      break;
      
    case 'audio':
      const previewAudioEl=document.getElementById('preview-audio');
      const audioSourceEl=document.getElementById('audio-source');
      const audioContainerEl=document.getElementById('audio-container');
      
      if(audioSourceEl)audioSourceEl.src=video.video;
      if(audioSourceEl)audioSourceEl.type=video.fileType||'audio/mpeg';
      if(previewAudioEl)previewAudioEl.load();
      if(audioContainerEl)audioContainerEl.classList.remove('hidden');
      break;
      
    case 'pdf':
      const previewDocumentEl=document.getElementById('preview-document');
      const documentContainerEl=document.getElementById('document-container');
      
      if(previewDocumentEl)previewDocumentEl.src=video.video;
      if(documentContainerEl)documentContainerEl.classList.remove('hidden');
      break;
      
    case 'office':
    case 'text':
      const fileDownloadTitleEl=document.getElementById('file-download-title');
      const fileDownloadDescEl=document.getElementById('file-download-desc');
      const fileDownloadBtnEl=document.getElementById('file-download-btn');
      const fileDownloadContainerEl=document.getElementById('file-download-container');
      
      if(fileDownloadTitleEl)fileDownloadTitleEl.textContent=video.name;
      if(fileDownloadDescEl)fileDownloadDescEl.textContent=video.fileName||'é»æ“Šä¸‹è¼‰æŸ¥çœ‹è©²æ–‡ä»¶';
      if(fileDownloadBtnEl)fileDownloadBtnEl.href=video.video;
      if(fileDownloadBtnEl)fileDownloadBtnEl.download=video.fileName||video.name;
      if(fileDownloadContainerEl)fileDownloadContainerEl.classList.remove('hidden');
      break;
      
    default:
      // æ™®é€šé“¾æ¥
      const linkIconEl=document.getElementById('link-icon');
      const linkTitleEl=document.getElementById('link-title');
      const linkDescEl=document.getElementById('link-desc');
      const linkBtnEl=document.getElementById('link-btn');
      const linkContainerEl=document.getElementById('link-container');
      
      if(linkIconEl)linkIconEl.className='link-card-icon fa fa-link';
      if(linkTitleEl)linkTitleEl.textContent=video.name;
      if(linkDescEl)linkDescEl.textContent=video.note||'é»æ“Šé–‹å•Ÿå¤–éƒ¨é€£çµ';
      if(linkBtnEl)linkBtnEl.href=video.video;
      if(linkContainerEl)linkContainerEl.classList.remove('hidden');
      break;
  }
  
  // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
  if(videoPreviewEl){
    videoPreviewEl.classList.remove('hidden');
    videoPreviewEl.scrollIntoView({behavior:'smooth'});
  }
}

// ç¼–è¾‘å½“å‰é¢„è§ˆçš„å†…å®¹
function editCurrentVideo(){
  const videoId=appState.currentViewingVideoId;
  if(!videoId)return;
  hideVideoPreview();
  setTimeout(()=>{editVideo(videoId);},300);
}

// ç¡®è®¤åˆ é™¤å†…å®¹
function deleteVideoConfirm(videoId){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢å…§å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼'))return;
  deleteVideo(videoId);
}

// åˆ é™¤å½“å‰é¢„è§ˆçš„å†…å®¹
function deleteCurrentVideo(){
  const videoId=appState.currentViewingVideoId;
  if(!videoId)return;
  deleteVideo(videoId);
}

// æ‰§è¡Œåˆ é™¤æ“ä½œ
function deleteVideo(videoId){
  if(appState.isSubmitting||!isManageUser()){
    if(!isManageUser())showError('åƒ…ç®¡ç†ç”¨æˆ¶å¯åˆªé™¤å…§å®¹');
    return;
  }
  
  setSubmitState(true);
  deleteVideoFromGAS(videoId,(isSuccess)=>{
    if(isSuccess){
      // ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤
      appState.videoList=appState.videoList.filter(v=>v.id!==videoId);
      updateVideoCountDisplay();
      renderVideoList();
      renderViewerVideoList();
      showSuccess('å…§å®¹å·²æˆåŠŸåˆªé™¤ï¼');
      
      // éšè—é¢„è§ˆ/ç¼–è¾‘åŒºåŸŸ
      hideVideoPreview();
      hideEditSection();
      appState.currentViewingVideoId=null;
    }
    resetSubmitState();
  });
}

// éšè—å†…å®¹é¢„è§ˆ
function hideVideoPreview(){
  const videoPreviewEl=document.getElementById('video-preview');
  const isManage=isManageUser();
  
  if(videoPreviewEl)videoPreviewEl.classList.add('hidden');
  appState.currentViewingVideoId=null;
  
  // ç®¡ç†ç”¨æˆ·è¿”å›å†…å®¹ç®¡ç†åˆ—è¡¨ï¼Œæ™®é€šç”¨æˆ·è¿”å›æŸ¥çœ‹åˆ—è¡¨
  if(isManage)document.getElementById('video-list-section').classList.remove('hidden');
  if(!isManage)document.getElementById('video-viewer-section').classList.remove('hidden');
}

// å¤åˆ¶å†…å®¹é“¾æ¥
function copyVideoLink(){
  const videoId=appState.currentViewingVideoId;
  if(!videoId)return;
  
  const video=appState.videoList.find(v=>v.id===videoId);
  if(!video)return;
  
  const linkText=video.fileName?`ã€${video.name}ã€‘æ–‡ä»¶ï¼š${video.fileName}`:`ã€${video.name}ã€‘éˆæ¥ï¼š${video.video}`;
  navigator.clipboard.writeText(linkText).then(()=>{
    showSuccess('éˆæ¥å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
  }).catch(()=>{
    // å…¼å®¹ä¸æ”¯æŒå‰ªè´´æ¿APIçš„æµè§ˆå™¨
    const textarea=document.createElement('textarea');
    textarea.value=linkText;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showSuccess('éˆæ¥å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
  });
}

// åˆå§‹åŒ–LIFF
async function initLIFF(){
  try{
    setStatus('æ­£åœ¨é©—è­‰ç”¨æˆ¶èº«ä»½...');
    await liff.init({liffId:CONFIG.LIFF_ID});
    
    if(!liff.isLoggedIn()){
      setStatus('æ­£åœ¨è·³è½‰ç™»éŒ„...');
      liff.login();
      return;
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    const userProfile=await liff.getProfile();
    appState.currentUser={
      userId:userProfile.userId,
      displayName:userProfile.displayName||userProfile.userId
    };
    
    // éªŒè¯ç”¨æˆ·æƒé™ï¼ˆé€šè¿‡GASï¼‰
    $.ajax({
      url:CONFIG.GAS_URL,
      dataType:'jsonp',
      jsonp:'callback',
      timeout:CONFIG.JSONP_TIMEOUT,
      data:{
        action:'verifyUser',
        userId:userProfile.userId,
        displayName:userProfile.displayName||userProfile.userId
      },
      success:function(resp){
        renderResult(resp);
      },
      error:function(xhr,status,error){
        console.error("ç”¨æˆ¶é©—è­‰å¤±æ•—ï¼š",status,error);
        showError(`ç”¨æˆ¶é©—è­‰å¤±æ•—ï¼š${status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦'}`);
      }
    });
    
  }catch(error){
    console.error("LIFFåˆå§‹åŒ–å¤±æ•—ï¼š",error);
    showError(`ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š${error.message||'æœªçŸ¥éŒ¯èª¤'}`);
  }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
$(document).ready(function(){
  // æ£€æŸ¥æ˜¯å¦åœ¨LINEç¯å¢ƒä¸­
  if(window.location.hostname!=='localhost'&&window.location.hostname!=='127.0.0.1'&&liff){
    initLIFF();
  }else{
    // æœ¬åœ°è°ƒè¯•æ¨¡å¼ï¼šæ¨¡æ‹Ÿç®¡ç†å‘˜æƒé™
    setStatus('æœ¬åœ°èª¿è©¦æ¨¡å¼ï¼Œè·³éLIFFé©—è­‰...');
    setTimeout(()=>{
      renderResult({
        isAuthorized:true,
        isAdmin:true,
        displayName:'æœ¬åœ°æ¸¬è©¦ç®¡ç†å“¡',
        userId:'local_test_admin',
        expiryDate:CONFIG.PERMANENT_EXPIRY_DATE
      });
    },1000);
  }
});
</script>
</body>
</html>

const CONFIG = {
  ADMIN_SPREADSHEET_ID: "1VZjEClfImH13739J3ciEwpZRIW5v_S5Q8P-VeJBxZyQ",
  LOG_SPREADSHEET_ID: "1VZjEClfImH13739J3ciEwpZRIW5v_S5Q8P-VeJBxZyQ",
  USER_CHECK_SPREADSHEET_ID: "1MxnhJlr7Q5zdmMxjeoKZ5r7s8DZATRewbneiG3eDRgM",
  TIME_ZONE: "Asia/Taipei",
  PERMANENT_EXPIRY_DATE: "9999/12/31",
  VIDEO_SHEET_NAME: "è¦–é »æ•¸æ“šè¨˜éŒ„",
  ADMIN_SHEET_NAME: "ç®¡ç†ç”¨æˆ¶",
  PRO_SHEET_NAME: "å°ˆæ¥­ç”¨æˆ¶",
  // æ–°å¢ï¼šé è¦½ç›¸é—œé…ç½®
  PREVIEW_CONFIG: {
    YOUTUBE: {
      embedPrefix: "https://www.youtube.com/embed/",
      width: 560,
      height: 315
    },
    TENCENT_MEETING: {
      previewText: "é¨°è¨Šæœƒè­°éˆæ¥",
      icon: "ğŸ“¹"
    },
    GENERAL: {
      previewText: "å¤–éƒ¨éˆæ¥",
      icon: "ğŸ”—"
    }
  }
};

/**
 * æ¸…æ´—ç”¨æˆ¶åç¨±ï¼Œé¿å…éæ³•å€¼
 * @param {string} rawName åŸå§‹åç¨±
 * @param {string} userId LINE UserID
 * @returns {string} æ¸…æ´—å¾Œçš„åç¨±
 */
function sanitizeDisplayName(rawName, userId) {
  let originalName = (rawName || "").toString().trim();
  let cleanName = originalName.replace(/[\n\r\t]/g, " ").replace(/\s+/g, " ");
  const systemInvalidValues = ["undefined", "null", "NaN", "æœªçŸ¥ç”¨æˆ¶", "æœªçŸ¥ç”¨æˆ·", "æœªå‘½å", ""];
  const isRealNameValid = cleanName && !systemInvalidValues.includes(cleanName);
  if (isRealNameValid) {
    return cleanName.length > 50 ? cleanName.substring(0, 50) + "â€¦" : cleanName;
  } else {
    const userIdSuffix = userId ? userId.slice(-6) : "æœªçŸ¥ID";
    return `LINEç”¨æˆ¶(${userIdSuffix})`;
  }
}

/**
 * è­˜åˆ¥å½±ç‰‡URLé¡å‹
 * @param {string} url å½±ç‰‡/é€£çµURL
 * @returns {string} é¡å‹ï¼ˆyoutube/tencent_meeting/generalï¼‰
 */
function getVideoType(url) {
  if (!url) return "general";
  const lowerUrl = url.toLowerCase().trim();
  if (lowerUrl.includes("youtube.com") || lowerUrl.includes("youtu.be")) {
    return "youtube";
  } else if (lowerUrl.includes("meeting.tencent.com") || lowerUrl.includes("tencent.com")) {
    return "tencent_meeting";
  } else {
    return "general";
  }
}

/**
 * ç”Ÿæˆé è¦½HTMLç‰‡æ®µï¼ˆä¾›å‰ç«¯ä½¿ç”¨ï¼‰
 * @param {string} url å½±ç‰‡/é€£çµURL
 * @param {string} type é¡å‹ï¼ˆyoutube/tencent_meeting/generalï¼‰
 * @returns {string} é è¦½HTML
 */
function generatePreviewHtml(url, type) {
  if (!url) return "";
  
  switch(type) {
    case "youtube":
      // æå–YouTubeå½±ç‰‡ID
      let videoId = "";
      if (url.includes("youtu.be/")) {
        videoId = url.split("youtu.be/")[1].split("?")[0];
      } else if (url.includes("v=")) {
        videoId = url.split("v=")[1].split("&")[0];
      }
      if (videoId) {
        const { embedPrefix, width, height } = CONFIG.PREVIEW_CONFIG.YOUTUBE;
        return `<iframe width="${width}" height="${height}" src="${embedPrefix}${videoId}" frameborder="0" allowfullscreen></iframe>`;
      }
      return `<a href="${url}" target="_blank">${CONFIG.PREVIEW_CONFIG.YOUTUBE.previewText} (é»æ“Šæ‰“é–‹)</a>`;
      
    case "tencent_meeting":
      return `<a href="${url}" target="_blank">${CONFIG.PREVIEW_CONFIG.TENCENT_MEETING.icon} ${CONFIG.PREVIEW_CONFIG.TENCENT_MEETING.previewText} (é»æ“Šæ‰“é–‹)</a>`;
      
    default:
      return `<a href="${url}" target="_blank">${CONFIG.PREVIEW_CONFIG.GENERAL.icon} ${CONFIG.PREVIEW_CONFIG.GENERAL.previewText} (é»æ“Šæ‰“é–‹)</a>`;
  }
}

/**
 * è™•ç† GET è«‹æ±‚å…¥å£
 * @param {Object} e è«‹æ±‚åƒæ•¸
 * @returns {ContentService} JSONP å›æ‡‰
 */
function doGet(e) {
  try {
    const callback = e.parameter.callback;
    if (!callback || callback.trim() === "") throw new Error("ç¼ºå°‘ callback åƒæ•¸");
    const action = e.parameter.action || "";
    switch(action) {
      case "verifyUser": return handleVerifyUser(e, callback);
      case "getVideoList": return handleGetVideoList(e, callback);
      case "saveVideo": return handleSaveVideo(e, callback);
      case "deleteVideo": return handleDeleteVideo(e, callback);
      case "updateVideoOrder": return handleUpdateVideoOrder(e, callback);
      case "submitChecklist": return handleSubmitChecklist(e, callback);
      default: throw new Error("æœªçŸ¥çš„ action åƒæ•¸ï¼š" + action);
    }
  } catch (err) {
    const error = {
      status: "error", message: err.message || "æœªçŸ¥éŒ¯èª¤", redirectUrl: null, redirect: false,
      remainingDays: undefined, expiryDate: undefined, displayName: undefined,
      isAdmin: false, isPro: false, isAuthorized: false
    };
    const jsonError = JSON.stringify(error);
    return ContentService
      .createTextOutput((e.parameter.callback || "callback") + "(" + jsonError + ")")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
}

/**
 * é©—è­‰ç”¨æˆ¶æ¬Šé™ï¼ˆå€åˆ†ç®¡ç†/å°ˆæ¥­ç”¨æˆ¶ï¼‰
 * @param {Object} e è«‹æ±‚åƒæ•¸
 * @param {string} callback JSONP å›èª¿å‡½æ•¸å
 * @returns {ContentService} JSONP å›æ‡‰
 */
function handleVerifyUser(e, callback) {
  const userId = (e.parameter.userId || "").trim();
  const rawDisplayName = e.parameter.displayName;
  const writeToSheet = e.parameter.writeToSheet === "true" || e.parameter.writeToSheet === true;
  const needExpiryDate = e.parameter.needExpiryDate === "true" || e.parameter.needExpiryDate === true;
  if (!userId) throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šuserId ç‚ºå¿…å¡«");
  const displayName = sanitizeDisplayName(rawDisplayName, userId);
  console.log(`[é©—è­‰ç”¨æˆ¶] UserID: ${userId} | æœ€çµ‚é¡¯ç¤ºåç¨±: ${displayName} | åŸå§‹ LINE æš±ç¨±: ${rawDisplayName || 'æœªå‚³é'}`);
  const userStatus = checkUserStatus(userId);
  const isAdmin = userStatus.isAdmin;
  const isPro = userStatus.isPro;
  const isAuthorized = isAdmin || isPro;
  if (!isAuthorized) throw new Error("æœªæˆæ¬Šä½¿ç”¨ï¼Œåƒ…ç®¡ç†/å°ˆæ¥­ç”¨æˆ¶å¯è¨ªå•ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡é–‹é€š");
  if (writeToSheet) {
    logAccess(
      userId, 
      displayName, 
      isAdmin, 
      isAdmin ? "å·²ç¢ºèªç‚ºç®¡ç†ç”¨æˆ¶" : "å·²ç¢ºèªç‚ºå°ˆæ¥­ç”¨æˆ¶", 
      userStatus.remainingDays, 
      userStatus.expiryDateStr
    );
  }
  const result = {
    status: "success", userId: userId, displayName: displayName,
    isAdmin: isAdmin, isPro: isPro, isAuthorized: isAuthorized,
    remainingDays: userStatus.remainingDays === "æ°¸ä¹…æœ‰æ•ˆ" ? "æ°¸ä¹…æœ‰æ•ˆ" : parseInt(userStatus.remainingDays, 10) || 0,
    expiryDate: userStatus.expiryDateStr || CONFIG.PERMANENT_EXPIRY_DATE,
    redirectUrl: "https://liff.line.me/2008578880-kzWN1hOE", redirect: true
  };
  const jsonResult = JSON.stringify(result, (key, value) => {
    if (value instanceof Date) return Utilities.formatDate(value, CONFIG.TIME_ZONE, "yyyy/MM/dd");
    if (typeof value === "number" && isNaN(value)) return 0;
    return value;
  });
  return ContentService
    .createTextOutput(callback + "(" + jsonResult + ")")
    .setMimeType(ContentService.MimeType.JAVASCRIPT);
}

/**
 * ç²å–æ‰€æœ‰å½±ç‰‡åˆ—è¡¨ï¼ˆæ”¯æ´ä»»æ„URLï¼Œå¢åŠ é è¦½å­—æ®µï¼‰
 * @param {Object} e è«‹æ±‚åƒæ•¸
 * @param {string} callback JSONP å›èª¿å‡½æ•¸å
 * @returns {ContentService} JSONP å›æ‡‰
 */
function handleGetVideoList(e, callback) {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const videoSheet = spreadsheet.getSheetByName(CONFIG.VIDEO_SHEET_NAME);
    if (!videoSheet || videoSheet.getLastRow() < 2) {
      const result = { status: "success", data: [] };
      const jsonResult = JSON.stringify(result);
      return ContentService
        .createTextOutput(callback + "(" + jsonResult + ")")
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    const lastRow = videoSheet.getLastRow();
    // æ“´å±•åˆ—ç¯„åœï¼šåŒ…å«å½±ç‰‡é¡å‹ï¼ˆç¬¬9åˆ—ï¼‰
    const dataRange = videoSheet.getRange(2, 4, lastRow - 1, 6);
    const data = dataRange.getValues();
    const videoList = data.map(row => {
      const videoUrl = row[2] || "";
      const videoType = row[5] || getVideoType(videoUrl);
      return {
        id: row[0] || "", 
        name: row[1] || "", 
        video: videoUrl,
        note: row[3] || "", 
        updatedAt: row[4] || "",
        // æ–°å¢å­—æ®µ
        videoType: videoType,
        previewHtml: generatePreviewHtml(videoUrl, videoType),
        previewText: videoType === "youtube" ? "YouTubeå½±ç‰‡" : 
                     videoType === "tencent_meeting" ? "é¨°è¨Šæœƒè­°" : "å¤–éƒ¨é€£çµ"
      };
    }).filter(video => video.id && video.video);
    
    const result = { status: "success", data: videoList };
    const jsonResult = JSON.stringify(result);
    return ContentService
      .createTextOutput(callback + "(" + jsonResult + ")")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } catch (err) {
    throw new Error("ç²å–å½±ç‰‡åˆ—è¡¨å¤±æ•—ï¼š" + err.message);
  }
}

/**
 * ä¿å­˜/æ›´æ–°å½±ç‰‡æ•¸æ“šï¼ˆæ”¯æ´ä»»æ„URLï¼Œå¢åŠ å½±ç‰‡é¡å‹ï¼‰
 * @param {Object} e è«‹æ±‚åƒæ•¸
 * @param {string} callback JSONP å›èª¿å‡½æ•¸å
 * @returns {ContentService} JSONP å›æ‡‰
 */
function handleSaveVideo(e, callback) {
  const videoId = (e.parameter.videoId || "").trim();
  const name = (e.parameter.name || "").trim();
  const videoUrl = (e.parameter.video || "").trim();
  const note = (e.parameter.note || "").trim();
  const updatedAt = (e.parameter.updatedAt || "").trim();
  const userId = (e.parameter.userId || "").trim();
  const operator = (e.parameter.displayName || userId || "æœªçŸ¥ç”¨æˆ¶").trim();
  
  if (!videoId) throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼švideoId å½±ç‰‡å”¯ä¸€IDç‚ºå¿…å¡«");
  if (!name) throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šname å½±ç‰‡åç¨±ç‚ºå¿…å¡«");
  if (!videoUrl) throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼švideo å½±ç‰‡é€£çµç‚ºå¿…å¡«");
  
  try {
    const displayName = sanitizeDisplayName(operator, userId);
    const spreadsheet = SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    let videoSheet = spreadsheet.getSheetByName(CONFIG.VIDEO_SHEET_NAME);
    
    if (!videoSheet) {
      videoSheet = spreadsheet.insertSheet(CONFIG.VIDEO_SHEET_NAME);
      // èª¿æ•´è¡¨å¤´ï¼šå¢åŠ ã€Œå½±ç‰‡é¡å‹ã€åˆ—
      const headers = [
        "ç³»çµ±ä¿å­˜æ™‚é–“", "UserID", "æ“ä½œå“¡åç¨±", "å½±ç‰‡å”¯ä¸€ID", 
        "å½±ç‰‡åç¨±", "å½±ç‰‡é€£çµ", "å½±ç‰‡å‚™è¨»", "å‰ç«¯æœ€å¾Œæ›´æ–°æ™‚é–“", 
        "ç”¨æˆ¶é¡å‹", "ä½¿ç”¨æœŸé™", "åŒæ­¥ç‹€æ…‹", "å½±ç‰‡é¡å‹"
      ];
      const headerRange = videoSheet.getRange(1, 1, 1, headers.length);
      headerRange.setValues([headers])
        .setFontWeight("bold")
        .setBackground("#0066CC")
        .setTextColor("white")
        .setHorizontalAlignment("center")
        .setWrap(true);
      videoSheet.autoResizeColumns(1, headers.length);
    }
    
    const lastRow = videoSheet.getLastRow();
    let isUpdate = false;
    let targetRow = -1;
    
    if (lastRow >= 2) {
      const idRange = videoSheet.getRange(2, 4, lastRow - 1, 1);
      const idData = idRange.getValues();
      for (let i = 0; i < idData.length; i++) {
        if (idData[i][0] === videoId) {
          isUpdate = true;
          targetRow = i + 2;
          break;
        }
      }
    }
    
    // è­˜åˆ¥å½±ç‰‡é¡å‹
    const videoType = getVideoType(videoUrl);
    const saveTime = Utilities.formatDate(new Date(), CONFIG.TIME_ZONE, "yyyy-MM-dd HH:mm:ss");
    
    // èª¿æ•´è¡Œæ•¸æ“šï¼šå¢åŠ å½±ç‰‡é¡å‹
    const row = [
      saveTime, userId || "æœªçŸ¥UserID", displayName, videoId,
      name, videoUrl, note, updatedAt,
      "ç®¡ç†ç”¨æˆ¶", CONFIG.PERMANENT_EXPIRY_DATE,
      isUpdate ? "å·²æ›´æ–°" : "å·²æ–°å¢", videoType
    ];
    
    if (isUpdate) {
      videoSheet.getRange(targetRow, 1, 1, row.length).setValues([row]);
    } else {
      videoSheet.appendRow(row);
    }
    
    videoSheet.autoResizeColumns(1, row.length);
    
    const result = {
      status: "success",
      message: isUpdate ? "å½±ç‰‡æ•¸æ“šæ›´æ–°æˆåŠŸ" : "å½±ç‰‡æ•¸æ“šæ–°å¢æˆåŠŸ",
      videoId: videoId, 
      videoName: name,
      videoType: videoType,
      previewHtml: generatePreviewHtml(videoUrl, videoType)
    };
    
    const jsonResult = JSON.stringify(result);
    return ContentService
      .createTextOutput(callback + "(" + jsonResult + ")")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } catch (err) {
    throw new Error("ä¿å­˜å½±ç‰‡æ•¸æ“šå¤±æ•—ï¼š" + err.message);
  }
}

/**
 * åˆªé™¤å½±ç‰‡æ•¸æ“š
 * @param {Object} e è«‹æ±‚åƒæ•¸
 * @param {string} callback JSONP å›èª¿å‡½æ•¸å
 * @returns {ContentService} JSONP å›æ‡‰
 */
function handleDeleteVideo(e, callback) {
  const videoId = (e.parameter.videoId || "").trim();
  if (!videoId) throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼švideoId å½±ç‰‡å”¯ä¸€IDç‚ºå¿…å¡«");
  
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const videoSheet = spreadsheet.getSheetByName(CONFIG.VIDEO_SHEET_NAME);
    
    if (!videoSheet || videoSheet.getLastRow() < 2) {
      throw new Error("å½±ç‰‡åˆ—è¡¨ç‚ºç©ºï¼Œç„¡éœ€åˆªé™¤");
    }
    
    const lastRow = videoSheet.getLastRow();
    const idRange = videoSheet.getRange(2, 4, lastRow - 1, 1);
    const idData = idRange.getValues();
    let deleteRowIndex = -1;
    
    for (let i = 0; i < idData.length; i++) {
      if (idData[i][0] === videoId) {
        deleteRowIndex = i + 2;
        break;
      }
    }
    
    if (deleteRowIndex === -1) {
      throw new Error("æœªæ‰¾åˆ°è©²å½±ç‰‡IDï¼š" + videoId);
    }
    
    videoSheet.deleteRow(deleteRowIndex);
    
    const result = {
      status: "success", message: "å½±ç‰‡å·²æˆåŠŸåˆªé™¤", videoId: videoId
    };
    
    const jsonResult = JSON.stringify(result);
    return ContentService
      .createTextOutput(callback + "(" + jsonResult + ")")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } catch (err) {
    throw new Error("åˆªé™¤å½±ç‰‡å¤±æ•—ï¼š" + err.message);
  }
}

/**
 * æ›´æ–°å½±ç‰‡æ’åºï¼ˆé€‚é…å‰ç«¯æ‹–æ‹½æ’åºï¼Œæ”¯æ´ä»»æ„URLï¼‰
 * @param {Object} e è«‹æ±‚åƒæ•¸
 * @param {string} callback JSONP å›èª¿å‡½æ•¸å
 * @returns {ContentService} JSONP å›æ‡‰
 */
function handleUpdateVideoOrder(e, callback) {
  const videoIdsStr = e.parameter.videoIds || "";
  if (!videoIdsStr) throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼švideoIds å½±ç‰‡IDåˆ—è¡¨ç‚ºå¿…å¡«");
  
  try {
    const videoIds = JSON.parse(videoIdsStr);
    if (!Array.isArray(videoIds) || videoIds.length === 0) {
      throw new Error("videoIds å¿…é ˆæ˜¯éç©ºæ•¸çµ„æ ¼å¼");
    }
    
    const spreadsheet = SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const videoSheet = spreadsheet.getSheetByName(CONFIG.VIDEO_SHEET_NAME);
    
    if (!videoSheet || videoSheet.getLastRow() < 2) {
      throw new Error("å½±ç‰‡åˆ—è¡¨ç‚ºç©ºï¼Œç„¡éœ€æ›´æ–°æ’åº");
    }
    
    const lastRow = videoSheet.getLastRow();
    const lastCol = videoSheet.getLastColumn();
    const allDataRange = videoSheet.getRange(2, 1, lastRow - 1, lastCol);
    const allData = allDataRange.getValues();
    
    // å½±ç‰‡å”¯ä¸€IDåœ¨ç¬¬4åˆ—ï¼ˆç´¢å¼•3ï¼‰
    const idColumnIndex = 3;
    const sortedData = [];
    
    // å…ˆæŒ‰å‚³å…¥çš„IDé †åºæ’åº
    videoIds.forEach(videoId => {
      for (let i = 0; i < allData.length; i++) {
        if (allData[i][idColumnIndex] === videoId) {
          sortedData.push(allData[i]);
          break;
        }
      }
    });
    
    // è£œå……æœªåœ¨æ’åºåˆ—è¡¨ä¸­çš„æ•¸æ“š
    allData.forEach(row => {
      const rowId = row[idColumnIndex];
      if (!videoIds.includes(rowId)) {
        sortedData.push(row);
      }
    });
    
    // æ¸…ç©ºåŸæœ‰æ•¸æ“šä¸¦å¯«å…¥æ’åºå¾Œçš„æ•¸æ“š
    videoSheet.getRange(2, 1, lastRow - 1, lastCol).clearContent();
    if (sortedData.length > 0) {
      const sortedRange = videoSheet.getRange(2, 1, sortedData.length, sortedData[0].length);
      sortedRange.setValues(sortedData);
    }
    
    const result = {
      status: "success",
      message: `æˆåŠŸæ›´æ–° ${sortedData.length} å€‹å½±ç‰‡çš„æ’åº`,
      sortedCount: sortedData.length
    };
    
    const jsonResult = JSON.stringify(result);
    return ContentService
      .createTextOutput(callback + "(" + jsonResult + ")")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } catch (err) {
    throw new Error("æ›´æ–°å½±ç‰‡æ’åºå¤±æ•—ï¼š" + err.message);
  }
}

/**
 * ä¿ç•™åŸæœ‰è‡ªæª¢è¡¨è™•ç†é‚è¼¯
 * @param {Object} e è«‹æ±‚åƒæ•¸
 * @param {string} callback JSONP å›èª¿å‡½æ•¸å
 * @returns {ContentService} JSONP å›æ‡‰
 */
function handleSubmitChecklist(e, callback) {
  const dataStr = e.parameter.data;
  if (!dataStr || dataStr.trim() === "") throw new Error("ç¼ºå°‘è‡ªæª¢è¡¨æ•¸æ“š");
  
  try {
    const submitData = JSON.parse(dataStr);
    if (!submitData.userId || !submitData.selectedSymptoms || !Array.isArray(submitData.selectedSymptoms)) {
      throw new Error("è‡ªæª¢è¡¨æ•¸æ“šæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘ userId/selectedSymptoms");
    }
    
    submitData.displayName = sanitizeDisplayName(submitData.displayName, submitData.userId);
    console.log(`[æäº¤è‡ªæª¢è¡¨] UserID: ${submitData.userId} | çœŸå¯¦ LINE æš±ç¨±: ${submitData.displayName}`);
    saveChecklistData(submitData);
    
    const result = {
      status: "success", message: "è‡ªæª¢è¡¨æäº¤æˆåŠŸ",
      displayName: submitData.displayName,
      submitTime: Utilities.formatDate(new Date(), CONFIG.TIME_ZONE, "yyyy-MM-dd HH:mm:ss")
    };
    
    const jsonResult = JSON.stringify(result);
    return ContentService
      .createTextOutput(callback + "(" + jsonResult + ")")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } catch (parseErr) {
    throw new Error("è‡ªæª¢è¡¨æ•¸æ“šè§£æå¤±æ•—ï¼š" + parseErr.message + "ï¼ŒåŸå§‹æ•¸æ“šï¼š" + dataStr.substring(0, 100));
  }
}

/**
 * æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹ï¼ˆå€åˆ†ç®¡ç†/å°ˆæ¥­ç”¨æˆ¶ï¼‰
 * @param {string} userId LINE UserID
 * @returns {Object} ç”¨æˆ¶ç‹€æ…‹
 */
function checkUserStatus(userId) {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.USER_CHECK_SPREADSHEET_ID);
    const adminSheet = spreadsheet.getSheetByName(CONFIG.ADMIN_SHEET_NAME);
    
    if (adminSheet) {
      const adminLastRow = adminSheet.getLastRow();
      if (adminLastRow >= 2) {
        const adminIdRange = adminSheet.getRange(2, 1, adminLastRow - 1, 1);
        const adminIds = adminIdRange.getValues().flat();
        if (adminIds.includes(userId)) {
          return {
            isAdmin: true, isPro: false,
            remainingDays: "æ°¸ä¹…æœ‰æ•ˆ",
            expiryDateStr: CONFIG.PERMANENT_EXPIRY_DATE
          };
        }
      }
    }
    
    const proSheet = spreadsheet.getSheetByName(CONFIG.PRO_SHEET_NAME);
    if (!proSheet) {
      console.error(`ã€Œ${CONFIG.PRO_SHEET_NAME}ã€å·¥ä½œè¡¨ä¸å­˜åœ¨`);
      return { isAdmin: false, isPro: false, remainingDays: 0, expiryDateStr: null };
    }
    
    const proLastRow = proSheet.getLastRow();
    if (proLastRow < 2) return { isAdmin: false, isPro: false, remainingDays: 0, expiryDateStr: null };
    
    const proDataRange = proSheet.getRange(2, 1, proLastRow - 1, 3);
    const proData = proDataRange.getValues();
    const userIdStr = userId.toString().trim();
    
    for (let i = 0; i < proData.length; i++) {
      const row = proData[i];
      const proId = row[0] ? row[0].toString().trim() : "";
      const expiryDateVal = row[2];
      
      if (proId === userIdStr) {
        if (!expiryDateVal || expiryDateVal.toString().trim() === "" || 
            expiryDateVal.toString().trim() === "æ°¸ä¹…æœ‰æ•ˆ" || 
            expiryDateVal.toString().trim() === CONFIG.PERMANENT_EXPIRY_DATE) {
          return {
            isAdmin: false, isPro: true,
            remainingDays: "æ°¸ä¹…æœ‰æ•ˆ",
            expiryDateStr: CONFIG.PERMANENT_EXPIRY_DATE
          };
        }
        
        let expiryDate = null;
        if (expiryDateVal instanceof Date) {
          expiryDate = !isNaN(expiryDateVal.getTime()) ? expiryDateVal : null;
        } else if (typeof expiryDateVal === "string") {
          const trimmedDate = expiryDateVal.trim();
          const dateRegex = /^\d{4}[-\/\.]\d{2}[-\/\.]\d{2}$/;
          if (dateRegex.test(trimmedDate)) {
            const normalizedDate = trimmedDate.replace(/-/g, '/').replace(/\./g, '/');
            const [year, month, day] = normalizedDate.split('/').map(Number);
            if (month >= 1 && month <= 12 && day >= 1 && day <= new Date(year, month, 0).getDate()) {
              expiryDate = new Date(year, month - 1, day);
            }
          }
        }
        
        if (!expiryDate || isNaN(expiryDate.getTime())) {
          console.error("ç”¨æˆ¶ " + userId + " çš„åˆ°æœŸæ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼š" + expiryDateVal);
          return { isAdmin: false, isPro: false, remainingDays: 0, expiryDateStr: null };
        }
        
        const expiryDateStr = Utilities.formatDate(expiryDate, CONFIG.TIME_ZONE, "yyyy/MM/dd");
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const expiryDateNormalized = new Date(expiryDate);
        expiryDateNormalized.setHours(0, 0, 0, 0);
        const timeDiff = expiryDateNormalized - today;
        const remainingDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
        
        if (remainingDays < 0) {
          console.log("ç”¨æˆ¶ " + userId + " çš„å°ˆæ¥­è³‡æ ¼å·²éæœŸï¼ˆåˆ°æœŸæ—¥ï¼š" + expiryDateStr + "ï¼‰");
          return { isAdmin: false, isPro: false, remainingDays: 0, expiryDateStr: expiryDateStr };
        }
        
        return {
          isAdmin: false, isPro: true,
          remainingDays: remainingDays,
          expiryDateStr: expiryDateStr
        };
      }
    }
    
    return { isAdmin: false, isPro: false, remainingDays: 0, expiryDateStr: null };
  } catch (err) {
    console.error("æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹å¤±æ•—ï¼š" + err.stack);
    return { isAdmin: false, isPro: false, remainingDays: 0, expiryDateStr: null };
  }
}

/**
 * ä¿å­˜è‡ªæª¢è¡¨æ•¸æ“šï¼ˆä¿ç•™åŸæœ‰é‚è¼¯ï¼‰
 * @param {Object} submitData è‡ªæª¢è¡¨æ•¸æ“š
 */
function saveChecklistData(submitData) {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const sheetName = "è‡ªæª¢è¡¨è¨˜éŒ„";
    let checklistSheet = spreadsheet.getSheetByName(sheetName);
    
    if (!checklistSheet) {
      checklistSheet = spreadsheet.insertSheet(sheetName);
      const headers = ["æäº¤æ™‚é–“","UserID","ç”¨æˆ¶åç¨±","ç—‡ç‹€åºè™Ÿ","ç—‡ç‹€åç¨±","æŒçºŒæ™‚é–“ä»£ç¢¼","æŒçºŒæ™‚é–“èªªæ˜","åš´é‡ç¨‹åº¦ä»£ç¢¼","åš´é‡ç¨‹åº¦èªªæ˜"];
      const headerRange = checklistSheet.getRange(1, 1, 1, headers.length);
      headerRange.setValues([headers])
        .setFontWeight("bold")
        .setBackground("#00B900")
        .setTextColor("white")
        .setHorizontalAlignment("center")
        .setWrap(true);
      checklistSheet.autoResizeColumns(1, headers.length);
    }
    
    const submitTime = submitData.submitTime ? new Date(submitData.submitTime) : new Date();
    const formattedTime = Utilities.formatDate(submitTime, CONFIG.TIME_ZONE, "yyyy-MM-dd HH:mm:ss");
    const rows = [];
    
    submitData.selectedSymptoms.forEach(symptom => {
      rows.push([
        formattedTime,
        submitData.userId || "æœªçŸ¥UserID",
        submitData.displayName,
        symptom.seq || "",
        symptom.symptom || "",
        symptom.duration || "",
        symptom.durationText || "",
        symptom.severity || "",
        symptom.severityText || ""
      ]);
    });
    
    if (rows.length > 0) {
      const lastRow = checklistSheet.getLastRow();
      const dataRange = checklistSheet.getRange(lastRow + 1, 1, rows.length, rows[0].length);
      dataRange.setValues(rows)
        .setHorizontalAlignment("center")
        .setWrap(true)
        .setFontSize(11);
      checklistSheet.autoResizeColumns(1, headers.length);
    }
    
    console.log(`è‡ªæª¢è¡¨æ•¸æ“šä¿å­˜æˆåŠŸï¼šç”¨æˆ¶ ${submitData.displayName} (${submitData.userId})ï¼Œå…± ${rows.length} å€‹ç—‡ç‹€`);
  } catch (err) {
    console.error("ä¿å­˜è‡ªæª¢è¡¨æ•¸æ“šå¤±æ•—ï¼š" + err.stack);
    throw new Error("æ•¸æ“šå­˜å„²å¤±æ•—ï¼š" + err.message);
  }
}

/**
 * è¨˜éŒ„ç”¨æˆ¶è¨ªå•æ—¥å¿—
 * @param {string} userId LINE UserID
 * @param {string} displayName ç”¨æˆ¶åç¨±
 * @param {boolean} isAdmin æ˜¯å¦ç®¡ç†ç”¨æˆ¶
 * @param {string} note å‚™è¨»
 * @param {number|string} remainingDays å‰©é¤˜å¤©æ•¸
 * @param {string} expiryDateStr åˆ°æœŸæ—¥æœŸ
 */
function logAccess(userId, displayName, isAdmin, note, remainingDays, expiryDateStr) {
  try {
    const finalDisplayName = sanitizeDisplayName(displayName, userId);
    console.log(`[è¨˜éŒ„è¨ªå•] UserID: ${userId} | å¯«å…¥å·¥ä½œè¡¨çš„åç¨±: ${finalDisplayName}ï¼ˆåŸå§‹å‚³å…¥ï¼š${displayName || 'æœªå‚³é'}ï¼‰`);
    
    const spreadsheet = SpreadsheetApp.openById(CONFIG.LOG_SPREADSHEET_ID);
    let userLogSheet = spreadsheet.getSheetByName("ç”¨æˆ¶åˆ—è¡¨");
    if (!userLogSheet) userLogSheet = spreadsheet.insertSheet("ç”¨æˆ¶åˆ—è¡¨");
    
    const headerRow = 1;
    const expectedHeader = ["è¨ªå•æ—¥æœŸ", "userId", "é¡¯ç¤ºæš±ç¨±", "ç”¨æˆ¶é¡å‹", "åˆ°æœŸæ—¥æœŸ", "å‚™è¨»", "å‰©é¤˜å¤©æ•¸"];
    const currentHeader = userLogSheet.getRange(headerRow, 1, 1, expectedHeader.length).getValues()[0];
    
    if (!currentHeader || currentHeader.join() !== expectedHeader.join()) {
      userLogSheet.getRange(headerRow, 1, 1, expectedHeader.length).setValues([expectedHeader]);
      userLogSheet.getRange(headerRow, 1, 1, expectedHeader.length)
        .setFontWeight("bold")
        .setBackground("#f0f0f0")
        .setHorizontalAlignment("center")
        .setFontSize(12);
    }
    
    const remainingInfo = (remainingDays === "æ°¸ä¹…æœ‰æ•ˆ") ? "æ°¸ä¹…æœ‰æ•ˆ" : (remainingDays + " å¤©");
    const userType = isAdmin ? "ç®¡ç†ç”¨æˆ¶" : "å°ˆæ¥­ç”¨æˆ¶";
    const expiryDisplay = expiryDateStr || CONFIG.PERMANENT_EXPIRY_DATE;
    
    const logRow = [
      Utilities.formatDate(new Date(), CONFIG.TIME_ZONE, "yyyy-MM-dd HH:mm:ss"),
      userId || "æœªçŸ¥UserID",
      finalDisplayName,
      userType,
      expiryDisplay,
      note || "ç„¡å‚™è¨»",
      remainingInfo
    ];
    
    userLogSheet.appendRow(logRow);
    userLogSheet.autoResizeColumns(1, expectedHeader.length);
    console.log(`ç”¨æˆ¶è¨ªå•è¨˜éŒ„æˆåŠŸï¼š${finalDisplayName} (${userId})ï¼Œç”¨æˆ¶é¡å‹ï¼š${userType}`);
  } catch (err) {
    console.error("è¨˜éŒ„ç”¨æˆ¶è¨ªå•å¤±æ•—ï¼š" + err.stack);
  }
}

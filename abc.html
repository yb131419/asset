const CONFIG={
  ADMIN_SPREADSHEET_ID:"15p3ghuE3rucx_9kBNhLw4u8cJ6HNRkpt_tYRvPmU3XU",
  LOG_SPREADSHEET_ID:"15p3ghuE3rucx_9kBNhLw4u8cJ6HNRkpt_tYRvPmU3XU",
  USER_CHECK_SPREADSHEET_ID:"1MxnhJlr7Q5zdmMxjeoKZ5r7s8DZATRewbneiG3eDRgM",
  TIME_ZONE:"Asia/Taipei",
  PERMANENT_EXPIRY_DATE:"9999/12/31",
  VIDEO_SHEET_NAME:"è¦–é »æ•¸æ“šè¨˜éŒ„",
  FILE_SHEET_NAME:"æ–‡ä»¶æ•¸æ“šè¨˜éŒ„",
  ADMIN_SHEET_NAME:"ç®¡ç†ç”¨æˆ¶",
  PRO_SHEET_NAME:"å°ˆæ¥­ç”¨æˆ¶",
  PREVIEW_CONFIG:{
    YOUTUBE:{embedPrefix:"https://www.youtube.com/embed/",width:560,height:315},
    TENCENT_MEETING:{previewText:"é¨°è¨Šæœƒè­°éˆæ¥",icon:"ğŸ“¹"},
    GENERAL:{previewText:"å¤–éƒ¨éˆæ¥",icon:"ğŸ”—"},
    FILE:{previewText:"é»æ“Šä¸‹è¼‰/æŸ¥çœ‹",icon:"ğŸ“„"}
  }
};

// ä¿®æ­£ï¼šæ”¾å®½æ— æ•ˆåç§°åˆ¤æ–­é€»è¾‘ï¼Œä»…è¿‡æ»¤ç©ºå€¼å’Œçº¯ç©ºç™½
function sanitizeDisplayName(rawName,userId){
  let n=(rawName||"").toString().trim().replace(/[\n\r\t]/g," ").replace(/\s+/g," ");
  // ä»…åˆ¤æ–­æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œä¸å†é™åˆ¶ç‰¹å®šåç§°
  if(n)return n.length>50?n.substring(0,50)+"â€¦":n;
  const s=userId?userId.slice(-6):"æœªçŸ¥ID";
  return `LINEç”¨æˆ¶(${s})`;
}

function getVideoType(url){
  if(!url)return"general";
  const u=url.toLowerCase().trim();
  return u.includes("youtube.com")||u.includes("youtu.be")?"youtube":
         u.includes("meeting.tencent.com")||u.includes("tencent.com")?"tencent_meeting":"general";
}

function getFileType(url){
  if(!url)return"unknown";
  const u=url.toLowerCase().trim();
  if(u.endsWith(".pdf"))return"pdf";
  if(u.endsWith(".doc")||u.endsWith(".docx"))return"word";
  if(u.endsWith(".xls")||u.endsWith(".xlsx"))return"excel";
  if(u.endsWith(".ppt")||u.endsWith(".pptx"))return"ppt";
  return"other";
}

function generateVideoPreviewHtml(url,type){
  if(!url)return"";
  if(type==="youtube"){
    let id="";
    if(url.includes("youtu.be/"))id=url.split("youtu.be/")[1].split("?")[0];
    else if(url.includes("v="))id=url.split("v=")[1].split("&")[0];
    return id?`<iframe width="${CONFIG.PREVIEW_CONFIG.YOUTUBE.width}" height="${CONFIG.PREVIEW_CONFIG.YOUTUBE.height}" src="${CONFIG.PREVIEW_CONFIG.YOUTUBE.embedPrefix}${id}" frameborder="0" allowfullscreen></iframe>`:`<a href="${url}" target="_blank">YouTubeå½±ç‰‡ (é»æ“Šæ‰“é–‹)</a>`;
  }
  return type==="tencent_meeting"?
    `<a href="${url}" target="_blank">${CONFIG.PREVIEW_CONFIG.TENCENT_MEETING.icon} ${CONFIG.PREVIEW_CONFIG.TENCENT_MEETING.previewText} (é»æ“Šæ‰“é–‹)</a>`:
    `<a href="${url}" target="_blank">${CONFIG.PREVIEW_CONFIG.GENERAL.icon} ${CONFIG.PREVIEW_CONFIG.GENERAL.previewText} (é»æ“Šæ‰“é–‹)</a>`;
}

function generateFilePreviewHtml(url,type){
  if(!url)return"";
  const c=CONFIG.PREVIEW_CONFIG.FILE;
  let t="";
  switch(type){
    case"pdf":t="PDFæ–‡ä»¶";break;
    case"word":t="Wordæ–‡ä»¶";break;
    case"excel":t="Excelæ–‡ä»¶";break;
    case"ppt":t="PPTæ–‡ä»¶";break;
    default:t="å…¶ä»–æ–‡ä»¶";break;
  }
  return`<a href="${url}" target="_blank">${c.icon} ${t} ${c.previewText}</a>`;
}

function doGet(e){
  try{
    const cb=e.parameter.callback;
    if(!cb||cb.trim()==="")throw new Error("ç¼ºå°‘ callback åƒæ•¸");
    const a=e.parameter.action||"";
    switch(a){
      case"verifyUser":return handleVerifyUser(e,cb);
      case"getVideoList":return handleGetVideoList(e,cb);
      case"saveVideo":return handleSaveVideo(e,cb);
      case"deleteVideo":return handleDeleteVideo(e,cb);
      case"updateVideoOrder":return handleUpdateVideoOrder(e,cb);
      case"getFileList":return handleGetFileList(e,cb);
      case"saveFile":return handleSaveFile(e,cb);
      case"deleteFile":return handleDeleteFile(e,cb);
      case"updateFileOrder":return handleUpdateFileOrder(e,cb);
      case"submitChecklist":return handleSubmitChecklist(e,cb);
      default:throw new Error("æœªçŸ¥çš„ action åƒæ•¸ï¼š"+a);
    }
  }catch(err){
    const res={
      status:"error",message:err.message||"æœªçŸ¥éŒ¯èª¤",redirectUrl:null,redirect:false,
      remainingDays:undefined,expiryDate:undefined,displayName:undefined,
      isAdmin:false,isPro:false,isAuthorized:false
    };
    return ContentService.createTextOutput((e.parameter.callback||"callback")+"("+JSON.stringify(res)+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
}

function handleVerifyUser(e,cb){
  const uid=(e.parameter.userId||"").trim();
  const rdn=e.parameter.displayName;
  const wts=e.parameter.writeToSheet==="true"||e.parameter.writeToSheet===true;
  const ned=e.parameter.needExpiryDate==="true"||e.parameter.needExpiryDate===true;
  if(!uid)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šuserId ç‚ºå¿…å¡«");
  const dn=sanitizeDisplayName(rdn,uid);
  console.log(`[é©—è­‰ç”¨æˆ¶] UserID: ${uid} | æœ€çµ‚é¡¯ç¤ºåç¨±: ${dn} | åŸå§‹ LINE æš±ç¨±: ${rdn||'æœªå‚³é'}`);
  const us=checkUserStatus(uid);
  const ia=us.isAdmin,ip=us.isPro,iauth=ia||ip;
  if(!iauth)throw new Error("<br><br>é©—è­‰å¤±æ•—<br>ï¼ˆå¯èƒ½åŸå› ï¼šæœªæˆæ¬Šã€ä½¿ç”¨æœŸé™å·²éã€é©—è­‰è¶…æ™‚ï¼‰<br><br>åƒ…ã€å°Šçˆµç”¨æˆ¶ã€å¯è¨ªå•<br><br>è«‹è¯ç¹«å½¥å½¬é–‹é€šã€å°Šçˆµç”¨æˆ¶ã€<br>");
  if(wts)logAccess(uid,dn,ia,ia?"å·²ç¢ºèªç‚ºç®¡ç†ç”¨æˆ¶":"å·²ç¢ºèªç‚ºå°ˆæ¥­ç”¨æˆ¶",us.remainingDays,us.expiryDateStr);
  const res={
    status:"success",userId:uid,displayName:dn,
    isAdmin:ia,isPro:ip,isAuthorized:iauth,
    remainingDays:us.remainingDays==="æ°¸ä¹…æœ‰æ•ˆ"?"æ°¸ä¹…æœ‰æ•ˆ":parseInt(us.remainingDays,10)||0,
    expiryDate:us.expiryDateStr||CONFIG.PERMANENT_EXPIRY_DATE,
    redirectUrl:"https://liff.line.me/2008578880-cOBTYud0",redirect:true
  };
  const json=JSON.stringify(res,(k,v)=>{
    if(v instanceof Date)return Utilities.formatDate(v,CONFIG.TIME_ZONE,"yyyy/MM/dd");
    if(typeof v==="number"&&isNaN(v))return 0;
    return v;
  });
  return ContentService.createTextOutput(cb+"("+json+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
}

function handleGetVideoList(e,cb){
  try{
    const ss=SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const sh=ss.getSheetByName(CONFIG.VIDEO_SHEET_NAME);
    if(!sh||sh.getLastRow()<2){
      return ContentService.createTextOutput(cb+"("+JSON.stringify({status:"success",data:[]})+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    const lr=sh.getLastRow();
    const dt=sh.getRange(2,4,lr-1,9).getValues();
    const vl=dt.map(r=>{
      const u=r[2]||"";
      const t=r[8]||getVideoType(u);
      return{
        id:r[0]||"",name:r[1]||"",video:u,
        note:r[3]||"",updatedAt:r[4]||"",
        videoType:t,
        previewHtml:generateVideoPreviewHtml(u,t),
        previewText:t==="youtube"?"YouTubeå½±ç‰‡":t==="tencent_meeting"?"é¨°è¨Šæœƒè­°":"å¤–éƒ¨é€£çµ"
      };
    }).filter(v=>v.id&&v.video);
    return ContentService.createTextOutput(cb+"("+JSON.stringify({status:"success",data:vl})+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }catch(err){
    throw new Error("ç²å–å½±ç‰‡åˆ—è¡¨å¤±æ•—ï¼š"+err.message);
  }
}

function handleSaveVideo(e,cb){
  const vid=(e.parameter.videoId||"").trim();
  const n=(e.parameter.name||"").trim();
  const u=(e.parameter.video||"").trim();
  const nt=(e.parameter.note||"").trim();
  const ua=(e.parameter.updatedAt||"").trim();
  const uid=(e.parameter.userId||"").trim();
  const op=(e.parameter.displayName||uid||"æœªçŸ¥ç”¨æˆ¶").trim();
  if(!vid)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼švideoId å½±ç‰‡å”¯ä¸€IDç‚ºå¿…å¡«");
  if(!n)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šname å½±ç‰‡åç¨±ç‚ºå¿…å¡«");
  if(!u)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼švideo å½±ç‰‡é€£çµç‚ºå¿…å¡«");
  
  try{
    const dn=sanitizeDisplayName(op,uid);
    const ss=SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    let sh=ss.getSheetByName(CONFIG.VIDEO_SHEET_NAME);
    if(!sh){
      sh=ss.insertSheet(CONFIG.VIDEO_SHEET_NAME);
      const h=["ç³»çµ±ä¿å­˜æ™‚é–“","UserID","æ“ä½œå“¡åç¨±","å½±ç‰‡å”¯ä¸€ID","å½±ç‰‡åç¨±","å½±ç‰‡é€£çµ","å½±ç‰‡å‚™è¨»","å‰ç«¯æœ€å¾Œæ›´æ–°æ™‚é–“","ç”¨æˆ¶é¡å‹","ä½¿ç”¨æœŸé™","åŒæ­¥ç‹€æ…‹","å½±ç‰‡é¡å‹"];
      sh.getRange(1,1,1,h.length).setValues([h]).setFontWeight("bold").setBackground("#0066CC").setTextColor("white").setHorizontalAlignment("center").setWrap(true);
      sh.autoResizeColumns(1,h.length);
    }
    const lr=sh.getLastRow();
    let up=false,tr=-1;
    if(lr>=2){
      const id=sh.getRange(2,4,lr-1,1).getValues();
      for(let i=0;i<id.length;i++){
        if(id[i][0]===vid){up=true;tr=i+2;break;}
      }
    }
    const vt=getVideoType(u);
    const st=Utilities.formatDate(new Date(),CONFIG.TIME_ZONE,"yyyy-MM-dd HH:mm:ss");
    const r=[st,uid||"æœªçŸ¥UserID",dn,vid,n,u,nt,ua,"ç®¡ç†ç”¨æˆ¶",CONFIG.PERMANENT_EXPIRY_DATE,up?"å·²æ›´æ–°":"å·²æ–°å¢",vt];
    if(up)sh.getRange(tr,1,1,r.length).setValues([r]);
    else sh.appendRow(r);
    sh.autoResizeColumns(1,r.length);
    const res={
      status:"success",message:up?"å½±ç‰‡æ•¸æ“šæ›´æ–°æˆåŠŸ":"å½±ç‰‡æ•¸æ“šæ–°å¢æˆåŠŸ",
      videoId:vid,videoName:n,videoType:vt,previewHtml:generateVideoPreviewHtml(u,vt)
    };
    return ContentService.createTextOutput(cb+"("+JSON.stringify(res)+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }catch(err){
    throw new Error("ä¿å­˜å½±ç‰‡æ•¸æ“šå¤±æ•—ï¼š"+err.message);
  }
}

function handleDeleteVideo(e,cb){
  const vid=(e.parameter.videoId||"").trim();
  if(!vid)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼švideoId å½±ç‰‡å”¯ä¸€IDç‚ºå¿…å¡«");
  
  try{
    const ss=SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const sh=ss.getSheetByName(CONFIG.VIDEO_SHEET_NAME);
    if(!sh||sh.getLastRow()<2)throw new Error("å½±ç‰‡åˆ—è¡¨ç‚ºç©ºï¼Œç„¡éœ€åˆªé™¤");
    const lr=sh.getLastRow();
    const id=sh.getRange(2,4,lr-1,1).getValues();
    let dr=-1;
    for(let i=0;i<id.length;i++){
      if(id[i][0]===vid){dr=i+2;break;}
    }
    if(dr===-1)throw new Error("æœªæ‰¾åˆ°è©²å½±ç‰‡IDï¼š"+vid);
    sh.deleteRow(dr);
    return ContentService.createTextOutput(cb+"("+JSON.stringify({status:"success",message:"å½±ç‰‡å·²æˆåŠŸåˆªé™¤",videoId:vid})+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }catch(err){
    throw new Error("åˆªé™¤å½±ç‰‡å¤±æ•—ï¼š"+err.message);
  }
}

function handleUpdateVideoOrder(e,cb){
  const vis=e.parameter.videoIds||"";
  if(!vis)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼švideoIds å½±ç‰‡IDåˆ—è¡¨ç‚ºå¿…å¡«");
  
  try{
    const vi=JSON.parse(vis);
    if(!Array.isArray(vi)||vi.length===0)throw new Error("videoIds å¿…é ˆæ˜¯éç©ºæ•¸çµ„æ ¼å¼");
    const ss=SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const sh=ss.getSheetByName(CONFIG.VIDEO_SHEET_NAME);
    if(!sh||sh.getLastRow()<2)throw new Error("å½±ç‰‡åˆ—è¡¨ç‚ºç©ºï¼Œç„¡éœ€æ›´æ–°æ’åº");
    const lr=sh.getLastRow(),lc=sh.getLastColumn();
    const ad=sh.getRange(2,1,lr-1,lc).getValues();
    const ici=3,sd=[];
    vi.forEach(id=>{
      for(let i=0;i<ad.length;i++){
        if(ad[i][ici]===id){sd.push(ad[i]);break;}
      }
    });
    ad.forEach(r=>{
      const rid=r[ici];
      if(!vi.includes(rid))sd.push(r);
    });
    sh.getRange(2,1,lr-1,lc).clearContent();
    if(sd.length>0)sh.getRange(2,1,sd.length,sd[0].length).setValues(sd);
    return ContentService.createTextOutput(cb+"("+JSON.stringify({
      status:"success",message:`æˆåŠŸæ›´æ–° ${sd.length} å€‹å½±ç‰‡çš„æ’åº`,sortedCount:sd.length
    })+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }catch(err){
    throw new Error("æ›´æ–°å½±ç‰‡æ’åºå¤±æ•—ï¼š"+err.message);
  }
}

function handleGetFileList(e,cb){
  try{
    const ss=SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const sh=ss.getSheetByName(CONFIG.FILE_SHEET_NAME);
    if(!sh||sh.getLastRow()<2){
      return ContentService.createTextOutput(cb+"("+JSON.stringify({status:"success",data:[]})+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    const lr=sh.getLastRow();
    const dt=sh.getRange(2,4,lr-1,9).getValues();
    const fl=dt.map(r=>{
      const u=r[2]||"";
      const t=r[8]||getFileType(u);
      return{
        id:r[0]||"",name:r[1]||"",file:u,
        note:r[3]||"",updatedAt:r[4]||"",
        fileType:t,
        previewHtml:generateFilePreviewHtml(u,t),
        previewText:t==="pdf"?"PDFæ–‡ä»¶":t==="word"?"Wordæ–‡ä»¶":t==="excel"?"Excelæ–‡ä»¶":t==="ppt"?"PPTæ–‡ä»¶":"å…¶ä»–æ–‡ä»¶"
      };
    }).filter(f=>f.id&&f.file);
    return ContentService.createTextOutput(cb+"("+JSON.stringify({status:"success",data:fl})+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }catch(err){
    throw new Error("ç²å–æ–‡ä»¶åˆ—è¡¨å¤±æ•—ï¼š"+err.message);
  }
}

function handleSaveFile(e,cb){
  const fid=(e.parameter.fileId||"").trim();
  const n=(e.parameter.name||"").trim();
  const u=(e.parameter.file||"").trim();
  const nt=(e.parameter.note||"").trim();
  const ua=(e.parameter.updatedAt||"").trim();
  const uid=(e.parameter.userId||"").trim();
  const op=(e.parameter.displayName||uid||"æœªçŸ¥ç”¨æˆ¶").trim();
  if(!fid)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šfileId æ–‡ä»¶å”¯ä¸€IDç‚ºå¿…å¡«");
  if(!n)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šname æ–‡ä»¶åç¨±ç‚ºå¿…å¡«");
  if(!u)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šfile æ–‡ä»¶é€£çµç‚ºå¿…å¡«");
  
  try{
    const dn=sanitizeDisplayName(op,uid);
    const ss=SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    let sh=ss.getSheetByName(CONFIG.FILE_SHEET_NAME);
    if(!sh){
      sh=ss.insertSheet(CONFIG.FILE_SHEET_NAME);
      const h=["ç³»çµ±ä¿å­˜æ™‚é–“","UserID","æ“ä½œå“¡åç¨±","æ–‡ä»¶å”¯ä¸€ID","æ–‡ä»¶åç¨±","æ–‡ä»¶é€£çµ","æ–‡ä»¶å‚™è¨»","å‰ç«¯æœ€å¾Œæ›´æ–°æ™‚é–“","ç”¨æˆ¶é¡å‹","ä½¿ç”¨æœŸé™","åŒæ­¥ç‹€æ…‹","æ–‡ä»¶é¡å‹"];
      sh.getRange(1,1,1,h.length).setValues([h]).setFontWeight("bold").setBackground("#3b82f6").setTextColor("white").setHorizontalAlignment("center").setWrap(true);
      sh.autoResizeColumns(1,h.length);
    }
    const lr=sh.getLastRow();
    let up=false,tr=-1;
    if(lr>=2){
      const id=sh.getRange(2,4,lr-1,1).getValues();
      for(let i=0;i<id.length;i++){
        if(id[i][0]===fid){up=true;tr=i+2;break;}
      }
    }
    const ft=getFileType(u);
    const st=Utilities.formatDate(new Date(),CONFIG.TIME_ZONE,"yyyy-MM-dd HH:mm:ss");
    const r=[st,uid||"æœªçŸ¥UserID",dn,fid,n,u,nt,ua,"ç®¡ç†ç”¨æˆ¶",CONFIG.PERMANENT_EXPIRY_DATE,up?"å·²æ›´æ–°":"å·²æ–°å¢",ft];
    if(up)sh.getRange(tr,1,1,r.length).setValues([r]);
    else sh.appendRow(r);
    sh.autoResizeColumns(1,r.length);
    const res={
      status:"success",message:up?"æ–‡ä»¶æ•¸æ“šæ›´æ–°æˆåŠŸ":"æ–‡ä»¶æ•¸æ“šæ–°å¢æˆåŠŸ",
      fileId:fid,fileName:n,fileType:ft,previewHtml:generateFilePreviewHtml(u,ft)
    };
    return ContentService.createTextOutput(cb+"("+JSON.stringify(res)+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }catch(err){
    throw new Error("ä¿å­˜æ–‡ä»¶æ•¸æ“šå¤±æ•—ï¼š"+err.message);
  }
}

function handleDeleteFile(e,cb){
  const fid=(e.parameter.fileId||"").trim();
  if(!fid)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šfileId æ–‡ä»¶å”¯ä¸€IDç‚ºå¿…å¡«");
  
  try{
    const ss=SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const sh=ss.getSheetByName(CONFIG.FILE_SHEET_NAME);
    if(!sh||sh.getLastRow()<2)throw new Error("æ–‡ä»¶åˆ—è¡¨ç‚ºç©ºï¼Œç„¡éœ€åˆªé™¤");
    const lr=sh.getLastRow();
    const id=sh.getRange(2,4,lr-1,1).getValues();
    let dr=-1;
    for(let i=0;i<id.length;i++){
      if(id[i][0]===fid){dr=i+2;break;}
    }
    if(dr===-1)throw new Error("æœªæ‰¾åˆ°è©²æ–‡ä»¶IDï¼š"+fid);
    sh.deleteRow(dr);
    return ContentService.createTextOutput(cb+"("+JSON.stringify({status:"success",message:"æ–‡ä»¶å·²æˆåŠŸåˆªé™¤",fileId:fid})+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }catch(err){
    throw new Error("åˆªé™¤æ–‡ä»¶å¤±æ•—ï¼š"+err.message);
  }
}

function handleUpdateFileOrder(e,cb){
  const fis=e.parameter.fileIds||"";
  if(!fis)throw new Error("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šfileIds æ–‡ä»¶IDåˆ—è¡¨ç‚ºå¿…å¡«");
  
  try{
    const fi=JSON.parse(fis);
    if(!Array.isArray(fi)||fi.length===0)throw new Error("fileIds å¿…é ˆæ˜¯éç©ºæ•¸çµ„æ ¼å¼");
    const ss=SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const sh=ss.getSheetByName(CONFIG.FILE_SHEET_NAME);
    if(!sh||sh.getLastRow()<2)throw new Error("æ–‡ä»¶åˆ—è¡¨ç‚ºç©ºï¼Œç„¡éœ€æ›´æ–°æ’åº");
    const lr=sh.getLastRow(),lc=sh.getLastColumn();
    const ad=sh.getRange(2,1,lr-1,lc).getValues();
    const ici=3,sd=[];
    fi.forEach(id=>{
      for(let i=0;i<ad.length;i++){
        if(ad[i][ici]===id){sd.push(ad[i]);break;}
      }
    });
    ad.forEach(r=>{
      const rid=r[ici];
      if(!fi.includes(rid))sd.push(r);
    });
    sh.getRange(2,1,lr-1,lc).clearContent();
    if(sd.length>0)sh.getRange(2,1,sd.length,sd[0].length).setValues(sd);
    return ContentService.createTextOutput(cb+"("+JSON.stringify({
      status:"success",message:`æˆåŠŸæ›´æ–° ${sd.length} å€‹æ–‡ä»¶çš„æ’åº`,sortedCount:sd.length
    })+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }catch(err){
    throw new Error("æ›´æ–°æ–‡ä»¶æ’åºå¤±æ•—ï¼š"+err.message);
  }
}

function handleSubmitChecklist(e,cb){
  const ds=e.parameter.data;
  if(!ds||ds.trim()==="")throw new Error("ç¼ºå°‘è‡ªæª¢è¡¨æ•¸æ“š");
  
  try{
    const sd=JSON.parse(ds);
    if(!sd.userId||!sd.selectedSymptoms||!Array.isArray(sd.selectedSymptoms))throw new Error("è‡ªæª¢è¡¨æ•¸æ“šæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘ userId/selectedSymptoms");
    sd.displayName=sanitizeDisplayName(sd.displayName,sd.userId);
    console.log(`[æäº¤è‡ªæª¢è¡¨] UserID: ${sd.userId} | çœŸå¯¦ LINE æš±ç¨±: ${sd.displayName}`);
    saveChecklistData(sd);
    const res={
      status:"success",message:"è‡ªæª¢è¡¨æäº¤æˆåŠŸ",
      displayName:sd.displayName,
      submitTime:Utilities.formatDate(new Date(),CONFIG.TIME_ZONE,"yyyy-MM-dd HH:mm:ss")
    };
    return ContentService.createTextOutput(cb+"("+JSON.stringify(res)+")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }catch(err){
    throw new Error("è‡ªæª¢è¡¨æ•¸æ“šè§£æå¤±æ•—ï¼š"+err.message+"ï¼ŒåŸå§‹æ•¸æ“šï¼š"+ds.substring(0,100));
  }
}

function checkUserStatus(userId){
  try{
    const ss=SpreadsheetApp.openById(CONFIG.USER_CHECK_SPREADSHEET_ID);
    const ash=ss.getSheetByName(CONFIG.ADMIN_SHEET_NAME);
    if(ash&&ash.getLastRow()>=2){
      const aid=ash.getRange(2,1,ash.getLastRow()-1,1).getValues().flat();
      if(aid.includes(userId)){
        return{isAdmin:true,isPro:false,remainingDays:"æ°¸ä¹…æœ‰æ•ˆ",expiryDateStr:CONFIG.PERMANENT_EXPIRY_DATE};
      }
    }
    const psh=ss.getSheetByName(CONFIG.PRO_SHEET_NAME);
    if(!psh){
      console.error(`ã€Œ${CONFIG.PRO_SHEET_NAME}ã€å·¥ä½œè¡¨ä¸å­˜åœ¨`);
      return{isAdmin:false,isPro:false,remainingDays:0,expiryDateStr:null};
    }
    const plr=psh.getLastRow();
    if(plr<2)return{isAdmin:false,isPro:false,remainingDays:0,expiryDateStr:null};
    const pd=psh.getRange(2,1,plr-1,3).getValues();
    const uids=userId.toString().trim();
    for(let i=0;i<pd.length;i++){
      const r=pd[i];
      const pid=r[0]?r[0].toString().trim():"";
      const edv=r[2];
      if(pid===uids){
        if(!edv||edv.toString().trim()===""||edv.toString().trim()==="æ°¸ä¹…æœ‰æ•ˆ"||edv.toString().trim()===CONFIG.PERMANENT_EXPIRY_DATE){
          return{isAdmin:false,isPro:true,remainingDays:"æ°¸ä¹…æœ‰æ•ˆ",expiryDateStr:CONFIG.PERMANENT_EXPIRY_DATE};
        }
        let ed=null;
        if(edv instanceof Date)ed=!isNaN(edv.getTime())?edv:null;
        else if(typeof edv==="string"){
          const td=edv.trim();
          const rx=/^\d{4}[-\/\.]\d{2}[-\/\.]\d{2}$/;
          if(rx.test(td)){
            const nd=td.replace(/-/g,"/").replace(/\./g,"/");
            const [y,m,d]=nd.split("/").map(Number);
            if(m>=1&&m<=12&&d>=1&&d<=new Date(y,m,0).getDate())ed=new Date(y,m-1,d);
          }
        }
        if(!ed||isNaN(ed.getTime())){
          console.error("ç”¨æˆ¶ "+userId+" çš„åˆ°æœŸæ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼š"+edv);
          return{isAdmin:false,isPro:false,remainingDays:0,expiryDateStr:null};
        }
        const eds=Utilities.formatDate(ed,CONFIG.TIME_ZONE,"yyyy/MM/dd");
        const td=new Date();td.setHours(0,0,0,0);
        const edn=new Date(ed);edn.setHours(0,0,0,0);
        const tdiff=edn-td;
        const rd=Math.ceil(tdiff/(1000*60*60*24));
        if(rd<0){
          console.log("ç”¨æˆ¶ "+userId+" çš„å°ˆæ¥­è³‡æ ¼å·²éæœŸï¼ˆåˆ°æœŸæ—¥ï¼š"+eds+"ï¼‰");
          return{isAdmin:false,isPro:false,remainingDays:0,expiryDateStr:eds};
        }
        return{isAdmin:false,isPro:true,remainingDays:rd,expiryDateStr:eds};
      }
    }
    return{isAdmin:false,isPro:false,remainingDays:0,expiryDateStr:null};
  }catch(err){
    console.error("æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹å¤±æ•—ï¼š"+err.stack);
    return{isAdmin:false,isPro:false,remainingDays:0,expiryDateStr:null};
  }
}

function saveChecklistData(submitData){
  try{
    const ss=SpreadsheetApp.openById(CONFIG.ADMIN_SPREADSHEET_ID);
    const sn="è‡ªæª¢è¡¨è¨˜éŒ„";
    let sh=ss.getSheetByName(sn);
    if(!sh){
      sh=ss.insertSheet(sn);
      const h=["æäº¤æ™‚é–“","UserID","ç”¨æˆ¶åç¨±","ç—‡ç‹€åºè™Ÿ","ç—‡ç‹€åç¨±","æŒçºŒæ™‚é–“ä»£ç¢¼","æŒçºŒæ™‚é–“èªªæ˜","åš´é‡ç¨‹åº¦ä»£ç¢¼","åš´é‡ç¨‹åº¦èªªæ˜"];
      sh.getRange(1,1,1,h.length).setValues([h]).setFontWeight("bold").setBackground("#00B900").setTextColor("white").setHorizontalAlignment("center").setWrap(true);
      sh.autoResizeColumns(1,h.length);
    }
    const st=submitData.submitTime?new Date(submitData.submitTime):new Date();
    const ft=Utilities.formatDate(st,CONFIG.TIME_ZONE,"yyyy-MM-dd HH:mm:ss");
    const r=[];
    submitData.selectedSymptoms.forEach(s=>{
      r.push([ft,submitData.userId||"æœªçŸ¥UserID",submitData.displayName,s.seq||"",s.symptom||"",s.duration||"",s.durationText||"",s.severity||"",s.severityText||""]);
    });
    if(r.length>0){
      const lr=sh.getLastRow();
      sh.getRange(lr+1,1,r.length,r[0].length).setValues(r).setHorizontalAlignment("center").setWrap(true).setFontSize(11);
      sh.autoResizeColumns(1,h.length);
    }
    console.log(`è‡ªæª¢è¡¨æ•¸æ“šä¿å­˜æˆåŠŸï¼šç”¨æˆ¶ ${submitData.displayName} (${submitData.userId})ï¼Œå…± ${r.length} å€‹ç—‡ç‹€`);
  }catch(err){
    console.error("ä¿å­˜è‡ªæª¢è¡¨æ•¸æ“šå¤±æ•—ï¼š"+err.stack);
    throw new Error("æ•¸æ“šå­˜å„²å¤±æ•—ï¼š"+err.message);
  }
}

function logAccess(userId,displayName,isAdmin,note,remainingDays,expiryDateStr){
  try{
    const fdn=sanitizeDisplayName(displayName,userId);
    console.log(`[è¨˜éŒ„è¨ªå•] UserID: ${userId} | å¯«å…¥å·¥ä½œè¡¨çš„åç¨±: ${fdn}ï¼ˆåŸå§‹å‚³å…¥ï¼š${displayName||'æœªå‚³é'}ï¼‰`);
    const ss=SpreadsheetApp.openById(CONFIG.LOG_SPREADSHEET_ID);
    let sh=ss.getSheetByName("ç”¨æˆ¶åˆ—è¡¨");
    if(!sh)sh=ss.insertSheet("ç”¨æˆ¶åˆ—è¡¨");
    
    const hr=1;
    const eh=["è¨ªå•æ—¥æœŸ","userId","é¡¯ç¤ºæš±ç¨±","ç”¨æˆ¶é¡å‹","åˆ°æœŸæ—¥æœŸ","å‚™è¨»","å‰©é¤˜å¤©æ•¸"];
    const ch=sh.getRange(hr,1,1,eh.length).getValues()[0];
    if(!ch||ch.join()!==eh.join()){
      sh.getRange(hr,1,1,eh.length).setValues([eh]).setFontWeight("bold").setBackground("#f0f0f0").setHorizontalAlignment("center").setFontSize(12);
    }

    const ri=remainingDays==="æ°¸ä¹…æœ‰æ•ˆ"?"æ°¸ä¹…æœ‰æ•ˆ":(remainingDays+" å¤©");
    const ut=isAdmin?"ç®¡ç†ç”¨æˆ¶":"å°ˆæ¥­ç”¨æˆ¶";
    const ed=expiryDateStr||CONFIG.PERMANENT_EXPIRY_DATE;
    const lr=[Utilities.formatDate(new Date(),CONFIG.TIME_ZONE,"yyyy-MM-dd HH:mm:ss"),userId||"æœªçŸ¥UserID",fdn,ut,ed,note||"ç„¡å‚™è¨»",ri];

    const lr_=sh.getLastRow();
    let tr=-1;
    if(lr_>hr){
      const ud=sh.getRange(hr+1,2,lr_-hr,1).getValues().flat();
      for(let i=0;i<ud.length;i++){
        if(ud[i]===userId){tr=hr+1+i;break;}
      }
    }

    if(tr>-1)sh.getRange(tr,1,1,lr.length).setValues([lr]);
    else sh.appendRow(lr);
    sh.autoResizeColumns(1,eh.length);
    console.log(`ç”¨æˆ¶è¨ªå•è¨˜éŒ„æˆåŠŸï¼š${fdn} (${userId})ï¼Œç”¨æˆ¶é¡å‹ï¼š${ut}`);
  }catch(err){
    console.error("è¨˜éŒ„ç”¨æˆ¶è¨ªå•å¤±æ•—ï¼š"+err.stack);
  }
}

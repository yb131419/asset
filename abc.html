<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<title>ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0"/>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
tailwind.config={
  theme:{
    extend:{
      colors:{
        primary:'#008C76',
        secondary:'#E8F9F7',
        accent:'#FFD700',
        dark:'#1A202C',
        lightBg:'#F9FAFB',
        neutral:'#F3F4F6',
        cardBg:'#FFFFFF',
        textPrimary:'#1E293B',
        textSecondary:'#64748B'
      },
      fontFamily:{
        sans:['Noto Sans TC','sans-serif','system-ui'],
        display:['Noto Sans TC','sans-serif','system-ui']
      },
      boxShadow:{
        'elevation-1':'0 2px 8px rgba(0,0,0,0.06)',
        'elevation-2':'0 4px 16px rgba(0,0,0,0.08)',
        'elevation-3':'0 8px 24px rgba(0,0,0,0.12)'
      }
    }
  }
};
</script>
<style type="text/tailwindcss">
@layer utilities{
  .fade-in{animation:fadeIn 0.6s cubic-bezier(0.4,0,0.2,1);}
  .pulse-subtle{animation:pulseSubtle 2s infinite;}
  .gradient-text{background-clip:text;-webkit-background-clip:text;color:transparent;}
  .slide-in{animation:slideIn 0.4s cubic-bezier(0.4,0,0.2,1);}
  .scale-in{animation:scaleIn 0.3s cubic-bezier(0.4,0,0.2,1);}
  .slide-up{animation:slideUp 0.3s ease-out;}
}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes pulseSubtle{0%,100%{opacity:1;}50%{opacity:0.8;}}
@keyframes slideIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes scaleIn{from{transform:scale(0.95);opacity:0;}to{transform:scale(1);opacity:1;}}
@keyframes slideUp{from{transform:translateY(10px);opacity:0;}to{transform:translateY(0);opacity:1;}}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:#F1F5F9;border-radius:3px;}
::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:#94A3B8;}
body{font-feature-settings:"palt";letter-spacing:0.02em;}
.video-container{
  position:relative;
  padding-bottom:56.25%;
  height:0;
  overflow:hidden;
  border-radius:8px;
  background-color:#0F172A;
  min-height:280px;
}
.video-item{transition:all 0.2s ease;cursor:grab;}
.video-item:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.08);}
.video-item.dragging{opacity:0.5;border:2px dashed #008C76;cursor:grabbing;}
.video-item.pro-user{cursor:pointer;}
.video-item.pro-user:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.08);}
.drop-zone{border:2px dashed #008C76 !important;background-color:#E8F9F7 !important;}
.thumbnail-container{width:80px;height:50px;border-radius:4px;overflow:hidden;background:#f1f1f1;flex-shrink:0;}
.thumbnail-img{width:100%;height:100%;object-fit:cover;}
.viewer-card{transition:all 0.3s ease;}
.viewer-card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.watch-btn{padding:8px 16px !important;font-size:14px !important;font-weight:600 !important;border-radius:8px !important;}
.mobile-btn{min-height:48px !important;padding:12px 20px !important;font-size:16px !important;border-radius:10px !important;}
.mobile-btn-sm{min-height:40px !important;padding:8px 16px !important;font-size:15px !important;border-radius:8px !important;}
.video-container iframe{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  border:0;
  opacity:0;
  transition:opacity 0.3s ease;
}
.video-container iframe.loaded{opacity:1;}
.btn-disabled{opacity:0.7;cursor:not-allowed;pointer-events:none;}
</style>
</head>
<body class="bg-lightBg min-h-screen flex flex-col p-2 md:p-4">
<div class="max-w-5xl w-full bg-cardBg rounded-xl shadow-elevation-2 overflow-hidden fade-in self-center">
  <div class="bg-gradient-to-r from-primary to-[#006658] p-4 md:p-6 text-white text-center relative overflow-hidden">
    <div class="absolute top-0 left-0 w-24 h-24 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/3"></div>
    <div class="absolute bottom-0 right-0 w-32 h-32 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3"></div>
    <div class="relative z-10">
      <div class="inline-flex items-center justify-center w-12 h-12 bg-white/10 backdrop-blur-sm rounded-full mb-2 pulse-subtle">
        <i class="fa fa-film text-2xl text-accent"></i>
      </div>
      <h1 class="text-2xl md:text-3xl font-bold mb-1 tracking-wide"> ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </h1>
      <p class="text-white/90 text-sm md:text-base font-light">å½¥å½¬ å¹¸ç¦ç³»çµ±</p>
    </div>
  </div>
  <div class="p-3 md:p-5">
    <div id="status" class="flex items-center justify-center py-6 text-textPrimary text-center">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-2"></div>
        <p id="status-text" class="text-base">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±ï¼Œè«‹ç¨å€™...</p>
      </div>
    </div>
    <div id="error-message" class="hidden bg-red-50 border border-red-100 text-red-700 px-4 py-3 rounded-lg mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-exclamation-circle text-red-500 mt-1 mr-2 text-lg"></i>
        <div id="error-content" class="text-sm"></div>
      </div>
    </div>
    <div id="success-message" class="hidden bg-green-50 border border-green-100 text-green-700 px-4 py-3 rounded-lg mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-check-circle text-green-500 mt-1 mr-2 text-lg"></i>
        <div id="success-content" class="text-sm"></div>
      </div>
    </div>
    <div id="result-card" class="hidden bg-gradient-to-r from-secondary to-[#F0FAF8] border border-primary/15 rounded-xl p-4 mb-4 text-center fade-in relative overflow-hidden">
      <div class="absolute top-0 right-0 w-16 h-16 bg-primary/5 rounded-full translate-x-1/2 -translate-y-1/2"></div>
      <div class="relative z-10">
        <div id="result-main" class="text-lg md:text-xl font-bold mb-2 text-textPrimary"></div>
        <div id="result-details" class="text-sm text-textSecondary space-y-1 md:space-y-1.5"></div>
        <div id="content-count-display" class="mt-2 text-sm font-medium text-primary">
          <i class="fa fa-play-circle mr-1"></i> å½±ç‰‡æ•¸ï¼š<span id="video-count-num">0</span> | 
          <i class="fa fa-file mr-1"></i> æ–‡ä»¶æ•¸ï¼š<span id="file-count-num">0</span>
        </div>
        <div class="w-20 h-0.5 bg-primary/20 mx-auto my-2"></div>
      </div>
    </div>
    <div id="video-viewer-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å½±ç‰‡åˆ—è¡¨
        </h2>
        <div id="manage-video-btn-container" class="flex gap-2 hidden">
          <button onclick="toggleVideoListSection()" class="mobile-btn-sm bg-primary hover:bg-[#007A69] text-white text-sm font-medium px-4 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center gap-1">
            <i class="fa fa-cog text-sm"></i> å½±ç‰‡ç®¡ç†
          </button>
        </div>
      </div>
      <div id="viewer-video-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-2"></div>
      <div id="viewer-empty-video-list" class="py-8 text-center text-textSecondary hidden">
        <i class="fa fa-film text-3xl mb-3 text-gray-300"></i>
        <p class="text-base">æš«ç„¡å¯æŸ¥çœ‹çš„å½±ç‰‡</p>
        <p class="text-xs mt-1 text-textSecondary/70">è«‹è¯ç¹«ç®¡ç†å“¡æ·»åŠ å½±ç‰‡</p>
      </div>
    </div>
    <div id="file-viewer-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-file text-primary mr-2 text-sm"></i> æ–‡ä»¶åˆ—è¡¨
        </h2>
        <div id="manage-file-btn-container" class="flex gap-2 hidden">
          <button onclick="toggleFileListSection()" class="mobile-btn-sm bg-primary hover:bg-[#007A69] text-white text-sm font-medium px-4 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center gap-1">
            <i class="fa fa-cog text-sm"></i> æ–‡ä»¶ç®¡ç†
          </button>
        </div>
      </div>
      <div id="viewer-file-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-2"></div>
      <div id="viewer-empty-file-list" class="py-8 text-center text-textSecondary hidden">
        <i class="fa fa-file text-3xl mb-3 text-gray-300"></i>
        <p class="text-base">æš«ç„¡å¯æŸ¥çœ‹çš„æ–‡ä»¶</p>
        <p class="text-xs mt-1 text-textSecondary/70">è«‹è¯ç¹«ç®¡ç†å“¡æ·»åŠ æ–‡ä»¶</p>
      </div>
    </div>
    <div id="video-list-section" class="bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100 hidden">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-th-list text-primary mr-2 text-sm"></i> å½±ç‰‡ç®¡ç†åˆ—è¡¨
        </h2>
        <div id="add-video-btn-container" class="flex gap-2 w-full md:w-auto">
          <button onclick="addNewVideo()" class="mobile-btn bg-primary hover:bg-[#007A69] text-white text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-plus text-lg"></i> æ–°å¢å½±ç‰‡
          </button>
          <button onclick="toggleVideoListSection()" class="mobile-btn bg-gray-200 hover:bg-gray-300 text-textPrimary text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-lg"></i> è¿”å›
          </button>
        </div>
      </div>
      <div id="video-list-container" class="space-y-2.5 mb-2"></div>
      <div id="empty-video-list" class="py-5 text-center text-textSecondary hidden">
        <i class="fa fa-film text-2xl mb-2 text-gray-300"></i>
        <p class="text-sm">å°šæœªæ·»åŠ ä»»ä½•å½±ç‰‡</p>
        <p id="empty-video-tip" class="text-xs mt-1">é»æ“Šã€Œæ–°å¢å½±ç‰‡ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ </p>
      </div>
    </div>
    <div id="file-list-section" class="bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100 hidden">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-th-list text-primary mr-2 text-sm"></i> æ–‡ä»¶ç®¡ç†åˆ—è¡¨
        </h2>
        <div id="add-file-btn-container" class="flex gap-2 w-full md:w-auto">
          <button onclick="addNewFile()" class="mobile-btn bg-primary hover:bg-[#007A69] text-white text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-plus text-lg"></i> æ–°å¢æ–‡ä»¶
          </button>
          <button onclick="toggleFileListSection()" class="mobile-btn bg-gray-200 hover:bg-gray-300 text-textPrimary text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-lg"></i> è¿”å›
          </button>
        </div>
      </div>
      <div id="file-list-container" class="space-y-2.5 mb-2"></div>
      <div id="empty-file-list" class="py-5 text-center text-textSecondary hidden">
        <i class="fa fa-file text-2xl mb-2 text-gray-300"></i>
        <p class="text-sm">å°šæœªæ·»åŠ ä»»ä½•æ–‡ä»¶</p>
        <p id="empty-file-tip" class="text-xs mt-1">é»æ“Šã€Œæ–°å¢æ–‡ä»¶ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ </p>
      </div>
    </div>
    <div id="video-edit-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 id="video-edit-title" class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢å½±ç‰‡
        </h2>
        <button onclick="hideVideoEditSection()" class="text-textSecondary hover:text-textPrimary transition-colors p-2 rounded-full hover:bg-gray-100">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="video-form" onsubmit="saveVideo(event)">
        <input type="hidden" id="video-id" value="">
        <div class="space-y-3">
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> å½±ç‰‡åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="video-name" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm" placeholder="è«‹è¼¸å…¥å½±ç‰‡åç¨±" required>
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-link text-primary mr-2 text-xs"></i> è¦–é »éˆæ¥ <span class="text-red-500">*</span>
            </label>
            <input type="url" id="video-url" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm" placeholder="è«‹è¼¸å…¥YouTubeã€é¨°è¨Šè¦–é »ã€é¨°è¨Šæœƒè­°ã€Spotifyæˆ–Podcastæœ‰æ•ˆç¶²å€" required>
            <p class="text-xs text-textSecondary mt-1">
              <i class="fa fa-lightbulb-o text-accent mr-1"></i> æ”¯æ´YouTubeæ™®é€šå½±ç‰‡/Shortsã€é¨°è¨Šè¦–é »ã€é¨°è¨Šæœƒè­°ã€Spotify(éŸ³æ¨‚/æ’­å®¢)åŠPodcastéˆæ¥
            </p>
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="video-note" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-1 flex gap-2">
            <button type="button" onclick="hideVideoEditSection()" class="mobile-btn-sm w-1/3 bg-gray-200 hover:bg-gray-300 text-textPrimary font-medium px-3 py-2 rounded-lg transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="video-save-btn" class="mobile-btn-sm w-2/3 bg-primary hover:bg-[#007A69] text-white font-medium px-3 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="video-save-btn-text">å„²å­˜å½±ç‰‡</span>
              <div id="video-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    <div id="file-edit-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 id="file-edit-title" class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢æ–‡ä»¶
        </h2>
        <button onclick="hideFileEditSection()" class="text-textSecondary hover:text-textPrimary transition-colors p-2 rounded-full hover:bg-gray-100">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="file-form" onsubmit="saveFile(event)">
        <input type="hidden" id="file-id" value="">
        <div class="space-y-3">
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> æ–‡ä»¶åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="file-name" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm" placeholder="è«‹è¼¸å…¥æ–‡ä»¶åç¨±" required>
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-link text-primary mr-2 text-xs"></i> æ–‡ä»¶éˆæ¥ <span class="text-red-500">*</span>
            </label>
            <input type="url" id="file-url" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm" placeholder="è«‹è¼¸å…¥æ–‡ä»¶æˆ–é¨°è¨Šæœƒè­°æœ‰æ•ˆç¶²å€" required>
            <p class="text-xs text-textSecondary mt-1">
              <i class="fa fa-lightbulb-o text-accent mr-1"></i> æ”¯æ´PDFã€Wordã€Excelç­‰å„é¡æ–‡ä»¶åŠé¨°è¨Šæœƒè­°å•†æ¥­å°ˆå±¬éˆæ¥
            </p>
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="file-note" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-1 flex gap-2">
            <button type="button" onclick="hideFileEditSection()" class="mobile-btn-sm w-1/3 bg-gray-200 hover:bg-gray-300 text-textPrimary font-medium px-3 py-2 rounded-lg transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="file-save-btn" class="mobile-btn-sm w-2/3 bg-primary hover:bg-[#007A69] text-white font-medium px-3 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="file-save-btn-text">å„²å­˜æ–‡ä»¶</span>
              <div id="file-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    <div id="content-preview" class="hidden bg-cardBg rounded-xl p-2 md:p-4 mb-4 scale-in border border-primary/20 shadow-elevation-1">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å…§å®¹é è¦½
        </h2>
        <div id="preview-action-btns" class="flex gap-1 hidden">
          <button id="preview-edit-btn" onclick="editCurrentContent()" class="mobile-btn-sm text-primary hover:text-[#007A69] text-sm font-medium flex items-center gap-1 bg-primary/5 px-3 py-2 rounded-lg">
            <i class="fa fa-pencil text-sm"></i> ç·¨è¼¯
          </button>
          <button id="preview-delete-btn" onclick="event.stopPropagation();deleteCurrentContent()" class="mobile-btn-sm text-red-500 hover:text-red-600 text-sm font-medium flex items-center gap-1 bg-red-50 px-3 py-2 rounded-lg">
            <i class="fa fa-trash text-sm"></i> åˆªé™¤
          </button>
          <button onclick="hideContentPreview()" class="text-textSecondary hover:text-textPrimary transition-colors p-2 rounded-full hover:bg-gray-100">
            <i class="fa fa-times-circle text-lg"></i>
          </button>
        </div>
      </div>
      <div id="preview-content" class="space-y-3">
        <h3 id="preview-title" class="text-sm md:text-base font-medium text-textPrimary text-center mb-2"></h3>
        <div id="preview-container" class="mb-3">
          <div id="video-container" class="video-container mb-3 flex items-center justify-center hidden">
            <div id="video-loading" class="absolute text-white/70">
              <i class="fa fa-spinner animate-spin text-xl mb-1"></i>
              <p class="text-xs">è¼‰å…¥å…§å®¹ä¸­...</p>
            </div>
            <iframe id="preview-video" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" onload="this.classList.add('loaded'); const el = document.getElementById('video-loading'); if(el) el.classList.add('hidden');"></iframe>
          </div>
          <div id="unsupported-tip" class="py-8 text-center text-textSecondary hidden">
            <i class="fa fa-exclamation-triangle text-3xl mb-3 text-orange-500"></i>
            <p class="text-base">ä¸æ”¯æ´çš„å…§å®¹é¡å‹</p>
            <p class="text-xs mt-1 text-textSecondary/70">åƒ…æ”¯æ´YouTubeã€é¨°è¨Šè¦–é »ã€SpotifyåµŒå…¥é è¦½ï¼Œå…¶ä»–è«‹é»æ“Šéˆæ¥é€²å…¥</p>
          </div>
          <div id="file-preview-tip" class="py-8 text-center text-textSecondary hidden">
            <i class="fa fa-file text-3xl mb-3 text-blue-500"></i>
            <p class="text-base" id="file-preview-name"></p>
            <p class="text-xs mt-1 text-textSecondary/70">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥çœ‹å…§å®¹</p>
            <a id="file-preview-btn" href="" target="_blank" class="mt-3 inline-block bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
              <i class="fa fa-external-link mr-1"></i> æŸ¥çœ‹å…§å®¹
            </a>
          </div>
        </div>
        <div class="bg-neutral rounded-lg p-3 text-xs md:text-sm text-textSecondary">
          <div class="grid grid-cols-1 gap-2 mb-2">
            <div>
              <span class="font-medium text-textPrimary text-xs md:text-sm"><i class="fa fa-clock-o text-primary mr-1.5 text-xs"></i> æœ€å¾Œæ›´æ–°ï¼š</span>
              <p id="preview-updated" class="mt-1 text-xs md:text-sm"></p>
            </div>
            <div>
              <span class="font-medium text-textPrimary text-xs md:text-sm"><i class="fa fa-sticky-note text-primary mr-1.5 text-xs"></i> å‚™æ³¨ï¼š</span>
              <p id="preview-note" class="mt-1 text-xs md:text-sm">- ç„¡å‚™æ³¨ -</p>
            </div>
          </div>
        </div>
        <div class="flex justify-center mt-2">
          <button onclick="hideContentPreview()" class="mobile-btn bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium px-6 py-3 rounded-lg flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-sm"></i> è¿”å›åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// é…ç½®å¸¸é‡
const CONFIG={
  LIFF_ID:"2008578880-cOBTYud0",
  GAS_URL:"https://script.google.com/macros/s/AKfycbyZMHC4c3QRgBnjFX3-4S1wI8-9x1519SQwwwxom8oDRupOpysz0SOlU4jO40frncXoIg/exec",
  JSONP_TIMEOUT:6000,
  PERMANENT_EXPIRY_DATE:"9999/12/31",
  STORAGE_KEY_PREFIX:"yanbin_video_manager_"
};

// æ‡‰ç”¨ç‹€æ…‹
let appState={
  currentUser:null,videoList:[],fileList:[],currentViewingId:null,
  currentViewingType:null,currentEditingVideoId:null,currentEditingFileId:null,
  isSubmitting:false,draggingItem:null,userRole:'',
  userExpiryInfo:{remainingDays:0,expiryDate:''}
};

// DOMå…ƒç´ ç·©å­˜ï¼ˆé é¢åŠ è¼‰å¾Œåˆå§‹åŒ–ï¼‰
let DOM = {};

// å·¥å…·å‡½æ•¸ - æ ¼å¼åŒ–å°ç£æ™‚é–“
const formatTaiwanTime=(utcStr)=>{
  const options={timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'};
  return utcStr ? new Date(utcStr).toLocaleString('zh-TW',options) : new Date().toLocaleString('zh-TW',options);
};

// è¨­ç½®ç‹€æ…‹æ–‡æœ¬
const setStatus=(text)=>{
  if(DOM.statusText) DOM.statusText.textContent=text;
};

// é¡¯ç¤ºéŒ¯èª¤æç¤º
const showError=(msg)=>{
  const hideEls=[DOM.status, DOM.resultCard, DOM.videoViewerSection, DOM.fileViewerSection,
    DOM.videoListSection, DOM.fileListSection, DOM.videoEditSection, DOM.fileEditSection,
    DOM.contentPreview, DOM.successMessage];
  hideEls.forEach(el=>el&&el.classList.add('hidden'));
  
  if(DOM.errorMessage && DOM.errorContent){
    DOM.errorContent.innerHTML=`<p class="font-medium">${msg}</p><div class="mt-2 flex justify-center"><button onclick="window.location.reload()" class="text-primary hover:text-[#007A69] font-medium flex items-center gap-1 text-xs"><i class="fa fa-refresh text-xs"></i> é‡æ–°å˜—è©¦</button></div>`;
    DOM.errorMessage.classList.remove('hidden');
  }
  resetSubmitState();
};

// é¡¯ç¤ºæˆåŠŸæç¤º
const showSuccess=(msg)=>{
  if(DOM.errorMessage) DOM.errorMessage.classList.add('hidden');
  if(DOM.successMessage && DOM.successContent){
    DOM.successContent.innerHTML=`<p class="font-medium">${msg}</p>`;
    DOM.successMessage.classList.remove('hidden');
    setTimeout(()=>DOM.successMessage&&DOM.successMessage.classList.add('hidden'),4000);
  }
};

// è¨­ç½®æäº¤ç‹€æ…‹
const setSubmitState=(type,isSubmitting)=>{
  appState.isSubmitting=isSubmitting;
  let saveBtn, saveBtnText, saveLoading, btnText;
  if(type==='video'){
    saveBtn=DOM.videoSaveBtn;
    saveBtnText=DOM.videoSaveBtnText;
    saveLoading=DOM.videoSaveLoading;
    btnText=appState.currentEditingVideoId?"æ›´æ–°å½±ç‰‡":"å„²å­˜å½±ç‰‡";
  }else{
    saveBtn=DOM.fileSaveBtn;
    saveBtnText=DOM.fileSaveBtnText;
    saveLoading=DOM.fileSaveLoading;
    btnText=appState.currentEditingFileId?"æ›´æ–°æ–‡ä»¶":"å„²å­˜æ–‡ä»¶";
  }
  if(isSubmitting){
    saveBtn&&saveBtn.classList.add('btn-disabled');
    saveBtnText&&(saveBtnText.textContent="å„²å­˜ä¸­...");
    saveLoading&&saveLoading.classList.remove('hidden');
  }else{
    saveBtn&&saveBtn.classList.remove('btn-disabled');
    saveBtnText&&(saveBtnText.textContent=btnText);
    saveLoading&&saveLoading.classList.add('hidden');
  }
};

// é‡ç½®æäº¤ç‹€æ…‹
const resetSubmitState=()=>{
  setSubmitState('video', false);
  setSubmitState('file', false);
};

// URLé©—è­‰å‡½æ•¸
const isYoutubeUrl=(url)=>url&&url.toLowerCase().trim().match(/youtube\.com|youtu\.be/);
const isTencentUrl=(url)=>url&&url.toLowerCase().trim().includes('v.qq.com');
const isTencentMeetingUrl=(url)=>url&&url.toLowerCase().trim().match(/meeting\.tencent\.com|tm\.qq\.com|tencent\.meeting/);
const isSpotifyUrl=(url)=>url&&url.toLowerCase().trim().includes('spotify.com');
const isPodcastUrl=(url)=>{
  const lowerUrl = url.toLowerCase().trim();
  return lowerUrl.includes('podcast') || lowerUrl.includes('apple.com/podcasts') || lowerUrl.includes('google.com/podcasts');
};
const isValidVideoUrl=(url)=>isYoutubeUrl(url)||isTencentUrl(url)||isTencentMeetingUrl(url)||isSpotifyUrl(url)||isPodcastUrl(url);
const validateUrl=(url)=>{try{new URL(url);return true;}catch(e){return false;}};

// æå–é¨°è¨Šè¦–é »VID
const extractTencentVid=(url)=>{
  if(!isTencentUrl(url))return '';
  const regs=[/v\.qq\.com\/x\/page\/([a-zA-Z0-9_]+)\.html/,
    /v\.qq\.com\/x\/cover\/([a-zA-Z0-9_]+)\/([a-zA-Z0-9_]+)\.html/,
    /v\.qq\.com\/detail\/\w+\/([a-zA-Z0-9_]+)\.html/,/vid=([a-zA-Z0-9_]+)/];
  for(let reg of regs){
    const match=url.match(reg);
    if(match)return match[2]||match[1]||'';
  }
  return '';
};

// è½‰æ›ç‚ºåµŒå…¥URLï¼ˆæ–°å¢Spotify/Podcastæ”¯æŒï¼‰
const convertToEmbedUrl=(url)=>{
  if(isYoutubeUrl(url)){
    const match=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/|live\/|playlist\?list=))([\w-]+)/);
    if(match&&match[1]){
      const isShort=url.includes('shorts/');
      return `https://www.youtube.com/embed/${match[1]}?autoplay=0&rel=0${isShort?'&enablejsapi=1':''}`;
    }
  }else if(isTencentUrl(url)){
    const vid=extractTencentVid(url);
    if(vid)return `https://v.qq.com/txp/iframe/player.html?vid=${vid}&auto=0&show1080p=1`;
  }else if(isSpotifyUrl(url)){
    const match=url.match(/spotify\.com\/(track|album|playlist|episode)\/([\w\d]+)/);
    if(match&&match[1]&&match[2]){
      return `https://open.spotify.com/embed/${match[1]}/${match[2]}?utm_source=generator`;
    }
  }else if(isPodcastUrl(url)){
    if(isSpotifyUrl(url)){
      const match=url.match(/spotify\.com\/episode\/([\w\d]+)/);
      if(match&&match[1]){
        return `https://open.spotify.com/embed/episode/${match[1]}?utm_source=generator`;
      }
    }
  }
  return '';
};

// è¨ˆç®—å‰©é¤˜å¤©æ•¸
const calculateRemainingDaysByDate=(expiryDateStr)=>{
  try{
    if(expiryDateStr===CONFIG.PERMANENT_EXPIRY_DATE)return{displayDate:"æ°¸ä¹…æœ‰æ•ˆ",remainingDays:"æ°¸ä¹…æœ‰æ•ˆ"};
    if(!/^\d{4}[-\/]\d{2}[-\/]\d{2}(?:\s+\d{1,2}:\d{1,2}(?::\d{1,2})?)?$/.test(expiryDateStr)){
      return{displayDate:"æ ¼å¼éŒ¯èª¤",remainingDays:"æ ¼å¼éŒ¯èª¤"};
    }
    const normalized=expiryDateStr.replace(/-/g,'/');
    let expiryDate;
    if(normalized.includes(' ')){
      const [datePart,timePart]=normalized.split(' ');
      const [y,m,d]=datePart.split('/').map(Number);
      const [h,mi,s]=timePart.split(':').map(Number);
      expiryDate=new Date(Date.UTC(y,m-1,d,h||0,mi||0,s||0));
    }else{
      const [y,m,d]=normalized.split('/').map(Number);
      expiryDate=new Date(Date.UTC(y,m-1,d));
    }
    if(isNaN(expiryDate.getTime()))return{displayDate:"æ—¥æœŸç„¡æ•ˆ",remainingDays:"æ—¥æœŸç„¡æ•ˆ"};
    
    const today=new Date();
    const taipeiOffset=8*60*60*1000;
    const todayTaipei=new Date(today.getTime()+taipeiOffset);
    const todayUTC=new Date(Date.UTC(todayTaipei.getFullYear(),todayTaipei.getMonth(),todayTaipei.getDate()));
    const timeDiff=expiryDate-todayUTC;
    const remainingDays=Math.ceil(timeDiff/(1000*3600*24));
    
    const formattedDate=new Date(expiryDate).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    let remainingDaysText;
    if(remainingDays<0)remainingDaysText="<span class='text-red-500 font-medium'>å·²éæœŸ</span>";
    else if(remainingDays===0)remainingDaysText="<span class='text-orange-500 font-medium'>æœ€å¾Œ1å¤©</span>";
    else if(remainingDays<=30)remainingDaysText=`<span class='text-orange-500 font-medium'>${remainingDays} å¤©</span>`;
    else remainingDaysText=`${remainingDays} å¤©`;
    
    return{displayDate:formattedDate,remainingDays:remainingDaysText};
  }catch(error){
    console.error("è¨ˆç®—å‰©é¤˜å¤©æ•¸å¤±æ•—ï¼š",error);
    return{displayDate:"è¨ˆç®—éŒ¯èª¤",remainingDays:"è¨ˆç®—éŒ¯èª¤"};
  }
};

// ç²å–ç¸®ç•¥åœ–ï¼ˆæ–°å¢Spotify/Podcastæ”¯æŒï¼‰
const getThumbnail=(url, type)=>{
  if(!url)return 'https://via.placeholder.com/300x180?text=No+Preview';
  if(type==='video'){
    if(isYoutubeUrl(url)){
      const match=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/))([\w-]+)/);
      return match&&match[1] ? `https://img.youtube.com/vi/${match[1]}/mqdefault.jpg` : 
        'https://via.placeholder.com/300x180?text=è¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(isTencentUrl(url)){
      return 'https://via.placeholder.com/300x180?text=é¨°è¨Šè¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(isTencentMeetingUrl(url)){
      return 'https://via.placeholder.com/300x180?text=é¨°è¨Šæœƒè­°&bgcolor=e8f9f7&color=008c76';
    }else if(isSpotifyUrl(url)){
      return 'https://via.placeholder.com/300x180?text=Spotify&bgcolor=1DB954&color=ffffff';
    }else if(isPodcastUrl(url)){
      return 'https://via.placeholder.com/300x180?text=Podcast&bgcolor=7C3AED&color=ffffff';
    }
    return 'https://via.placeholder.com/300x180?text=è¦–é »&bgcolor=e8f9f7&color=008c76';
  }else if(type==='file'){
    if(isTencentMeetingUrl(url))return 'https://via.placeholder.com/300x180?text=é¨°è¨Šæœƒè­°&bgcolor=f0f7ff&color=3b82f6';
    const lowerUrl=url.toLowerCase();
    if(lowerUrl.endsWith('.pdf'))return 'https://via.placeholder.com/300x180?text=PDFæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.doc')||lowerUrl.endsWith('.docx'))return 'https://via.placeholder.com/300x180?text=Wordæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.xls')||lowerUrl.endsWith('.xlsx'))return 'https://via.placeholder.com/300x180?text=Excelæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.ppt')||lowerUrl.endsWith('.pptx'))return 'https://via.placeholder.com/300x180?text=PPTæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else return 'https://via.placeholder.com/300x180?text=æ–‡ä»¶&bgcolor=f1f5f9&color=64748b';
  }
  return 'https://via.placeholder.com/300x180?text=å…§å®¹&bgcolor=f1f5f9&color=64748b';
};

// æ¬Šé™åˆ¤æ–·
const isManageUser=()=>appState.userRole==='admin';
const isProUser=()=>appState.userRole==='pro';

// æ‹–æ‹½è™•ç†å‡½æ•¸
const handleDragStart=(e)=>{
  if(!isManageUser())return;
  appState.draggingItem=e.target;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain',JSON.stringify({id:e.target.dataset.id,type:e.target.dataset.type}));
  e.target.style.opacity='0.5';
};
const handleDragOver=(e)=>{
  if(!isManageUser())return;
  e.preventDefault();
  const item=e.target.closest('.video-item');
  if(item&&item!==appState.draggingItem)item.classList.add('drop-zone');
};
const handleDragLeave=(e)=>{
  if(!isManageUser())return;
  const item=e.target.closest('.video-item');
  item&&item.classList.remove('drop-zone');
};
const handleDrop=(e)=>{
  if(!isManageUser())return;
  e.preventDefault();
  const dragData=JSON.parse(e.dataTransfer.getData('text/plain'));
  const targetItem=e.target.closest('.video-item');
  if(!targetItem||targetItem.dataset.id===dragData.id||targetItem.dataset.type!==dragData.type)return;
  
  let draggedIndex, targetIndex;
  if(dragData.type==='video'){
    draggedIndex=appState.videoList.findIndex(v=>v.id===dragData.id);
    targetIndex=appState.videoList.findIndex(v=>v.id===targetItem.dataset.id);
    if(draggedIndex!==-1&&targetIndex!==-1){
      const [draggedItem]=appState.videoList.splice(draggedIndex,1);
      appState.videoList.splice(targetIndex,0,draggedItem);
      syncVideoListOrderToGAS();
      renderVideoList();
      renderViewerVideoList();
    }
  }else if(dragData.type==='file'){
    draggedIndex=appState.fileList.findIndex(f=>f.id===dragData.id);
    targetIndex=appState.fileList.findIndex(f=>f.id===targetItem.dataset.id);
    if(draggedIndex!==-1&&targetIndex!==-1){
      const [draggedItem]=appState.fileList.splice(draggedIndex,1);
      appState.fileList.splice(targetIndex,0,draggedItem);
      syncFileListOrderToGAS();
      renderFileList();
      renderViewerFileList();
    }
  }
  targetItem.classList.remove('drop-zone');
  if(appState.draggingItem){
    appState.draggingItem.classList.remove('dragging');
    appState.draggingItem.style.opacity='1';
  }
  appState.draggingItem=null;
  showSuccess('å…§å®¹é †åºå·²å³æ™‚æ›´æ–°ï¼');
};
const handleDragEnd=(e)=>{
  if(!isManageUser())return;
  e.target.classList.remove('dragging');
  e.target.style.opacity='1';
  document.querySelectorAll('.video-item').forEach(item=>item.classList.remove('drop-zone'));
  appState.draggingItem=null;
};

// æ›´æ–°å…§å®¹è¨ˆæ•¸é¡¯ç¤º
const updateContentCountDisplay=()=>{
  if(DOM.videoCountNum) DOM.videoCountNum.textContent=appState.videoList.length;
  if(DOM.fileCountNum) DOM.fileCountNum.textContent=appState.fileList.length;
};

// é©—è­‰ç”¨æˆ¶æ¬Šé™
const verifyUserPermission=()=>{
  return new Promise((resolve, reject)=>{
    setStatus('é©—è­‰ç”¨æˆ¶æ¬Šé™...');
    if(!appState.currentUser)return reject(new Error('ç”¨æˆ¶ä¿¡æ¯ä¸å­˜åœ¨'));

    const requestData = {
      action:'verifyUser',
      userId:appState.currentUser.userId,
      displayName:appState.currentUser.displayName,
      writeToSheet:true,
      needExpiryDate:true
    };

    $.ajax({
      url:CONFIG.GAS_URL,
      dataType:'jsonp',
      jsonp:'callback',
      timeout:6000,
      data:requestData,
      cache: true,
      success:(resp)=>{
        if(resp.status==="success"&&resp.isAuthorized){
          appState.userRole=resp.isAdmin?'admin':(resp.isPro?'pro':'user');
          appState.userExpiryInfo={
            remainingDays:resp.remainingDays || 0,
            expiryDate:resp.expiryDate || CONFIG.PERMANENT_EXPIRY_DATE
          };
          resolve(true);
        }else{
          reject(new Error(resp.message||'ç”¨æˆ¶æœªæˆæ¬Šï¼Œè«‹è¯ç¹«ç®¡ç†å“¡é–‹é€š'));
        }
      },
      error:(xhr,status,error)=>{
        console.error("ç”¨æˆ¶æ¬Šé™é©—è­‰å¤±æ•—ï¼š",status,error);
        const errorMsg = status === 'timeout' 
          ? 'æ¬Šé™é©—è­‰è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡è©¦' 
          : (status === 'abort' ? 'è«‹æ±‚å·²ä¸­æ–·' : 'ç¶²çµ¡éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰ç”¨æˆ¶æ¬Šé™');
        reject(new Error(errorMsg));
      }
    });
  });
};

// ç²å–å½±ç‰‡åˆ—è¡¨
const fetchVideoListFromGAS=()=>{
  return new Promise((resolve, reject)=>{
    setStatus('è¼‰å…¥å½±ç‰‡åˆ—è¡¨ä¸­...');
    $.ajax({
      url:CONFIG.GAS_URL,
      dataType:'jsonp',
      jsonp:'callback',
      timeout:CONFIG.JSONP_TIMEOUT,
      data:{action:'getVideoList'},
      success:(resp)=>{
        if(resp.status==="success"&&Array.isArray(resp.data)){
          appState.videoList=resp.data.map(v=>({
            id:v.id||`vid_${Date.now()}_${Math.floor(Math.random()*1000)}`,
            name:v.name||'',
            url:v.video||'',
            note:v.note||'',
            updatedAt:formatTaiwanTime(v.updatedAt)||formatTaiwanTime(new Date().toISOString()),
            videoType:v.videoType||''
          })).filter(v=>v.url&&v.id);
          resolve(true);
        }else{
          appState.videoList=[];
          resolve(false);
        }
      },
      error:(xhr,status,error)=>{
        console.error("ç²å–å½±ç‰‡åˆ—è¡¨å¤±æ•—ï¼š",status,error);
        appState.videoList=[];
        reject(new Error('ç²å–å½±ç‰‡åˆ—è¡¨å¤±æ•—'));
      }
    });
  });
};

// ç²å–æ–‡ä»¶åˆ—è¡¨
const fetchFileListFromGAS=()=>{
  return new Promise((resolve, reject)=>{
    setStatus('è¼‰å…¥æ–‡ä»¶åˆ—è¡¨ä¸­...');
    $.ajax({
      url:CONFIG.GAS_URL,
      dataType:'jsonp',
      jsonp:'callback',
      timeout:CONFIG.JSONP_TIMEOUT,
      data:{action:'getFileList'},
      success:(resp)=>{
        if(resp.status==="success"&&Array.isArray(resp.data)){
          appState.fileList=resp.data.map(f=>({
            id:f.id||`file_${Date.now()}_${Math.floor(Math.random()*1000)}`,
            name:f.name||'',
            url:f.file||'',
            note:f.note||'',
            updatedAt:formatTaiwanTime(f.updatedAt)||formatTaiwanTime(new Date().toISOString()),
            fileType:f.fileType||''
          })).filter(f=>f.url&&f.id);
          resolve(true);
        }else{
          appState.fileList=[];
          resolve(false);
        }
      },
      error:(xhr,status,error)=>{
        console.error("ç²å–æ–‡ä»¶åˆ—è¡¨å¤±æ•—ï¼š",status,error);
        appState.fileList=[];
        reject(new Error('ç²å–æ–‡ä»¶åˆ—è¡¨å¤±æ•—'));
      }
    });
  });
};

// é€šç”¨åŒæ­¥å‡½æ•¸
const syncToGAS=(type, data, callback)=>{
  const action=type==='video'?'saveVideo':'saveFile';
  const key=type==='video'?'video':'file';
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action,
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      [`${type}Id`]:data.id,
      name:data.name,
      [key]:data.url,
      note:data.note,
      updatedAt:data.updatedAt
    },
    success:(resp)=>{
      if(resp.status==="success"){
        callback&&callback(true);
      }else{
        showError(`åŒæ­¥${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
        callback&&callback(false);
      }
    },
    error:(xhr,status,error)=>{
      console.error(`åŒæ­¥${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š`,status,error);
      showError(`åŒæ­¥${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š${status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
      callback&&callback(false);
    }
  });
};
const syncVideoToGAS=(data, callback)=>syncToGAS('video', data, callback);
const syncFileToGAS=(data, callback)=>syncToGAS('file', data, callback);

// é€šç”¨åˆªé™¤å‡½æ•¸
const deleteFromGAS=(type, id, callback)=>{
  const action=type==='video'?'deleteVideo':'deleteFile';
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action,
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      [`${type}Id`]:id
    },
    success:(resp)=>{
      if(resp.status==="success"){
        callback&&callback(true);
      }else{
        showError(`åˆªé™¤${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
        callback&&callback(false);
      }
    },
    error:(xhr,status,error)=>{
      console.error(`åˆªé™¤${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š`,status,error);
      showError(`åˆªé™¤${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š${status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
      callback&&callback(false);
    }
  });
};
const deleteVideoFromGAS=(id, callback)=>deleteFromGAS('video', id, callback);
const deleteFileFromGAS=(id, callback)=>deleteFromGAS('file', id, callback);

// åŒæ­¥å½±ç‰‡é †åº
const syncVideoListOrderToGAS=()=>{
  const videoIds=appState.videoList.map(v=>v.id);
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action:'updateVideoOrder',
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      videoIds:JSON.stringify(videoIds)
    },
    success:(resp)=>{
      if(resp.status!=="success")console.warn("åŒæ­¥å½±ç‰‡é †åºå¤±æ•—ï¼š",resp.message);
    },
    error:(xhr,status,error)=>{
      console.error("åŒæ­¥å½±ç‰‡é †åºå¤±æ•—ï¼š",status,error);
    }
  });
};

// åŒæ­¥æ–‡ä»¶é †åº
const syncFileListOrderToGAS=()=>{
  const fileIds=appState.fileList.map(f=>f.id);
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action:'updateFileOrder',
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      fileIds:JSON.stringify(fileIds)
    },
    success:(resp)=>{
      if(resp.status!=="success")console.warn("åŒæ­¥æ–‡ä»¶é †åºå¤±æ•—ï¼š",resp.message);
    },
    error:(xhr,status,error)=>{
      console.error("åŒæ­¥æ–‡ä»¶é †åºå¤±æ•—ï¼š",status,error);
    }
  });
};

      // æ¸²æŸ“å½±ç‰‡åˆ—è¡¨ï¼ˆç®¡ç†è§†å›¾ï¼‰
function renderVideoList(){
  const container=DOM.videoListContainer, emptyEl=DOM.emptyVideoList;
  if(!container||!emptyEl)return;
  container.innerHTML='';
  const isManage=isManageUser();
  if(appState.videoList.length===0){
    emptyEl.classList.remove('hidden');
    DOM.emptyVideoTip.textContent=isManage?'é»æ“Šã€Œæ–°å¢å½±ç‰‡ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ ':'æš«ç„¡å¯ç”¨çš„å½±ç‰‡';
    return;
  }
  emptyEl.classList.add('hidden');
  
  appState.videoList.forEach((video)=>{
    const videoItem=document.createElement('div');
    videoItem.className=isManage?
      'video-item bg-cardBg rounded-lg p-3 shadow-elevation-1 flex items-center gap-3 border border-gray-100 cursor-grab' :
      'video-item pro-user bg-cardBg rounded-lg p-3 shadow-elevation-1 flex items-center gap-3 border border-gray-100';
    
    videoItem.dataset.id=video.id;
    videoItem.dataset.type='video';
    
    // æ‹–æ‹½ç›¸å…³äº‹ä»¶ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
    if(isManage){
      videoItem.draggable=true;
      videoItem.addEventListener('dragstart', handleDragStart);
      videoItem.addEventListener('dragover', handleDragOver);
      videoItem.addEventListener('dragleave', handleDragLeave);
      videoItem.addEventListener('drop', handleDrop);
      videoItem.addEventListener('dragend', handleDragEnd);
    }
    
    // ç¼©ç‡å›¾å®¹å™¨
    const thumbnailContainer=document.createElement('div');
    thumbnailContainer.className='thumbnail-container';
    const thumbnailImg=document.createElement('img');
    thumbnailImg.className='thumbnail-img';
    thumbnailImg.src=getThumbnail(video.url, 'video');
    thumbnailImg.alt=video.name;
    thumbnailContainer.appendChild(thumbnailImg);
    
    // å†…å®¹ä¿¡æ¯
    const infoContainer=document.createElement('div');
    infoContainer.className='flex-1 min-w-0';
    
    const nameEl=document.createElement('h3');
    nameEl.className='font-medium text-textPrimary text-sm truncate';
    nameEl.textContent=video.name||'æœªå‘½åå½±ç‰‡';
    
    const urlEl=document.createElement('p');
    urlEl.className='text-xs text-textSecondary truncate mt-1';
    urlEl.textContent=video.url||'';
    
    const noteEl=document.createElement('p');
    noteEl.className='text-xs text-textSecondary/80 mt-1';
    noteEl.textContent=video.note||'ç„¡å‚™æ³¨';
    
    const updatedEl=document.createElement('p');
    updatedEl.className='text-xs text-primary/70 mt-1';
    updatedEl.innerHTML=`æ›´æ–°æ™‚é–“ï¼š${video.updatedAt||'æœªçŸ¥'}`;
    
    infoContainer.appendChild(nameEl);
    infoContainer.appendChild(urlEl);
    infoContainer.appendChild(noteEl);
    infoContainer.appendChild(updatedEl);
    
    // æ“ä½œæŒ‰é’®ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
    const actionContainer=document.createElement('div');
    actionContainer.className='flex gap-1 flex-shrink-0';
    
    if(isManage){
      const editBtn=document.createElement('button');
      editBtn.className='p-1.5 bg-primary/10 hover:bg-primary/20 text-primary rounded-md transition-colors';
      editBtn.title='ç·¨è¼¯';
      editBtn.innerHTML='<i class="fa fa-pencil text-xs"></i>';
      editBtn.onclick=()=>editVideo(video.id);
      
      const deleteBtn=document.createElement('button');
      deleteBtn.className='p-1.5 bg-red-50 hover:bg-red-100 text-red-500 rounded-md transition-colors';
      deleteBtn.title='åˆªé™¤';
      deleteBtn.innerHTML='<i class="fa fa-trash text-xs"></i>';
      deleteBtn.onclick=()=>deleteVideo(video.id);
      
      actionContainer.appendChild(editBtn);
      actionContainer.appendChild(deleteBtn);
    }else{
      // æ™®é€šç”¨æˆ·/Proç”¨æˆ·ä»…æ˜¾ç¤ºæŸ¥çœ‹æŒ‰é’®
      const viewBtn=document.createElement('button');
      viewBtn.className='p-1.5 bg-primary/10 hover:bg-primary/20 text-primary rounded-md transition-colors';
      viewBtn.title='é è¦½';
      viewBtn.innerHTML='<i class="fa fa-eye text-xs"></i>';
      viewBtn.onclick=()=>showContentPreview(video.id, 'video');
      actionContainer.appendChild(viewBtn);
    }
    
    // ç»„è£…å…ƒç´ 
    videoItem.appendChild(thumbnailContainer);
    videoItem.appendChild(infoContainer);
    videoItem.appendChild(actionContainer);
    
    // ç‚¹å‡»æ•´è¡Œé¢„è§ˆï¼ˆé™¤äº†ç®¡ç†å‘˜çš„æ‹–æ‹½æ“ä½œï¼‰
    if(!isManage){
      videoItem.addEventListener('click', (e)=>{
        if(!e.target.closest('button')){
          showContentPreview(video.id, 'video');
        }
      });
    }
    
    container.appendChild(videoItem);
  });
  
  updateContentCountDisplay();
}

// æ¸²æŸ“ç”¨æˆ·è§†å›¾çš„å½±ç‰‡åˆ—è¡¨
function renderViewerVideoList(){
  const container=DOM.viewerVideoList, emptyEl=DOM.viewerEmptyVideoList;
  if(!container||!emptyEl)return;
  container.innerHTML='';
  
  if(appState.videoList.length===0){
    emptyEl.classList.remove('hidden');
    return;
  }
  emptyEl.classList.add('hidden');
  
  appState.videoList.forEach((video)=>{
    const videoItem=document.createElement('div');
    videoItem.className='viewer-card bg-cardBg rounded-lg overflow-hidden shadow-elevation-1 cursor-pointer';
    videoItem.dataset.id=video.id;
    videoItem.dataset.type='video';
    
    // ç¼©ç‡å›¾åŒºåŸŸ
    const thumbnailWrapper=document.createElement('div');
    thumbnailWrapper.className='relative aspect-video bg-neutral';
    const thumbnailImg=document.createElement('img');
    thumbnailImg.className='w-full h-full object-cover';
    thumbnailImg.src=getThumbnail(video.url, 'video');
    thumbnailImg.alt=video.name;
    thumbnailWrapper.appendChild(thumbnailImg);
    
    // æ’­æ”¾å›¾æ ‡
    const playIcon=document.createElement('div');
    playIcon.className='absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 hover:opacity-100 transition-opacity';
    playIcon.innerHTML='<i class="fa fa-play-circle text-white text-4xl"></i>';
    thumbnailWrapper.appendChild(playIcon);
    
    // å†…å®¹ä¿¡æ¯
    const infoContainer=document.createElement('div');
    infoContainer.className='p-3';
    
    const nameEl=document.createElement('h3');
    nameEl.className='font-medium text-textPrimary text-sm mb-1';
    nameEl.textContent=video.name||'æœªå‘½åå½±ç‰‡';
    
    const noteEl=document.createElement('p');
    noteEl.className='text-xs text-textSecondary line-clamp-2 mb-2';
    noteEl.textContent=video.note||'ç„¡å‚™æ³¨';
    
    const updatedEl=document.createElement('p');
    updatedEl.className='text-xs text-primary/70';
    updatedEl.innerHTML=`æ›´æ–°æ™‚é–“ï¼š${video.updatedAt||'æœªçŸ¥'}`;
    
    infoContainer.appendChild(nameEl);
    infoContainer.appendChild(noteEl);
    infoContainer.appendChild(updatedEl);
    
    // ç»„è£…å…ƒç´ 
    videoItem.appendChild(thumbnailWrapper);
    videoItem.appendChild(infoContainer);
    
    // ç‚¹å‡»é¢„è§ˆ
    videoItem.addEventListener('click', ()=>{
      showContentPreview(video.id, 'video');
    });
    
    container.appendChild(videoItem);
  });
}

// æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ï¼ˆç®¡ç†è§†å›¾ï¼‰
function renderFileList(){
  const container=DOM.fileListContainer, emptyEl=DOM.emptyFileList;
  if(!container||!emptyEl)return;
  container.innerHTML='';
  const isManage=isManageUser();
  
  if(appState.fileList.length===0){
    emptyEl.classList.remove('hidden');
    DOM.emptyFileTip.textContent=isManage?'é»æ“Šã€Œæ–°å¢æ–‡ä»¶ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ ':'æš«ç„¡å¯ç”¨çš„æ–‡ä»¶';
    return;
  }
  emptyEl.classList.add('hidden');
  
  appState.fileList.forEach((file)=>{
    const fileItem=document.createElement('div');
    fileItem.className=isManage?
      'video-item bg-cardBg rounded-lg p-3 shadow-elevation-1 flex items-center gap-3 border border-gray-100 cursor-grab' :
      'video-item pro-user bg-cardBg rounded-lg p-3 shadow-elevation-1 flex items-center gap-3 border border-gray-100';
    
    fileItem.dataset.id=file.id;
    fileItem.dataset.type='file';
    
    // æ‹–æ‹½ç›¸å…³äº‹ä»¶ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
    if(isManage){
      fileItem.draggable=true;
      fileItem.addEventListener('dragstart', handleDragStart);
      fileItem.addEventListener('dragover', handleDragOver);
      fileItem.addEventListener('dragleave', handleDragLeave);
      fileItem.addEventListener('drop', handleDrop);
      fileItem.addEventListener('dragend', handleDragEnd);
    }
    
    // ç¼©ç‡å›¾å®¹å™¨
    const thumbnailContainer=document.createElement('div');
    thumbnailContainer.className='thumbnail-container';
    const thumbnailImg=document.createElement('img');
    thumbnailImg.className='thumbnail-img';
    thumbnailImg.src=getThumbnail(file.url, 'file');
    thumbnailImg.alt=file.name;
    thumbnailContainer.appendChild(thumbnailImg);
    
    // å†…å®¹ä¿¡æ¯
    const infoContainer=document.createElement('div');
    infoContainer.className='flex-1 min-w-0';
    
    const nameEl=document.createElement('h3');
    nameEl.className='font-medium text-textPrimary text-sm truncate';
    nameEl.textContent=file.name||'æœªå‘½åæ–‡ä»¶';
    
    const urlEl=document.createElement('p');
    urlEl.className='text-xs text-textSecondary truncate mt-1';
    urlEl.textContent=file.url||'';
    
    const noteEl=document.createElement('p');
    noteEl.className='text-xs text-textSecondary/80 mt-1';
    noteEl.textContent=file.note||'ç„¡å‚™æ³¨';
    
    const updatedEl=document.createElement('p');
    updatedEl.className='text-xs text-primary/70 mt-1';
    updatedEl.innerHTML=`æ›´æ–°æ™‚é–“ï¼š${file.updatedAt||'æœªçŸ¥'}`;
    
    infoContainer.appendChild(nameEl);
    infoContainer.appendChild(urlEl);
    infoContainer.appendChild(noteEl);
    infoContainer.appendChild(updatedEl);
    
    // æ“ä½œæŒ‰é’®ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
    const actionContainer=document.createElement('div');
    actionContainer.className='flex gap-1 flex-shrink-0';
    
    if(isManage){
      const editBtn=document.createElement('button');
      editBtn.className='p-1.5 bg-primary/10 hover:bg-primary/20 text-primary rounded-md transition-colors';
      editBtn.title='ç·¨è¼¯';
      editBtn.innerHTML='<i class="fa fa-pencil text-xs"></i>';
      editBtn.onclick=()=>editFile(file.id);
      
      const deleteBtn=document.createElement('button');
      deleteBtn.className='p-1.5 bg-red-50 hover:bg-red-100 text-red-500 rounded-md transition-colors';
      deleteBtn.title='åˆªé™¤';
      deleteBtn.innerHTML='<i class="fa fa-trash text-xs"></i>';
      deleteBtn.onclick=()=>deleteFile(file.id);
      
      actionContainer.appendChild(editBtn);
      actionContainer.appendChild(deleteBtn);
    }else{
      // æ™®é€šç”¨æˆ·/Proç”¨æˆ·ä»…æ˜¾ç¤ºæŸ¥çœ‹æŒ‰é’®
      const viewBtn=document.createElement('button');
      viewBtn.className='p-1.5 bg-primary/10 hover:bg-primary/20 text-primary rounded-md transition-colors';
      viewBtn.title='é è¦½';
      viewBtn.innerHTML='<i class="fa fa-eye text-xs"></i>';
      viewBtn.onclick=()=>showContentPreview(file.id, 'file');
      actionContainer.appendChild(viewBtn);
    }
    
    // ç»„è£…å…ƒç´ 
    fileItem.appendChild(thumbnailContainer);
    fileItem.appendChild(infoContainer);
    fileItem.appendChild(actionContainer);
    
    // ç‚¹å‡»æ•´è¡Œé¢„è§ˆï¼ˆé™¤äº†ç®¡ç†å‘˜çš„æ‹–æ‹½æ“ä½œï¼‰
    if(!isManage){
      fileItem.addEventListener('click', (e)=>{
        if(!e.target.closest('button')){
          showContentPreview(file.id, 'file');
        }
      });
    }
    
    container.appendChild(fileItem);
  });
  
  updateContentCountDisplay();
}

// æ¸²æŸ“ç”¨æˆ·è§†å›¾çš„æ–‡ä»¶åˆ—è¡¨
function renderViewerFileList(){
  const container=DOM.viewerFileList, emptyEl=DOM.viewerEmptyFileList;
  if(!container||!emptyEl)return;
  container.innerHTML='';
  
  if(appState.fileList.length===0){
    emptyEl.classList.remove('hidden');
    return;
  }
  emptyEl.classList.add('hidden');
  
  appState.fileList.forEach((file)=>{
    const fileItem=document.createElement('div');
    fileItem.className='viewer-card bg-cardBg rounded-lg overflow-hidden shadow-elevation-1 cursor-pointer';
    fileItem.dataset.id=file.id;
    fileItem.dataset.type='file';
    
    // ç¼©ç‡å›¾åŒºåŸŸ
    const thumbnailWrapper=document.createElement('div');
    thumbnailWrapper.className='relative aspect-video bg-neutral';
    const thumbnailImg=document.createElement('img');
    thumbnailImg.className='w-full h-full object-cover';
    thumbnailImg.src=getThumbnail(file.url, 'file');
    thumbnailImg.alt=file.name;
    thumbnailWrapper.appendChild(thumbnailImg);
    
    // æ–‡ä»¶å›¾æ ‡
    const fileIcon=document.createElement('div');
    fileIcon.className='absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 hover:opacity-100 transition-opacity';
    fileIcon.innerHTML='<i class="fa fa-file-text text-white text-4xl"></i>';
    thumbnailWrapper.appendChild(fileIcon);
    
    // å†…å®¹ä¿¡æ¯
    const infoContainer=document.createElement('div');
    infoContainer.className='p-3';
    
    const nameEl=document.createElement('h3');
    nameEl.className='font-medium text-textPrimary text-sm mb-1';
    nameEl.textContent=file.name||'æœªå‘½åæ–‡ä»¶';
    
    const noteEl=document.createElement('p');
    noteEl.className='text-xs text-textSecondary line-clamp-2 mb-2';
    noteEl.textContent=file.note||'ç„¡å‚™æ³¨';
    
    const updatedEl=document.createElement('p');
    updatedEl.className='text-xs text-primary/70';
    updatedEl.innerHTML=`æ›´æ–°æ™‚é–“ï¼š${file.updatedAt||'æœªçŸ¥'}`;
    
    infoContainer.appendChild(nameEl);
    infoContainer.appendChild(noteEl);
    infoContainer.appendChild(updatedEl);
    
    // ç»„è£…å…ƒç´ 
    fileItem.appendChild(thumbnailWrapper);
    fileItem.appendChild(infoContainer);
    
    // ç‚¹å‡»é¢„è§ˆ
    fileItem.addEventListener('click', ()=>{
      showContentPreview(file.id, 'file');
    });
    
    container.appendChild(fileItem);
  });
}

// æ˜¾ç¤ºå†…å®¹é¢„è§ˆ
function showContentPreview(id, type){
  // éšè—å…¶ä»–åŒºåŸŸï¼Œæ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
  const hideEls=[DOM.status, DOM.resultCard, DOM.videoViewerSection, DOM.fileViewerSection,
    DOM.videoListSection, DOM.fileListSection, DOM.videoEditSection, DOM.fileEditSection];
  hideEls.forEach(el=>el&&el.classList.add('hidden'));
  
  DOM.contentPreview.classList.remove('hidden');
  DOM.previewActionBtns.classList.remove('hidden');
  
  // ä¿å­˜å½“å‰æŸ¥çœ‹çš„å†…å®¹IDå’Œç±»å‹
  appState.currentViewingId=id;
  appState.currentViewingType=type;
  
  let content, embedUrl, isVideoType=false;
  
  if(type==='video'){
    content=appState.videoList.find(v=>v.id===id);
    isVideoType=true;
  }else{
    content=appState.fileList.find(f=>f.id===id);
  }
  
  if(!content){
    showError('ç„¡æ³•æ‰¾åˆ°å°æ‡‰çš„å…§å®¹');
    return;
  }
  
  // è®¾ç½®é¢„è§ˆæ ‡é¢˜
  DOM.previewTitle.textContent=content.name||(type==='video'?'æœªå‘½åå½±ç‰‡':'æœªå‘½åæ–‡ä»¶');
  
  // è®¾ç½®æ›´æ–°æ—¶é—´å’Œå¤‡æ³¨
  DOM.previewUpdated.textContent=content.updatedAt||'æœªçŸ¥æ™‚é–“';
  DOM.previewNote.textContent=content.note||'ç„¡å‚™æ³¨';
  
  // é‡ç½®é¢„è§ˆå®¹å™¨
  DOM.videoContainer.classList.add('hidden');
  DOM.unsupportedTip.classList.add('hidden');
  DOM.filePreviewTip.classList.add('hidden');
  
  if(isVideoType){
    embedUrl=convertToEmbedUrl(content.url);
    if(embedUrl){
      DOM.videoContainer.classList.remove('hidden');
      DOM.previewVideo.src=embedUrl;
      // é‡ç½®åŠ è½½çŠ¶æ€
      DOM.previewVideo.classList.remove('loaded');
      const videoLoading=document.getElementById('video-loading');
      if(videoLoading) videoLoading.classList.remove('hidden');
    }else{
      DOM.unsupportedTip.classList.remove('hidden');
    }
  }else{
    // æ–‡ä»¶ç±»å‹æ˜¾ç¤ºè·³è½¬æç¤º
    DOM.filePreviewTip.classList.remove('hidden');
    DOM.filePreviewName.textContent=content.name||'æœªå‘½åæ–‡ä»¶';
    DOM.filePreviewBtn.href=content.url;
  }
  
  // ç®¡ç†å‘˜æ˜¾ç¤ºç¼–è¾‘/åˆ é™¤æŒ‰é’®ï¼Œæ™®é€šç”¨æˆ·éšè—
  if(!isManageUser()){
    DOM.previewEditBtn.style.display='none';
    DOM.previewDeleteBtn.style.display='none';
  }else{
    DOM.previewEditBtn.style.display='flex';
    DOM.previewDeleteBtn.style.display='flex';
  }
}

// éšè—å†…å®¹é¢„è§ˆ
function hideContentPreview(){
  DOM.contentPreview.classList.add('hidden');
  // é‡ç½®é¢„è§ˆè§†é¢‘
  DOM.previewVideo.src='';
  
  // æ ¹æ®ç”¨æˆ·æƒé™æ˜¾ç¤ºå¯¹åº”åˆ—è¡¨
  if(isManageUser()){
    DOM.videoListSection.classList.remove('hidden');
    DOM.fileListSection.classList.remove('hidden');
  }else{
    DOM.videoViewerSection.classList.remove('hidden');
    DOM.fileViewerSection.classList.remove('hidden');
  }
}

// ç¼–è¾‘å½“å‰é¢„è§ˆçš„å†…å®¹
function editCurrentContent(){
  const id=appState.currentViewingId;
  const type=appState.currentViewingType;
  
  if(type==='video'){
    editVideo(id);
  }else{
    editFile(id);
  }
}

// åˆ é™¤å½“å‰é¢„è§ˆçš„å†…å®¹
function deleteCurrentContent(){
  const id=appState.currentViewingId;
  const type=appState.currentViewingType;
  
  if(!confirm(`ç¢ºå®šè¦åˆªé™¤${type==='video'?'è©²å½±ç‰‡':'è©²æ–‡ä»¶'}å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼`)){
    return;
  }
  
  if(type==='video'){
    deleteVideo(id);
  }else{
    deleteFile(id);
  }
}

// æ–°å¢/ç¼–è¾‘å½±ç‰‡ç›¸å…³å‡½æ•°
function addNewVideo(){
  appState.currentEditingVideoId=null;
  // æ¸…ç©ºè¡¨å•
  DOM.videoForm.reset();
  DOM.videoId.value='';
  DOM.videoEditTitle.textContent='æ–°å¢å½±ç‰‡';
  
  // éšè—å…¶ä»–åŒºåŸŸï¼Œæ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
  const hideEls=[DOM.status, DOM.resultCard, DOM.videoViewerSection, DOM.fileViewerSection,
    DOM.videoListSection, DOM.fileListSection, DOM.fileEditSection, DOM.contentPreview];
  hideEls.forEach(el=>el&&el.classList.add('hidden'));
  
  DOM.videoEditSection.classList.remove('hidden');
  // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
  DOM.videoName.focus();
}

function hideVideoEditSection(){
  DOM.videoEditSection.classList.add('hidden');
  // è¿”å›ç®¡ç†åˆ—è¡¨
  if(isManageUser()){
    DOM.videoListSection.classList.remove('hidden');
  }else{
    DOM.videoViewerSection.classList.remove('hidden');
  }
}

function editVideo(id){
  const video=appState.videoList.find(v=>v.id===id);
  if(!video)return;
  
  appState.currentEditingVideoId=id;
  // å¡«å……è¡¨å•
  DOM.videoId.value=video.id;
  DOM.videoName.value=video.name||'';
  DOM.videoUrl.value=video.url||'';
  DOM.videoNote.value=video.note||'';
  DOM.videoEditTitle.textContent='ç·¨è¼¯å½±ç‰‡';
  
  // éšè—å…¶ä»–åŒºåŸŸï¼Œæ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
  const hideEls=[DOM.status, DOM.resultCard, DOM.videoViewerSection, DOM.fileViewerSection,
    DOM.fileListSection, DOM.fileEditSection, DOM.contentPreview];
  hideEls.forEach(el=>el&&el.classList.add('hidden'));
  
  DOM.videoEditSection.classList.remove('hidden');
  DOM.videoListSection.classList.remove('hidden'); // ä¿ç•™ç®¡ç†åˆ—è¡¨èƒŒæ™¯
  // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
  DOM.videoName.focus();
}

function saveVideo(e){
  e.preventDefault();
  if(appState.isSubmitting)return;
  
  const id=DOM.videoId.value||`vid_${Date.now()}_${Math.floor(Math.random()*1000)}`;
  const name=DOM.videoName.value.trim();
  const url=DOM.videoUrl.value.trim();
  const note=DOM.videoNote.value.trim();
  
  // åŸºç¡€éªŒè¯
  if(!name){
    showError('è«‹è¼¸å…¥å½±ç‰‡åç¨±');
    return;
  }
  
  if(!validateUrl(url)){
    showError('è«‹è¼¸å…¥æœ‰æ•ˆçš„URLéˆæ¥');
    return;
  }
  
  // è®¾ç½®æäº¤çŠ¶æ€
  setSubmitState('video', true);
  
  // æ„å»ºæ•°æ®å¯¹è±¡
  const videoData={
    id,
    name,
    url,
    note,
    updatedAt:formatTaiwanTime(new Date().toISOString())
  };
  
  // åŒæ­¥åˆ°GAS
  syncVideoToGAS(videoData, (success)=>{
    setSubmitState('video', false);
    if(success){
      // æ›´æ–°æœ¬åœ°åˆ—è¡¨
      const index=appState.videoList.findIndex(v=>v.id===id);
      if(index>-1){
        appState.videoList[index]=videoData;
        showSuccess('å½±ç‰‡æ›´æ–°æˆåŠŸï¼');
      }else{
        appState.videoList.push(videoData);
        showSuccess('å½±ç‰‡æ–°å¢æˆåŠŸï¼');
      }
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderVideoList();
      renderViewerVideoList();
      
      // éšè—ç¼–è¾‘åŒºåŸŸï¼Œè¿”å›åˆ—è¡¨
      hideVideoEditSection();
    }
  });
}

function deleteVideo(id){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å½±ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼'))return;
  
  // ä»æœ¬åœ°åˆ—è¡¨åˆ é™¤
  const index=appState.videoList.findIndex(v=>v.id===id);
  if(index===-1){
    showError('å½±ç‰‡ä¸å­˜åœ¨');
    return;
  }
  
  // åŒæ­¥åˆ°GAS
  deleteVideoFromGAS(id, (success)=>{
    if(success){
      appState.videoList.splice(index, 1);
      showSuccess('å½±ç‰‡åˆªé™¤æˆåŠŸï¼');
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderVideoList();
      renderViewerVideoList();
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é¢„è§ˆçš„å†…å®¹ï¼Œéšè—é¢„è§ˆ
      if(appState.currentViewingId===id&&appState.currentViewingType==='video'){
        hideContentPreview();
      }
    }
  });
}

// æ–°å¢/ç¼–è¾‘æ–‡ä»¶ç›¸å…³å‡½æ•°
function addNewFile(){
  appState.currentEditingFileId=null;
  // æ¸…ç©ºè¡¨å•
  DOM.fileForm.reset();
  DOM.fileId.value='';
  DOM.fileEditTitle.textContent='æ–°å¢æ–‡ä»¶';
  
  // éšè—å…¶ä»–åŒºåŸŸï¼Œæ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
  const hideEls=[DOM.status, DOM.resultCard, DOM.videoViewerSection, DOM.fileViewerSection,
    DOM.videoListSection, DOM.fileListSection, DOM.videoEditSection, DOM.contentPreview];
  hideEls.forEach(el=>el&&el.classList.add('hidden'));
  
  DOM.fileEditSection.classList.remove('hidden');
  // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
  DOM.fileName.focus();
}

function hideFileEditSection(){
  DOM.fileEditSection.classList.add('hidden');
  // è¿”å›ç®¡ç†åˆ—è¡¨
  if(isManageUser()){
    DOM.fileListSection.classList.remove('hidden');
  }else{
    DOM.fileViewerSection.classList.remove('hidden');
  }
}

function editFile(id){
  const file=appState.fileList.find(f=>f.id===id);
  if(!file)return;
  
  appState.currentEditingFileId=id;
  // å¡«å……è¡¨å•
  DOM.fileId.value=file.id;
  DOM.fileName.value=file.name||'';
  DOM.fileUrl.value=file.url||'';
  DOM.fileNote.value=file.note||'';
  DOM.fileEditTitle.textContent='ç·¨è¼¯æ–‡ä»¶';
  
  // éšè—å…¶ä»–åŒºåŸŸï¼Œæ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
  const hideEls=[DOM.status, DOM.resultCard, DOM.videoViewerSection, DOM.fileViewerSection,
    DOM.videoListSection, DOM.videoEditSection, DOM.contentPreview];
  hideEls.forEach(el=>el&&el.classList.add('hidden'));
  
  DOM.fileEditSection.classList.remove('hidden');
  DOM.fileListSection.classList.remove('hidden'); // ä¿ç•™ç®¡ç†åˆ—è¡¨èƒŒæ™¯
  // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
  DOM.fileName.focus();
}

function saveFile(e){
  e.preventDefault();
  if(appState.isSubmitting)return;
  
  const id=DOM.fileId.value||`file_${Date.now()}_${Math.floor(Math.random()*1000)}`;
  const name=DOM.fileName.value.trim();
  const url=DOM.fileUrl.value.trim();
  const note=DOM.fileNote.value.trim();
  
  // åŸºç¡€éªŒè¯
  if(!name){
    showError('è«‹è¼¸å…¥æ–‡ä»¶åç¨±');
    return;
  }
  
  if(!validateUrl(url)){
    showError('è«‹è¼¸å…¥æœ‰æ•ˆçš„URLéˆæ¥');
    return;
  }
  
  // è®¾ç½®æäº¤çŠ¶æ€
  setSubmitState('file', true);
  
  // æ„å»ºæ•°æ®å¯¹è±¡
  const fileData={
    id,
    name,
    url,
    note,
    updatedAt:formatTaiwanTime(new Date().toISOString())
  };
  
  // åŒæ­¥åˆ°GAS
  syncFileToGAS(fileData, (success)=>{
    setSubmitState('file', false);
    if(success){
      // æ›´æ–°æœ¬åœ°åˆ—è¡¨
      const index=appState.fileList.findIndex(f=>f.id===id);
      if(index>-1){
        appState.fileList[index]=fileData;
        showSuccess('æ–‡ä»¶æ›´æ–°æˆåŠŸï¼');
      }else{
        appState.fileList.push(fileData);
        showSuccess('æ–‡ä»¶æ–°å¢æˆåŠŸï¼');
      }
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderFileList();
      renderViewerFileList();
      
      // éšè—ç¼–è¾‘åŒºåŸŸï¼Œè¿”å›åˆ—è¡¨
      hideFileEditSection();
    }
  });
}

function deleteFile(id){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼'))return;
  
  // ä»æœ¬åœ°åˆ—è¡¨åˆ é™¤
  const index=appState.fileList.findIndex(f=>f.id===id);
  if(index===-1){
    showError('æ–‡ä»¶ä¸å­˜åœ¨');
    return;
  }
  
  // åŒæ­¥åˆ°GAS
  deleteFileFromGAS(id, (success)=>{
    if(success){
      appState.fileList.splice(index, 1);
      showSuccess('æ–‡ä»¶åˆªé™¤æˆåŠŸï¼');
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderFileList();
      renderViewerFileList();
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é¢„è§ˆçš„å†…å®¹ï¼Œéšè—é¢„è§ˆ
      if(appState.currentViewingId===id&&appState.currentViewingType==='file'){
        hideContentPreview();
      }
    }
  });
}

// åˆ‡æ¢åˆ—è¡¨æ˜¾ç¤ºï¼ˆç®¡ç†/æŸ¥çœ‹ï¼‰
function toggleVideoListSection(){
  const isVideoListVisible=!DOM.videoListSection.classList.contains('hidden');
  const isManage=isManageUser();
  
  // éšè—æ‰€æœ‰ç›¸å…³åŒºåŸŸ
  DOM.videoListSection.classList.add('hidden');
  DOM.videoViewerSection.classList.add('hidden');
  DOM.videoEditSection.classList.add('hidden');
  
  if(isVideoListVisible){
    // åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼
    if(isManage){
      DOM.manageVideoBtnContainer.classList.remove('hidden');
    }
    DOM.videoViewerSection.classList.remove('hidden');
  }else{
    // åˆ‡æ¢åˆ°ç®¡ç†æ¨¡å¼ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
    if(isManage){
      DOM.manageVideoBtnContainer.classList.add('hidden');
      DOM.videoListSection.classList.remove('hidden');
    }else{
      DOM.videoViewerSection.classList.remove('hidden');
    }
  }
}

function toggleFileListSection(){
  const isFileListVisible=!DOM.fileListSection.classList.contains('hidden');
  const isManage=isManageUser();
  
  // éšè—æ‰€æœ‰ç›¸å…³åŒºåŸŸ
  DOM.fileListSection.classList.add('hidden');
  DOM.fileViewerSection.classList.add('hidden');
  DOM.fileEditSection.classList.add('hidden');
  
  if(isFileListVisible){
    // åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼
    if(isManage){
      DOM.manageFileBtnContainer.classList.remove('hidden');
    }
    DOM.fileViewerSection.classList.remove('hidden');
  }else{
    // åˆ‡æ¢åˆ°ç®¡ç†æ¨¡å¼ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
    if(isManage){
      DOM.manageFileBtnContainer.classList.add('hidden');
      DOM.fileListSection.classList.remove('hidden');
    }else{
      DOM.fileViewerSection.classList.remove('hidden');
    }
  }
}

// åˆå§‹åŒ–DOMå…ƒç´ ç¼“å­˜
function initDOM(){
  // çŠ¶æ€ç›¸å…³
  DOM.status = document.getElementById('status');
  DOM.statusText = document.getElementById('status-text');
  
  // æç¤ºç›¸å…³
  DOM.errorMessage = document.getElementById('error-message');
  DOM.errorContent = document.getElementById('error-content');
  DOM.successMessage = document.getElementById('success-message');
  DOM.successContent = document.getElementById('success-content');
  
  // ç»Ÿè®¡ç›¸å…³
  DOM.resultCard = document.getElementById('result-card');
  DOM.resultMain = document.getElementById('result-main');
  DOM.resultDetails = document.getElementById('result-details');
  DOM.videoCountNum = document.getElementById('video-count-num');
  DOM.fileCountNum = document.getElementById('file-count-num');
  
  // å½±ç‰‡ç®¡ç†ç›¸å…³
  DOM.videoListSection = document.getElementById('video-list-section');
  DOM.videoListContainer = document.getElementById('video-list-container');
  DOM.emptyVideoList = document.getElementById('empty-video-list');
  DOM.emptyVideoTip = document.getElementById('empty-video-tip');
  DOM.manageVideoBtnContainer = document.getElementById('manage-video-btn-container');
  
  // æ–‡ä»¶ç®¡ç†ç›¸å…³
  DOM.fileListSection = document.getElementById('file-list-section');
  DOM.fileListContainer = document.getElementById('file-list-container');
  DOM.emptyFileList = document.getElementById('empty-file-list');
  DOM.emptyFileTip = document.getElementById('empty-file-tip');
  DOM.manageFileBtnContainer = document.getElementById('manage-file-btn-container');
  
  // å½±ç‰‡æŸ¥çœ‹ç›¸å…³
  DOM.videoViewerSection = document.getElementById('video-viewer-section');
  DOM.viewerVideoList = document.getElementById('viewer-video-list');
  DOM.viewerEmptyVideoList = document.getElementById('viewer-empty-video-list');
  
  // æ–‡ä»¶æŸ¥çœ‹ç›¸å…³
  DOM.fileViewerSection = document.getElementById('file-viewer-section');
  DOM.viewerFileList = document.getElementById('viewer-file-list');
  DOM.viewerEmptyFileList = document.getElementById('viewer-empty-file-list');
  
  // å½±ç‰‡ç¼–è¾‘ç›¸å…³
  DOM.videoEditSection = document.getElementById('video-edit-section');
  DOM.videoEditTitle = document.getElementById('video-edit-title');
  DOM.videoForm = document.getElementById('video-form');
  DOM.videoId = document.getElementById('video-id');
  DOM.videoName = document.getElementById('video-name');
  DOM.videoUrl = document.getElementById('video-url');
  DOM.videoNote = document.getElementById('video-note');
  DOM.videoSaveBtn = document.getElementById('video-save-btn');
  DOM.videoSaveBtnText = document.getElementById('video-save-btn-text');
  DOM.videoSaveLoading = document.getElementById('video-save-loading');
  
  // æ–‡ä»¶ç¼–è¾‘ç›¸å…³
  DOM.fileEditSection = document.getElementById('file-edit-section');
  DOM.fileEditTitle = document.getElementById('file-edit-title');
  DOM.fileForm = document.getElementById('file-form');
  DOM.fileId = document.getElementById('file-id');
  DOM.fileName = document.getElementById('file-name');
  DOM.fileUrl = document.getElementById('file-url');
  DOM.fileNote = document.getElementById('file-note');
  DOM.fileSaveBtn = document.getElementById('file-save-btn');
  DOM.fileSaveBtnText = document.getElementById('file-save-btn-text');
  DOM.fileSaveLoading = document.getElementById('file-save-loading');
  
  // é¢„è§ˆç›¸å…³
  DOM.contentPreview = document.getElementById('content-preview');
  DOM.previewTitle = document.getElementById('preview-title');
  DOM.previewUpdated = document.getElementById('preview-updated');
  DOM.previewNote = document.getElementById('preview-note');
  DOM.previewActionBtns = document.getElementById('preview-action-btns');
  DOM.previewEditBtn = document.getElementById('preview-edit-btn');
  DOM.previewDeleteBtn = document.getElementById('preview-delete-btn');
  
  // è§†é¢‘é¢„è§ˆç›¸å…³
  DOM.videoContainer = document.getElementById('video-container');
  DOM.previewVideo = document.getElementById('preview-video');
  DOM.unsupportedTip = document.getElementById('unsupported-tip');
  
  // æ–‡ä»¶é¢„è§ˆç›¸å…³
  DOM.filePreviewTip = document.getElementById('file-preview-tip');
  DOM.filePreviewName = document.getElementById('file-preview-name');
  DOM.filePreviewBtn = document.getElementById('file-preview-btn');
}

// åˆå§‹åŒ–LIFFå’Œåº”ç”¨
async function initApp(){
  try{
    // åˆå§‹åŒ–DOMç¼“å­˜
    initDOM();
    
    // åˆå§‹åŒ–LIFF
    setStatus('åˆå§‹åŒ–LIFF...');
    await liff.init({ liffId: CONFIG.LIFF_ID });
    
    // æ£€æŸ¥æ˜¯å¦ç™»å½•
    if(!liff.isLoggedIn()){
      setStatus('è«‹å…ˆç™»å…¥...');
      liff.login();
      return;
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    appState.currentUser = {
      userId: liff.getDecodedIDToken()?.sub || liff.getUserId(),
      displayName: liff.getProfile()?.displayName || 'æœªçŸ¥ç”¨æˆ¶'
    };
    
    // éªŒè¯ç”¨æˆ·æƒé™
    await verifyUserPermission();
    
    // åŠ è½½æ•°æ®
    await Promise.all([
      fetchVideoListFromGAS(),
      fetchFileListFromGAS()
    ]);
    
    // éšè—åŠ è½½çŠ¶æ€
    DOM.status.classList.add('hidden');
    
    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œæƒé™å¯¹åº”ç•Œé¢
    const expiryInfo = calculateRemainingDaysByDate(appState.userExpiryInfo.expiryDate);
    DOM.resultMain.textContent = `${appState.currentUser.displayName || 'ç”¨æˆ¶'} (${appState.userRole === 'admin' ? 'ç®¡ç†å“¡' : appState.userRole === 'pro' ? 'Proç”¨æˆ¶' : 'æ™®é€šç”¨æˆ¶'})`;
    DOM.resultDetails.innerHTML = `
      <p>æœ‰æ•ˆæœŸï¼š${expiryInfo.displayDate}</p>
      <p>å‰©é¤˜å¤©æ•¸ï¼š${expiryInfo.remainingDays}</p>
    `;
    DOM.resultCard.classList.remove('hidden');
    
    // æ ¹æ®æƒé™æ˜¾ç¤ºå¯¹åº”ç•Œé¢
    if(isManageUser()){
      // ç®¡ç†å‘˜æ˜¾ç¤ºç®¡ç†åˆ—è¡¨
      DOM.videoListSection.classList.remove('hidden');
      DOM.fileListSection.classList.remove('hidden');
      DOM.manageVideoBtnContainer.classList.remove('hidden');
      DOM.manageFileBtnContainer.classList.remove('hidden');
      renderVideoList();
      renderFileList();
    }else{
      // æ™®é€šç”¨æˆ·/Proç”¨æˆ·æ˜¾ç¤ºæŸ¥çœ‹åˆ—è¡¨
      DOM.videoViewerSection.classList.remove('hidden');
      DOM.fileViewerSection.classList.remove('hidden');
      renderViewerVideoList();
      renderViewerFileList();
    }
    
    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
    updateContentCountDisplay();
    
  }catch(error){
    console.error('åˆå§‹åŒ–å¤±æ•—ï¼š', error);
    showError(error.message || 'æ‡‰ç”¨åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<title>ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0"/>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
tailwind.config={theme:{extend:{colors:{
  primary:'#008C76',secondary:'#E8F9F7',accent:'#FFD700',gold:'#D4AF37',
  darkGold:'#B8860B',dark:'#1A202C',lightBg:'#F9FAFB',neutral:'#F3F4F6',
  cardBg:'#FFFFFF',textPrimary:'#1E293B',textSecondary:'#64748B',
  premiumBg:'#FFF8E6',premiumBorder:'#FFE082'
},fontFamily:{
  sans:['Noto Sans TC','sans-serif','system-ui'],
  display:['Noto Sans TC','sans-serif','system-ui']
},boxShadow:{
  'elevation-1':'0 2px 8px rgba(0,0,0,0.06)',
  'elevation-2':'0 4px 16px rgba(0,0,0,0.08)',
  'elevation-3':'0 8px 24px rgba(0,0,0,0.12)',
  'gold-hover':'0 4px 15px rgba(212, 175, 55, 0.25)',
  'primary-hover':'0 4px 15px rgba(0, 140, 118, 0.25)'
}}}};
</script>
<style type="text/tailwindcss">
@layer utilities{
  .fade-in{animation:fadeIn 0.6s cubic-bezier(0.4,0,0.2,1);}
  .pulse-subtle{animation:pulseSubtle 2s infinite;}
  .gradient-text{background-clip:text;-webkit-background-clip:text;color:transparent;}
  .slide-in{animation:slideIn 0.4s cubic-bezier(0.4,0,0.2,1);}
  .scale-in{animation:scaleIn 0.3s cubic-bezier(0.4,0,0.2,1);}
  .slide-up{animation:slideUp 0.3s ease-out;}
  .content-transition{transition:all 0.3s ease-in-out;}
  .gold-gradient{background:linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);}
  .primary-gradient{background:linear-gradient(135deg, #008C76 0%, #00A88D 100%);}
  .text-gold-gradient{background:linear-gradient(135deg, #B8860B 0%, #FFD700 100%);-webkit-background-clip:text;background-clip:text;color:transparent;}
}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes pulseSubtle{0%,100%{opacity:1;}50%{opacity:0.8;}}
@keyframes slideIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes scaleIn{from{transform:scale(0.95);opacity:0;}to{transform:scale(1);opacity:1;}}
@keyframes slideUp{from{transform:translateY(10px);opacity:0;}to{transform:translateY(0);opacity:1;}}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:#F1F5F9;border-radius:3px;}
::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:#94A3B8;}
body{font-feature-settings:"palt";letter-spacing:0.02em;background-color:#F5F7FA;}
.video-container,.audio-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;background-color:#0F172A;box-shadow:0 4px 20px rgba(0,0,0,0.15);}
.video-container{min-height:320px;}
.audio-container{padding-bottom:280px;min-height:280px;}
@media (max-width: 640px) {
  .audio-container {padding-bottom: 260px;min-height: 260px;}
  .video-container {min-height: 280px;}
}
@media (min-width: 641px) and (max-width: 1024px) {
  .audio-container {padding-bottom: 270px;min-height: 270px;}
  .video-container {min-height: 300px;}
}
@media (min-width: 1025px) {
  .audio-container {padding-bottom: 300px;min-height: 300px;}
  .video-container {min-height: 350px;}
}
.video-item{transition:all 0.3s ease;cursor:grab;border-radius:10px;}
.video-item:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.video-item.dragging{opacity:0.5;border:2px dashed #008C76;cursor:grabbing;}
.video-item.pro-user{cursor:pointer;}
.video-item.pro-user:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.drop-zone{border:2px dashed #008C76 !important;background-color:#E8F9F7 !important;}
.thumbnail-container{width:80px;height:50px;border-radius:6px;overflow:hidden;background:#f1f1f1;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.thumbnail-img{width:100%;height:100%;object-fit:cover;}
.viewer-card{transition:all 0.4s ease;border-radius:12px;overflow:hidden;}
.viewer-card:hover{transform:translateY(-5px);box-shadow:0 12px 25px rgba(0,0,0,0.12);}
.watch-btn{padding:8px 16px !important;font-size:14px !important;font-weight:600 !important;border-radius:8px !important;transition:all 0.3s ease !important;}
.watch-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0, 140, 118, 0.2) !important;}
.mobile-btn{min-height:48px !important;padding:12px 20px !important;font-size:16px !important;border-radius:12px !important;font-weight:600 !important;transition:all 0.3s ease !important;position:relative;overflow:hidden;}
.mobile-btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);transition:all 0.6s ease;}
.mobile-btn:hover::after{left:100%;}
.mobile-btn-sm{min-height:40px !important;padding:8px 16px !important;font-size:15px !important;border-radius:10px !important;font-weight:600 !important;transition:all 0.3s ease !important;}
.video-container iframe, .audio-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;opacity:0;transition:opacity 0.3s ease;border-radius:12px;}
.video-container iframe.loaded, .audio-container iframe.loaded{opacity:1;}
.btn-disabled{opacity:0.7;cursor:not-allowed;pointer-events:none;}
.dropdown-menu {
  @apply absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-elevation-2 border border-gray-100 z-50 content-transition rounded-xl overflow-hidden;
}
.dropdown-item {
  @apply block px-4 py-3 text-sm text-gray-700 hover:bg-primary/5 hover:text-primary cursor-pointer transition-colors font-medium;
}
.dropdown-item:hover {
  background:linear-gradient(135deg, #008C76 0%, #00A88D 100%);
  color:white !important;
}
.premium-badge{
  background:linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
  color:white;
  font-weight:bold;
  padding:2px 8px;
  border-radius:20px;
  font-size:11px;
  box-shadow:0 2px 8px rgba(212, 175, 55, 0.3);
}
.content-selector {
  @apply w-full bg-white border border-gray-200 rounded-xl p-3 text-textPrimary font-medium mb-4 shadow-elevation-1;
}
.content-selector select {
  @apply w-full border-none outline-none bg-transparent text-textPrimary font-medium text-base;
}
.content-display-card {
  @apply bg-cardBg rounded-xl overflow-hidden shadow-elevation-1 slide-up mb-4;
}
</style>
</head>
<body class="bg-lightBg min-h-screen flex flex-col p-2 md:p-4 pt-6 pb-6">
<div class="max-w-5xl w-full bg-cardBg rounded-2xl shadow-elevation-2 overflow-hidden fade-in self-center border border-gray-100">
  <div class="bg-gradient-to-r from-primary to-[#006658] p-4 md:p-6 text-white text-center relative overflow-hidden">
    <div class="absolute top-0 left-0 w-24 h-24 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/3"></div>
    <div class="absolute bottom-0 right-0 w-32 h-32 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3"></div>
    <div class="relative z-10">
      <div class="inline-flex items-center justify-center w-14 h-14 bg-white/10 backdrop-blur-sm rounded-full mb-3 pulse-subtle border border-white/20">
        <i class="fa fa-film text-2xl text-accent"></i>
      </div>
      <h1 class="text-2xl md:text-3xl font-bold mb-1 tracking-wide"> ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </h1>
      <p class="text-white/90 text-sm md:text-base font-light">å½¥å½¬_å¹¸ç¦ç³»çµ± <span class="text-accent font-medium">å°Šçˆµç”¨æˆ¶å°ˆå±¬</span></p>
    </div>
  </div>
  <div class="p-3 md:p-5">
    <div id="status" class="flex items-center justify-center py-8 text-textPrimary text-center">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-primary mb-3"></div>
        <p id="status-text" class="text-base font-medium">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±ï¼Œè«‹ç¨å€™...</p>
      </div>
    </div>
    <div id="error-message" class="hidden bg-red-50 border border-red-100 text-red-700 px-4 py-4 rounded-xl mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-exclamation-circle text-red-500 mt-1 mr-2 text-lg"></i>
        <div id="error-content" class="text-sm"></div>
      </div>
    </div>
    <div id="success-message" class="hidden bg-green-50 border border-green-100 text-green-700 px-4 py-4 rounded-xl mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-check-circle text-green-500 mt-1 mr-2 text-lg"></i>
        <div id="success-content" class="text-sm"></div>
      </div>
    </div>
    <div id="result-card" class="hidden bg-gradient-to-r from-premiumBg to-[#FFFAF0] border border-premiumBorder rounded-2xl p-5 mb-5 text-center fade-in relative overflow-hidden shadow-elevation-1">
      <div class="absolute top-0 right-0 w-20 h-20 bg-gold/5 rounded-full translate-x-1/2 -translate-y-1/2"></div>
      <div class="absolute bottom-0 left-0 w-16 h-16 bg-primary/5 rounded-full -translate-x-1/2 translate-y-1/2"></div>
      <div class="relative z-10">
        <div class="inline-block mb-3">
          <div class="gold-gradient w-16 h-16 rounded-full flex items-center justify-center shadow-gold-hover">
            <i class="fa fa-crown text-white text-2xl"></i>
          </div>
        </div>
        <div id="result-main" class="text-xl md:text-2xl font-bold mb-3 text-textPrimary text-gold-gradient"></div>
        <div id="result-details" class="text-sm text-textSecondary space-y-2 md:space-y-2">
          <div class="flex items-center justify-center">
            <span class="premium-badge mr-2">å°Šçˆµ</span>
            <span id="user-role-display" class="font-medium"></span>
          </div>
          <div id="user-name-display" class="hidden">
            <i class="fa fa-user text-primary mr-1"></i> <span class="font-medium">ä½¿ç”¨è€…ï¼š</span> <span id="user-name"></span>
          </div>
          <div id="user-expiry-display" class="hidden">
            <i class="fa fa-calendar text-primary mr-1"></i> <span class="font-medium">ä½¿ç”¨æœŸé™ï¼š</span> <span id="expiry-date"></span> (<span id="remaining-days"></span>)
          </div>
        </div>
        <div id="content-count-display" class="mt-4 text-base font-semibold text-primary bg-white/50 rounded-lg py-2 px-4 inline-block">
          <i class="fa fa-play-circle mr-1"></i> å½±éŸ³æ•¸ï¼š<span id="video-count-num">0</span> | 
          <i class="fa fa-file mr-1"></i> æ–‡ä»¶æ•¸ï¼š<span id="file-count-num">0</span>
        </div>
        <div class="w-24 h-1 bg-gradient-to-r from-gold to-primary mx-auto my-4 rounded-full"></div>
      </div>
    </div>
    
    <div class="relative mb-5">
      <button id="content-type-toggle" class="mobile-btn w-full primary-gradient text-white text-sm font-medium px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-between border-none">
        <span id="current-content-type" class="font-semibold">å½±éŸ³åˆ—è¡¨</span>
        <i class="fa fa-chevron-down text-sm"></i>
      </button>
      <div id="content-type-dropdown" class="dropdown-menu hidden">
        <div class="dropdown-item" onclick="switchContentType('video')">
          <i class="fa fa-play-circle mr-2"></i>å½±éŸ³åˆ—è¡¨
        </div>
        <div class="dropdown-item" onclick="switchContentType('file')">
          <i class="fa fa-file mr-2"></i>æ–‡ä»¶åˆ—è¡¨
        </div>
      </div>
    </div>
    
    <div id="content-viewer-section" class="hidden bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="viewer-section-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å½±éŸ³åˆ—è¡¨
        </h2>
        <div id="manage-content-btn-container" class="flex gap-2">
          <button onclick="toggleManageSection()" class="mobile-btn-sm primary-gradient text-white text-sm font-medium px-4 py-2 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center gap-1">
            <i class="fa fa-cog text-sm"></i> å…§å®¹ç®¡ç†
          </button>
        </div>
      </div>
      
      <div class="content-selector" id="content-select-container">
        <select id="content-select" class="w-full" onchange="selectContent(this.value)">
          <option value="">è«‹é¸æ“‡è¦æŸ¥çœ‹çš„å…§å®¹...</option>
        </select>
      </div>
      
      <div id="selected-content-display" class="hidden">
        <div class="content-display-card" id="viewer-content-card"></div>
      </div>
      
      <div id="viewer-empty-list" class="py-10 text-center text-textSecondary hidden">
        <div class="inline-block gold-gradient w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-gold-hover">
          <i class="fa fa-film text-white text-2xl"></i>
        </div>
        <p id="viewer-empty-text" class="text-lg font-medium">æš«ç„¡å¯æŸ¥çœ‹çš„å½±éŸ³</p>
        <p class="text-xs mt-2 text-textSecondary/70">è«‹è¯ç¹«ç®¡ç†å“¡æ·»åŠ å…§å®¹</p>
      </div>
    </div>
    
    <div id="content-manage-section" class="bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1 hidden">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
        <h2 id="manage-section-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-th-list text-primary mr-2 text-sm"></i> å½±éŸ³ç®¡ç†åˆ—è¡¨
        </h2>
        <!-- ä¿®æ”¹ï¼šå…§å®¹ç®¡ç†ä¸‹æ‹‰é¸å–® -->
        <div id="manage-action-buttons" class="w-full">
          <!-- ç¬¬ä¸€è¡Œï¼šå…§å®¹é¸æ“‡ä¸‹æ‹‰é¸å–® -->
          <div class="mb-3">
            <div class="content-selector">
              <select id="manage-content-select" class="w-full" onchange="selectManageContent(this.value)">
                <option value="">è«‹é¸æ“‡è¦ç®¡ç†çš„å…§å®¹...</option>
              </select>
            </div>
          </div>
          
          <!-- ç¬¬äºŒè¡Œï¼šæ“ä½œæŒ‰éˆ• -->
          <div class="flex gap-2 w-full">
            <button id="manage-content-type-toggle" class="mobile-btn-sm bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium flex items-center gap-1 px-4 py-2 rounded-xl shadow-elevation-1 transition-all duration-300 flex-1">
              <i class="fa fa-th-list text-sm"></i> 
              <span id="manage-current-type">å½±éŸ³</span>
              <i class="fa fa-chevron-down text-xs ml-1"></i>
            </button>
            <div id="manage-content-type-dropdown" class="dropdown-menu hidden"></div>
            
            <button id="add-content-btn" onclick="addNewContent()" class="mobile-btn primary-gradient text-white text-sm font-medium flex-1 px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1">
              <i class="fa fa-plus text-lg"></i> æ–°å¢å½±éŸ³
            </button>
            <button onclick="toggleManageSection()" class="mobile-btn bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium flex-1 px-6 py-3 rounded-xl shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
              <i class="fa fa-arrow-left text-lg"></i> è¿”å›
            </button>
          </div>
        </div>
      </div>
      
      <!-- å–®ç­†å…§å®¹é¡¯ç¤ºå€åŸŸ -->
      <div id="single-content-display" class="hidden bg-cardBg rounded-xl p-4 shadow-elevation-1 mb-4">
        <div class="flex items-center justify-between mb-3">
          <h3 id="single-content-title" class="font-bold text-white text-xs px-4 py-2 rounded-xl bg-gradient-to-r from-black/90 to-gray-800/90 shadow-lg shadow-black/20 border border-gray-700/50 backdrop-blur-sm tracking-wide"></h3>
          <div class="flex gap-2">
            <button id="edit-single-btn" onclick="editSelectedContent()" class="p-2 px-3 text-white bg-gold/90 hover:bg-gold rounded-full hover:shadow-lg hover:shadow-gold/20 transition-all duration-300 flex items-center gap-1">
              <i class="fa fa-pencil text-base"></i>
              <span class="text-xs">ç·¨è¼¯</span>
            </button>
            <button id="delete-single-btn" onclick="deleteSelectedContent()" class="p-2 px-3 text-white bg-red-600 hover:bg-red-700 rounded-full hover:shadow-lg hover:shadow-red-200 transition-all duration-300 flex items-center gap-1">
              <i class="fa fa-trash text-base"></i>
              <span class="text-xs">åˆªé™¤</span>
            </button>
          </div>
        </div>
        
        <div id="single-content-note" class="bg-white/80 backdrop-blur-sm rounded-xl p-3 mb-3 shadow-md border border-gray-100 whitespace-pre-wrap break-words hidden">
          <p class="text-textSecondary text-sm leading-relaxed"></p>
        </div>
        
        <div id="single-content-updated" class="text-xs text-white bg-gradient-to-r from-gray-800/90 to-black/90 px-3 py-1 rounded-xl shadow-md border border-gray-700/50 inline-block"></div>
      </div>
      
      <!-- ç©ºåˆ—è¡¨æç¤º -->
      <div id="empty-manage-list" class="py-8 text-center text-textSecondary hidden">
        <div class="inline-block gold-gradient w-14 h-14 rounded-full flex items-center justify-center mb-3 shadow-gold-hover">
          <i class="fa fa-film text-white text-xl"></i>
        </div>
        <p id="empty-manage-text" class="text-base font-medium">å°šæœªæ·»åŠ ä»»ä½•å½±éŸ³</p>
        <p id="empty-manage-tip" class="text-xs mt-2">é»æ“Šã€Œæ–°å¢å½±éŸ³ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ </p>
      </div>
      
      <!-- éš±è—åŸæœ‰çš„åˆ—è¡¨å®¹å™¨ -->
      <div id="video-list-container" class="hidden"></div>
      <div id="file-list-container" class="hidden"></div>
    </div>
    
    <div id="video-edit-section" class="hidden bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="video-edit-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢å½±éŸ³
        </h2>
        <button onclick="hideVideoEditSection()" class="text-textSecondary hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/5 shadow-sm">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="video-form" onsubmit="saveVideo(event)">
        <input type="hidden" id="video-id" value="">
        <div class="space-y-4">
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> å½±éŸ³åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="video-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥å½±éŸ³åç¨±" required>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-link text-primary mr-2 text-xs"></i> è¦–é »/æ’­å®¢éˆæ¥ <span class="text-red-500">*</span>
            </label>
            <input type="url" id="video-url" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥YouTubeã€é¨°è¨Šè¦–é »ã€Spotifyã€Podcastæœ‰æ•ˆç¶²å€" required>
            <p class="text-xs text-textSecondary mt-1 bg-white/80 p-2 rounded-lg">
              <i class="fa fa-lightbulb-o text-accent mr-1"></i> æ”¯æ´YouTubeã€é¨°è¨Šè¦–é »ã€Spotifyã€Apple Podcastã€å„å¤§æ’­å®¢å¹³å°éˆæ¥
            </p>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="video-note" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm shadow-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-2 flex gap-3">
            <button type="button" onclick="hideVideoEditSection()" class="mobile-btn-sm w-1/3 bg-gray-100 hover:bg-gray-200 text-textPrimary font-medium px-3 py-2 rounded-xl transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="video-save-btn" class="mobile-btn-sm w-2/3 primary-gradient text-white font-medium px-3 py-2 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="video-save-btn-text">å„²å­˜å½±éŸ³</span>
              <div id="video-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    
    <div id="file-edit-section" class="hidden bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="file-edit-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢æ–‡ä»¶
        </h2>
        <button onclick="hideFileEditSection()" class="text-textSecondary hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/5 shadow-sm">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="file-form" onsubmit="saveFile(event)">
        <input type="hidden" id="file-id-hidden" value="">
        <div class="space-y-4">
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> æ–‡ä»¶åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="file-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥æ–‡ä»¶åç¨±" required>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-link text-primary mr-2 text-xs"></i> æ–‡ä»¶éˆæ¥ <span class="text-red-500">*</span>
            </label>
            <input type="url" id="file-id" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥æ–‡ä»¶æœ‰æ•ˆç¶²å€" required>
            <p class="text-xs text-textSecondary mt-1 bg-white/80 p-2 rounded-lg">
              <i class="fa fa-lightbulb-o text-accent mr-1"></i> æ”¯æ´PDFã€Wordã€Excelç­‰å„é¡æ–‡ä»¶éˆæ¥
            </p>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="file-note" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm shadow-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-2 flex gap-3">
            <button type="button" onclick="hideFileEditSection()" class="mobile-btn-sm w-1/3 bg-gray-100 hover:bg-gray-200 text-textPrimary font-medium px-3 py-2 rounded-xl transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="file-save-btn" class="mobile-btn-sm w-2/3 primary-gradient text-white font-medium px-3 py-2 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="file-save-btn-text">å„²å­˜æ–‡ä»¶</span>
              <div id="file-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    
    <div id="content-preview" class="hidden bg-cardBg rounded-2xl p-3 md:p-5 mb-5 scale-in border border-primary/20 shadow-elevation-2">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å…§å®¹é è¦½
        </h2>
        <div id="preview-action-btns" class="flex gap-2 hidden">
          <button id="preview-edit-btn" onclick="editCurrentContent()" class="mobile-btn-sm gold-gradient text-white text-sm font-medium flex items-center gap-1 px-3 py-2 rounded-xl shadow-gold-hover">
            <i class="fa fa-pencil text-sm"></i> ç·¨è¼¯
          </button>
          <button id="preview-delete-btn" onclick="event.stopPropagation();deleteCurrentContent()" class="mobile-btn-sm bg-red-500 hover:bg-red-600 text-white text-sm font-medium flex items-center gap-1 px-3 py-2 rounded-xl shadow-md">
            <i class="fa fa-trash text-sm"></i> åˆªé™¤
          </button>
          <button onclick="hideContentPreview()" class="text-textSecondary hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/5 shadow-sm">
            <i class="fa fa-times-circle text-lg"></i>
          </button>
        </div>
      </div>
      <div id="preview-content" class="space-y-4">
        <h3 id="preview-title" class="text-sm md:text-base font-semibold text-textPrimary text-center mb-3 text-gold-gradient"></h3>
        <div id="preview-container" class="mb-4">
          <!-- é è¦½å…§å®¹å°‡é€šéJSå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div class="flex justify-center mt-3">
          <button onclick="hideContentPreview()" class="mobile-btn bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium px-6 py-3 rounded-xl flex items-center justify-center gap-1 shadow-sm">
            <i class="fa fa-arrow-left text-sm"></i> è¿”å›åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// é…ç½®å¸¸é‡
const CONFIG={
  LIFF_ID:"2008578880-cOBTYud0",
  GAS_URL:"https://script.google.com/macros/s/AKfycbyZMHC4c3QRgBnjFX3-4S1wI8-9x1519SQwwwxom8oDRupOpysz0SOlU4jO40frncXoIg/exec",
  JSONP_TIMEOUT:10000,
  PERMANENT_EXPIRY_DATE:"9999/12/31",
  STORAGE_KEY_PREFIX:"yanbin_video_manager_",
  currentContentType: 'video',
  CACHE_DURATION: 24 * 60 * 60 * 1000
};

// æ‡‰ç”¨ç‹€æ…‹
let appState={
  currentUser:null,videoList:[],fileList:[],currentViewingId:null,
  currentViewingType:null,currentEditingVideoId:null,currentEditingFileId:null,
  isSubmitting:false,draggingItem:null,userRole:'',
  userExpiryInfo:{remainingDays:0,expiryDate:''},
  userNickname:'',
  selectedContentId:'',
  selectedManageContentId: '' // æ–°å¢ï¼šç•¶å‰é¸æ“‡çš„ç®¡ç†å…§å®¹ID
};

// å·¥å…·å‡½æ•¸
const DOM=(id)=>document.getElementById(id);
const convertUTCToTaiwanTime=(utcStr)=>{
  const options={timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'};
  return utcStr ? new Date(utcStr).toLocaleString('zh-TW',options) : new Date().toLocaleString('zh-TW',options);
};
const setStatus=(text)=>{const el=DOM('status-text');if(el)el.textContent=text;};
const resetSubmitState=()=>{setVideoSubmitState(false);setFileSubmitState(false);};

// ç·©å­˜ç®¡ç†å‡½æ•¸
const getCachedAuthData = (userId) => {
  try {
    const cacheKey = `${CONFIG.STORAGE_KEY_PREFIX}auth_${userId}`;
    const cached = localStorage.getItem(cacheKey);
    if (!cached) return null;
    
    const parsed = JSON.parse(cached);
    if (Date.now() - parsed.timestamp > CONFIG.CACHE_DURATION) {
      localStorage.removeItem(cacheKey);
      return null;
    }
    return parsed.data;
  } catch (e) {
    console.error('è®€å–ç·©å­˜å¤±æ•—:', e);
    return null;
  }
};

const setCachedAuthData = (userId, authData) => {
  try {
    const cacheKey = `${CONFIG.STORAGE_KEY_PREFIX}auth_${userId}`;
    localStorage.setItem(cacheKey, JSON.stringify({
      timestamp: Date.now(),
      data: authData
    }));
  } catch (e) {
    console.error('ä¿å­˜ç·©å­˜å¤±æ•—:', e);
  }
};

// æç¤ºè¨Šæ¯è™•ç†
const showError=(msg)=>{
  const hideEls=[DOM('status'),DOM('result-card'),DOM('content-viewer-section'),
    DOM('content-manage-section'),DOM('video-edit-section'),DOM('file-edit-section'),
    DOM('content-preview'),DOM('success-message')];
  hideEls.forEach(el=>el&&el.classList.add('hidden'));
  const errorEl=DOM('error-message'), contentEl=DOM('error-content');
  if(errorEl&&contentEl){
    contentEl.innerHTML=`<p class="font-medium text-lg">${msg}</p>
<div class="mt-2 flex justify-center gap-3">
  <button 
    onclick="window.location.href = 'https://lihi.cc/DLihS'" 
    class="text-primary hover:text-[#007A69] font-medium text-base px-6 py-3 rounded-lg bg-white border border-primary/20 hover:bg-primary/5 transition-all duration-300 flex items-center gap-2 shadow-sm hover:shadow-md"
  >
    <i class="fa fa-user-circle"></i> è¯ç¹«<br>å½¥å½¬
  </button>
  <button 
    onclick="window.location.reload()" 
    class="text-primary hover:text-[#007A69] font-medium text-base px-6 py-3 rounded-lg bg-white border border-primary/20 hover:bg-primary/5 transition-all duration-300 flex items-center gap-2 shadow-sm hover:shadow-md"
  >
    <i class="fa fa-refresh"></i> é‡æ–°<br>åŠ è¼‰
  </button>
</div>`;
    errorEl.classList.remove('hidden');
  }
  resetSubmitState();
};

const showSuccess=(msg)=>{
  const errorEl=DOM('error-message');
  if(errorEl)errorEl.classList.add('hidden');
  const successEl=DOM('success-message'), contentEl=DOM('success-content');
  if(successEl&&contentEl){
    contentEl.innerHTML=`<p class="font-medium">${msg}</p>`;
    successEl.classList.remove('hidden');
    setTimeout(()=>successEl&&successEl.classList.add('hidden'),4000);
  }
};

// æäº¤ç‹€æ…‹ç®¡ç†
const setSubmitState=(type,isSubmitting)=>{
  appState.isSubmitting=isSubmitting;
  let saveBtn, saveBtnText, saveLoading, btnText;
  if(type==='video'){
    saveBtn=DOM('video-save-btn');
    saveBtnText=DOM('video-save-btn-text');
    saveLoading=DOM('video-save-loading');
    btnText=appState.currentEditingVideoId?"æ›´æ–°å½±éŸ³":"å„²å­˜å½±éŸ³";
  }else{
    saveBtn=DOM('file-save-btn');
    saveBtnText=DOM('file-save-btn-text');
    saveLoading=DOM('file-save-loading');
    btnText=appState.currentEditingFileId?"æ›´æ–°æ–‡ä»¶":"å„²å­˜æ–‡ä»¶";
  }
  if(isSubmitting){
    saveBtn&&saveBtn.classList.add('btn-disabled');
    saveBtnText&&(saveBtnText.textContent="å„²å­˜ä¸­...");
    saveLoading&&saveLoading.classList.remove('hidden');
  }else{
    saveBtn&&saveBtn.classList.remove('btn-disabled');
    saveBtnText&&(saveBtnText.textContent=btnText);
    saveLoading&&saveLoading.classList.add('hidden');
  }
};
const setVideoSubmitState=(isSubmitting)=>setSubmitState('video',isSubmitting);
const setFileSubmitState=(isSubmitting)=>setSubmitState('file',isSubmitting);

// URLè™•ç†å·¥å…·
const urlCheckers = {
  isYoutube: (url) => url && (url.toLowerCase().includes('youtube.com') || url.toLowerCase().includes('youtu.be') || url.toLowerCase().includes('youtube-nocookie.com')),
  isTencent: (url) => url && url.toLowerCase().includes('v.qq.com'),
  isSpotify: (url) => url && (url.toLowerCase().includes('spotify.com') || url.toLowerCase().includes('open.spotify.com')),
  isApplePodcast: (url) => url && (url.toLowerCase().includes('podcasts.apple.com') || url.toLowerCase().includes('itunes.apple.com/podcast')),
  isPodcast: (url) => url && ['podcast','pca.st','soundcloud.com','anchor.fm','mixcloud.com','castbox.fm','player.fm','listennotes.com'].some(d => url.toLowerCase().includes(d)),
  isValidUrl: (url) => {try{new URL(url);return true;}catch(e){return false;}}
};

// è½‰æ›åµŒå…¥URL
const convertToEmbedUrl=(url)=>{
  if(!url) return {type: 'unsupported', url: ''};
  
  if(urlCheckers.isYoutube(url)){
    const match=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/|live\/|playlist\?list=)|youtube-nocookie\.com\/embed\/)([\w-]+)/);
    if(match&&match[1]){
      const isShort=url.includes('shorts/');
      return {type: 'video',url: `https://www.youtube.com/embed/${match[1]}?autoplay=0&rel=0${isShort?'&enablejsapi=1':''}`};
    }
    const vidMatch = url.match(/[?&]v=([^&]+)/);
    if(vidMatch&&vidMatch[1]) return {type: 'video',url: `https://www.youtube.com/embed/${vidMatch[1]}?autoplay=0&rel=0`};
  }
  
  else if(urlCheckers.isTencent(url)){
    const regs=[/v\.qq\.com\/x\/page\/([a-zA-Z0-9_]+)\.html/,/v\.qq\.com\/x\/cover\/([a-zA-Z0-9_]+)\/([a-zA-Z0-9_]+)\.html/,
      /v\.qq\.com\/detail\/\w+\/([a-zA-Z0-9_]+)\.html/,/vid=([a-zA-Z0-9_]+)/];
    let vid='';
    for(let reg of regs){const match=url.match(reg);if(match){vid=match[2]||match[1]||'';break;}}
    if(vid)return {type: 'video',url: `https://v.qq.com/txp/iframe/player.html?vid=${vid}&auto=0&show1080p=1`};
  }
  
  else if(urlCheckers.isSpotify(url)){
    const match=url.match(/spotify\.com\/(track|episode|playlist|album|show)\/([a-zA-Z0-9]+)/);
    if(match&&match[2]){
      return {type: 'audio',url: `https://open.spotify.com/embed/${match[1]}/${match[2]}?utm_source=generator&autoplay=0`};
    }
    const idMatch=url.match(/[a-zA-Z0-9]{22}/);
    if(idMatch) return {type: 'audio',url: `https://open.spotify.com/embed/track/${idMatch[0]}?utm_source=generator&autoplay=0`};
  }
  
  else if(urlCheckers.isApplePodcast(url)){
    const showMatch=url.match(/podcasts\.apple\.com\/.+\/podcast\/.+\/id(\d+)/);
    if(showMatch&&showMatch[1]){
      return {type: 'audio',url: `https://embed.podcasts.apple.com/us/podcast/id${showMatch[1]}?itsct=podcast_box&itscg=30200`};
    }
    const episodeMatch=url.match(/\/id(\d+)\?i=(\d+)/);
    if(episodeMatch&&episodeMatch[2]){
      return {type: 'audio',url: `https://embed.podcasts.apple.com/us/podcast/id${episodeMatch[1]}?i=${episodeMatch[2]}&itsct=podcast_box&itscg=30200`};
    }
  }
  
  else if(urlCheckers.isPodcast(url)){
    if(url.includes('soundcloud.com')){
      const match = url.match(/soundcloud\.com\/([^\/]+)\/([^\/]+)/);
      if(match) return {type: 'audio', url: `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&visual=true`};
    }
    else if(url.includes('anchor.fm')){
      const match = url.match(/anchor\.fm\/([^\/]+)\/episodes\/([^\/]+)/);
      if(match) return {type: 'audio', url: `https://anchor.fm/${match[1]}/embed/episodes/${match[2]}?color=blue&autoplay=false`};
    }
    return {type: 'audio', url: url};
  }
  
  try {
    const urlObj = new URL(url);
    const videoDomains = ['facebook.com', 'fb.watch', 'instagram.com', 'tiktok.com', 'douyin.com', 'bilibili.com', 'iqiyi.com', 'youku.com'];
    if(videoDomains.some(domain => urlObj.host.includes(domain))){
      return {type: 'video', url: url};
    }
  } catch(e) {}
  
  return {type: 'unsupported', url: url};
};

// è¨ˆç®—å‰©é¤˜å¤©æ•¸
const calculateRemainingDaysByDate=(expiryDateStr)=>{
  try{
    if(expiryDateStr===CONFIG.PERMANENT_EXPIRY_DATE)return{displayDate:"æ°¸ä¹…æœ‰æ•ˆ",remainingDays:"æ°¸ä¹…æœ‰æ•ˆ"};
    if(!/^\d{4}[-\/]\d{2}[-\/]\d{2}(?:\s+\d{1,2}:\d{1,2}(?::\d{1,2})?)?$/.test(expiryDateStr)){
      return{displayDate:"æ ¼å¼éŒ¯èª¤",remainingDays:"æ ¼å¼éŒ¯èª¤"};
    }
    const normalized=expiryDateStr.replace(/-/g,'/');
    let expiryDate;
    if(normalized.includes(' ')){
      const [datePart,timePart]=normalized.split(' ');
      const [y,m,d]=datePart.split('/').map(Number);
      const [h,mi,s]=timePart.split(':').map(Number);
      expiryDate=new Date(Date.UTC(y,m-1,d,h||0,mi||0,s||0));
    }else{
      const [y,m,d]=normalized.split('/').map(Number);
      expiryDate=new Date(Date.UTC(y,m-1,d));
    }
    if(isNaN(expiryDate.getTime()))return{displayDate:"æ—¥æœŸç„¡æ•ˆ",remainingDays:"æ—¥æœŸç„¡æ•ˆ"};
    const today=new Date();
    const taipeiOffset=8*60*60*1000;
    const todayTaipei=new Date(today.getTime()+taipeiOffset);
    const todayUTC=new Date(Date.UTC(todayTaipei.getFullYear(),todayTaipei.getMonth(),todayTaipei.getDate()));
    const timeDiff=expiryDate-todayUTC;
    const remainingDays=Math.ceil(timeDiff/(1000*3600*24));
    const formattedDate=new Date(expiryDate).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    let remainingDaysText;
    if(remainingDays<0)remainingDaysText="<span class='text-red-500 font-medium'>å·²éæœŸ</span>";
    else if(remainingDays===0)remainingDaysText="<span class='text-orange-500 font-medium'>æœ€å¾Œ1å¤©</span>";
    else if(remainingDays<=30)remainingDaysText=`<span class='text-orange-500 font-medium'>${remainingDays} å¤©</span>`;
    else remainingDaysText=`${remainingDays} å¤©`;
    return{displayDate:formattedDate,remainingDays:remainingDaysText};
  }catch(error){
    console.error("è¨ˆç®—å‰©é¤˜å¤©æ•¸å¤±æ•—ï¼š",error);
    return{displayDate:"è¨ˆç®—éŒ¯èª¤",remainingDays:"è¨ˆç®—éŒ¯èª¤"};
  }
};

// ç²å–é è¦½åœ–
const getThumbnail=(url, type)=>{
  if(!url)return 'https://via.placeholder.com/300x180?text=No+Preview';
  if(type==='video'){
    if(urlCheckers.isYoutube(url)){
      const match=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/))([\w-]+)/);
      return match&&match[1] ? `https://img.youtube.com/vi/${match[1]}/mqdefault.jpg` : 'https://via.placeholder.com/300x180?text=è¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(urlCheckers.isTencent(url)){
      return 'https://via.placeholder.com/300x180?text=é¨°è¨Šè¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(urlCheckers.isSpotify(url)){
      return 'https://via.placeholder.com/300x180?text=Spotify&bgcolor=1DB954&color=ffffff';
    }else if(urlCheckers.isApplePodcast(url)){
      return 'https://via.placeholder.com/300x180?text=Apple Podcast&bgcolor=ffffff&color=000000';
    }else if(urlCheckers.isPodcast(url)){
      return 'https://via.placeholder.com/300x180?text=æ’­å®¢&bgcolor=7C3AED&color=ffffff';
    }
    return 'https://via.placeholder.com/300x180?text=å½±éŸ³&bgcolor=e8f9f7&color=008c76';
  }else if(type==='file'){
    const lowerUrl=url.toLowerCase();
    if(lowerUrl.endsWith('.pdf'))return 'https://via.placeholder.com/300x180?text=PDFæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.doc')||lowerUrl.endsWith('.docx'))return 'https://via.placeholder.com/300x180?text=Wordæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.xls')||lowerUrl.endsWith('.xlsx'))return 'https://via.placeholder.com/300x180?text=Excelæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.ppt')||lowerUrl.endsWith('.pptx'))return 'https://via.placeholder.com/300x180?text=PPTæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else return 'https://via.placeholder.com/300x180?text=æ–‡ä»¶&bgcolor=f0f7ff&color=64748b';
  }
  return 'https://via.placeholder.com/300x180?text=å…§å®¹&bgcolor=f1f5f9&color=64748b';
};

// æ›´æ–°å…§å®¹è¨ˆæ•¸é¡¯ç¤º
const updateContentCountDisplay=()=>{
  const videoCount=DOM('video-count-num'), fileCount=DOM('file-count-num');
  videoCount&&(videoCount.textContent=appState.videoList.length);
  fileCount&&(fileCount.textContent=appState.fileList.length);
};

// æ¬Šé™åˆ¤æ–·
const isAdminUser = () => appState.userRole === 'admin';
const isProUser = () => appState.userRole === 'pro' || isAdminUser();
const isManageUser = () => isAdminUser();

// é©—è­‰ç”¨æˆ¶æ¬Šé™ï¼ˆå¸¶ç·©å­˜ï¼‰
const verifyUserPermission=()=>{
  return new Promise((resolve, reject)=>{
    setStatus('é©—è­‰ç”¨æˆ¶æ¬Šé™...');
    
    // å¦‚æœæœ‰ç·©å­˜ä¸”æœªéæœŸï¼Œç›´æ¥ä½¿ç”¨ç·©å­˜æ•¸æ“š
    const cachedAuth = getCachedAuthData(appState.currentUser.userId);
    if (cachedAuth) {
      appState.userRole = cachedAuth.userRole;
      appState.userExpiryInfo = cachedAuth.userExpiryInfo;
      appState.userNickname = cachedAuth.userNickname;
      resolve(true);
      return;
    }
    
    // ç„¡ç·©å­˜æˆ–ç·©å­˜éæœŸï¼Œè«‹æ±‚é©—è­‰
    if(!appState.currentUser)return reject(new Error('ç”¨æˆ¶ä¿¡æ¯ä¸å­˜åœ¨'));
    const requestData = {
      action:'verifyUser',
      userId:appState.currentUser.userId,
      displayName:appState.currentUser.displayName,
      writeToSheet:true,
      needExpiryDate:true
    };
    $.ajax({
      url:CONFIG.GAS_URL,
      dataType:'jsonp',
      jsonp:'callback',
      timeout:10000,
      data:requestData,
      cache: true,
      success:(resp)=>{
        if(resp.status==="success"&&resp.isAuthorized){
          appState.userRole=resp.isAdmin?'admin':(resp.isPro?'pro':'user');
          appState.userExpiryInfo={
            remainingDays:resp.remainingDays || 0,
            expiryDate:resp.expiryDate || CONFIG.PERMANENT_EXPIRY_DATE
          };
          // ä¿®å¾©ï¼šç¢ºä¿æš±ç¨±å§‹çµ‚æœ‰å€¼ï¼Œå¢å¼·å®¹éŒ¯
          appState.userNickname = resp.nickname || appState.currentUser.displayName || 'å¹¸ç¦ç³»çµ±ç”¨æˆ¶';
          
          // ç·©å­˜é©—è­‰çµæœ
          setCachedAuthData(appState.currentUser.userId, {
            userRole: appState.userRole,
            userExpiryInfo: appState.userExpiryInfo,
            userNickname: appState.userNickname
          });
          
          resolve(true);
        }else{
          reject(new Error(resp.message||'ç”¨æˆ¶æœªæˆæ¬Šï¼Œè«‹è¯ç¹«ç®¡ç†å“¡é–‹é€š'));
        }
      },
      error:(xhr,status,error)=>{
        console.error("ç”¨æˆ¶æ¬Šé™é©—è­‰å¤±æ•—ï¼š",status,error);
        const errorMsg = status === 'timeout' 
          ? 'æ¬Šé™é©—è­‰è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡è©¦' 
          : (status === 'abort' ? 'è«‹æ±‚å·²ä¸­æ–·' : 'ç¶²çµ¡éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰ç”¨æˆ¶æ¬Šé™');
        reject(new Error(errorMsg));
      }
    });
  });
};

// ç²å–GASæ•¸æ“š
const fetchDataFromGAS=(type)=>{
  return new Promise((resolve, reject)=>{
    setStatus(`è¼‰å…¥${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}åˆ—è¡¨ä¸­...`);
    $.ajax({
      url:CONFIG.GAS_URL,
      dataType:'jsonp',
      jsonp:'callback',
      timeout:CONFIG.JSONP_TIMEOUT,
      data:{action:`get${type==='video'?'Video':'File'}List`},
      success:(resp)=>{
        if(resp.status==="success"&&Array.isArray(resp.data)){
          const listKey = `${type}List`;
          const urlKey = type==='video'?'video':'file';
          appState[listKey] = resp.data.map(item=>({
            id:item.id||`${type}_${Date.now()}_${Math.floor(Math.random()*1000)}`,
            name:item.name||'',
            url:item[urlKey]||'',
            note:item.note||'',
            updatedAt:convertUTCToTaiwanTime(item.updatedAt)||convertUTCToTaiwanTime(new Date().toISOString()),
            [`${type}Type`]:item[`${type}Type`]||''
          })).filter(item=>item.url&&item.id);
          resolve(true);
        }else{
          appState[`${type}List`] = [];
          resolve(false);
        }
      },
      error:(xhr,status,error)=>{
        console.error(`ç²å–${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}åˆ—è¡¨å¤±æ•—ï¼š`,status,error);
        appState[`${type}List`] = [];
        reject(new Error(`ç²å–${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}åˆ—è¡¨å¤±æ•—`));
      }
    });
  });
};
const fetchVideoListFromGAS=()=>fetchDataFromGAS('video');
const fetchFileListFromGAS=()=>fetchDataFromGAS('file');

// åŒæ­¥æ•¸æ“šåˆ°GAS
const syncToGAS=(type, data, callback)=>{
  const action=`save${type==='video'?'Video':'File'}`;
  const key=type==='video'?'video':'file';
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action,
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      [`${type}Id`]:data.id,
      name:data.name,
      [key]:data.url,
      note:data.note,
      updatedAt:data.updatedAt
    },
    success:(resp)=>{
      if(resp.status==="success"){
        callback&&callback(true);
      }else{
        showError(`åŒæ­¥${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
        callback&&callback(false);
      }
    },
    error:(xhr,status,error)=>{
      console.error(`åŒæ­¥${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š`,status,error);
      showError(`åŒæ­¥${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š${status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
      callback&&callback(false);
    }
  });
};
const syncVideoToGAS=(data, callback)=>syncToGAS('video', data, callback);
const syncFileToGAS=(data, callback)=>syncToGAS('file', data, callback);

// åˆªé™¤GASæ•¸æ“š
const deleteFromGAS=(type, id, callback)=>{
  const action=`delete${type==='video'?'Video':'File'}`;
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action,
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      [`${type}Id`]:id
    },
    success:(resp)=>{
      if(resp.status==="success"){
        callback&&callback(true);
      }else{
        showError(`åˆªé™¤${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
        callback&&callback(false);
      }
    },
    error:(xhr,status,error)=>{
      console.error(`åˆªé™¤${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š`,status,error);
      showError(`åˆªé™¤${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š${status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
      callback&&callback(false);
    }
  });
};
const deleteVideoFromGAS=(id, callback)=>deleteFromGAS('video', id, callback);
const deleteFileFromGAS=(id, callback)=>deleteFromGAS('file', id, callback);

// åŒæ­¥åˆ—è¡¨é †åº
const syncListOrderToGAS=(type)=>{
  const listKey = `${type}List`;
  const ids = appState[listKey].map(item=>item.id);
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action:`update${type==='video'?'Video':'File'}Order`,
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      [`${type}Ids`]:JSON.stringify(ids)
    },
    success:(resp)=>{
      if(resp.status!=="success")console.warn(`åŒæ­¥${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}é †åºå¤±æ•—ï¼š`,resp.message);
    },
    error:(xhr,status,error)=>{
      console.error(`åŒæ­¥${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}é †åºå¤±æ•—ï¼š`,status,error);
    }
  });
};
const syncVideoListOrderToGAS=()=>syncListOrderToGAS('video');
const syncFileListOrderToGAS=()=>syncListOrderToGAS('file');

// æ¸²æŸ“ç€è¦½åˆ—è¡¨
const renderViewerContentList = () => {
  const type = CONFIG.currentContentType;
  const listKey = `${type}List`;
  const contentSelect = DOM('content-select');
  const emptyEl = DOM('viewer-empty-list');
  const emptyText = DOM('viewer-empty-text');
  const selectedDisplay = DOM('selected-content-display');
  
  contentSelect.innerHTML = '<option value="">è«‹é¸æ“‡è¦æŸ¥çœ‹çš„å…§å®¹...</option>';
  selectedDisplay.classList.add('hidden');
  emptyEl.classList.add('hidden');
  
  emptyText.textContent = type === 'video' ? 'æš«ç„¡å¯æŸ¥çœ‹çš„å½±éŸ³' : 'æš«ç„¡å¯æŸ¥çœ‹çš„æ–‡ä»¶';
  
  if (appState[listKey].length === 0) {
    emptyEl.classList.remove('hidden');
    return;
  }
  
  appState[listKey].forEach((item) => {
    const option = document.createElement('option');
    option.value = item.id;
    option.textContent = item.name.length > 50 ? item.name.substring(0, 50) + '...' : item.name;
    contentSelect.appendChild(option);
  });
  
  if (appState.selectedContentId) {
    const selectedOption = contentSelect.querySelector(`option[value="${appState.selectedContentId}"]`);
    if (selectedOption) {
      selectedOption.selected = true;
      selectContent(appState.selectedContentId);
    }
  }
};

// æ¸²æŸ“ç®¡ç†åˆ—è¡¨ï¼ˆä¿®æ”¹ç‚ºä¸‹æ‹‰é¸å–®æ¨¡å¼ï¼‰
const renderManageContentList = () => {
  const type = CONFIG.currentContentType;
  const listKey = `${type}List`;
  const contentSelect = DOM('manage-content-select');
  const emptyEl = DOM('empty-manage-list');
  const emptyText = DOM('empty-manage-text');
  const emptyTip = DOM('empty-manage-tip');
  const singleDisplay = DOM('single-content-display');
  
  // æ¸…ç©ºä¸‹æ‹‰é¸å–®
  contentSelect.innerHTML = '<option value="">è«‹é¸æ“‡è¦ç®¡ç†çš„å…§å®¹...</option>';
  
  // éš±è—å–®ç­†é¡¯ç¤ºå€åŸŸ
  singleDisplay.classList.add('hidden');
  
  // æ›´æ–°ç©ºåˆ—è¡¨æç¤º
  emptyText.textContent = type === 'video' ? 'å°šæœªæ·»åŠ ä»»ä½•å½±éŸ³' : 'å°šæœªæ·»åŠ ä»»ä½•æ–‡ä»¶';
  emptyTip.textContent = type === 'video' ? 'é»æ“Šã€Œæ–°å¢å½±éŸ³ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ ' : 'é»æ“Šã€Œæ–°å¢æ–‡ä»¶ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ ';
  
  // é¡¯ç¤º/éš±è—ç©ºåˆ—è¡¨æç¤º
  if (appState[listKey].length === 0) {
    emptyEl.classList.remove('hidden');
  } else {
    emptyEl.classList.add('hidden');
    
    // å¡«å……ä¸‹æ‹‰é¸å–®
    appState[listKey].forEach((item) => {
      const option = document.createElement('option');
      option.value = item.id;
      option.textContent = item.name.length > 50 ? item.name.substring(0, 50) + '...' : item.name;
      contentSelect.appendChild(option);
    });
    
    // å¦‚æœæœ‰é¸ä¸­çš„ç®¡ç†å…§å®¹ï¼Œè‡ªå‹•é¡¯ç¤º
    if (appState.selectedManageContentId) {
      const selectedOption = contentSelect.querySelector(`option[value="${appState.selectedManageContentId}"]`);
      if (selectedOption) {
        selectedOption.selected = true;
        selectManageContent(appState.selectedManageContentId);
      }
    }
  }
};

// é¸æ“‡ç®¡ç†å…§å®¹
const selectManageContent = (contentId) => {
  if (!contentId) {
    DOM('single-content-display').classList.add('hidden');
    appState.selectedManageContentId = '';
    return;
  }

  const type = CONFIG.currentContentType;
  const listKey = `${type}List`;
  const contentItem = appState[listKey].find(item => item.id === contentId);
  
  if (!contentItem) {
    showError('é¸æ“‡çš„å…§å®¹ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°é¸æ“‡');
    DOM('single-content-display').classList.add('hidden');
    appState.selectedManageContentId = '';
    return;
  }

  appState.selectedManageContentId = contentId;
  const singleDisplay = DOM('single-content-display');
  const titleEl = DOM('single-content-title');
  const noteEl = DOM('single-content-note');
  const noteText = noteEl.querySelector('p');
  const updatedEl = DOM('single-content-updated');
  
  // è¨­ç½®æ¨™é¡Œ
  titleEl.textContent = contentItem.name;
  
  // è¨­ç½®å‚™è¨»
  if (contentItem.note) {
    noteEl.classList.remove('hidden');
    noteText.innerHTML = contentItem.note.replace(/\n/g, '<br>');
  } else {
    noteEl.classList.add('hidden');
  }
  
  // è¨­ç½®æ›´æ–°æ™‚é–“
  updatedEl.textContent = contentItem.updatedAt;
  
  // é¡¯ç¤ºå–®ç­†å…§å®¹å€åŸŸ
  singleDisplay.classList.remove('hidden');
};

// ç·¨è¼¯é¸ä¸­çš„ç®¡ç†å…§å®¹
const editSelectedContent = () => {
  if (!appState.selectedManageContentId) {
    showError('è«‹å…ˆé¸æ“‡è¦ç·¨è¼¯çš„å…§å®¹');
    return;
  }
  
  editContent(CONFIG.currentContentType, appState.selectedManageContentId);
};

// åˆªé™¤é¸ä¸­çš„ç®¡ç†å…§å®¹
const deleteSelectedContent = () => {
  if (!appState.selectedManageContentId) {
    showError('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„å…§å®¹');
    return;
  }
    // ç¢ºèªåˆªé™¤
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€${CONFIG.currentContentType === 'video' ? 'å½±éŸ³' : 'æ–‡ä»¶'}ã€‘ï¼š${DOM('single-content-title').textContent} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
    return;
  }

  deleteContent(CONFIG.currentContentType, appState.selectedManageContentId);
};

// é¸æ“‡ç€è¦½å…§å®¹
const selectContent = (contentId) => {
  if (!contentId) {
    DOM('selected-content-display').classList.add('hidden');
    appState.selectedContentId = '';
    return;
  }

  const type = CONFIG.currentContentType;
  const listKey = `${type}List`;
  const contentItem = appState[listKey].find(item => item.id === contentId);
  
  if (!contentItem) {
    showError('é¸æ“‡çš„å…§å®¹ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°é¸æ“‡');
    DOM('selected-content-display').classList.add('hidden');
    appState.selectedContentId = '';
    return;
  }

  appState.selectedContentId = contentId;
  const viewerCard = DOM('viewer-content-card');
  const selectedDisplay = DOM('selected-content-display');
  
  // ç”Ÿæˆå…§å®¹é è¦½HTML
  const thumbnailUrl = getThumbnail(contentItem.url, type);
  const embedInfo = type === 'video' ? convertToEmbedUrl(contentItem.url) : { type: 'file', url: contentItem.url };
  
  let contentHtml = `
    <div class="p-4">
      <div class="mb-4 text-center">
        <h3 class="text-lg font-bold text-textPrimary mb-2">${contentItem.name}</h3>
        ${contentItem.note ? `<p class="text-sm text-textSecondary mb-3 bg-neutral/50 p-2 rounded-lg">${contentItem.note.replace(/\n/g, '<br>')}</p>` : ''}
      </div>
      <div class="mb-4">
        <div class="rounded-xl overflow-hidden shadow-elevation-1">
          <img src="${thumbnailUrl}" alt="${contentItem.name}" class="w-full h-auto object-cover">
        </div>
      </div>
      <div class="flex justify-center">
        <button onclick="previewContent('${type}', '${contentItem.id}')" class="mobile-btn primary-gradient text-white font-medium px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1">
          <i class="fa fa-play-circle text-lg"></i> æŸ¥çœ‹å®Œæ•´å…§å®¹
        </button>
      </div>
      <div class="text-xs text-textSecondary text-center mt-3">
        <i class="fa fa-clock-o mr-1"></i> æœ€å¾Œæ›´æ–°ï¼š${contentItem.updatedAt}
      </div>
    </div>
  `;
  
  viewerCard.innerHTML = contentHtml;
  selectedDisplay.classList.remove('hidden');
};

// é è¦½å…§å®¹
const previewContent = (type, contentId) => {
  const listKey = `${type}List`;
  const contentItem = appState[listKey].find(item => item.id === contentId);
  
  if (!contentItem) {
    showError('é è¦½çš„å…§å®¹ä¸å­˜åœ¨');
    return;
  }

  appState.currentViewingId = contentId;
  appState.currentViewingType = type;
  
  const previewSection = DOM('content-preview');
  const previewTitle = DOM('preview-title');
  const previewContainer = DOM('preview-container');
  const previewActionBtns = DOM('preview-action-btns');
  
  // éš±è—å…¶ä»–å€åŸŸ
  DOM('status').classList.add('hidden');
  DOM('result-card').classList.add('hidden');
  DOM('content-viewer-section').classList.add('hidden');
  DOM('content-manage-section').classList.add('hidden');
  DOM('video-edit-section').classList.add('hidden');
  DOM('file-edit-section').classList.add('hidden');
  
  // è¨­ç½®æ¨™é¡Œ
  previewTitle.textContent = contentItem.name;
  
  // ç”Ÿæˆé è¦½å…§å®¹
  let previewHtml = '';
  const embedInfo = type === 'video' ? convertToEmbedUrl(contentItem.url) : { type: 'file', url: contentItem.url };
  
  if (type === 'video') {
    if (embedInfo.type === 'unsupported') {
      previewHtml = `
        <div class="text-center py-8">
          <div class="inline-block bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mb-4">
            <i class="fa fa-exclamation-triangle text-xl text-orange-500"></i>
          </div>
          <p class="text-lg font-medium text-textPrimary mb-2">ä¸æ”¯æ´çš„å½±éŸ³æ ¼å¼</p>
          <p class="text-sm text-textSecondary mb-4">ç•¶å‰éˆæ¥æ ¼å¼ä¸æ”¯æ´å…§åµŒé è¦½</p>
          <a href="${contentItem.url}" target="_blank" class="mobile-btn primary-gradient text-white font-medium px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300 inline-flex items-center gap-1">
            <i class="fa fa-external-link text-sm"></i> å¤–éƒ¨æ‰“é–‹
          </a>
        </div>
      `;
    } else {
      previewHtml = `
        <div class="${embedInfo.type}-container">
          <iframe src="${embedInfo.url}" class="loaded" allowfullscreen="true" allow="autoplay; encrypted-media; picture-in-picture"></iframe>
        </div>
      `;
    }
  } else if (type === 'file') {
    previewHtml = `
      <div class="text-center py-8">
        <div class="inline-block bg-primary/10 rounded-full w-16 h-16 flex items-center justify-center mb-4">
          <i class="fa fa-file-text-o text-xl text-primary"></i>
        </div>
        <p class="text-lg font-medium text-textPrimary mb-2">${contentItem.name}</p>
        <p class="text-sm text-textSecondary mb-4">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ‰“é–‹æ–‡ä»¶</p>
        <a href="${contentItem.url}" target="_blank" class="mobile-btn primary-gradient text-white font-medium px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300 inline-flex items-center gap-1">
          <i class="fa fa-download text-sm"></i> æ‰“é–‹/ä¸‹è¼‰æ–‡ä»¶
        </a>
      </div>
    `;
  }
  
  // æ·»åŠ å‚™è¨»ä¿¡æ¯
  if (contentItem.note) {
    previewHtml += `
      <div class="mt-4 bg-neutral rounded-xl p-3">
        <h4 class="text-sm font-medium text-textPrimary mb-2"><i class="fa fa-sticky-note text-primary mr-1"></i> å‚™æ³¨è³‡è¨Š</h4>
        <p class="text-sm text-textSecondary whitespace-pre-wrap break-words">${contentItem.note.replace(/\n/g, '<br>')}</p>
      </div>
    `;
  }
  
  // æ·»åŠ æ›´æ–°æ™‚é–“
  previewHtml += `
    <div class="text-xs text-textSecondary text-center mt-3">
      <i class="fa fa-clock-o mr-1"></i> æœ€å¾Œæ›´æ–°ï¼š${contentItem.updatedAt}
    </div>
  `;
  
  previewContainer.innerHTML = previewHtml;
  
  // é¡¯ç¤º/éš±è—ç·¨è¼¯åˆªé™¤æŒ‰éˆ•ï¼ˆåƒ…ç®¡ç†å“¡å¯è¦‹ï¼‰
  previewActionBtns.style.display = isManageUser() ? 'flex' : 'none';
  
  // é¡¯ç¤ºé è¦½å€åŸŸ
  previewSection.classList.remove('hidden');
};

// éš±è—å…§å®¹é è¦½
const hideContentPreview = () => {
  DOM('content-preview').classList.add('hidden');
  
  // æ¢å¾©é¡¯ç¤ºç€è¦½å€åŸŸ
  DOM('content-viewer-section').classList.remove('hidden');
  
  // é‡ç½®ç•¶å‰æŸ¥çœ‹ç‹€æ…‹
  appState.currentViewingId = null;
  appState.currentViewingType = null;
};

// ç·¨è¼¯ç•¶å‰å…§å®¹
const editCurrentContent = () => {
  if (!appState.currentViewingId || !appState.currentViewingType) {
    showError('æ²’æœ‰å¯ç·¨è¼¯çš„å…§å®¹');
    return;
  }
  
  editContent(appState.currentViewingType, appState.currentViewingId);
};

// åˆªé™¤ç•¶å‰å…§å®¹
const deleteCurrentContent = () => {
  if (!appState.currentViewingId || !appState.currentViewingType) {
    showError('æ²’æœ‰å¯åˆªé™¤çš„å…§å®¹');
    return;
  }
  
  deleteContent(appState.currentViewingType, appState.currentViewingId);
};

// ç·¨è¼¯å…§å®¹
const editContent = (type, contentId) => {
  if (!isManageUser()) {
    showError('æ‚¨æ²’æœ‰ç·¨è¼¯å…§å®¹çš„æ¬Šé™');
    return;
  }

  const listKey = `${type}List`;
  const contentItem = appState[listKey].find(item => item.id === contentId);
  
  if (!contentItem) {
    showError('è¦ç·¨è¼¯çš„å…§å®¹ä¸å­˜åœ¨');
    return;
  }

  // éš±è—å…¶ä»–å€åŸŸ
  DOM('status').classList.add('hidden');
  DOM('result-card').classList.add('hidden');
  DOM('content-viewer-section').classList.add('hidden');
  DOM('content-manage-section').classList.add('hidden');
  DOM('content-preview').classList.add('hidden');
  DOM('file-edit-section').classList.add('hidden');
  
  if (type === 'video') {
    // è¨­ç½®å½±éŸ³ç·¨è¼¯è¡¨å–®
    DOM('video-id').value = contentItem.id;
    DOM('video-name').value = contentItem.name;
    DOM('video-url').value = contentItem.url;
    DOM('video-note').value = contentItem.note;
    DOM('video-edit-title').textContent = 'ç·¨è¼¯å½±éŸ³';
    appState.currentEditingVideoId = contentItem.id;
    
    // é¡¯ç¤ºå½±éŸ³ç·¨è¼¯å€åŸŸ
    DOM('video-edit-section').classList.remove('hidden');
  } else {
    // è¨­ç½®æ–‡ä»¶ç·¨è¼¯è¡¨å–®
    DOM('file-id-hidden').value = contentItem.id;
    DOM('file-name').value = contentItem.name;
    DOM('file-id').value = contentItem.url;
    DOM('file-note').value = contentItem.note;
    DOM('file-edit-title').textContent = 'ç·¨è¼¯æ–‡ä»¶';
    appState.currentEditingFileId = contentItem.id;
    
    // é¡¯ç¤ºæ–‡ä»¶ç·¨è¼¯å€åŸŸ
    DOM('file-edit-section').classList.remove('hidden');
  }
};

// åˆªé™¤å…§å®¹
const deleteContent = (type, contentId) => {
  if (!isManageUser()) {
    showError('æ‚¨æ²’æœ‰åˆªé™¤å…§å®¹çš„æ¬Šé™');
    return;
  }

  const listKey = `${type}List`;
  const contentItem = appState[listKey].find(item => item.id === contentId);
  
  if (!contentItem) {
    showError('è¦åˆªé™¤çš„å…§å®¹ä¸å­˜åœ¨');
    return;
  }

  // äºŒæ¬¡ç¢ºèª
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€${type === 'video' ? 'å½±éŸ³' : 'æ–‡ä»¶'}ã€‘ï¼š${contentItem.name} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
    return;
  }

  // èª¿ç”¨GASåˆªé™¤æ¥å£
  const deleteFunc = type === 'video' ? deleteVideoFromGAS : deleteFileFromGAS;
  deleteFunc(contentId, (success) => {
    if (success) {
      // å¾æœ¬åœ°åˆ—è¡¨ä¸­ç§»é™¤
      appState[listKey] = appState[listKey].filter(item => item.id !== contentId);
      
      // æ›´æ–°è¨ˆæ•¸
      updateContentCountDisplay();
      
      // é‡ç½®ç‹€æ…‹
      if (appState.selectedContentId === contentId) {
        appState.selectedContentId = '';
      }
      if (appState.selectedManageContentId === contentId) {
        appState.selectedManageContentId = '';
      }
      if (appState.currentViewingId === contentId) {
        appState.currentViewingId = null;
        appState.currentViewingType = null;
        hideContentPreview();
      }
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderViewerContentList();
      renderManageContentList();
      
      // é¡¯ç¤ºæˆåŠŸæç¤º
      showSuccess(`${type === 'video' ? 'å½±éŸ³' : 'æ–‡ä»¶'}å·²æˆåŠŸåˆªé™¤`);
    }
  });
};

// æ–°å¢å…§å®¹
const addNewContent = () => {
  if (!isManageUser()) {
    showError('æ‚¨æ²’æœ‰æ–°å¢å…§å®¹çš„æ¬Šé™');
    return;
  }

  const type = CONFIG.currentContentType;
  
  // éš±è—å…¶ä»–å€åŸŸ
  DOM('status').classList.add('hidden');
  DOM('result-card').classList.add('hidden');
  DOM('content-viewer-section').classList.add('hidden');
  DOM('content-manage-section').classList.add('hidden');
  DOM('content-preview').classList.add('hidden');
  DOM('video-edit-section').classList.add('hidden');
  DOM('file-edit-section').classList.add('hidden');
  
  if (type === 'video') {
    // é‡ç½®å½±éŸ³è¡¨å–®
    DOM('video-form').reset();
    DOM('video-id').value = '';
    DOM('video-edit-title').textContent = 'æ–°å¢å½±éŸ³';
    appState.currentEditingVideoId = null;
    
    // é¡¯ç¤ºå½±éŸ³ç·¨è¼¯å€åŸŸ
    DOM('video-edit-section').classList.remove('hidden');
  } else {
    // é‡ç½®æ–‡ä»¶è¡¨å–®
    DOM('file-form').reset();
    DOM('file-id-hidden').value = '';
    DOM('file-edit-title').textContent = 'æ–°å¢æ–‡ä»¶';
    appState.currentEditingFileId = null;
    
    // é¡¯ç¤ºæ–‡ä»¶ç·¨è¼¯å€åŸŸ
    DOM('file-edit-section').classList.remove('hidden');
  }
};

// ä¿å­˜å½±éŸ³
const saveVideo = (event) => {
  event.preventDefault();
  
  if (appState.isSubmitting) return;
  if (!isManageUser()) {
    showError('æ‚¨æ²’æœ‰ä¿å­˜å…§å®¹çš„æ¬Šé™');
    return;
  }

  const id = DOM('video-id').value;
  const name = DOM('video-name').value.trim();
  const url = DOM('video-url').value.trim();
  const note = DOM('video-note').value.trim();
  
  // åŸºæœ¬é©—è­‰
  if (!name) {
    showError('è«‹è¼¸å…¥å½±éŸ³åç¨±');
    return;
  }
  
  if (!url || !urlCheckers.isValidUrl(url)) {
    showError('è«‹è¼¸å…¥æœ‰æ•ˆçš„å½±éŸ³éˆæ¥');
    return;
  }

  setVideoSubmitState(true);
  
  // æº–å‚™ä¿å­˜æ•¸æ“š
  const videoData = {
    id: id || `video_${Date.now()}_${Math.floor(Math.random()*1000)}`,
    name,
    url,
    note,
    updatedAt: convertUTCToTaiwanTime(new Date().toISOString())
  };
  
  // èª¿ç”¨GASä¿å­˜æ¥å£
  syncVideoToGAS(videoData, (success) => {
    setVideoSubmitState(false);
    
    if (success) {
      // æ›´æ–°æœ¬åœ°åˆ—è¡¨
      if (id) {
        // ç·¨è¼¯ç¾æœ‰å½±éŸ³
        const index = appState.videoList.findIndex(item => item.id === id);
        if (index !== -1) {
          appState.videoList[index] = videoData;
        }
      } else {
        // æ–°å¢å½±éŸ³
        appState.videoList.push(videoData);
      }
      
      // æ›´æ–°è¨ˆæ•¸
      updateContentCountDisplay();
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderViewerContentList();
      renderManageContentList();
      
      // éš±è—ç·¨è¼¯å€åŸŸ
      hideVideoEditSection();
      
      // é¡¯ç¤ºæˆåŠŸæç¤º
      showSuccess(id ? 'å½±éŸ³å·²æˆåŠŸæ›´æ–°' : 'å½±éŸ³å·²æˆåŠŸæ–°å¢');
    }
  });
};

// ä¿å­˜æ–‡ä»¶
const saveFile = (event) => {
  event.preventDefault();
  
  if (appState.isSubmitting) return;
  if (!isManageUser()) {
    showError('æ‚¨æ²’æœ‰ä¿å­˜å…§å®¹çš„æ¬Šé™');
    return;
  }

  const id = DOM('file-id-hidden').value;
  const name = DOM('file-name').value.trim();
  const url = DOM('file-id').value.trim();
  const note = DOM('file-note').value.trim();
  
  // åŸºæœ¬é©—è­‰
  if (!name) {
    showError('è«‹è¼¸å…¥æ–‡ä»¶åç¨±');
    return;
  }
  
  if (!url || !urlCheckers.isValidUrl(url)) {
    showError('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ–‡ä»¶éˆæ¥');
    return;
  }

  setFileSubmitState(true);
  
  // æº–å‚™ä¿å­˜æ•¸æ“š
  const fileData = {
    id: id || `file_${Date.now()}_${Math.floor(Math.random()*1000)}`,
    name,
    url,
    note,
    updatedAt: convertUTCToTaiwanTime(new Date().toISOString())
  };
  
  // èª¿ç”¨GASä¿å­˜æ¥å£
  syncFileToGAS(fileData, (success) => {
    setFileSubmitState(false);
    
    if (success) {
      // æ›´æ–°æœ¬åœ°åˆ—è¡¨
      if (id) {
        // ç·¨è¼¯ç¾æœ‰æ–‡ä»¶
        const index = appState.fileList.findIndex(item => item.id === id);
        if (index !== -1) {
          appState.fileList[index] = fileData;
        }
      } else {
        // æ–°å¢æ–‡ä»¶
        appState.fileList.push(fileData);
      }
      
      // æ›´æ–°è¨ˆæ•¸
      updateContentCountDisplay();
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderViewerContentList();
      renderManageContentList();
      
      // éš±è—ç·¨è¼¯å€åŸŸ
      hideFileEditSection();
      
      // é¡¯ç¤ºæˆåŠŸæç¤º
      showSuccess(id ? 'æ–‡ä»¶å·²æˆåŠŸæ›´æ–°' : 'æ–‡ä»¶å·²æˆåŠŸæ–°å¢');
    }
  });
};

// åˆ‡æ›å…§å®¹é¡å‹
const switchContentType = (type) => {
  if (CONFIG.currentContentType === type) return;
  
  CONFIG.currentContentType = type;
  
  // æ›´æ–°æŒ‰éˆ•æ–‡å­—
  DOM('current-content-type').textContent = type === 'video' ? 'å½±éŸ³åˆ—è¡¨' : 'æ–‡ä»¶åˆ—è¡¨';
  
  // æ›´æ–°ç€è¦½å€åŸŸæ¨™é¡Œ
  DOM('viewer-section-title').innerHTML = type === 'video' 
    ? '<i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å½±éŸ³åˆ—è¡¨' 
    : '<i class="fa fa-file text-primary mr-2 text-sm"></i> æ–‡ä»¶åˆ—è¡¨';
  
  // æ›´æ–°ç®¡ç†å€åŸŸæ¨™é¡Œ
  DOM('manage-section-title').innerHTML = type === 'video' 
    ? '<i class="fa fa-th-list text-primary mr-2 text-sm"></i> å½±éŸ³ç®¡ç†åˆ—è¡¨' 
    : '<i class="fa fa-th-list text-primary mr-2 text-sm"></i> æ–‡ä»¶ç®¡ç†åˆ—è¡¨';
  
  // æ›´æ–°æ–°å¢æŒ‰éˆ•æ–‡å­—
  DOM('add-content-btn').innerHTML = type === 'video' 
    ? '<i class="fa fa-plus text-lg"></i> æ–°å¢å½±éŸ³' 
    : '<i class="fa fa-plus text-lg"></i> æ–°å¢æ–‡ä»¶';
  
  // æ›´æ–°ç®¡ç†é¡å‹é¡¯ç¤º
  DOM('manage-current-type').textContent = type === 'video' ? 'å½±éŸ³' : 'æ–‡ä»¶';
  
  // é‡ç½®é¸æ“‡ç‹€æ…‹
  appState.selectedContentId = '';
  appState.selectedManageContentId = '';
  
  // é‡æ–°æ¸²æŸ“åˆ—è¡¨
  renderViewerContentList();
  renderManageContentList();
  
  // éš±è—ä¸‹æ‹‰é¸å–®
  DOM('content-type-dropdown').classList.add('hidden');
  DOM('manage-content-type-dropdown').classList.add('hidden');
};

// åˆ‡æ›ç®¡ç†å€åŸŸ
const toggleManageSection = () => {
  const viewerSection = DOM('content-viewer-section');
  const manageSection = DOM('content-manage-section');
  
  if (manageSection.classList.contains('hidden')) {
    // é¡¯ç¤ºç®¡ç†å€åŸŸ
    viewerSection.classList.add('hidden');
    manageSection.classList.remove('hidden');
    
    // é‡æ–°æ¸²æŸ“ç®¡ç†åˆ—è¡¨
    renderManageContentList();
  } else {
    // é¡¯ç¤ºç€è¦½å€åŸŸ
    manageSection.classList.add('hidden');
    viewerSection.classList.remove('hidden');
    
    // é‡æ–°æ¸²æŸ“ç€è¦½åˆ—è¡¨
    renderViewerContentList();
  }
};

// éš±è—å½±éŸ³ç·¨è¼¯å€åŸŸ
const hideVideoEditSection = () => {
  DOM('video-edit-section').classList.add('hidden');
  
  // é‡ç½®è¡¨å–®å’Œç‹€æ…‹
  DOM('video-form').reset();
  DOM('video-id').value = '';
  appState.currentEditingVideoId = null;
  
  // æ¢å¾©é¡¯ç¤ºç®¡ç†å€åŸŸ
  DOM('content-manage-section').classList.remove('hidden');
};

// éš±è—æ–‡ä»¶ç·¨è¼¯å€åŸŸ
const hideFileEditSection = () => {
  DOM('file-edit-section').classList.add('hidden');
  
  // é‡ç½®è¡¨å–®å’Œç‹€æ…‹
  DOM('file-form').reset();
  DOM('file-id-hidden').value = '';
  appState.currentEditingFileId = null;
  
  // æ¢å¾©é¡¯ç¤ºç®¡ç†å€åŸŸ
  DOM('content-manage-section').classList.remove('hidden');
};

// åˆå§‹åŒ–é é¢
const initPage = async () => {
  try {
    // åˆå§‹åŒ–LIFF
    await liff.init({ liffId: CONFIG.LIFF_ID });
    
    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    // ç²å–ç”¨æˆ¶ä¿¡æ¯
    const profile = await liff.getProfile();
    appState.currentUser = {
      userId: profile.userId,
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl
    };
    
    // é©—è­‰ç”¨æˆ¶æ¬Šé™
    await verifyUserPermission();
    
    // ç²å–å½±éŸ³å’Œæ–‡ä»¶åˆ—è¡¨
    await Promise.all([
      fetchVideoListFromGAS(),
      fetchFileListFromGAS()
    ]);
    
    // æ›´æ–°å…§å®¹è¨ˆæ•¸
    updateContentCountDisplay();
    
    // éš±è—åŠ è¼‰ç‹€æ…‹
    DOM('status').classList.add('hidden');
    
    // é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯å¡ç‰‡
    DOM('result-card').classList.remove('hidden');
    
    // è¨­ç½®ç”¨æˆ¶ä¿¡æ¯
    const expiryInfo = calculateRemainingDaysByDate(appState.userExpiryInfo.expiryDate);
    DOM('result-main').textContent = isAdminUser() ? 'ç³»çµ±ç®¡ç†å“¡' : (isProUser() ? 'å°Šçˆµæœƒå“¡' : 'æ™®é€šæœƒå“¡');
    DOM('user-role-display').textContent = isAdminUser() ? 'ç³»çµ±ç®¡ç†å“¡' : (isProUser() ? 'å°Šçˆµæœƒå“¡' : 'æ™®é€šæœƒå“¡');
    DOM('user-name').textContent = appState.userNickname;
    DOM('expiry-date').textContent = expiryInfo.displayDate;
    DOM('remaining-days').innerHTML = expiryInfo.remainingDays;
    
    // é¡¯ç¤ºç”¨æˆ¶åç¨±å’Œæœ‰æ•ˆæœŸ
    DOM('user-name-display').classList.remove('hidden');
    DOM('user-expiry-display').classList.remove('hidden');
    
    // é¡¯ç¤ºç€è¦½å€åŸŸ
    DOM('content-viewer-section').classList.remove('hidden');
    
    // æ¸²æŸ“å…§å®¹åˆ—è¡¨
    renderViewerContentList();
    
    // è¨­ç½®ä¸‹æ‹‰é¸å–®åˆ‡æ›äº‹ä»¶
    DOM('content-type-toggle').addEventListener('click', () => {
      const dropdown = DOM('content-type-dropdown');
      dropdown.classList.toggle('hidden');
    });
    
    // é»æ“Šå…¶ä»–å€åŸŸé—œé–‰ä¸‹æ‹‰é¸å–®
    document.addEventListener('click', (e) => {
      const dropdown = DOM('content-type-dropdown');
      const toggleBtn = DOM('content-type-toggle');
      
      if (!toggleBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });
    
  } catch (error) {
    console.error('åˆå§‹åŒ–å¤±æ•—ï¼š', error);
    showError(error.message || 'ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
};

// é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>

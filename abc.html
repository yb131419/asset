<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<title>ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
tailwind.config={theme:{extend:{colors:{primary:'#008C76',secondary:'#E8F9F7',accent:'#FFD700',dark:'#1A202C',lightBg:'#F9FAFB',neutral:'#F3F4F6',cardBg:'#FFFFFF',textPrimary:'#1E293B',textSecondary:'#64748B'},fontFamily:{sans:['Noto Sans TC','sans-serif','system-ui'],display:['Noto Sans TC','sans-serif','system-ui']},boxShadow:{'elevation-1':'0 2px 8px rgba(0,0,0,0.06)','elevation-2':'0 4px 16px rgba(0,0,0,0.08)','elevation-3':'0 8px 24px rgba(0,0,0,0.12)'}}}};
</script>
<style type="text/tailwindcss">
@layer utilities{.fade-in{animation:fadeIn 0.6s cubic-bezier(0.4,0,0.2,1);}.pulse-subtle{animation:pulseSubtle 2s infinite;}.gradient-text{background-clip:text;-webkit-background-clip:text;color:transparent;}.slide-in{animation:slideIn 0.4s cubic-bezier(0.4,0,0.2,1);}.scale-in{animation:scaleIn 0.3s cubic-bezier(0.4,0,0.2,1);}.slide-up{animation:slideUp 0.3s ease-out;}}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes pulseSubtle{0%,100%{opacity:1;}50%{opacity:0.8;}}
@keyframes slideIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes scaleIn{from{transform:scale(0.95);opacity:0;}to{transform:scale(1);opacity:1;}}
@keyframes slideUp{from{transform:translateY(10px);opacity:0;}to{transform:translateY(0);opacity:1;}}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:#F1F5F9;border-radius:3px;}
::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:#94A3B8;}
body{font-feature-settings:"palt";letter-spacing:0.02em;margin:0;padding:0;}
.media-container{position:fixed;top:0;left:0;width:100vw;height:100vh;border-radius:0;background-color:#0F172A;z-index:9999;}
.media-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;opacity:0;transition:opacity 0.3s ease;}
.media-container iframe.loaded{opacity:1;}
.audio-container{width:100%;height:60vh;min-height:400px;}
@media (max-width: 768px) {
  .media-container {width:100vw;height:100vh;}
  .audio-container {height:80vh;min-height:300px;}
}
.video-item{transition:all 0.2s ease;cursor:grab;}
.video-item:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.08);}
.video-item.dragging{opacity:0.5;border:2px dashed #008C76;cursor:grabbing;}
.video-item.pro-user{cursor:pointer;}
.video-item.pro-user:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.08);}
.drop-zone{border:2px dashed #008C76 !important;background-color:#E8F9F7 !important;}
.thumbnail-container{width:80px;height:50px;border-radius:4px;overflow:hidden;background:#f1f1f1;flex-shrink:0;}
.thumbnail-img{width:100%;height:100%;object-fit:cover;}
.viewer-card{transition:all 0.3s ease;}
.viewer-card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.watch-btn{padding:8px 16px !important;font-size:14px !important;font-weight:600 !important;border-radius:8px !important;}
.mobile-btn{min-height:48px !important;padding:12px 20px !important;font-size:16px !important;border-radius:10px !important;}
.mobile-btn-sm{min-height:40px !important;padding:8px 16px !important;font-size:15px !important;border-radius:8px !important;}
.btn-disabled{opacity:0.7;cursor:not-allowed;pointer-events:none;}
.fullscreen-close-btn{position:absolute;top:15px;right:15px;width:40px;height:40px;background:rgba(0,0,0,0.7);border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer;color:white;}
.fullscreen-close-btn:hover{background:rgba(0,0,0,0.9);}
.loading-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;z-index:10;}
.audio-placeholder{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#121212;padding:20px;}
.audio-placeholder-icon{font-size:80px;color:#1DB954;margin-bottom:20px;}
.audio-placeholder-text{color:white;font-size:20px;text-align:center;}
.file-upload-area{border:2px dashed #CBD5E1;border-radius:8px;padding:20px;text-align:center;transition:all 0.3s ease;cursor:pointer;}
.file-upload-area:hover{border-color:#008C76;background-color:#E8F9F7;}
.file-upload-area.active{border-color:#008C76;background-color:#E8F9F7;}
.file-info{margin-top:10px;padding:10px;background:#F1F5F9;border-radius:6px;text-align:left;}
.progress-bar{height:4px;background:#E2E8F0;border-radius:2px;overflow:hidden;margin-top:10px;}
.progress-fill{height:100%;background:#008C76;width:0%;transition:width 0.3s ease;}
</style>
</head>
<body class="bg-lightBg min-h-screen flex flex-col p-2 md:p-4">
<div class="max-w-5xl w-full bg-cardBg rounded-xl shadow-elevation-2 overflow-hidden fade-in self-center">
  <div class="bg-gradient-to-r from-primary to-[#006658] p-4 md:p-6 text-white text-center relative overflow-hidden">
    <div class="absolute top-0 left-0 w-24 h-24 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/3"></div>
    <div class="absolute bottom-0 right-0 w-32 h-32 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3"></div>
    <div class="relative z-10">
      <div class="inline-flex items-center justify-center w-12 h-12 bg-white/10 backdrop-blur-sm rounded-full mb-2 pulse-subtle">
        <i class="fa fa-film text-2xl text-accent"></i>
      </div>
      <h1 class="text-2xl md:text-3xl font-bold mb-1 tracking-wide"> ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </h1>
      <p class="text-white/90 text-sm md:text-base font-light">å½¥å½¬ å¹¸ç¦ç³»çµ±</p>
    </div>
  </div>
  <div class="p-3 md:p-5">
    <div id="status" class="flex items-center justify-center py-6 text-textPrimary text-center">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-2"></div>
        <p id="status-text" class="text-base">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±ï¼Œè«‹ç¨å€™...</p>
      </div>
    </div>
    <div id="error-message" class="hidden bg-red-50 border border-red-100 text-red-700 px-4 py-3 rounded-lg mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-exclamation-circle text-red-500 mt-1 mr-2 text-lg"></i>
        <div id="error-content" class="text-sm"></div>
      </div>
    </div>
    <div id="success-message" class="hidden bg-green-50 border border-green-100 text-green-700 px-4 py-3 rounded-lg mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-check-circle text-green-500 mt-1 mr-2 text-lg"></i>
        <div id="success-content" class="text-sm"></div>
      </div>
    </div>
    <div id="result-card" class="hidden bg-gradient-to-r from-secondary to-[#F0FAF8] border border-primary/15 rounded-xl p-4 mb-4 text-center fade-in relative overflow-hidden">
      <div class="absolute top-0 right-0 w-16 h-16 bg-primary/5 rounded-full translate-x-1/2 -translate-y-1/2"></div>
      <div class="relative z-10">
        <div id="result-main" class="text-lg md:text-xl font-bold mb-2 text-textPrimary"></div>
        <div id="result-details" class="text-sm text-textSecondary space-y-1 md:space-y-1.5"></div>
        <div id="content-count-display" class="mt-2 text-sm font-medium text-primary">
          <i class="fa fa-play-circle mr-1"></i> å½±ç‰‡æ•¸ï¼š<span id="video-count-num">0</span> | 
          <i class="fa fa-file mr-1"></i> æ–‡ä»¶æ•¸ï¼š<span id="file-count-num">0</span>
        </div>
        <div class="w-20 h-0.5 bg-primary/20 mx-auto my-2"></div>
      </div>
    </div>
    <div id="video-viewer-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å½±ç‰‡åˆ—è¡¨
        </h2>
        <div id="manage-video-btn-container" class="flex gap-2 hidden">
          <button onclick="toggleVideoListSection()" class="mobile-btn-sm bg-primary hover:bg-[#007A69] text-white text-sm font-medium px-4 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center gap-1">
            <i class="fa fa-cog text-sm"></i> å½±ç‰‡ç®¡ç†
          </button>
        </div>
      </div>
      <div id="viewer-video-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-2"></div>
      <div id="viewer-empty-video-list" class="py-8 text-center text-textSecondary hidden">
        <i class="fa fa-film text-3xl mb-3 text-gray-300"></i>
        <p class="text-base">æš«ç„¡å¯æŸ¥çœ‹çš„å½±ç‰‡</p>
        <p class="text-xs mt-1 text-textSecondary/70">è«‹è¯ç¹«ç®¡ç†å“¡æ·»åŠ å½±ç‰‡</p>
      </div>
    </div>
    <div id="file-viewer-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-file text-primary mr-2 text-sm"></i> æ–‡ä»¶åˆ—è¡¨
        </h2>
        <div id="manage-file-btn-container" class="flex gap-2 hidden">
          <button onclick="toggleFileListSection()" class="mobile-btn-sm bg-primary hover:bg-[#007A69] text-white text-sm font-medium px-4 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center gap-1">
            <i class="fa fa-cog text-sm"></i> æ–‡ä»¶ç®¡ç†
          </button>
        </div>
      </div>
      <div id="viewer-file-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-2"></div>
      <div id="viewer-empty-file-list" class="py-8 text-center text-textSecondary hidden">
        <i class="fa fa-file text-3xl mb-3 text-gray-300"></i>
        <p class="text-base">æš«ç„¡å¯æŸ¥çœ‹çš„æ–‡ä»¶</p>
        <p class="text-xs mt-1 text-textSecondary/70">è«‹è¯ç¹«ç®¡ç†å“¡æ·»åŠ æ–‡ä»¶</p>
      </div>
    </div>
    <div id="video-list-section" class="bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100 hidden">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-th-list text-primary mr-2 text-sm"></i> å½±ç‰‡ç®¡ç†åˆ—è¡¨
        </h2>
        <div id="add-video-btn-container" class="flex gap-2 w-full md:w-auto">
          <button onclick="addNewVideo()" class="mobile-btn bg-primary hover:bg-[#007A69] text-white text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-plus text-lg"></i> æ–°å¢å½±ç‰‡
          </button>
          <button onclick="toggleVideoListSection()" class="mobile-btn bg-gray-200 hover:bg-gray-300 text-textPrimary text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-lg"></i> è¿”å›
          </button>
        </div>
      </div>
      <div id="video-list-container" class="space-y-2.5 mb-2"></div>
      <div id="empty-video-list" class="py-5 text-center text-textSecondary hidden">
        <i class="fa fa-film text-2xl mb-2 text-gray-300"></i>
        <p class="text-sm">å°šæœªæ·»åŠ ä»»ä½•å½±ç‰‡</p>
        <p id="empty-video-tip" class="text-xs mt-1">é»æ“Šã€Œæ–°å¢å½±ç‰‡ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ </p>
      </div>
    </div>
    <div id="file-list-section" class="bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100 hidden">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
        <h2 class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-th-list text-primary mr-2 text-sm"></i> æ–‡ä»¶ç®¡ç†åˆ—è¡¨
        </h2>
        <div id="add-file-btn-container" class="flex gap-2 w-full md:w-auto">
          <button onclick="addNewFile()" class="mobile-btn bg-primary hover:bg-[#007A69] text-white text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-plus text-lg"></i> æ–°å¢æ–‡ä»¶
          </button>
          <button onclick="toggleFileListSection()" class="mobile-btn bg-gray-200 hover:bg-gray-300 text-textPrimary text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-lg"></i> è¿”å›
          </button>
        </div>
      </div>
      <div id="file-list-container" class="space-y-2.5 mb-2"></div>
      <div id="empty-file-list" class="py-5 text-center text-textSecondary hidden">
        <i class="fa fa-file text-2xl mb-2 text-gray-300"></i>
        <p class="text-sm">å°šæœªæ·»åŠ ä»»ä½•æ–‡ä»¶</p>
        <p id="empty-file-tip" class="text-xs mt-1">é»æ“Šã€Œæ–°å¢æ–‡ä»¶ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ </p>
      </div>
    </div>
    <div id="video-edit-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 id="video-edit-title" class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢å½±ç‰‡
        </h2>
        <button onclick="hideVideoEditSection()" class="text-textSecondary hover:text-textPrimary transition-colors p-2 rounded-full hover:bg-gray-100">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="video-form" onsubmit="saveVideo(event)">
        <input type="hidden" id="video-id" value="">
        <div class="space-y-3">
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> å½±ç‰‡åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="video-name" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm" placeholder="è«‹è¼¸å…¥å½±ç‰‡åç¨±" required>
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-upload text-primary mr-2 text-xs"></i> ä¸Šå‚³å½±ç‰‡/éŸ³é »æ–‡ä»¶ <span class="text-red-500">*</span>
            </label>
            <div class="file-upload-area" id="video-upload-area" onclick="document.getElementById('video-file-input').click()">
              <i class="fa fa-cloud-upload text-3xl text-textSecondary mb-2"></i>
              <p class="text-sm text-textSecondary">é»æ“Šæˆ–æ‹–æ”¾æ–‡ä»¶è‡³æ­¤ä¸Šå‚³</p>
              <p class="text-xs text-textSecondary/70 mt-1">æ”¯æ´MP4ã€MP3ã€MOVã€AVIã€WAVç­‰æ ¼å¼</p>
              <input type="file" id="video-file-input" class="hidden" accept="video/*,audio/*" onchange="handleVideoFileSelect(event)">
            </div>
            <div id="video-file-info" class="file-info hidden">
              <p id="video-file-name" class="text-sm font-medium"></p>
              <p id="video-file-size" class="text-xs text-textSecondary"></p>
              <div class="progress-bar">
                <div id="video-upload-progress" class="progress-fill"></div>
              </div>
            </div>
            <input type="hidden" id="video-file-url" value="">
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="video-note" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-1 flex gap-2">
            <button type="button" onclick="hideVideoEditSection()" class="mobile-btn-sm w-1/3 bg-gray-200 hover:bg-gray-300 text-textPrimary font-medium px-3 py-2 rounded-lg transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="video-save-btn" class="mobile-btn-sm w-2/3 bg-primary hover:bg-[#007A69] text-white font-medium px-3 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="video-save-btn-text">å„²å­˜å½±ç‰‡</span>
              <div id="video-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    <div id="file-edit-section" class="hidden bg-neutral rounded-xl p-2 md:p-4 mb-4 slide-in border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h2 id="file-edit-title" class="text-base md:text-lg font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢æ–‡ä»¶
        </h2>
        <button onclick="hideFileEditSection()" class="text-textSecondary hover:text-textPrimary transition-colors p-2 rounded-full hover:bg-gray-100">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="file-form" onsubmit="saveFile(event)">
        <input type="hidden" id="file-id" value="">
        <div class="space-y-3">
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> æ–‡ä»¶åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="file-name" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm" placeholder="è«‹è¼¸å…¥æ–‡ä»¶åç¨±" required>
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-upload text-primary mr-2 text-xs"></i> ä¸Šå‚³æ–‡ä»¶ <span class="text-red-500">*</span>
            </label>
            <div class="file-upload-area" id="file-upload-area" onclick="document.getElementById('file-file-input').click()">
              <i class="fa fa-cloud-upload text-3xl text-textSecondary mb-2"></i>
              <p class="text-sm text-textSecondary">é»æ“Šæˆ–æ‹–æ”¾æ–‡ä»¶è‡³æ­¤ä¸Šå‚³</p>
              <p class="text-xs text-textSecondary/70 mt-1">æ”¯æ´PDFã€Wordã€Excelã€PPTã€åœ–ç‰‡ç­‰æ ¼å¼</p>
              <input type="file" id="file-file-input" class="hidden" onchange="handleFileFileSelect(event)">
            </div>
            <div id="file-file-info" class="file-info hidden">
              <p id="file-file-name" class="text-sm font-medium"></p>
              <p id="file-file-size" class="text-xs text-textSecondary"></p>
              <div class="progress-bar">
                <div id="file-upload-progress" class="progress-fill"></div>
              </div>
            </div>
            <input type="hidden" id="file-file-url" value="">
          </div>
          <div class="space-y-1">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="file-note" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-1 flex gap-2">
            <button type="button" onclick="hideFileEditSection()" class="mobile-btn-sm w-1/3 bg-gray-200 hover:bg-gray-300 text-textPrimary font-medium px-3 py-2 rounded-lg transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="file-save-btn" class="mobile-btn-sm w-2/3 bg-primary hover:bg-[#007A69] text-white font-medium px-3 py-2 rounded-lg shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="file-save-btn-text">å„²å­˜æ–‡ä»¶</span>
              <div id="file-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    <div id="content-preview" class="hidden bg-cardBg rounded-xl p-2 md:p-4 mb-4 scale-in border border-primary/20 shadow-elevation-1">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å…§å®¹é è¦½
        </h2>
        <div id="preview-action-btns" class="flex gap-1 hidden">
          <button id="preview-edit-btn" onclick="editCurrentContent()" class="mobile-btn-sm text-primary hover:text-[#007A69] text-sm font-medium flex items-center gap-1 bg-primary/5 px-3 py-2 rounded-lg">
            <i class="fa fa-pencil text-sm"></i> ç·¨è¼¯
          </button>
          <button id="preview-delete-btn" onclick="event.stopPropagation();deleteCurrentContent()" class="mobile-btn-sm text-red-500 hover:text-red-600 text-sm font-medium flex items-center gap-1 bg-red-50 px-3 py-2 rounded-lg">
            <i class="fa fa-trash text-sm"></i> åˆªé™¤
          </button>
          <button onclick="hideContentPreview()" class="text-textSecondary hover:text-textPrimary transition-colors p-2 rounded-full hover:bg-gray-100">
            <i class="fa fa-times-circle text-lg"></i>
          </button>
        </div>
      </div>
      <div id="preview-content" class="space-y-3">
        <h3 id="preview-title" class="text-sm md:text-base font-medium text-textPrimary text-center mb-2"></h3>
        <div id="preview-container" class="mb-3">
          <div id="media-container" class="media-container mb-3 flex items-center justify-center hidden">
            <div class="fullscreen-close-btn" onclick="closeFullscreenPlayer()">
              <i class="fa fa-times text-xl"></i>
            </div>
            <div id="media-loading" class="loading-overlay">
              <i class="fa fa-spinner animate-spin text-xl mb-1"></i>
              <p class="text-xs">è¼‰å…¥å…§å®¹ä¸­...</p>
            </div>
            <iframe id="preview-media" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" onload="handleMediaLoad(this)"></iframe>
            <!-- éŸ³é¢‘æ’­æ”¾å™¨å¤‡ç”¨æ–¹æ¡ˆ -->
            <div id="audio-player-fallback" class="audio-placeholder hidden">
              <i class="fa fa-music audio-placeholder-icon"></i>
              <p class="audio-placeholder-text" id="audio-fallback-text">ç„¡æ³•åµŒå…¥æ’­æ”¾ï¼Œè«‹é»æ“Šä¸‹æ–¹éˆæ¥</p>
              <a id="audio-fallback-link" href="" target="_blank" class="mt-4 bg-primary text-white px-6 py-3 rounded-lg text-sm font-medium">
                <i class="fa fa-external-link mr-1"></i> æ’­æ”¾éŸ³é »
              </a>
            </div>
            <!-- è§†é¢‘æ’­æ”¾å™¨å¤‡ç”¨æ–¹æ¡ˆ -->
            <video id="video-player-fallback" class="w-full h-full hidden" controls>
              <source id="video-fallback-source" src="" type="video/mp4">
              æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è¦–é »æ’­æ”¾
            </video>
          </div>
          <div id="unsupported-tip" class="py-8 text-center text-textSecondary hidden">
            <i class="fa fa-exclamation-triangle text-3xl mb-3 text-orange-500"></i>
            <p class="text-base">ä¸æ”¯æ´çš„å…§å®¹é¡å‹</p>
            <p class="text-xs mt-1 text-textSecondary/70">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥çœ‹å…§å®¹</p>
            <a id="direct-link-btn" href="" target="_blank" class="mt-3 inline-block bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
              <i class="fa fa-external-link mr-1"></i> ç›´æ¥æ‰“é–‹
            </a>
          </div>
          <div id="file-preview-tip" class="py-8 text-center text-textSecondary hidden">
            <i class="fa fa-file text-3xl mb-3 text-blue-500"></i>
            <p class="text-base" id="file-preview-name"></p>
            <p class="text-xs mt-1 text-textSecondary/70">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥çœ‹å…§å®¹</p>
            <a id="file-preview-btn" href="" target="_blank" class="mt-3 inline-block bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
              <i class="fa fa-external-link mr-1"></i> æŸ¥çœ‹å…§å®¹
            </a>
          </div>
        </div>
        <div class="bg-neutral rounded-lg p-3 text-xs md:text-sm text-textSecondary">
          <div class="grid grid-cols-1 gap-2 mb-2">
            <div>
              <span class="font-medium text-textPrimary text-xs md:text-sm"><i class="fa fa-clock-o text-primary mr-1.5 text-xs"></i> æœ€å¾Œæ›´æ–°ï¼š</span>
              <p id="preview-updated" class="mt-1 text-xs md:text-sm"></p>
            </div>
            <div>
              <span class="font-medium text-textPrimary text-xs md:text-sm"><i class="fa fa-sticky-note text-primary mr-1.5 text-xs"></i> å‚™æ³¨ï¼š</span>
              <p id="preview-note" class="mt-1 text-xs md:text-sm">- ç„¡å‚™æ³¨ -</p>
            </div>
          </div>
        </div>
        <div class="flex justify-center mt-2">
          <button onclick="hideContentPreview()" class="mobile-btn bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium px-6 py-3 rounded-lg flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-sm"></i> è¿”å›åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// é…ç½®å¸¸é‡
const CONFIG={
  LIFF_ID:"2008578880-cOBTYud0",
  GAS_URL:"https://script.google.com/macros/s/AKfycbyZMHC4c3QRgBnjFX3-4S1wI8-9x1519SQwwwxom8oDRupOpysz0SOlU4jO40frncXoIg/exec",
  JSONP_TIMEOUT:15000,
  PERMANENT_EXPIRY_DATE:"9999/12/31",
  STORAGE_KEY_PREFIX:"yanbin_video_manager_",
  MAX_FILE_SIZE:100 * 1024 * 1024, // 100MB
  UPLOAD_TIMEOUT:30000
};

// åº”ç”¨çŠ¶æ€
let appState={
  currentUser:null,videoList:[],fileList:[],currentViewingId:null,
  currentViewingType:null,currentEditingVideoId:null,currentEditingFileId:null,
  isSubmitting:false,draggingItem:null,userRole:'',
  userExpiryInfo:{remainingDays:0,expiryDate:''},
  uploadTasks:{}
};

// æ ¸å¿ƒå·¥å…·å‡½æ•°
const DOM=(id)=>document.getElementById(id);
const formatFileSize=(bytes)=>{
  if(bytes===0)return'0 Bytes';
  const k=1024;
  const sizes=['Bytes','KB','MB','GB'];
  const i=Math.floor(Math.log(bytes)/Math.log(k));
  return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i];
};
const convertUTCToTaiwanTime=(utcStr)=>{
  const options={timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'};
  return utcStr ? new Date(utcStr).toLocaleString('zh-TW',options) : new Date().toLocaleString('zh-TW',options);
};
const setStatus=(text)=>{const el=DOM('status-text');if(el)el.textContent=text;};
const resetSubmitState=()=>{setVideoSubmitState(false);setFileSubmitState(false);};

// æç¤ºæ¶ˆæ¯å‡½æ•°
const showError=(msg)=>{
  const hideEls=[DOM('status'),DOM('result-card'),DOM('video-viewer-section'),DOM('file-viewer-section'),
    DOM('video-list-section'),DOM('file-list-section'),DOM('video-edit-section'),DOM('file-edit-section'),
    DOM('content-preview'),DOM('success-message')];
  hideEls.forEach(el=>el&&el.classList.add('hidden'));
  const errorEl=DOM('error-message'), contentEl=DOM('error-content');
  if(errorEl&&contentEl){
    contentEl.innerHTML=`<p class="font-medium">${msg}</p><div class="mt-2 flex justify-center"><button onclick="window.location.reload()" class="text-primary hover:text-[#007A69] font-medium flex items-center gap-1 text-xs"><i class="fa fa-refresh text-xs"></i> é‡æ–°å˜—è©¦</button></div>`;
    errorEl.classList.remove('hidden');
  }
  resetSubmitState();
};

const showSuccess=(msg)=>{
  const errorEl=DOM('error-message');
  if(errorEl)errorEl.classList.add('hidden');
  const successEl=DOM('success-message'), contentEl=DOM('success-content');
  if(successEl&&contentEl){
    contentEl.innerHTML=`<p class="font-medium">${msg}</p>`;
    successEl.classList.remove('hidden');
    setTimeout(()=>successEl&&successEl.classList.add('hidden'),4000);
  }
};

// æäº¤çŠ¶æ€ç®¡ç†
const setSubmitState=(type,isSubmitting)=>{
  appState.isSubmitting=isSubmitting;
  let saveBtn, saveBtnText, saveLoading, btnText;
  if(type==='video'){
    saveBtn=DOM('video-save-btn');
    saveBtnText=DOM('video-save-btn-text');
    saveLoading=DOM('video-save-loading');
    btnText=appState.currentEditingVideoId?"æ›´æ–°å½±ç‰‡":"å„²å­˜å½±ç‰‡";
  }else{
    saveBtn=DOM('file-save-btn');
    saveBtnText=DOM('file-save-btn-text');
    saveLoading=DOM('file-save-loading');
    btnText=appState.currentEditingFileId?"æ›´æ–°æ–‡ä»¶":"å„²å­˜æ–‡ä»¶";
  }
  if(isSubmitting){
    saveBtn&&saveBtn.classList.add('btn-disabled');
    saveBtnText&&(saveBtnText.textContent="å„²å­˜ä¸­...");
    saveLoading&&saveLoading.classList.remove('hidden');
  }else{
    saveBtn&&saveBtn.classList.remove('btn-disabled');
    saveBtnText&&(saveBtnText.textContent=btnText);
    saveLoading&&saveLoading.classList.add('hidden');
  }
};
const setVideoSubmitState=(isSubmitting)=>setSubmitState('video',isSubmitting);
const setFileSubmitState=(isSubmitting)=>setSubmitState('file',isSubmitting);

// å¤„ç†åª’ä½“åŠ è½½å®Œæˆäº‹ä»¶ï¼ˆä¿®å¤Spotify/PodcaståŠ è½½å¡ä½é—®é¢˜ï¼‰
const handleMediaLoad=(iframe)=>{
  iframe.classList.add('loaded');
  DOM('media-loading').classList.add('hidden');
  
  // è®¾ç½®è¶…æ—¶å¤„ç†ï¼Œé˜²æ­¢åŠ è½½å¤±è´¥ä½†ä¸è§¦å‘onloadçš„æƒ…å†µ
  setTimeout(()=>{
    if(!iframe.classList.contains('loaded')){
      DOM('media-loading').classList.add('hidden');
      // æ˜¾ç¤ºå¤‡ç”¨æ’­æ”¾æ–¹æ¡ˆ
      if(iframe.src.includes('spotify') || iframe.src.includes('podcast') || iframe.src.includes('audio')){
        DOM('audio-player-fallback').classList.remove('hidden');
        DOM('audio-fallback-link').href = iframe.src;
        DOM('audio-fallback-text').textContent = 'éŸ³é »ç„¡æ³•åµŒå…¥æ’­æ”¾ï¼Œè«‹é»æ“Šä¸‹æ–¹éˆæ¥';
      }else if(iframe.src.includes('video')){
        DOM('video-player-fallback').classList.remove('hidden');
        DOM('video-fallback-source').src = iframe.src;
        DOM('video-player-fallback').load();
      }
    }
  }, 8000);
};

// URLéªŒè¯å’Œè½¬æ¢å‡½æ•°ï¼ˆå¢å¼ºæ’­å®¢/Spotifyæ’­æ”¾ä½“éªŒï¼‰
const urlCheckers = {
  isYoutube: (url) => url && (url.toLowerCase().includes('youtube.com') || url.toLowerCase().includes('youtu.be') || url.toLowerCase().includes('youtube-nocookie.com')),
  isTencent: (url) => url && url.toLowerCase().includes('v.qq.com'),
  isSpotify: (url) => url && (url.toLowerCase().includes('spotify.com') || url.toLowerCase().includes('open.spotify.com')),
  isApplePodcast: (url) => url && (url.toLowerCase().includes('podcasts.apple.com') || url.toLowerCase().includes('itunes.apple.com/podcast')),
  isPodcast: (url) => url && ['podcast','pca.st','soundcloud.com','anchor.fm','mixcloud.com','castbox.fm','player.fm','listennotes.com'].some(d => url.toLowerCase().includes(d)),
  isValidUrl: (url) => {try{new URL(url);return true;}catch(e){return false;}},
  isVideoFile: (url) => url && ['mp4','mov','avi','mkv','flv','wmv'].some(ext => url.toLowerCase().endsWith(ext)),
  isAudioFile: (url) => url && ['mp3','wav','ogg','flac','m4a','aac'].some(ext => url.toLowerCase().endsWith(ext)),
  isDocumentFile: (url) => url && ['pdf','doc','docx','xls','xlsx','ppt','pptx','txt'].some(ext => url.toLowerCase().endsWith(ext))
};

// å¢å¼ºç‰ˆåµŒå…¥é“¾æ¥è½¬æ¢ï¼ˆä¿®å¤Spotify/PodcaståŠ è½½é—®é¢˜ï¼‰
const convertToEmbedUrl=(url)=>{
  if(!url) return {type: 'unsupported', url: ''};
  
  // ç›´æ¥æ–‡ä»¶é“¾æ¥å¤„ç†
  if(urlCheckers.isVideoFile(url)){
    return {type: 'video-file', url: url};
  }else if(urlCheckers.isAudioFile(url)){
    return {type: 'audio-file', url: url};
  }else if(urlCheckers.isDocumentFile(url)){
    return {type: 'document', url: url};
  }
  
  // YouTube
  if(urlCheckers.isYoutube(url)){
    const match=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/|live\/|playlist\?list=)|youtube-nocookie\.com\/embed\/)([\w-]+)/);
    if(match&&match[1]){
      const isShort=url.includes('shorts/');
      return {type: 'video',url: `https://www.youtube.com/embed/${match[1]}?autoplay=0&rel=0${isShort?'&enablejsapi=1':''}`};
    }
    const vidMatch = url.match(/[?&]v=([^&]+)/);
    if(vidMatch&&vidMatch[1]) return {type: 'video',url: `https://www.youtube.com/embed/${vidMatch[1]}?autoplay=0&rel=0`};
  }
  
  // è…¾è®¯è§†é¢‘
  else if(urlCheckers.isTencent(url)){
    const regs=[/v\.qq\.com\/x\/page\/([a-zA-Z0-9_]+)\.html/,/v\.qq\.com\/x\/cover\/([a-zA-Z0-9_]+)\/([a-zA-Z0-9_]+)\.html/,
      /v\.qq\.com\/detail\/\w+\/([a-zA-Z0-9_]+)\.html/,/vid=([a-zA-Z0-9_]+)/];
    let vid='';
    for(let reg of regs){const match=url.match(reg);if(match){vid=match[2]||match[1]||'';break;}}
    if(vid)return {type: 'video',url: `https://v.qq.com/txp/iframe/player.html?vid=${vid}&auto=0&show1080p=1`};
  }
  
  // Spotifyï¼ˆä¿®å¤åŠ è½½é—®é¢˜ï¼Œä¼˜åŒ–åµŒå…¥å‚æ•°ï¼‰
  else if(urlCheckers.isSpotify(url)){
    const match=url.match(/spotify\.com\/(track|episode|playlist|album|show)\/([a-zA-Z0-9]+)/);
    if(match&&match[2]){
      return {type: 'audio',url: `https://open.spotify.com/embed/${match[1]}/${match[2]}?utm_source=generator&autoplay=0&width=100%&height=100%&theme=dark`};
    }
    const idMatch=url.match(/[a-zA-Z0-9]{22}/);
    if(idMatch) return {type: 'audio',url: `https://open.spotify.com/embed/track/${idMatch[0]}?utm_source=generator&autoplay=0&width=100%&height=100%&theme=dark`};
  }
  
  // Apple Podcastï¼ˆä¿®å¤åŠ è½½é—®é¢˜ï¼‰
  else if(urlCheckers.isApplePodcast(url)){
    const showMatch=url.match(/podcasts\.apple\.com\/.+\/podcast\/.+\/id(\d+)/);
    if(showMatch&&showMatch[1]){
      return {type: 'audio',url: `https://embed.podcasts.apple.com/us/podcast/id${showMatch[1]}?itsct=podcast_box&itscg=30200&width=100%&height=100%`};
    }
    const episodeMatch=url.match(/\/id(\d+)\?i=(\d+)/);
    if(episodeMatch&&episodeMatch[2]){
      return {type: 'audio',url: `https://embed.podcasts.apple.com/us/podcast/id${episodeMatch[1]}?i=${episodeMatch[2]}&itsct=podcast_box&itscg=30200&width=100%&height=100%`};
    }
  }
  
  // é€šç”¨æ’­å®¢ï¼ˆä¿®å¤åŠ è½½é—®é¢˜ï¼‰
  else if(urlCheckers.isPodcast(url)){
    if(url.includes('soundcloud.com')){
      const match = url.match(/soundcloud\.com\/([^\/]+)\/([^\/]+)/);
      if(match) return {type: 'audio', url: `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&visual=true&width=100%&height=100%`};
    }
    else if(url.includes('anchor.fm')){
      const match = url.match(/anchor\.fm\/([^\/]+)\/episodes\/([^\/]+)/);
      if(match) return {type: 'audio', url: `https://anchor.fm/${match[1]}/embed/episodes/${match[2]}?color=blue&autoplay=false&width=100%&height=100%`};
    }
    return {type: 'audio', url: url};
  }
  
  // å…œåº•å¤„ç†
  try {
    const urlObj = new URL(url);
    const videoDomains = ['facebook.com', 'fb.watch', 'instagram.com', 'tiktok.com', 'douyin.com', 'bilibili.com', 'iqiyi.com', 'youku.com'];
    if(videoDomains.some(domain => urlObj.host.includes(domain))){
      return {type: 'video', url: url};
    }
  } catch(e) {}
  
  return {type: 'unsupported', url: url};
};

// å…³é—­å…¨å±æ’­æ”¾å™¨
const closeFullscreenPlayer = () => {
  DOM('media-container').classList.add('hidden');
  DOM('preview-media').src = '';
  DOM('preview-media').classList.remove('loaded');
  DOM('audio-player-fallback').classList.add('hidden');
  DOM('video-player-fallback').classList.add('hidden');
  DOM('content-preview').classList.remove('hidden');
};

// æœ‰æ•ˆæœŸè®¡ç®—
const calculateRemainingDaysByDate=(expiryDateStr)=>{
  try{
    if(expiryDateStr===CONFIG.PERMANENT_EXPIRY_DATE)return{displayDate:"æ°¸ä¹…æœ‰æ•ˆ",remainingDays:"æ°¸ä¹…æœ‰æ•ˆ"};
    if(!/^\d{4}[-\/]\d{2}[-\/]\d{2}(?:\s+\d{1,2}:\d{1,2}(?::\d{1,2})?)?$/.test(expiryDateStr)){
      return{displayDate:"æ ¼å¼éŒ¯èª¤",remainingDays:"æ ¼å¼éŒ¯èª¤"};
    }
    const normalized=expiryDateStr.replace(/-/g,'/');
    let expiryDate;
    if(normalized.includes(' ')){
      const [datePart,timePart]=normalized.split(' ');
      const [y,m,d]=datePart.split('/').map(Number);
      const [h,mi,s]=timePart.split(':').map(Number);
      expiryDate=new Date(Date.UTC(y,m-1,d,h||0,mi||0,s||0));
    }else{
      const [y,m,d]=normalized.split('/').map(Number);
      expiryDate=new Date(Date.UTC(y,m-1,d));
    }
    if(isNaN(expiryDate.getTime()))return{displayDate:"æ—¥æœŸç„¡æ•ˆ",remainingDays:"æ—¥æœŸç„¡æ•ˆ"};
    const today=new Date();
    const taipeiOffset=8*60*60*1000;
    const todayTaipei=new Date(today.getTime()+taipeiOffset);
    const todayUTC=new Date(Date.UTC(todayTaipei.getFullYear(),todayTaipei.getMonth(),todayTaipei.getDate()));
    const timeDiff=expiryDate-todayUTC;
    const remainingDays=Math.ceil(timeDiff/(1000*3600*24));
    const formattedDate=new Date(expiryDate).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    let remainingDaysText;
    if(remainingDays<0)remainingDaysText="<span class='text-red-500 font-medium'>å·²éæœŸ</span>";
    else if(remainingDays===0)remainingDaysText="<span class='text-orange-500 font-medium'>æœ€å¾Œ1å¤©</span>";
    else if(remainingDays<=30)remainingDaysText=`<span class='text-orange-500 font-medium'>${remainingDays} å¤©</span>`;
    else remainingDaysText=`${remainingDays} å¤©`;
    return{displayDate:formattedDate,remainingDays:remainingDaysText};
  }catch(error){
    console.error("è¨ˆç®—å‰©é¤˜å¤©æ•¸å¤±æ•—ï¼š",error);
    return{displayDate:"è¨ˆç®—éŒ¯èª¤",remainingDays:"è¨ˆç®—éŒ¯èª¤"};
  }
};

// ç¼©ç•¥å›¾è·å–
const getThumbnail=(url, type)=>{
  if(!url)return 'https://via.placeholder.com/300x180?text=No+Preview';
  if(type==='video'){
    if(urlCheckers.isYoutube(url)){
      const match=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/))([\w-]+)/);
      return match&&match[1] ? `https://img.youtube.com/vi/${match[1]}/mqdefault.jpg` : 'https://via.placeholder.com/300x180?text=è¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(urlCheckers.isTencent(url)){
      return 'https://via.placeholder.com/300x180?text=é¨°è¨Šè¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(urlCheckers.isSpotify(url)){
      return 'https://via.placeholder.com/300x180?text=Spotify&bgcolor=1DB954&color=ffffff';
    }else if(urlCheckers.isApplePodcast(url)){
      return 'https://via.placeholder.com/300x180?text=Apple+Podcast&bgcolor=ffffff&color=000000';
    }else if(urlCheckers.isPodcast(url)){
      return 'https://via.placeholder.com/300x180?text=Podcast&bgcolor=7C3AED&color=ffffff';
    }else if(urlCheckers.isVideoFile(url)){
      return 'https://via.placeholder.com/300x180?text=è¦–é »æ–‡ä»¶&bgcolor=e8f9f7&color=008c76';
    }else if(urlCheckers.isAudioFile(url)){
      return 'https://via.placeholder.com/300x180?text=éŸ³é »æ–‡ä»¶&bgcolor=1DB954&color=ffffff';
    }
    return 'https://via.placeholder.com/300x180?text=éŸ³è¦–é »&bgcolor=e8f9f7&color=008c76';
  }else if(type==='file'){
    const lowerUrl=url.toLowerCase();
    if(lowerUrl.endsWith('.pdf'))return 'https://via.placeholder.com/300x180?text=PDFæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.doc')||lowerUrl.endsWith('.docx'))return 'https://via.placeholder.com/300x180?text=Wordæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.xls')||lowerUrl.endsWith('.xlsx'))return 'https://via.placeholder.com/300x180?text=Excelæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.ppt')||lowerUrl.endsWith('.pptx'))return 'https://via.placeholder.com/300x180?text=PPTæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.jpg')||lowerUrl.endsWith('.png')||lowerUrl.endsWith('.gif'))return 'https://via.placeholder.com/300x180?text=åœ–ç‰‡æ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else return 'https://via.placeholder.com/300x180?text=æ–‡ä»¶&bgcolor=f0f7ff&color=64748b';
  }
  return 'https://via.placeholder.com/300x180?text=å…§å®¹&bgcolor=f1f5f9&color=64748b';
};

// æ‹–æ‹½äº‹ä»¶å¤„ç†
const dragHandlers = {
  start: (e) => {
    if(!isManageUser())return;
    appState.draggingItem=e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData('text/plain',JSON.stringify({id:e.target.dataset.id,type:e.target.dataset.type}));
    e.target.style.opacity='0.5';
  },
  over: (e) => {
    if(!isManageUser())return;
    e.preventDefault();
    const item=e.target.closest('.video-item');
    if(item&&item!==appState.draggingItem)item.classList.add('drop-zone');
  },
  leave: (e) => {
    if(!isManageUser())return;
    const item=e.target.closest('.video-item');
    item&&item.classList.remove('drop-zone');
  },
  drop: (e) => {
    if(!isManageUser())return;
    e.preventDefault();
    const dragData=JSON.parse(e.dataTransfer.getData('text/plain'));
    const targetItem=e.target.closest('.video-item');
    if(!targetItem||targetItem.dataset.id===dragData.id||targetItem.dataset.type!==dragData.type)return;
    let draggedIndex, targetIndex;
    if(dragData.type==='video'){
      draggedIndex=appState.videoList.findIndex(v=>v.id===dragData.id);
      targetIndex=appState.videoList.findIndex(v=>v.id===targetItem.dataset.id);
      if(draggedIndex!==-1&&targetIndex!==-1){
        const [draggedItem]=appState.videoList.splice(draggedIndex,1);
        appState.videoList.splice(targetIndex,0,draggedItem);
        syncVideoListOrderToGAS();
        renderVideoList();
        renderViewerVideoList();
      }
    }else if(dragData.type==='file'){
      draggedIndex=appState.fileList.findIndex(f=>f.id===dragData.id);
      targetIndex=appState.fileList.findIndex(f=>f.id===targetItem.dataset.id);
      if(draggedIndex!==-1&&targetIndex!==-1){
        const [draggedItem]=appState.fileList.splice(draggedIndex,1);
        appState.fileList.splice(targetIndex,0,draggedItem);
        syncFileListOrderToGAS();
        renderFileList();
        renderViewerFileList();
      }
    }
    targetItem.classList.remove('drop-zone');
    if(appState.draggingItem){
      appState.draggingItem.classList.remove('dragging');
      appState.draggingItem.style.opacity='1';
    }
    appState.draggingItem=null;
    showSuccess('å…§å®¹é †åºå·²å³æ™‚æ›´æ–°ï¼');
  },
  end: (e) => {
    if(!isManageUser())return;
    e.target.classList.remove('dragging');
    e.target.style.opacity='1';
    document.querySelectorAll('.video-item').forEach(item=>item.classList.remove('drop-zone'));
    appState.draggingItem=null;
  }
};

// æ–‡ä»¶ä¸Šä¼ å¤„ç†å‡½æ•°
const handleVideoFileSelect=(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  
  // æ–‡ä»¶å¤§å°éªŒè¯
  if(file.size>CONFIG.MAX_FILE_SIZE){
    showError(`æ–‡ä»¶å¤§å°è¶…éé™åˆ¶ï¼ˆæœ€å¤§${CONFIG.MAX_FILE_SIZE/1024/1024}MBï¼‰`);
    return;
  }
  
  // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
  DOM('video-file-info').classList.remove('hidden');
  DOM('video-file-name').textContent=`æ–‡ä»¶åï¼š${file.name}`;
  DOM('video-file-size').textContent=`æ–‡ä»¶å¤§å°ï¼š${formatFileSize(file.size)}`;
  
  // ä¸Šä¼ æ–‡ä»¶åˆ°GAS
  uploadFileToGAS(file, 'video', (progress, url) => {
    // æ›´æ–°è¿›åº¦æ¡
    DOM('video-upload-progress').style.width=`${progress}%`;
    
    // ä¸Šä¼ å®Œæˆ
    if(url){
      DOM('video-file-url').value=url;
      showSuccess('æ–‡ä»¶ä¸Šå‚³æˆåŠŸï¼');
    }
  });
};

const handleFileFileSelect=(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  
  // æ–‡ä»¶å¤§å°éªŒè¯
  if(file.size>CONFIG.MAX_FILE_SIZE){
    showError(`æ–‡ä»¶å¤§å°è¶…éé™åˆ¶ï¼ˆæœ€å¤§${CONFIG.MAX_FILE_SIZE/1024/1024}MBï¼‰`);
    return;
  }
  
  // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
  DOM('file-file-info').classList.remove('hidden');
  DOM('file-file-name').textContent=`æ–‡ä»¶åï¼š${file.name}`;
  DOM('file-file-size').textContent=`æ–‡ä»¶å¤§å°ï¼š${formatFileSize(file.size)}`;
  
  // ä¸Šä¼ æ–‡ä»¶åˆ°GAS
  uploadFileToGAS(file, 'file', (progress, url) => {
    // æ›´æ–°è¿›åº¦æ¡
    DOM('file-upload-progress').style.width=`${progress}%`;
    
    // ä¸Šä¼ å®Œæˆ
    if(url){
      DOM('file-file-url').value=url;
      showSuccess('æ–‡ä»¶ä¸Šå‚³æˆåŠŸï¼');
    }
  });
};

// æ–‡ä»¶ä¸Šä¼ åˆ°GAS
const uploadFileToGAS=(file, type, callback)=>{
  const formData=new FormData();
  formData.append('file', file);
  formData.append('type', type);
  formData.append('action', 'uploadFile');
  formData.append('userId', appState.currentUser?.userId||'');
  formData.append('displayName', appState.currentUser?.displayName||'');
  
  const xhr=new XMLHttpRequest();
  xhr.open('POST', CONFIG.GAS_URL, true);
  
  // ä¸Šä¼ è¿›åº¦
  xhr.upload.addEventListener('progress', (e) => {
    if(e.lengthComputable){
      const percent=(e.loaded/e.total)*100;
      callback(Math.round(percent));
    }
  });
  
  // ä¸Šä¼ å®Œæˆ
  xhr.addEventListener('load', () => {
    if(xhr.status>=200&&xhr.status<300){
      try{
        const response=JSON.parse(xhr.responseText);
        if(response.status==='success'&&response.fileUrl){
          callback(100, response.fileUrl);
        }else{
          showError(`æ–‡ä»¶ä¸Šå‚³å¤±æ•—ï¼š${response.message||'æœªçŸ¥éŒ¯èª¤'}`);
          callback(0);
        }
      }catch(e){
        showError('æ–‡ä»¶ä¸Šå‚³å›æ‡‰è§£æå¤±æ•—');
        callback(0);
      }
    }else{
      showError(`æ–‡ä»¶ä¸Šå‚³å¤±æ•—ï¼šHTTP ${xhr.status}`);
      callback(0);
    }
  });
  
  // ä¸Šä¼ é”™è¯¯
  xhr.addEventListener('error', () => {
    showError('æ–‡ä»¶ä¸Šå‚³å¤±æ•—ï¼šç¶²çµ¡éŒ¯èª¤');
    callback(0);
  });
  
  // ä¸Šä¼ è¶…æ—¶
  xhr.timeout=CONFIG.UPLOAD_TIMEOUT;
  xhr.addEventListener('timeout', () => {
    showError('æ–‡ä»¶ä¸Šå‚³å¤±æ•—ï¼šè«‹æ±‚è¶…æ™‚');
    callback(0);
  });
  
  // å¼€å§‹ä¸Šä¼ 
  xhr.send(formData);
  
  // ä¿å­˜ä¸Šä¼ ä»»åŠ¡ä»¥ä¾¿å–æ¶ˆ
  appState.uploadTasks[type]=xhr;
};

// æ›´æ–°å†…å®¹è®¡æ•°æ˜¾ç¤º
const updateContentCountDisplay=()=>{
  const videoCount=DOM('video-count-num'), fileCount=DOM('file-count-num');
  videoCount&&(videoCount.textContent=appState.videoList.length);
  fileCount&&(fileCount.textContent=appState.fileList.length);
};

// ç”¨æˆ·æƒé™åˆ¤æ–­
const isAdminUser = () => appState.userRole === 'admin';
const isProUser = () => appState.userRole === 'pro' || isAdminUser();
const isManageUser = () => isAdminUser();

// ç”¨æˆ·æƒé™éªŒè¯
const verifyUserPermission=()=>{
  return new Promise((resolve, reject)=>{
    setStatus('é©—è­‰ç”¨æˆ¶æ¬Šé™...');
    if(!appState.currentUser)return reject(new Error('ç”¨æˆ¶ä¿¡æ¯ä¸å­˜åœ¨'));
    const requestData = {
      action:'verifyUser',
      userId:appState.currentUser.userId,
      displayName:appState.currentUser.displayName,
      writeToSheet:true,
      needExpiryDate:true
    };
    $.ajax({
      url:CONFIG.GAS_URL,
      dataType:'jsonp',
      jsonp:'callback',
      timeout:10000,
      data:requestData,
      cache: true,
      success:(resp)=>{
        if(resp.status==="success"&&resp.isAuthorized){
          appState.userRole=resp.isAdmin?'admin':(resp.isPro?'pro':'user');
          appState.userExpiryInfo={
            remainingDays:resp.remainingDays || 0,
            expiryDate:resp.expiryDate || CONFIG.PERMANENT_EXPIRY_DATE
          };
          resolve(true);
        }else{
          reject(new Error(resp.message||'ç”¨æˆ¶æœªæˆæ¬Šï¼Œè«‹è¯ç¹«ç®¡ç†å“¡é–‹é€š'));
        }
      },
      error:(xhr,status,error)=>{
        console.error("ç”¨æˆ¶æ¬Šé™é©—è­‰å¤±æ•—ï¼š",status,error);
        const errorMsg = status === 'timeout' 
          ? 'æ¬Šé™é©—è­‰è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡è©¦' 
          : (status === 'abort' ? 'è«‹æ±‚å·²ä¸­æ–·' : 'ç¶²çµ¡éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰ç”¨æˆ¶æ¬Šé™');
        reject(new Error(errorMsg));
      }
    });
  });
};

// æ•°æ®è·å–å‡½æ•°
const fetchDataFromGAS=(type)=>{
  return new Promise((resolve, reject)=>{
    setStatus(`è¼‰å…¥${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}åˆ—è¡¨ä¸­...`);
    $.ajax({
      url:CONFIG.GAS_URL,
      dataType:'jsonp',
      jsonp:'callback',
      timeout:CONFIG.JSONP_TIMEOUT,
      data:{action:`get${type==='video'?'Video':'File'}List`},
      success:(resp)=>{
        if(resp.status==="success"&&Array.isArray(resp.data)){
          const listKey = `${type}List`;
          const urlKey = type==='video'?'video':'file';
          appState[listKey] = resp.data.map(item=>({
            id:item.id||`${type}_${Date.now()}_${Math.floor(Math.random()*1000)}`,
            name:item.name||'',
            url:item[urlKey]||'',
            note:item.note||'',
            updatedAt:convertUTCToTaiwanTime(item.updatedAt)||convertUTCToTaiwanTime(new Date().toISOString()),
            [`${type}Type`]:item[`${type}Type`]||''
          })).filter(item=>item.url&&item.id);
          resolve(true);
        }else{
          appState[listKey] = [];
          resolve(false);
        }
      },
      error:(xhr,status,error)=>{
        console.error(`ç²å–${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}åˆ—è¡¨å¤±æ•—ï¼š`,status,error);
        appState[`${type}List`] = [];
        reject(new Error(`ç²å–${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}åˆ—è¡¨å¤±æ•—`));
      }
    });
  });
};
const fetchVideoListFromGAS=()=>fetchDataFromGAS('video');
const fetchFileListFromGAS=()=>fetchDataFromGAS('file');

// æ•°æ®åŒæ­¥å‡½æ•°
const syncToGAS=(type, data, callback)=>{
  const action=`save${type==='video'?'Video':'File'}`;
  const key=type==='video'?'video':'file';
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action,
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||'',
      [`${type}Id`]:data.id,
      name:data.name,
      [key]:data.url,
      note:data.note,
      updatedAt:data.updatedAt
    },
    success:(resp)=>{
      if(resp.status==="success"){
        callback&&callback(true);
      }else{
        showError(`åŒæ­¥${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
        callback&&callback(false);
      }
    },
    error:(xhr,status,error)=>{
      console.error(`åŒæ­¥${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š`,status,error);
      showError(`åŒæ­¥${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š${status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
      callback&&callback(false);
    }
  });
};

// åŒæ­¥åˆ—è¡¨é¡ºåºåˆ°GAS
const syncVideoListOrderToGAS=()=>{
  if(!isManageUser())return;
  const videoIds=appState.videoList.map(v=>v.id);
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action:'syncVideoOrder',
      videoIds:JSON.stringify(videoIds),
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||''
    },
    success:(resp)=>{
      if(resp.status!=="success"){
        console.error('åŒæ­¥å½±ç‰‡é †åºå¤±æ•—ï¼š',resp.message);
      }
    },
    error:(xhr,status,error)=>{
      console.error('åŒæ­¥å½±ç‰‡é †åºå¤±æ•—ï¼š',status,error);
    }
  });
};

const syncFileListOrderToGAS=()=>{
  if(!isManageUser())return;
  const fileIds=appState.fileList.map(f=>f.id);
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action:'syncFileOrder',
      fileIds:JSON.stringify(fileIds),
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||''
    },
    success:(resp)=>{
      if(resp.status!=="success"){
        console.error('åŒæ­¥æ–‡ä»¶é †åºå¤±æ•—ï¼š',resp.message);
      }
    },
    error:(xhr,status,error)=>{
      console.error('åŒæ­¥æ–‡ä»¶é †åºå¤±æ•—ï¼š',status,error);
    }
  });
};

// åˆ é™¤å†…å®¹
const deleteContent=(type, id)=>{
  if(!isManageUser()){
    showError('ç„¡ç®¡ç†æ¬Šé™ï¼Œç„¡æ³•åˆªé™¤å…§å®¹');
    return;
  }
  if(!confirm(`ç¢ºå®šè¦åˆªé™¤é€™${type==='video'?'å€‹å½±ç‰‡':'å€‹æ–‡ä»¶'}å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼`))return;
  
  $.ajax({
    url:CONFIG.GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    timeout:CONFIG.JSONP_TIMEOUT,
    data:{
      action:`delete${type==='video'?'Video':'File'}`,
      [`${type}Id`]:id,
      userId:appState.currentUser?.userId||'',
      displayName:appState.currentUser?.displayName||''
    },
    success:(resp)=>{
      if(resp.status==="success"){
        if(type==='video'){
          appState.videoList=appState.videoList.filter(v=>v.id!==id);
          renderVideoList();
          renderViewerVideoList();
        }else{
          appState.fileList=appState.fileList.filter(f=>f.id!==id);
          renderFileList();
          renderViewerFileList();
        }
        hideContentPreview();
        updateContentCountDisplay();
        showSuccess(`${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å·²æˆåŠŸåˆªé™¤ï¼`);
      }else{
        showError(`åˆªé™¤${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
      }
    },
    error:(xhr,status,error)=>{
      console.error(`åˆªé™¤${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š`,status,error);
      showError(`åˆªé™¤${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}å¤±æ•—ï¼š${status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
    }
  });
};

// æ¸²æŸ“åˆ—è¡¨å‡½æ•°
const renderVideoList=()=>{
  const container=DOM('video-list-container');
  const emptyEl=DOM('empty-video-list');
  if(!container||!emptyEl)return;
  
  if(appState.videoList.length===0){
    container.innerHTML='';
    emptyEl.classList.remove('hidden');
    return;
  }
  
  emptyEl.classList.add('hidden');
  container.innerHTML=appState.videoList.map((video, index)=>`
    <div class="video-item bg-cardBg rounded-lg p-3 shadow-elevation-1 border border-gray-100 flex items-center gap-3" 
         data-id="${video.id}" data-type="video" draggable="${isManageUser()}"
         ondragstart="dragHandlers.start(event)" ondragend="dragHandlers.end(event)"
         onclick="viewContent('video','${video.id}')">
      <div class="thumbnail-container">
        <img src="${getThumbnail(video.url, 'video')}" alt="${video.name}" class="thumbnail-img">
      </div>
      <div class="flex-1 min-w-0">
        <h3 class="text-sm font-medium text-textPrimary truncate">${index+1}. ${video.name}</h3>
        <p class="text-xs text-textSecondary mt-0.5 truncate">${video.note||'ç„¡å‚™æ³¨'}</p>
        <p class="text-xs text-textSecondary/70 mt-0.5">æœ€å¾Œæ›´æ–°ï¼š${video.updatedAt}</p>
      </div>
      ${isManageUser()?`
      <div class="flex gap-1 ml-2">
        <button onclick="event.stopPropagation();editVideo('${video.id}')" class="p-1.5 text-primary hover:bg-primary/5 rounded-full transition-colors">
          <i class="fa fa-pencil text-xs"></i>
        </button>
        <button onclick="event.stopPropagation();deleteContent('video','${video.id}')" class="p-1.5 text-red-500 hover:bg-red-50 rounded-full transition-colors">
          <i class="fa fa-trash text-xs"></i>
        </button>
      </div>
      `:''}
    </div>
  `).join('');
  
  // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬
  if(isManageUser()){
    const items=container.querySelectorAll('.video-item');
    items.forEach(item=>{
      item.addEventListener('dragover', dragHandlers.over);
      item.addEventListener('dragleave', dragHandlers.leave);
      item.addEventListener('drop', dragHandlers.drop);
    });
  }
};

const renderFileList=()=>{
  const container=DOM('file-list-container');
  const emptyEl=DOM('empty-file-list');
  if(!container||!emptyEl)return;
  
  if(appState.fileList.length===0){
    container.innerHTML='';
    emptyEl.classList.remove('hidden');
    return;
  }
  
  emptyEl.classList.add('hidden');
  container.innerHTML=appState.fileList.map((file, index)=>`
    <div class="video-item bg-cardBg rounded-lg p-3 shadow-elevation-1 border border-gray-100 flex items-center gap-3" 
         data-id="${file.id}" data-type="file" draggable="${isManageUser()}"
         ondragstart="dragHandlers.start(event)" ondragend="dragHandlers.end(event)"
         onclick="viewContent('file','${file.id}')">
      <div class="thumbnail-container">
        <img src="${getThumbnail(file.url, 'file')}" alt="${file.name}" class="thumbnail-img">
      </div>
      <div class="flex-1 min-w-0">
        <h3 class="text-sm font-medium text-textPrimary truncate">${index+1}. ${file.name}</h3>
        <p class="text-xs text-textSecondary mt-0.5 truncate">${file.note||'ç„¡å‚™æ³¨'}</p>
        <p class="text-xs text-textSecondary/70 mt-0.5">æœ€å¾Œæ›´æ–°ï¼š${file.updatedAt}</p>
      </div>
      ${isManageUser()?`
      <div class="flex gap-1 ml-2">
        <button onclick="event.stopPropagation();editFile('${file.id}')" class="p-1.5 text-primary hover:bg-primary/5 rounded-full transition-colors">
          <i class="fa fa-pencil text-xs"></i>
        </button>
        <button onclick="event.stopPropagation();deleteContent('file','${file.id}')" class="p-1.5 text-red-500 hover:bg-red-50 rounded-full transition-colors">
          <i class="fa fa-trash text-xs"></i>
        </button>
      </div>
      `:''}
    </div>
  `).join('');
  
  // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬
  if(isManageUser()){
    const items=container.querySelectorAll('.video-item');
    items.forEach(item=>{
      item.addEventListener('dragover', dragHandlers.over);
      item.addEventListener('dragleave', dragHandlers.leave);
      item.addEventListener('drop', dragHandlers.drop);
    });
  }
};

// æ¸²æŸ“æŸ¥çœ‹åˆ—è¡¨
const renderViewerVideoList=()=>{
  const container=DOM('viewer-video-list');
  const emptyEl=DOM('viewer-empty-video-list');
  if(!container||!emptyEl)return;
  
  if(appState.videoList.length===0){
    container.innerHTML='';
    emptyEl.classList.remove('hidden');
    return;
  }
  
  emptyEl.classList.add('hidden');
  container.innerHTML=appState.videoList.map((video, index)=>`
    <div class="video-item viewer-card bg-cardBg rounded-lg overflow-hidden shadow-elevation-1 border border-gray-100 ${isProUser()?'pro-user':''}"
         onclick="${isProUser()?'viewContent(\'video\','+JSON.stringify(video.id)+')':'showError(\'åƒ…é™Proç”¨æˆ¶æŸ¥çœ‹\')'}">
      <div class="h-40 bg-gray-100 overflow-hidden">
        <img src="${getThumbnail(video.url, 'video')}" alt="${video.name}" class="w-full h-full object-cover">
      </div>
      <div class="p-3">
        <h3 class="text-sm font-medium text-textPrimary truncate">${index+1}. ${video.name}</h3>
        <p class="text-xs text-textSecondary mt-1 line-clamp-2">${video.note||'ç„¡å‚™æ³¨'}</p>
        <div class="mt-2 flex justify-center">
          <button class="watch-btn bg-primary hover:bg-[#007A69] text-white flex items-center justify-center gap-1 w-full">
            <i class="fa fa-play-circle text-sm"></i> è§€çœ‹å½±ç‰‡
          </button>
        </div>
      </div>
    </div>
  `).join('');
};

const renderViewerFileList=()=>{
  const container=DOM('viewer-file-list');
  const emptyEl=DOM('viewer-empty-file-list');
  if(!container||!emptyEl)return;
  
  if(appState.fileList.length===0){
    container.innerHTML='';
    emptyEl.classList.remove('hidden');
    return;
  }
  
  emptyEl.classList.add('hidden');
  container.innerHTML=appState.fileList.map((file, index)=>`
    <div class="video-item viewer-card bg-cardBg rounded-lg overflow-hidden shadow-elevation-1 border border-gray-100 ${isProUser()?'pro-user':''}"
         onclick="${isProUser()?'viewContent(\'file\','+JSON.stringify(file.id)+')':'showError(\'åƒ…é™Proç”¨æˆ¶æŸ¥çœ‹\')'}">
      <div class="h-40 bg-gray-100 overflow-hidden">
        <img src="${getThumbnail(file.url, 'file')}" alt="${file.name}" class="w-full h-full object-cover">
      </div>
      <div class="p-3">
        <h3 class="text-sm font-medium text-textPrimary truncate">${index+1}. ${file.name}</h3>
        <p class="text-xs text-textSecondary mt-1 line-clamp-2">${file.note||'ç„¡å‚™æ³¨'}</p>
        <div class="mt-2 flex justify-center">
          <button class="watch-btn bg-primary hover:bg-[#007A69] text-white flex items-center justify-center gap-1 w-full">
            <i class="fa fa-file-text-o text-sm"></i> æŸ¥çœ‹æ–‡ä»¶
          </button>
        </div>
      </div>
    </div>
  `).join('');
};

// æ˜¾ç¤ºå†…å®¹é¢„è§ˆ
const viewContent=(type, id)=>{
  const listKey=`${type}List`;
  const content=appState[listKey].find(item=>item.id===id);
  if(!content){
    showError(`${type==='video'?'å½±ç‰‡':'æ–‡ä»¶'}ä¸å­˜åœ¨`);
    return;
  }
  
  appState.currentViewingId=id;
  appState.currentViewingType=type;
  
  // éšè—å…¶ä»–åŒºåŸŸï¼Œæ˜¾ç¤ºé¢„è§ˆ
  DOM('status').classList.add('hidden');
  DOM('result-card').classList.add('hidden');
  DOM('video-viewer-section').classList.add('hidden');
  DOM('file-viewer-section').classList.add('hidden');
  DOM('video-list-section').classList.add('hidden');
  DOM('file-list-section').classList.add('hidden');
  DOM('video-edit-section').classList.add('hidden');
  DOM('file-edit-section').classList.add('hidden');
  DOM('content-preview').classList.remove('hidden');
  
  // å¡«å……é¢„è§ˆæ•°æ®
  DOM('preview-title').textContent=content.name;
  DOM('preview-updated').textContent=content.updatedAt;
  DOM('preview-note').textContent=content.note||'- ç„¡å‚™æ³¨ -';
  
  // æ˜¾ç¤ºç¼–è¾‘/åˆ é™¤æŒ‰é’®ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
  if(isManageUser()){
    DOM('preview-action-btns').classList.remove('hidden');
  }else{
    DOM('preview-action-btns').classList.add('hidden');
  }
  
  // å¤„ç†åª’ä½“é¢„è§ˆ
  const embedInfo=convertToEmbedUrl(content.url);
  const mediaContainer=DOM('media-container');
  const previewMedia=DOM('preview-media');
  const unsupportedTip=DOM('unsupported-tip');
  const filePreviewTip=DOM('file-preview-tip');
  const directLinkBtn=DOM('direct-link-btn');
  const filePreviewBtn=DOM('file-preview-btn');
  const filePreviewName=DOM('file-preview-name');
  
  // é‡ç½®æ‰€æœ‰é¢„è§ˆå®¹å™¨
  mediaContainer.classList.add('hidden');
  unsupportedTip.classList.add('hidden');
  filePreviewTip.classList.add('hidden');
  previewMedia.src='';
  previewMedia.classList.remove('loaded');
  DOM('media-loading').classList.remove('hidden');
  
  if(type==='video'){
    if(embedInfo.type==='unsupported'){
      unsupportedTip.classList.remove('hidden');
      directLinkBtn.href=content.url;
    }else{
      mediaContainer.classList.remove('hidden');
      previewMedia.src=embedInfo.url;
    }
  }else if(type==='file'){
    filePreviewTip.classList.remove('hidden');
    filePreviewName.textContent=content.name;
    filePreviewBtn.href=content.url;
  }
};

// éšè—å†…å®¹é¢„è§ˆ
const hideContentPreview=()=>{
  DOM('content-preview').classList.add('hidden');
  DOM('media-container').classList.add('hidden');
  DOM('preview-media').src='';
  DOM('preview-media').classList.remove('loaded');
  
  // æ˜¾ç¤ºä¸»ç•Œé¢
  if(isManageUser()){
    DOM('video-list-section').classList.remove('hidden');
    DOM('file-list-section').classList.remove('hidden');
  }else{
    DOM('video-viewer-section').classList.remove('hidden');
    DOM('file-viewer-section').classList.remove('hidden');
    DOM('result-card').classList.remove('hidden');
  }
};

// ç¼–è¾‘å½“å‰å†…å®¹
const editCurrentContent=()=>{
  if(!appState.currentViewingId||!appState.currentViewingType)return;
  if(appState.currentViewingType==='video'){
    editVideo(appState.currentViewingId);
  }else{
    editFile(appState.currentViewingId);
  }
};

// åˆ é™¤å½“å‰å†…å®¹
const deleteCurrentContent=()=>{
  if(!appState.currentViewingId||!appState.currentViewingType)return;
  deleteContent(appState.currentViewingType, appState.currentViewingId);
};

// è§†é¢‘ç¼–è¾‘å‡½æ•°
const addNewVideo=()=>{
  if(!isManageUser()){
    showError('ç„¡ç®¡ç†æ¬Šé™ï¼Œç„¡æ³•æ–°å¢å½±ç‰‡');
    return;
  }
  appState.currentEditingVideoId=null;
  DOM('video-edit-title').textContent='æ–°å¢å½±ç‰‡';
  DOM('video-form').reset();
  DOM('video-file-url').value='';
  DOM('video-file-info').classList.add('hidden');
  DOM('video-upload-progress').style.width='0%';
  
  // éšè—å…¶ä»–åŒºåŸŸ
  DOM('status').classList.add('hidden');
  DOM('result-card').classList.add('hidden');
  DOM('video-viewer-section').classList.add('hidden');
  DOM('file-viewer-section').classList.add('hidden');
  DOM('video-list-section').classList.add('hidden');
  DOM('file-list-section').classList.add('hidden');
  DOM('content-preview').classList.add('hidden');
  
  // æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
  DOM('video-edit-section').classList.remove('hidden');
};

const editVideo=(id)=>{
  if(!isManageUser()){
    showError('ç„¡ç®¡ç†æ¬Šé™ï¼Œç„¡æ³•ç·¨è¼¯å½±ç‰‡');
    return;
  }
  const video=appState.videoList.find(v=>v.id===id);
  if(!video)return;
  
  appState.currentEditingVideoId=id;
  DOM('video-edit-title').textContent='ç·¨è¼¯å½±ç‰‡';
  DOM('video-id').value=video.id;
  DOM('video-name').value=video.name;
  DOM('video-file-url').value=video.url;
  DOM('video-note').value=video.note;
  
  // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯ï¼ˆå¦‚æœæœ‰URLï¼‰
  if(video.url){
    DOM('video-file-info').classList.remove('hidden');
    DOM('video-file-name').textContent=`æ–‡ä»¶ï¼š${video.name}`;
    DOM('video-file-size').textContent='å·²ä¸Šå‚³æ–‡ä»¶';
    DOM('video-upload-progress').style.width='100%';
  }else{
    DOM('video-file-info').classList.add('hidden');
    DOM('video-upload-progress').style.width='0%';
  }
  
  // éšè—å…¶ä»–åŒºåŸŸ
  DOM('status').classList.add('hidden');
  DOM('result-card').classList.add('hidden');
  DOM('video-viewer-section').classList.add('hidden');
  DOM('file-viewer-section').classList.add('hidden');
  DOM('video-list-section').classList.add('hidden');
  DOM('file-list-section').classList.add('hidden');
  DOM('content-preview').classList.add('hidden');
  
  // æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
  DOM('video-edit-section').classList.remove('hidden');
};

const hideVideoEditSection=()=>{
  DOM('video-edit-section').classList.add('hidden');
  if(isManageUser()){
    DOM('video-list-section').classList.remove('hidden');
  }else{
    DOM('video-viewer-section').classList.remove('hidden');
  }
  resetSubmitState();
};

const saveVideo=(e)=>{
  e.preventDefault();
  if(appState.isSubmitting)return;
  if(!isManageUser()){
    showError('ç„¡ç®¡ç†æ¬Šé™ï¼Œç„¡æ³•ä¿å­˜å½±ç‰‡');
    return;
  }
  
  const id=DOM('video-id').value||`video_${Date.now()}_${Math.floor(Math.random()*1000)}`;
  const name=DOM('video-name').value.trim();
  const url=DOM('video-file-url').value.trim();
  const note=DOM('video-note').value.trim();
  
  if(!name){
    showError('è«‹è¼¸å…¥å½±ç‰‡åç¨±');
    return;
  }
  
  if(!url){
    showError('è«‹ä¸Šå‚³å½±ç‰‡æ–‡ä»¶æˆ–è¼¸å…¥å½±ç‰‡éˆæ¥');
    return;
  }
  
  setVideoSubmitState(true);
  
  const videoData={
    id,
    name,
    url,
    note,
    updatedAt:convertUTCToTaiwanTime(new Date().toISOString())
  };
  
  syncToGAS('video', videoData, (success)=>{
    setVideoSubmitState(false);
    if(success){
      const index=appState.videoList.findIndex(v=>v.id===id);
      if(index!==-1){
        appState.videoList[index]=videoData;
      }else{
        appState.videoList.push(videoData);
      }
      renderVideoList();
      renderViewerVideoList();
      hideVideoEditSection();
      updateContentCountDisplay();
      showSuccess(appState.currentEditingVideoId?'å½±ç‰‡å·²æˆåŠŸæ›´æ–°ï¼':'å½±ç‰‡å·²æˆåŠŸæ–°å¢ï¼');
      appState.currentEditingVideoId=null;
    }
  });
};

// æ–‡ä»¶ç¼–è¾‘å‡½æ•°
const addNewFile=()=>{
  if(!isManageUser()){
    showError('ç„¡ç®¡ç†æ¬Šé™ï¼Œç„¡æ³•æ–°å¢æ–‡ä»¶');
    return;
  }
  appState.currentEditingFileId=null;
  DOM('file-edit-title').textContent='æ–°å¢æ–‡ä»¶';
  DOM('file-form').reset();
  DOM('file-file-url').value='';
  DOM('file-file-info').classList.add('hidden');
  DOM('file-upload-progress').style.width='0%';
  
  // éšè—å…¶ä»–åŒºåŸŸ
  DOM('status').classList.add('hidden');
  DOM('result-card').classList.add('hidden');
  DOM('video-viewer-section').classList.add('hidden');
  DOM('file-viewer-section').classList.add('hidden');
  DOM('video-list-section').classList.add('hidden');
  DOM('file-list-section').classList.add('hidden');
  DOM('content-preview').classList.add('hidden');
  
  // æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
  DOM('file-edit-section').classList.remove('hidden');
};

const editFile=(id)=>{
  if(!isManageUser()){
    showError('ç„¡ç®¡ç†æ¬Šé™ï¼Œç„¡æ³•ç·¨è¼¯æ–‡ä»¶');
    return;
  }
  const file=appState.fileList.find(f=>f.id===id);
  if(!file)return;
  
  appState.currentEditingFileId=id;
  DOM('file-edit-title').textContent='ç·¨è¼¯æ–‡ä»¶';
  DOM('file-id').value=file.id;
  DOM('file-name').value=file.name;
  DOM('file-file-url').value=file.url;
  DOM('file-note').value=file.note;
  
  // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯ï¼ˆå¦‚æœæœ‰URLï¼‰
  if(file.url){
    DOM('file-file-info').classList.remove('hidden');
    DOM('file-file-name').textContent=`æ–‡ä»¶ï¼š${file.name}`;
    DOM('file-file-size').textContent='å·²ä¸Šå‚³æ–‡ä»¶';
    DOM('file-upload-progress').style.width='100%';
  }else{
    DOM('file-file-info').classList.add('hidden');
    DOM('file-upload-progress').style.width='0%';
  }
  
  // éšè—å…¶ä»–åŒºåŸŸ
  DOM('status').classList.add('hidden');
  DOM('result-card').classList.add('hidden');
  DOM('video-viewer-section').classList.add('hidden');
  DOM('file-viewer-section').classList.add('hidden');
  DOM('video-list-section').classList.add('hidden');
  DOM('file-list-section').classList.add('hidden');
  DOM('content-preview').classList.add('hidden');
  
  // æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
  DOM('file-edit-section').classList.remove('hidden');
};

const hideFileEditSection=()=>{
  DOM('file-edit-section').classList.add('hidden');
  if(isManageUser()){
    DOM('file-list-section').classList.remove('hidden');
  }else{
    DOM('file-viewer-section').classList.remove('hidden');
  }
  resetSubmitState();
};

const saveFile=(e)=>{
  e.preventDefault();
  if(appState.isSubmitting)return;
  if(!isManageUser()){
    showError('ç„¡ç®¡ç†æ¬Šé™ï¼Œç„¡æ³•ä¿å­˜æ–‡ä»¶');
    return;
  }
  
  const id=DOM('file-id').value||`file_${Date.now()}_${Math.floor(Math.random()*1000)}`;
  const name=DOM('file-name').value.trim();
  const url=DOM('file-file-url').value.trim();
  const note=DOM('file-note').value.trim();
  
  if(!name){
    showError('è«‹è¼¸å…¥æ–‡ä»¶åç¨±');
    return;
  }
  
  if(!url){
    showError('è«‹ä¸Šå‚³æ–‡ä»¶æˆ–è¼¸å…¥æ–‡ä»¶éˆæ¥');
    return;
  }
  
  setFileSubmitState(true);
  
  const fileData={
    id,
    name,
    url,
    note,
    updatedAt:convertUTCToTaiwanTime(new Date().toISOString())
  };
  
  syncToGAS('file', fileData, (success)=>{
    setFileSubmitState(false);
    if(success){
      const index=appState.fileList.findIndex(f=>f.id===id);
      if(index!==-1){
        appState.fileList[index]=fileData;
      }else{
        appState.fileList.push(fileData);
      }
      renderFileList();
      renderViewerFileList();
      hideFileEditSection();
      updateContentCountDisplay();
      showSuccess(appState.currentEditingFileId?'æ–‡ä»¶å·²æˆåŠŸæ›´æ–°ï¼':'æ–‡ä»¶å·²æˆåŠŸæ–°å¢ï¼');
      appState.currentEditingFileId=null;
    }
  });
};

// åˆ‡æ¢åˆ—è¡¨æ˜¾ç¤º
const toggleVideoListSection=()=>{
  const viewerSection=DOM('video-viewer-section');
  const listSection=DOM('video-list-section');
  viewerSection.classList.toggle('hidden');
  listSection.classList.toggle('hidden');
  DOM('manage-video-btn-container').classList.toggle('hidden');
};

const toggleFileListSection=()=>{
  const viewerSection=DOM('file-viewer-section');
  const listSection=DOM('file-list-section');
  viewerSection.classList.toggle('hidden');
  listSection.classList.toggle('hidden');
  DOM('manage-file-btn-container').classList.toggle('hidden');
};

// åˆå§‹åŒ–åº”ç”¨
const initApp=async()=>{
  try{
    setStatus('åˆå§‹åŒ–LIFF...');
    await liff.init({ liffId: CONFIG.LIFF_ID });
    
    if(!liff.isLoggedIn()){
      setStatus('è«‹å…ˆç™»å…¥...');
      liff.login();
      return;
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    appState.currentUser={
      userId: liff.getDecodedIDToken()?.sub || liff.getUserId(),
      displayName: liff.getProfile()?.displayName || 'æœªçŸ¥ç”¨æˆ¶'
    };
    
    // éªŒè¯ç”¨æˆ·æƒé™
    await verifyUserPermission();
    
    // è·å–æ•°æ®
    await Promise.all([
      fetchVideoListFromGAS(),
      fetchFileListFromGAS()
    ]);
    
    // éšè—åŠ è½½çŠ¶æ€
    DOM('status').classList.add('hidden');
    
    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
    updateContentCountDisplay();
    
    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    const expiryInfo=calculateRemainingDaysByDate(appState.userExpiryInfo.expiryDate);
    DOM('result-main').innerHTML=`
      <span class="gradient-text bg-gradient-to-r from-primary to-[#006658]">${appState.currentUser.displayName}</span>
      <span class="text-sm font-normal ml-2">(${appState.userRole==='admin'?'ç®¡ç†å“¡':(appState.userRole==='pro'?'Proç”¨æˆ¶':'æ™®é€šç”¨æˆ¶')})</span>
    `;
    DOM('result-details').innerHTML=`
      <p>æœ‰æ•ˆæœŸï¼š${expiryInfo.displayDate}</p>
      <p>å‰©é¤˜å¤©æ•¸ï¼š${expiryInfo.remainingDays}</p>
    `;
    DOM('result-card').classList.remove('hidden');
    
    // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒç•Œé¢
    if(isManageUser()){
      // ç®¡ç†å‘˜æ˜¾ç¤ºç®¡ç†ç•Œé¢
      DOM('video-list-section').classList.remove('hidden');
      DOM('file-list-section').classList.remove('hidden');
      DOM('manage-video-btn-container').classList.remove('hidden');
      DOM('manage-file-btn-container').classList.remove('hidden');
      renderVideoList();
      renderFileList();
    }else{
      // æ™®é€šç”¨æˆ·æ˜¾ç¤ºæŸ¥çœ‹ç•Œé¢
      DOM('video-viewer-section').classList.remove('hidden');
      DOM('file-viewer-section').classList.remove('hidden');
      renderViewerVideoList();
      renderViewerFileList();
    }
    
  }catch(error){
    console.error('åˆå§‹åŒ–å¤±æ•—ï¼š',error);
    showError(`åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}`);
  }
};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', ()=>{
  // é˜»æ­¢æ‹–æ‹½é»˜è®¤è¡Œä¸º
  document.addEventListener('dragover', (e)=>e.preventDefault());
  document.addEventListener('drop', (e)=>e.preventDefault());
  
  // åˆå§‹åŒ–åº”ç”¨
  initApp();
});

// å…¨å±€é”™è¯¯å¤„ç†
window.onerror=(message, source, lineno, colno, error)=>{
  console.error('å…¨å±€éŒ¯èª¤ï¼š',message, source, lineno, colno, error);
  showError(`ç™¼ç”Ÿæœªé æœŸéŒ¯èª¤ï¼š${message}`);
  return true;
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<title>ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0"/>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
tailwind.config={theme:{extend:{colors:{
  primary:'#008C76',secondary:'#E8F9F7',accent:'#FFD700',gold:'#D4AF37',
  darkGold:'#B8860B',dark:'#1A202C',lightBg:'#F9FAFB',neutral:'#F3F4F6',
  cardBg:'#FFFFFF',textPrimary:'#1E293B',textSecondary:'#64748B',
  premiumBg:'#FFF8E6',premiumBorder:'#FFE082'
},fontFamily:{
  sans:['Noto Sans TC','sans-serif','system-ui'],
  display:['Noto Sans TC','sans-serif','system-ui']
},boxShadow:{
  'elevation-1':'0 2px 8px rgba(0,0,0,0.06)',
  'elevation-2':'0 4px 16px rgba(0,0,0,0.08)',
  'elevation-3':'0 8px 24px rgba(0,0,0,0.12)',
  'gold-hover':'0 4px 15px rgba(212, 175, 55, 0.25)',
  'primary-hover':'0 4px 15px rgba(0, 140, 118, 0.25)'
}}}};
</script>
<style type="text/tailwindcss">
@layer utilities{
  .fade-in{animation:fadeIn 0.6s cubic-bezier(0.4,0,0.2,1);}
  .pulse-subtle{animation:pulseSubtle 2s infinite;}
  .gradient-text{background-clip:text;-webkit-background-clip:text;color:transparent;}
  .slide-in{animation:slideIn 0.4s cubic-bezier(0.4,0,0.2,1);}
  .scale-in{animation:scaleIn 0.3s cubic-bezier(0.4,0,0.2,1);}
  .slide-up{animation:slideUp 0.3s ease-out;}
  .content-transition{transition:all 0.3s ease-in-out;}
  .gold-gradient{background:linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);}
  .primary-gradient{background:linear-gradient(135deg, #008C76 0%, #00A88D 100%);}
  .text-gold-gradient{background:linear-gradient(135deg, #B8860B 0%, #FFD700 100%);-webkit-background-clip:text;background-clip:text;color:transparent;}
}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes pulseSubtle{0%,100%{opacity:1;}50%{opacity:0.8;}}
@keyframes slideIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes scaleIn{from{transform:scale(0.95);opacity:0;}to{transform:scale(1);opacity:1;}}
@keyframes slideUp{from{transform:translateY(10px);opacity:0;}to{transform:translateY(0);opacity:1;}}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:#F1F5F9;border-radius:3px;}
::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:#94A3B8;}
body{font-feature-settings:"palt";letter-spacing:0.02em;background-color:#F5F7FA;}
.video-container,.audio-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;background-color:#0F172A;box-shadow:0 4px 20px rgba(0,0,0,0.15);}
.video-container{min-height:320px;}
.audio-container{padding-bottom:280px;min-height:280px;}
@media (max-width: 640px) {
  .audio-container {padding-bottom: 260px;min-height: 260px;}
  .video-container {min-height: 280px;}
}
@media (min-width: 641px) and (max-width: 1024px) {
  .audio-container {padding-bottom: 270px;min-height: 270px;}
  .video-container {min-height: 300px;}
}
@media (min-width: 1025px) {
  .audio-container {padding-bottom: 300px;min-height: 300px;}
  .video-container {min-height: 350px;}
}
.video-item{transition:all 0.3s ease;cursor:grab;border-radius:10px;}
.video-item:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.video-item.dragging{opacity:0.5;border:2px dashed #008C76;cursor:grabbing;}
.video-item.pro-user{cursor:pointer;}
.video-item.pro-user:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.drop-zone{border:2px dashed #008C76 !important;background-color:#E8F9F7 !important;}
.thumbnail-container{width:80px;height:50px;border-radius:6px;overflow:hidden;background:#f1f1f1;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.thumbnail-img{width:100%;height:100%;object-fit:cover;}
.viewer-card{transition:all 0.4s ease;border-radius:12px;overflow:hidden;}
.viewer-card:hover{transform:translateY(-5px);box-shadow:0 12px 25px rgba(0,0,0,0.12);}
.watch-btn{padding:8px 16px !important;font-size:14px !important;font-weight:600 !important;border-radius:8px !important;transition:all 0.3s ease !important;}
.watch-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0, 140, 118, 0.2) !important;}
.mobile-btn{min-height:48px !important;padding:12px 20px !important;font-size:16px !important;border-radius:12px !important;font-weight:600 !important;transition:all 0.3s ease !important;position:relative;overflow:hidden;}
.mobile-btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);transition:all 0.6s ease;}
.mobile-btn:hover::after{left:100%;}
.mobile-btn-sm{min-height:40px !important;padding:8px 16px !important;font-size:15px !important;border-radius:10px !important;font-weight:600 !important;transition:all 0.3s ease !important;}
.video-container iframe, .audio-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;opacity:0;transition:opacity 0.3s ease;border-radius:12px;}
.video-container iframe.loaded, .audio-container iframe.loaded{opacity:1;}
.btn-disabled{opacity:0.7;cursor:not-allowed;pointer-events:none;}
.dropdown-menu {
  @apply absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-elevation-2 border border-gray-100 z-50 content-transition rounded-xl overflow-hidden;
}
.dropdown-item {
  @apply block px-4 py-3 text-sm text-gray-700 hover:bg-primary/5 hover:text-primary cursor-pointer transition-colors font-medium;
}
.dropdown-item:hover {
  background:linear-gradient(135deg, #008C76 0%, #00A88D 100%);
  color:white !important;
}
.premium-badge{
  background:linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
  color:white;
  font-weight:bold;
  padding:2px 8px;
  border-radius:20px;
  font-size:11px;
  box-shadow:0 2px 8px rgba(212, 175, 55, 0.3);
}
.content-selector {
  @apply w-full bg-white border border-gray-200 rounded-xl p-3 text-textPrimary font-medium mb-4 shadow-elevation-1;
}
.content-selector select {
  @apply w-full border-none outline-none bg-transparent text-textPrimary font-medium;
}
.content-display-card {
  @apply bg-cardBg rounded-xl overflow-hidden shadow-elevation-1 slide-up mb-4;
}
.start-watch-btn {
  @apply w-full mt-3 mobile-btn gold-gradient text-white text-sm font-medium px-6 py-3 rounded-xl shadow-gold-hover transition-all duration-300 flex items-center justify-center border-none;
}
#refresh-btn {
  position:absolute;
  bottom: 50%;
  right: 50%;
  transform: translate(50%, 50%);
  width: 80px;       
  height: 80px;      
  background:#008C76;
  border-radius: 50%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  border: 3px solid #ffffff;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 
    0 5px 15px rgba(0,140,118,0.45),
    inset 0 2px 0 rgba(255,255,255,0.25),
    inset 0 -2px 0 rgba(0,80,65,0.2);
  font-size: 11px;
  color:white;
  font-weight:bold;
  text-align:center;
  line-height: 1.4;
  padding: 0;        
  box-sizing: border-box;
  z-index: 999;     
  outline: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background-image: linear-gradient(145deg, #009980 0%, #007a66 100%);
}
#refresh-btn:hover {
  transform: translate(50%, 50%) scale(1.08);
  background:#00A88D;
  box-shadow: 
    0 7px 20px rgba(0,140,118,0.6),
    inset 0 2px 0 rgba(255,255,255,0.35),
    inset 0 -2px 0 rgba(0,80,65,0.3);
  border-color: rgba(255,255,255,0.95);
  background-image: linear-gradient(145deg, #00bb9c 0%, #008c76 100%);
}
#refresh-btn:active {
  transform: translate(50%, 50%) scale(1.03);
  box-shadow: 
    0 3px 12px rgba(0,140,118,0.5),
    inset 0 1px 0 rgba(255,255,255,0.2),
    inset 0 -1px 0 rgba(0,80,65,0.2);
}
#refresh-btn i {
  color:white;
  font-size: 24px;
  display:block;
  margin-bottom: 4px;
  line-height: 1;
  transition: all 0.2s ease;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
#refresh-btn:hover i {
  transform: rotate(8deg);
  text-shadow: 0 2px 4px rgba(0,0,0,0.4);
}
#refresh-btn span {
  display:block;
  width: 100%;
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
  padding: 0 5px;
  text-shadow: 
    -1px -1px 0 #000,  
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000;
}
</style>
</head>
<body class="bg-lightBg min-h-screen flex flex-col p-2 md:p-4 pt-6 pb-6">
<div class="max-w-5xl w-full bg-cardBg rounded-2xl shadow-elevation-2 overflow-hidden fade-in self-center border border-gray-100">
  <div class="bg-gradient-to-r from-primary to-[#006658] p-4 md:p-6 text-white text-center relative overflow-hidden">
    <div class="absolute top-0 left-0 w-24 h-24 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/3"></div>
    <div class="absolute bottom-0 right-0 w-32 h-32 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3"></div>
    <div class="relative z-10">
      <div class="inline-flex items-center justify-center w-14 h-14 bg-white/10 backdrop-blur-sm rounded-full mb-3 pulse-subtle border border-white/20">
        <i class="fa fa-film text-2xl text-accent"></i>
      </div>
      <h1 class="text-2xl md:text-3xl font-bold mb-1 tracking-wide"> ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </h1>
      <p class="text-white/90 text-sm md:text-base font-light">å½¥å½¬_å¹¸ç¦ç³»çµ± <span class="text-accent font-medium">å°Šçˆµç”¨æˆ¶å°ˆå±¬</span></p>
    </div>
  </div>
  <div class="p-3 md:p-5">
    <div id="status" class="flex items-center justify-center py-8 text-textPrimary text-center">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-primary mb-3"></div>
        <p id="status-text" class="text-base font-medium">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±ï¼Œè«‹ç¨å€™...</p>
      </div>
    </div>
    <div id="error-message" class="hidden bg-red-50 border border-red-100 text-red-700 px-4 py-4 rounded-xl mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-exclamation-circle text-red-500 mt-1 mr-2 text-lg"></i>
        <div id="error-content" class="text-sm"></div>
      </div>
    </div>
    <div id="success-message" class="hidden bg-green-50 border border-green-100 text-green-700 px-4 py-4 rounded-xl mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-check-circle text-green-500 mt-1 mr-2 text-lg"></i>
        <div id="success-content" class="text-sm"></div>
      </div>
    </div>
    <div id="result-card" class="hidden bg-gradient-to-r from-premiumBg to-[#FFFAF0] border border-premiumBorder rounded-2xl p-5 mb-5 text-center fade-in relative overflow-hidden shadow-elevation-1">
      <div class="absolute top-0 right-0 w-20 h-20 bg-gold/5 rounded-full translate-x-1/2 -translate-y-1/2"></div>
      <div class="absolute bottom-0 left-0 w-16 h-16 bg-primary/5 rounded-full -translate-x-1/2 translate-y-1/2"></div>
      <div class="relative z-10">
        <div class="inline-block mb-3 relative">
          <div class="bg-primary w-16 h-16 rounded-full flex items-center justify-center shadow-primary-hover">
            <i class="fa fa-user text-white text-2xl"></i>
            <div id="refresh-btn" title="åˆ·æ–°é©—è­‰ä¸¦é‡æ–°åŠ è¼‰æ•¸æ“š" onclick="reauthenticateUser()">
              <i class="fa fa-refresh"></i>
              <span>æœ€æ–°è³‡æ–™</span>
            </div>
          </div>
        </div>
        <div id="result-main" class="text-xl md:text-2xl font-bold mb-3 text-textPrimary text-gold-gradient"></div>
        <div id="result-details" class="text-sm text-textSecondary space-y-2 md:space-y-2">
          <div class="flex items-center justify-center">
            <span class="premium-badge mr-2">å°Šçˆµ</span>
            <span id="user-role-display" class="font-medium"></span>
          </div>
          <div id="user-name-display" class="hidden">
            <i class="fa fa-user text-primary mr-1"></i> <span class="font-medium">ä½¿ç”¨è€…ï¼š</span> <span id="user-name"></span>
          </div>
          <div id="user-expiry-display" class="hidden">
            <i class="fa fa-calendar text-primary mr-1"></i> <span class="font-medium">ä½¿ç”¨æœŸé™ï¼š</span> <span id="expiry-date"></span> (<span id="remaining-days"></span>)
          </div>
        </div>
        <div id="content-count-display" class="mt-4 text-base font-semibold text-primary bg-white/50 rounded-lg py-2 px-4 inline-block">
          <i class="fa fa-play-circle mr-1"></i> å½±éŸ³æ•¸ï¼š<span id="video-count-num">0</span> | 
          <i class="fa fa-file mr-1"></i> æ–‡ä»¶æ•¸ï¼š<span id="file-count-num">0</span>
        </div>
        <div class="w-24 h-1 bg-gradient-to-r from-primary to-[#00A88D] mx-auto my-4 rounded-full"></div>
      </div>
    </div>
    
    <div class="relative mb-5">
      <button id="content-type-toggle" class="mobile-btn w-full primary-gradient text-white text-sm font-medium px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-between border-none">
        <span id="current-content-type" class="font-semibold">å½±éŸ³åˆ—è¡¨</span>
        <i class="fa fa-chevron-down text-sm"></i>
      </button>
      <div id="content-type-dropdown" class="dropdown-menu hidden">
        <div class="dropdown-item" onclick="switchContentType('video')">
          <i class="fa fa-play-circle mr-2"></i>å½±éŸ³åˆ—è¡¨
        </div>
        <div class="dropdown-item" onclick="switchContentType('file')">
          <i class="fa fa-file mr-2"></i>æ–‡ä»¶åˆ—è¡¨
        </div>
      </div>
    </div>
    
    <div id="content-viewer-section" class="hidden bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="viewer-section-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å½±éŸ³åˆ—è¡¨
        </h2>
        <div id="manage-content-btn-container" class="flex gap-2 hidden">
          <button onclick="toggleManageSection()" class="mobile-btn-sm primary-gradient text-white text-sm font-medium px-4 py-2 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center gap-1">
            <i class="fa fa-cog text-sm"></i> å…§å®¹ç®¡ç†
          </button>
        </div>
      </div>
      
      <div class="content-selector" id="content-select-container">
        <select id="content-select" class="w-full" onchange="selectContent(this.value)">
          <option value="">è«‹é¸æ“‡è¦æŸ¥çœ‹çš„å…§å®¹...</option>
        </select>
      </div>
      
      <button id="start-watch-btn" class="start-watch-btn hidden" onclick="startWatch()">
        <i class="fa fa-play-circle mr-2"></i> é–‹å§‹è§€çœ‹
      </button>
      
      <div id="selected-content-display" class="hidden">
        <div class="content-display-card" id="viewer-content-card"></div>
      </div>
      
      <div id="viewer-empty-list" class="py-10 text-center text-textSecondary hidden">
        <div class="inline-block bg-primary w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-primary-hover">
          <i class="fa fa-film text-white text-2xl"></i>
        </div>
        <p id="viewer-empty-text" class="text-lg font-medium">æš«ç„¡å¯æŸ¥çœ‹çš„å½±éŸ³</p>
        <p class="text-xs mt-2 text-textSecondary/70">è«‹è¯ç¹«ç®¡ç†å“¡æ·»åŠ å…§å®¹</p>
      </div>
    </div>
    
    <div id="content-manage-section" class="bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1 hidden">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
        <h2 id="manage-section-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-th-list text-primary mr-2 text-sm"></i> å½±éŸ³ç®¡ç†åˆ—è¡¨
        </h2>
        <div id="manage-action-buttons" class="flex gap-2 w-full md:w-auto">
          <button id="add-content-btn" onclick="addNewContent()" class="mobile-btn primary-gradient text-white text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-plus text-lg"></i> æ–°å¢å½±éŸ³
          </button>
          <button onclick="toggleManageSection()" class="mobile-btn bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-xl shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-lg"></i> è¿”å›
          </button>
        </div>
      </div>
      <div id="video-list-container" class="space-y-3 mb-3 max-h-[600px] overflow-y-auto pr-2"></div>
      <div id="file-list-container" class="space-y-3 mb-3 max-h-[600px] overflow-y-auto pr-2 hidden"></div>
      <div id="empty-manage-list" class="py-8 text-center text-textSecondary hidden">
        <div class="inline-block bg-primary w-14 h-14 rounded-full flex items-center justify-center mb-3 shadow-primary-hover">
          <i class="fa fa-film text-white text-xl"></i>
        </div>
        <p id="empty-manage-text" class="text-base font-medium">å°šæœªæ·»åŠ ä»»ä½•å½±éŸ³</p>
        <p id="empty-manage-tip" class="text-xs mt-2">é»æ“Šã€Œæ–°å¢å½±éŸ³ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ </p>
      </div>
    </div>
    
    <div id="video-edit-section" class="hidden bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="video-edit-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢å½±éŸ³
        </h2>
        <button onclick="hideVideoEditSection()" class="text-textSecondary hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/5 shadow-sm">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="video-form" onsubmit="saveVideo(event)">
        <input type="hidden" id="video-id" value="">
        <div class="space-y-4">
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> å½±éŸ³åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="video-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥å½±éŸ³åç¨±" required>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-link text-primary mr-2 text-xs"></i> è¦–é »/æ’­å®¢éˆæ¥ <span class="text-red-500">*</span>
            </label>
            <input type="url" id="video-url" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥YouTubeã€é¨°è¨Šè¦–é »ã€Spotifyã€Podcastæœ‰æ•ˆç¶²å€" required>
            <p class="text-xs text-textSecondary mt-1 bg-white/80 p-2 rounded-lg">
              <i class="fa fa-lightbulb-o text-accent mr-1"></i> æ”¯æ´YouTubeã€é¨°è¨Šè¦–é »ã€Spotifyã€Apple Podcastã€å„å¤§æ’­å®¢å¹³å°éˆæ¥
            </p>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="video-note" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm shadow-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-2 flex gap-3">
            <button type="button" onclick="hideVideoEditSection()" class="mobile-btn-sm w-1/3 bg-gray-100 hover:bg-gray-200 text-textPrimary font-medium px-3 py-2 rounded-xl transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="video-save-btn" class="mobile-btn-sm w-2/3 primary-gradient text-white font-medium px-3 py-2 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="video-save-btn-text">å„²å­˜å½±éŸ³</span>
              <div id="video-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    
    <div id="file-edit-section" class="hidden bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="file-edit-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢æ–‡ä»¶
        </h2>
        <button onclick="hideFileEditSection()" class="text-textSecondary hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/5 shadow-sm">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="file-form" onsubmit="saveFile(event)">
        <input type="hidden" id="file-id-hidden" value="">
        <div class="space-y-4">
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> æ–‡ä»¶åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="file-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥æ–‡ä»¶åç¨±" required>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-link text-primary mr-2 text-xs"></i> æ–‡ä»¶éˆæ¥ <span class="text-red-500">*</span>
            </label>
            <input type="url" id="file-url" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥æ–‡ä»¶æœ‰æ•ˆç¶²å€" required>
            <p class="text-xs text-textSecondary mt-1 bg-white/80 p-2 rounded-lg">
              <i class="fa fa-lightbulb-o text-accent mr-1"></i> æ”¯æ´PDFã€Wordã€Excelç­‰å„é¡æ–‡ä»¶éˆæ¥
            </p>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="file-note" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm shadow-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-2 flex gap-3">
            <button type="button" onclick="hideFileEditSection()" class="mobile-btn-sm w-1/3 bg-gray-100 hover:bg-gray-200 text-textPrimary font-medium px-3 py-2 rounded-xl transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="file-save-btn" class="mobile-btn-sm w-2/3 primary-gradient text-white font-medium px-3 py-2 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="file-save-btn-text">å„²å­˜æ–‡ä»¶</span>
              <div id="file-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    
    <div id="content-preview" class="hidden bg-cardBg rounded-2xl p-3 md:p-5 mb-5 scale-in border border-primary/20 shadow-elevation-2">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å…§å®¹é è¦½
        </h2>
        <div id="preview-action-btns" class="flex gap-2 hidden">
          <button id="preview-edit-btn" onclick="editCurrentContent()" class="mobile-btn-sm bg-primary text-white text-sm font-medium flex items-center gap-1 px-3 py-2 rounded-xl shadow-primary-hover">
            <i class="fa fa-pencil text-sm"></i> ç·¨è¼¯
          </button>
          <button id="preview-delete-btn" onclick="event.stopPropagation();deleteCurrentContent()" class="mobile-btn-sm bg-red-500 hover:bg-red-600 text-white text-sm font-medium flex items-center gap-1 px-3 py-2 rounded-xl shadow-md">
            <i class="fa fa-trash text-sm"></i> åˆªé™¤
          </button>
          <button onclick="hideContentPreview()" class="text-textSecondary hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/5 shadow-sm">
            <i class="fa fa-times-circle text-lg"></i>
          </button>
        </div>
      </div>
      <div id="preview-content" class="space-y-4">
        <h3 id="preview-title" class="text-sm md:text-base font-semibold text-textPrimary text-center mb-3 text-gold-gradient"></h3>
        <div id="preview-container" class="mb-4">
          <div id="video-container" class="video-container mb-4 flex items-center justify-center hidden">
            <div id="video-loading" class="absolute text-white/80">
              <div class="bg-primary w-12 h-12 rounded-full flex items-center justify-center animate-spin">
                <i class="fa fa-spinner text-white text-xl"></i>
              </div>
              <p class="text-sm mt-2">è¼‰å…¥å½±ç‰‡ä¸­...</p>
            </div>
            <iframe id="preview-video" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" onload="this.classList.add('loaded'); document.getElementById('video-loading').classList.add('hidden');"></iframe>
          </div>
          <div id="audio-container" class="audio-container mb-4 flex items-center justify-center hidden">
            <div id="audio-loading" class="absolute text-white/80">
              <div class="bg-primary w-12 h-12 rounded-full flex items-center justify-center animate-spin">
                <i class="fa fa-spinner text-white text-xl"></i>
              </div>
              <p class="text-sm mt-2">è¼‰å…¥æ’­å®¢ä¸­...</p>
            </div>
            <iframe id="preview-audio" src="" allow="encrypted-media; autoplay" onload="this.classList.add('loaded'); document.getElementById('audio-loading').classList.add('hidden');"></iframe>
          </div>
          <div id="unsupported-tip" class="py-10 text-center text-textSecondary hidden">
            <div class="inline-block bg-orange-500/10 w-16 h-16 rounded-full flex items-center justify-center mb-4">
              <i class="fa fa-exclamation-triangle text-3xl mb-3 text-orange-500"></i>
            </div>
            <p class="text-lg font-medium">ä¸æ”¯æ´çš„å…§å®¹é¡å‹</p>
            <p class="text-xs mt-2 text-textSecondary/70">åƒ…æ”¯æ´YouTubeã€é¨°è¨Šè¦–é »ã€Spotifyã€Apple Podcasté è¦½</p>
            <a id="direct-link-btn" href="" target="_blank" class="mt-4 inline-block primary-gradient text-white px-5 py-3 rounded-xl text-sm font-semibold shadow-primary-hover">
              <i class="fa fa-external-link mr-1"></i> ç›´æ¥æ‰“é–‹éˆæ¥
            </a>
          </div>
          <div id="file-preview-tip" class="py-10 text-center text-textSecondary hidden">
            <div class="inline-block bg-blue-500/10 w-16 h-16 rounded-full flex items-center justify-center mb-4">
              <i class="fa fa-file text-3xl text-blue-500"></i>
            </div>
            <p class="text-lg font-medium" id="file-preview-name"></p>
            <p class="text-xs mt-2 text-textSecondary/70">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥çœ‹å…§å®¹</p>
            <a id="file-preview-btn" href="" target="_blank" class="mt-4 inline-block primary-gradient text-white px-5 py-3 rounded-xl text-sm font-semibold shadow-primary-hover">
              <i class="fa fa-external-link mr-1"></i> æŸ¥çœ‹å…§å®¹
            </a>
          </div>
        </div>
        <div class="bg-neutral rounded-xl p-4 text-xs md:text-sm text-textSecondary shadow-sm">
          <div class="grid grid-cols-1 gap-3 mb-3">
            <div>
              <span class="font-semibold text-textPrimary text-xs md:text-sm"><i class="fa fa-clock-o text-primary mr-1.5 text-xs"></i> æœ€å¾Œæ›´æ–°ï¼š</span>
              <p id="preview-updated" class="mt-1 text-xs md:text-sm bg-white/80 p-2 rounded-lg"></p>
            </div>
            <div>
              <span class="font-semibold text-textPrimary text-xs md:text-sm"><i class="fa fa-sticky-note text-primary mr-1.5 text-xs"></i> å‚™æ³¨ï¼š</span>
              <p id="preview-note" class="mt-1 text-xs md:text-sm bg-white/80 p-2 rounded-lg">- ç„¡å‚™æ³¨ -</p>
            </div>
          </div>
        </div>
        <div class="flex justify-center mt-3">
          <button onclick="hideContentPreview()" class="mobile-btn bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium px-6 py-3 rounded-xl flex items-center justify-center gap-1 shadow-sm">
            <i class="fa fa-arrow-left text-sm"></i> è¿”å›åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// é…ç½®å¸¸é‡
const CONFIG={
  LIFF_ID:"2008578880-cOBTYud0",
  GAS_URL:"https://script.google.com/macros/s/AKfycbyZMHC4c3QRgBnjFX3-4S1wI8-9x1519SQwwwxom8oDRupOpysz0SOlU4jO40frncXoIg/exec",
  JSONP_TIMEOUT:10000,
  PERMANENT_EXPIRY_DATE:"9999/12/31",
  STORAGE_KEY_PREFIX:"yanbin_video_manager_",
  AUTH_CACHE_HOURS:24, // æƒé™éªŒè¯ç¼“å­˜24å°æ—¶
  VIDEO_CACHE_HOURS:24  // è§†é¢‘åˆ—è¡¨ç¼“å­˜24å°æ—¶
};

// æ‡‰ç”¨ç‹€æ…‹
let appState={
  currentUser:null,videoList:[],fileList:[],currentViewingId:null,
  currentViewingType:null,currentEditingVideoId:null,currentEditingFileId:null,
  isSubmitting:false,draggingItem:null,userRole:'',
  userExpiryInfo:{remainingDays:0,expiryDate:''},
  userNickname:'',selectedContentId:'',currentContentType:'video',
  isFirstLoad:true
};

// æœ¬åœ°å­˜å„²å·¥å…·
const storage={
  set:(key,data,expireHours=CONFIG.VIDEO_CACHE_HOURS)=>{
    try{
      const item={data:data,expiry:Date.now()+(expireHours*60*60*1000)};
      localStorage.setItem(CONFIG.STORAGE_KEY_PREFIX+key,JSON.stringify(item));
    }catch(e){console.error('å­˜å„²ç·©å­˜å¤±æ•—:',e);}
  },
  get:(key)=>{
    try{
      const itemStr=localStorage.getItem(CONFIG.STORAGE_KEY_PREFIX+key);
      if(!itemStr)return null;
      const item=JSON.parse(itemStr);
      if(Date.now()>item.expiry){
        localStorage.removeItem(CONFIG.STORAGE_KEY_PREFIX+key);
        return null;
      }
      return item.data;
    }catch(e){console.error('è®€å–ç·©å­˜å¤±æ•—:',e);return null;}
  },
  remove:(key)=>{
    try{localStorage.removeItem(CONFIG.STORAGE_KEY_PREFIX+key);}
    catch(e){console.error('æ¸…é™¤ç·©å­˜å¤±æ•—:',e);}
  },
  clearAll:()=>{
    try{
      Object.keys(localStorage).forEach(key=>{
        if(key.startsWith(CONFIG.STORAGE_KEY_PREFIX))localStorage.removeItem(key);
      });
    }catch(e){console.error('æ¸…é™¤æ‰€æœ‰ç·©å­˜å¤±æ•—:',e);}
  }
};

// å·¥å…·å‡½æ•°å°è£…
const utils={
  $:id=>document.getElementById(id),
  convertUTCToTaiwanTime:(utcStr)=>{
    const options={timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'};
    return utcStr?new Date(utcStr).toLocaleString('zh-TW',options):new Date().toLocaleString('zh-TW',options);
  },
  setStatus:(text)=>{
    const el=utils.$('status-text');
    if(el)el.textContent=text;
  },
  resetSubmitState:()=>{
    setVideoSubmitState(false);
    setFileSubmitState(false);
  },
  isValidUrl:(url)=>{
    try{new URL(url);return true;}catch(e){return false;}
  }
};

// æç¤ºè¨Šæ¯è™•ç†
const showError=(msg)=>{
  const hideEls=[utils.$('status'),utils.$('result-card'),utils.$('content-viewer-section'),
    utils.$('content-manage-section'),utils.$('video-edit-section'),utils.$('file-edit-section'),
    utils.$('content-preview'),utils.$('success-message')];
  hideEls.forEach(el=>el&&el.classList.add('hidden'));
  
  const errorEl=utils.$('error-message'),contentEl=utils.$('error-content');
  if(errorEl&&contentEl){
    contentEl.innerHTML=`<p class="font-medium text-lg">${msg}</p>
<div class="mt-2 flex justify-center gap-3">
  <button onclick="window.location.href = 'https://lihi.cc/DLihS'" class="text-primary hover:text-[#007A69] font-medium text-base px-6 py-3 rounded-lg bg-white border border-primary/20 hover:bg-primary/5 transition-all duration-300 flex items-center gap-2 shadow-sm hover:shadow-md">
    <i class="fa fa-user-circle"></i> è¯ç¹«<br>å½¥å½¬
  </button>
  <button onclick="window.location.reload()" class="text-primary hover:text-[#007A69] font-medium text-base px-6 py-3 rounded-lg bg-white border border-primary/20 hover:bg-primary/5 transition-all duration-300 flex items-center gap-2 shadow-sm hover:shadow-md">
    <i class="fa fa-refresh"></i> é‡æ–°<br>åŠ è¼‰
  </button>
</div>`;
    errorEl.classList.remove('hidden');
  }
  utils.resetSubmitState();
};

const showSuccess=(msg)=>{
  const errorEl=utils.$('error-message');
  if(errorEl)errorEl.classList.add('hidden');
  
  const successEl=utils.$('success-message'),contentEl=utils.$('success-content');
  if(successEl&&contentEl){
    contentEl.innerHTML=`<p class="font-medium">${msg}</p>`;
    successEl.classList.remove('hidden');
    setTimeout(()=>successEl&&successEl.classList.add('hidden'),4000);
  }
};

// æäº¤ç‹€æ…‹ç®¡ç†
const setSubmitState=(type,isSubmitting)=>{
  appState.isSubmitting=isSubmitting;
  let saveBtn,saveBtnText,saveLoading,btnText;
  
  if(type==='video'){
    saveBtn=utils.$('video-save-btn');
    saveBtnText=utils.$('video-save-btn-text');
    saveLoading=utils.$('video-save-loading');
    btnText=appState.currentEditingVideoId?"æ›´æ–°å½±éŸ³":"å„²å­˜å½±éŸ³";
  }else{
    saveBtn=utils.$('file-save-btn');
    saveBtnText=utils.$('file-save-btn-text');
    saveLoading=utils.$('file-save-loading');
    btnText=appState.currentEditingFileId?"æ›´æ–°æ–‡ä»¶":"å„²å­˜æ–‡ä»¶";
  }
  
  if(isSubmitting){
    saveBtn&&saveBtn.classList.add('btn-disabled');
    saveBtnText&&(saveBtnText.textContent="å„²å­˜ä¸­...");
    saveLoading&&saveLoading.classList.remove('hidden');
  }else{
    saveBtn&&saveBtn.classList.remove('btn-disabled');
    saveBtnText&&(saveBtnText.textContent=btnText);
    saveLoading&&saveLoading.classList.add('hidden');
  }
};

const setVideoSubmitState=(isSubmitting)=>setSubmitState('video',isSubmitting);
const setFileSubmitState=(isSubmitting)=>setSubmitState('file',isSubmitting);

// URLé©—è­‰å·¥å…·
const urlCheckers={
  isYoutube:(url)=>url&&(url.toLowerCase().includes('youtube.com')||url.toLowerCase().includes('youtu.be')||url.toLowerCase().includes('youtube-nocookie.com')),
  isTencent:(url)=>url&&url.toLowerCase().includes('v.qq.com'),
  isSpotify:(url)=>url&&(url.toLowerCase().includes('spotify.com')||url.toLowerCase().includes('open.spotify.com')),
  isApplePodcast:(url)=>url&&(url.toLowerCase().includes('podcasts.apple.com')||url.toLowerCase().includes('itunes.apple.com/podcast')),
  isPodcast:(url)=>url&&['podcast','pca.st','soundcloud.com','anchor.fm','mixcloud.com','castbox.fm','player.fm','listennotes.com'].some(d=>url.toLowerCase().includes(d)),
  isValidUrl:utils.isValidUrl
};

// è½‰æ›åµŒå…¥URL
const convertToEmbedUrl=(url)=>{
  if(!url)return{type:'unsupported',url:''};
  
  if(urlCheckers.isYoutube(url)){
    const match=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/|live\/|playlist\?list=)|youtube-nocookie\.com\/embed\/)([\w-]+)/);
    if(match&&match[1]){
      const isShort=url.includes('shorts/');
      return{type:'video',url:`https://www.youtube.com/embed/${match[1]}?autoplay=0&rel=0${isShort?'&enablejsapi=1':''}`};
    }
    const vidMatch=url.match(/[?&]v=([^&]+)/);
    if(vidMatch&&vidMatch[1])return{type:'video',url:`https://www.youtube.com/embed/${vidMatch[1]}?autoplay=0&rel=0`};
  }else if(urlCheckers.isTencent(url)){
    const regs=[/v\.qq\.com\/x\/page\/([a-zA-Z0-9_]+)\.html/,/v\.qq\.com\/x\/cover\/([a-zA-Z0-9_]+)\/([a-zA-Z0-9_]+)\.html/,
      /v\.qq\.com\/detail\/\w+\/([a-zA-Z0-9_]+)\.html/,/vid=([a-zA-Z0-9_]+)/];
    let vid='';
    for(let reg of regs){const match=url.match(reg);if(match){vid=match[2]||match[1]||'';break;}}
    if(vid)return{type:'video',url:`https://v.qq.com/txp/iframe/player.html?vid=${vid}&auto=0&show1080p=1`};
  }else if(urlCheckers.isSpotify(url)){
    const match=url.match(/spotify\.com\/(track|episode|playlist|album|show)\/([a-zA-Z0-9]+)/);
    if(match&&match[2]){
      return{type:'audio',url:`https://open.spotify.com/embed/${match[1]}/${match[2]}?utm_source=generator&autoplay=0`};
    }
    const idMatch=url.match(/[a-zA-Z0-9]{22}/);
    if(idMatch)return{type:'audio',url:`https://open.spotify.com/embed/track/${idMatch[0]}?utm_source=generator&autoplay=0`};
  }else if(urlCheckers.isApplePodcast(url)){
    const showMatch=url.match(/podcasts\.apple\.com\/.+\/podcast\/.+\/id(\d+)/);
    if(showMatch&&showMatch[1]){
      return{type:'audio',url:`https://embed.podcasts.apple.com/us/podcast/id${showMatch[1]}?itsct=podcast_box&itscg=30200`};
    }
    const episodeMatch=url.match(/\/id(\d+)\?i=(\d+)/);
    if(episodeMatch&&episodeMatch[2]){
      return{type:'audio',url:`https://embed.podcasts.apple.com/us/podcast/id${episodeMatch[1]}?i=${episodeMatch[2]}&itsct=podcast_box&itscg=30200`};
    }
  }else if(urlCheckers.isPodcast(url)){
    if(url.includes('soundcloud.com')){
      const match=url.match(/soundcloud\.com\/([^\/]+)\/([^\/]+)/);
      if(match)return{type:'audio',url:`https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&visual=true`};
    }else if(url.includes('anchor.fm')){
      const match=url.match(/anchor\.fm\/([^\/]+)\/episodes\/([^\/]+)/);
      if(match)return{type:'audio',url:`https://anchor.fm/${match[1]}/embed/episodes/${match[2]}?color=blue&autoplay=false`};
    }
    return{type:'audio',url:url};
  }
  
  try{
    const urlObj=new URL(url);
    const videoDomains=['facebook.com','fb.watch','instagram.com','tiktok.com','douyin.com','bilibili.com','iqiyi.com','youku.com'];
    if(videoDomains.some(domain=>urlObj.host.includes(domain))){
      return{type:'video',url:url};
    }
  }catch(e){}
  
  return{type:'unsupported',url:url};
};

// è¨ˆç®—å‰©é¤˜å¤©æ•¸
const calculateRemainingDaysByDate=(expiryDateStr)=>{
  try{
    if(expiryDateStr===CONFIG.PERMANENT_EXPIRY_DATE)return{displayDate:"æ°¸ä¹…æœ‰æ•ˆ",remainingDays:"æ°¸ä¹…æœ‰æ•ˆ"};
    if(!/^\d{4}[-\/]\d{2}[-\/]\d{2}(?:\s+\d{1,2}:\d{1,2}(?::\d{1,2})?)?$/.test(expiryDateStr)){
      return{displayDate:"æ ¼å¼éŒ¯èª¤",remainingDays:"æ ¼å¼éŒ¯èª¤"};
    }
    
    const normalized=expiryDateStr.replace(/-/g,'/');
    let expiryDate;
    
    if(normalized.includes(' ')){
      const [datePart,timePart]=normalized.split(' ');
      const [y,m,d]=datePart.split('/').map(Number);
      expiryDate=new Date(Date.UTC(y,m-1,d+1,0,0,0));
    }else{
      const [y,m,d]=normalized.split('/').map(Number);
      expiryDate=new Date(Date.UTC(y,m-1,d+1,0,0,0));
    }
    
    if(isNaN(expiryDate.getTime()))return{displayDate:"æ—¥æœŸç„¡æ•ˆ",remainingDays:"æ—¥æœŸç„¡æ•ˆ"};
    
    const now=new Date();
    const taipeiOffset=8*60*60*1000;
    const nowTaipei=new Date(now.getTime()+taipeiOffset);
    const todayStartTaipei=new Date(Date.UTC(nowTaipei.getFullYear(),nowTaipei.getMonth(),nowTaipei.getDate()));
    
    const timeDiff=expiryDate-todayStartTaipei;
    const remainingDays=Math.ceil(timeDiff/(1000*3600*24));
    
    const formattedDate=new Date(expiryDate.getTime()-taipeiOffset).toLocaleString('zh-TW',{
      timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit'
    });
    
    let remainingDaysText;
    if(remainingDays<0)remainingDaysText="<span class='text-red-500 font-medium'>å·²éæœŸ</span>";
    else if(remainingDays===0)remainingDaysText="<span class='text-orange-500 font-medium'>æœ€å¾Œ1å¤©</span>";
    else if(remainingDays<=30)remainingDaysText=`"<span class='text-orange-500 font-medium'>${remainingDays} å¤©</span>"`;
    else remainingDaysText=`${remainingDays} å¤©`;
    
    return{displayDate:formattedDate,remainingDays:remainingDaysText};
  }catch(error){
    console.error("è¨ˆç®—å‰©é¤˜å¤©æ•¸å¤±æ•—ï¼š",error);
    return{displayDate:"è¨ˆç®—éŒ¯èª¤",remainingDays:"è¨ˆç®—éŒ¯èª¤"};
  }
};

// ç²å–é è¦½åœ–
const getThumbnail=(url,type)=>{
  if(!url)return 'https://via.placeholder.com/300x180?text=No+Preview';
  if(type==='video'){
    if(urlCheckers.isYoutube(url)){
      const match=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/))([\w-]+)/);
      return match&&match[1]?`https://img.youtube.com/vi/${match[1]}/mqdefault.jpg`:'https://via.placeholder.com/300x180?text=è¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(urlCheckers.isTencent(url)){
      return 'https://via.placeholder.com/300x180?text=é¨°è¨Šè¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(urlCheckers.isSpotify(url)){
      return 'https://via.placeholder.com/300x180?text=Spotify&bgcolor=1DB954&color=ffffff';
    }else if(urlCheckers.isApplePodcast(url)){
      return 'https://via.placeholder.com/300x180?text=Apple Podcast&bgcolor=ffffff&color=000000';
    }else if(urlCheckers.isPodcast(url)){
      return 'https://via.placeholder.com/300x180?text=æ’­å®¢&bgcolor=7C3AED&color=ffffff';
    }
    return 'https://via.placeholder.com/300x180?text=å½±éŸ³&bgcolor=e8f9f7&color=008c76';
  }else if(type==='file'){
    const lowerUrl=url.toLowerCase();
    if(lowerUrl.endsWith('.pdf'))return 'https://via.placeholder.com/300x180?text=PDFæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.doc')||lowerUrl.endsWith('.docx'))return 'https://via.placeholder.com/300x180?text=Wordæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.xls')||lowerUrl.endsWith('.xlsx'))return 'https://via.placeholder.com/300x180?text=Excelæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lowerUrl.endsWith('.ppt')||lowerUrl.endsWith('.pptx'))return 'https://via.placeholder.com/300x180?text=PPTæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else return 'https://via.placeholder.com/300x180?text=æ–‡ä»¶&bgcolor=f0f7ff&color=64748b';
  }
  return 'https://via.placeholder.com/300x180?text=å…§å®¹&bgcolor=f1f5f9&color=64748b';
};

// æ‹–æ”¾è™•ç†
const dragHandlers={
  start:(e)=>{
    if(!isManageUser())return;
    appState.draggingItem=e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData('text/plain',JSON.stringify({id:e.target.dataset.id,type:e.target.dataset.type}));
    e.target.style.opacity='0.5';
  },
  over:(e)=>{
    if(!isManageUser())return;
    e.preventDefault();
    const item=e.target.closest('.video-item');
    if(item&&item!==appState.draggingItem)item.classList.add('drop-zone');
  },
  leave:(e)=>{
    if(!isManageUser())return;
    const item=e.target.closest('.video-item');
    item&&item.classList.remove('drop-zone');
  },
  drop:(e)=>{
    if(!isManageUser())return;
    e.preventDefault();
    const dragData=JSON.parse(e.dataTransfer.getData('text/plain'));
    const targetItem=e.target.closest('.video-item');
    if(!targetItem||targetItem.dataset.id===dragData.id||targetItem.dataset.type!==dragData.type)return;
    let draggedIndex,targetIndex;
    if(dragData.type==='video'){
      draggedIndex=appState.videoList.findIndex(v=>v.id===dragData.id);
      targetIndex=appState.videoList.findIndex(v=>v.id===targetItem.dataset.id);
      if(draggedIndex!==-1&&targetIndex!==-1){
        const [draggedItem]=appState.videoList.splice(draggedIndex,1);
        appState.videoList.splice(targetIndex,0,draggedItem);
        syncVideoListOrderToGAS();
        renderContentList('manage');
        renderContentList('viewer');
        storage.set('videoList',appState.videoList);
      }
    }else if(dragData.type==='file'){
      draggedIndex=appState.fileList.findIndex(f=>f.id===dragData.id);
      targetIndex=appState.fileList.findIndex(f=>f.id===targetItem.dataset.id);
      if(draggedIndex!==-1&&targetIndex!==-1){
        const [draggedItem]=appState.fileList.splice(draggedIndex,1);
        appState.fileList.splice(targetIndex,0,draggedItem);
        syncFileListOrderToGAS();
        renderContentList('manage');
        renderContentList('viewer');
        storage.set('fileList',appState.fileList);
      }
    }
    targetItem.classList.remove('drop-zone');
    if(appState.draggingItem){
      appState.draggingItem.classList.remove('dragging');
      appState.draggingItem.style.opacity='1';
    }
    appState.draggingItem=null;
    showSuccess('å…§å®¹é †åºå·²å³æ™‚æ›´æ–°ï¼');
  },
  end:(e)=>{
    if(!isManageUser())return;
    e.target.classList.remove('dragging');
    e.target.style.opacity='1';
    document.querySelectorAll('.video-item').forEach(item=>item.classList.remove('drop-zone'));
    appState.draggingItem=null;
  }
};

// æ›´æ–°å…§å®¹è¨ˆæ•¸é¡¯ç¤º
const updateContentCountDisplay=()=>{
  const videoCount=utils.$('video-count-num'),fileCount=utils.$('file-count-num');
  videoCount&&(videoCount.textContent=appState.videoList.length);
  fileCount&&(fileCount.textContent=appState.fileList.length);
};

// æ¬Šé™åˆ¤æ–·
const isAdminUser=()=>appState.userRole==='admin';
const isProUser=()=>appState.userRole==='pro'||isAdminUser();
const isManageUser=()=>isAdminUser();

// é‡æ–°é©—è­‰ç”¨æˆ¶æ¬Šé™
const reauthenticateUser=async()=>{
  try{
    storage.remove('userAuth');
    
    utils.$('status')?.classList.remove('hidden');
    utils.setStatus('é‡æ–°é©—è­‰ç”¨æˆ¶æ¬Šé™ä¸¦åŠ è¼‰æ•¸æ“šä¸­...');
    
    utils.$('error-message')?.classList.add('hidden');
    
    await verifyUserPermission();
    
    await Promise.all([
      fetchVideoListFromGAS(true),
      fetchFileListFromGAS() // æ–‡ä»¶åˆ—è¡¨å¼ºåˆ¶åˆ·æ–°
    ]);
    
    updateUserInfoDisplay();
    updateContentCountDisplay();
    
    utils.$('status')?.classList.add('hidden');
    utils.$('result-card')?.classList.remove('hidden');
    utils.$('content-viewer-section')?.classList.remove('hidden');
    
    renderContentList('viewer');
    renderContentList('manage');
    
    const manageBtnContainer=utils.$('manage-content-btn-container');
    if(manageBtnContainer){
      manageBtnContainer.classList.toggle('hidden',!isManageUser());
    }
    
    showSuccess('ç”¨æˆ¶æ¬Šé™å·²é‡æ–°é©—è­‰ï¼Œæ‰€æœ‰æ•¸æ“šå·²åˆ·æ–°ï¼');
  }catch(error){
    showError(`é‡æ–°é©—è­‰å¤±æ•—ï¼š${error.message}`);
  }
};

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
const updateUserInfoDisplay=()=>{
  const userRoleDisplay=utils.$('user-role-display');
  const userNameDisplay=utils.$('user-name-display');
  const userName=utils.$('user-name');
  const userExpiryDisplay=utils.$('user-expiry-display');
  const expiryDate=utils.$('expiry-date');
  const remainingDays=utils.$('remaining-days');
  const resultMain=utils.$('result-main');
  
  if(resultMain){
    resultMain.textContent=isAdminUser()?'ç®¡ç†å“¡å°ˆå±¬ç³»çµ±':(isProUser()?'å°Šçˆµç”¨æˆ¶å°ˆå±¬å…§å®¹':'æ™®é€šç”¨æˆ¶å…§å®¹');
  }
  
  if(userRoleDisplay){
    userRoleDisplay.textContent=isAdminUser()?'ç®¡ç†å“¡':(isProUser()?'å°Šçˆµç”¨æˆ¶':'æ™®é€šç”¨æˆ¶');
  }
  
  if(userNameDisplay&&userName){
    userNameDisplay.classList.remove('hidden');
    userName.textContent=appState.userNickname;
  }
  
  const expiryInfo=calculateRemainingDaysByDate(appState.userExpiryInfo.expiryDate);
  if(userExpiryDisplay&&expiryDate&&remainingDays){
    userExpiryDisplay.classList.remove('hidden');
    expiryDate.textContent=expiryInfo.displayDate;
    remainingDays.innerHTML=expiryInfo.remainingDays;
  }
};

// é©—è­‰ç”¨æˆ¶æ¬Šé™ - æ ¸å¿ƒä¿®æ”¹ï¼šæƒé™éªŒè¯ç¼“å­˜24å°æ—¶
const verifyUserPermission=()=>{
  return new Promise(async(resolve,reject)=>{
    utils.setStatus('é©—è­‰ç”¨æˆ¶æ¬Šé™...');
    
    // æƒé™éªŒè¯ç¼“å­˜24å°æ—¶ï¼Œä¸€å¤©åªéªŒè¯ä¸€æ¬¡
    const cachedAuth=storage.get('userAuth');
    if(cachedAuth&&appState.currentUser&&cachedAuth.userId===appState.currentUser.userId){
      appState.userRole=cachedAuth.userRole;
      appState.userExpiryInfo=cachedAuth.userExpiryInfo;
      appState.userNickname=cachedAuth.userNickname;
      resolve(true);
      return;
    }
    
    if(!appState.currentUser)return reject(new Error('ç”¨æˆ¶ä¿¡æ¯ä¸å­˜åœ¨'));
    
    const requestData={
      action:'verifyUser',
      userId:appState.currentUser.userId,
      displayName:appState.currentUser.displayName,
      writeToSheet:appState.isFirstLoad,
      needExpiryDate:true
    };
    
    try{
      const resp=await new Promise((resolve,reject)=>{
        $.ajax({
          url:CONFIG.GAS_URL,dataType:'jsonp',jsonp:'callback',timeout:10000,
          data:requestData,cache:true,success:resolve,
          error:(xhr,status,error)=>reject({status,error})
        });
      });
      
      if(resp.status==="success"&&resp.isAuthorized){
        appState.userRole=resp.isAdmin?'admin':(resp.isPro?'pro':'user');
        appState.userExpiryInfo={
          remainingDays:resp.remainingDays || 0,
          expiryDate:resp.expiryDate || CONFIG.PERMANENT_EXPIRY_DATE
        };
        appState.userNickname=resp.nickname || appState.currentUser.displayName || 'æœªçŸ¥ç”¨æˆ·';
        
        // ç¼“å­˜ç”¨æˆ·æƒé™ä¿¡æ¯24å°æ—¶
        storage.set('userAuth', {
          userId: appState.currentUser.userId,
          userRole: appState.userRole,
          userExpiryInfo: appState.userExpiryInfo,
          userNickname: appState.userNickname
        }, CONFIG.AUTH_CACHE_HOURS);
        
        resolve(true);
      } else {
        reject(new Error(resp.message || 'ç”¨æˆ·æœªæˆæƒè®¿é—®'));
      }
    } catch (error) {
      console.error('éªŒè¯ç”¨æˆ·æƒé™å¤±è´¥:', error);
      reject(new Error('éªŒè¯å¤±è´¥ï¼š' + (error.error || 'ç½‘ç»œé”™è¯¯')));
    }
  });
};

// ä»GASè·å–è§†é¢‘åˆ—è¡¨
const fetchVideoListFromGAS=(forceRefresh=false)=>{
  return new Promise(async(resolve,reject)=>{
    if(!forceRefresh){
      const cachedVideos=storage.get('videoList');
      if(cachedVideos){
        appState.videoList=cachedVideos;
        resolve(cachedVideos);
        return;
      }
    }
    
    utils.setStatus('åŠ è¼‰å½±éŸ³åˆ—è¡¨...');
    
    const requestData={
      action:'getVideos',
      userId:appState.currentUser?.userId
    };
    
    try{
      const resp=await new Promise((resolve,reject)=>{
        $.ajax({
          url:CONFIG.GAS_URL,dataType:'jsonp',jsonp:'callback',timeout:CONFIG.JSONP_TIMEOUT,
          data:requestData,cache:true,success:resolve,
          error:(xhr,status,error)=>reject({status,error})
        });
      });
      
      if(resp.status==="success"&&Array.isArray(resp.data)){
        appState.videoList=resp.data.map(item=>({
          id:item.id||'',
          name:item.name||'æœªå‘½åå½±éŸ³',
          url:item.url||'',
          note:item.note||'',
          updated:item.updated||utils.convertUTCToTaiwanTime(),
          order:item.order||0
        })).sort((a,b)=>a.order-b.order);
        
        storage.set('videoList',appState.videoList);
        resolve(appState.videoList);
      }else{
        reject(new Error(resp.message||'åŠ è¼‰å½±éŸ³åˆ—è¡¨å¤±æ•—'));
      }
    }catch(error){
      console.error('ç²å–å½±éŸ³åˆ—è¡¨å¤±æ•—:',error);
      reject(new Error('ç²å–å½±éŸ³åˆ—è¡¨å¤±æ•—ï¼š'+(error.error||'ç¶²çµ¡éŒ¯èª¤')));
    }
  });
};

// ä»GASè·å–æ–‡ä»¶åˆ—è¡¨
const fetchFileListFromGAS=(forceRefresh=false)=>{
  return new Promise(async(resolve,reject)=>{
    if(!forceRefresh){
      const cachedFiles=storage.get('fileList');
      if(cachedFiles){
        appState.fileList=cachedFiles;
        resolve(cachedFiles);
        return;
      }
    }
    
    utils.setStatus('åŠ è¼‰æ–‡ä»¶åˆ—è¡¨...');
    
    const requestData={
      action:'getFiles',
      userId:appState.currentUser?.userId
    };
    
    try{
      const resp=await new Promise((resolve,reject)=>{
        $.ajax({
          url:CONFIG.GAS_URL,dataType:'jsonp',jsonp:'callback',timeout:CONFIG.JSONP_TIMEOUT,
          data:requestData,cache:true,success:resolve,
          error:(xhr,status,error)=>reject({status,error})
        });
      });
      
      if(resp.status==="success"&&Array.isArray(resp.data)){
        appState.fileList=resp.data.map(item=>({
          id:item.id||'',
          name:item.name||'æœªå‘½åæ–‡ä»¶',
          url:item.url||'',
          note:item.note||'',
          updated:item.updated||utils.convertUTCToTaiwanTime(),
          order:item.order||0
        })).sort((a,b)=>a.order-b.order);
        
        storage.set('fileList',appState.fileList);
        resolve(appState.fileList);
      }else{
        reject(new Error(resp.message||'åŠ è¼‰æ–‡ä»¶åˆ—è¡¨å¤±æ•—'));
      }
    }catch(error){
      console.error('ç²å–æ–‡ä»¶åˆ—è¡¨å¤±æ•—:',error);
      reject(new Error('ç²å–æ–‡ä»¶åˆ—è¡¨å¤±æ•—ï¼š'+(error.error||'ç¶²çµ¡éŒ¯èª¤')));
    }
  });
};

// åŒæ­¥è§†é¢‘åˆ—è¡¨é¡ºåºåˆ°GAS
const syncVideoListOrderToGAS=()=>{
  if(!isManageUser()||!appState.videoList.length)return;
  
  const requestData={
    action:'updateVideoOrder',
    userId:appState.currentUser?.userId,
    videoOrder:appState.videoList.map((item,index)=>({
      id:item.id,
      order:index
    }))
  };
  
  $.ajax({
    url:CONFIG.GAS_URL,dataType:'jsonp',jsonp:'callback',timeout:CONFIG.JSONP_TIMEOUT,
    data:requestData,cache:false,
    success:(resp)=>{
      if(resp.status!=="success")console.error('åŒæ­¥é †åºå¤±æ•—:',resp.message);
    },
    error:(xhr,status,error)=>console.error('åŒæ­¥é †åºè«‹æ±‚å¤±æ•—:',error)
  });
};

// åŒæ­¥æ–‡ä»¶åˆ—è¡¨é¡ºåºåˆ°GAS
const syncFileListOrderToGAS=()=>{
  if(!isManageUser()||!appState.fileList.length)return;
  
  const requestData={
    action:'updateFileOrder',
    userId:appState.currentUser?.userId,
    fileOrder:appState.fileList.map((item,index)=>({
      id:item.id,
      order:index
    }))
  };
  
  $.ajax({
    url:CONFIG.GAS_URL,dataType:'jsonp',jsonp:'callback',timeout:CONFIG.JSONP_TIMEOUT,
    data:requestData,cache:false,
    success:(resp)=>{
      if(resp.status!=="success")console.error('åŒæ­¥æ–‡ä»¶é †åºå¤±æ•—:',resp.message);
    },
    error:(xhr,status,error)=>console.error('åŒæ­¥æ–‡ä»¶é †åºè«‹æ±‚å¤±æ•—:',error)
  });
};

// ä¿å­˜è§†é¢‘åˆ°GAS
const saveVideoToGAS=(videoData)=>{
  return new Promise(async(resolve,reject)=>{
    const requestData={
      action:videoData.id?'updateVideo':'addVideo',
      userId:appState.currentUser?.userId,
      video:videoData
    };
    
    try{
      const resp=await new Promise((resolve,reject)=>{
        $.ajax({
          url:CONFIG.GAS_URL,dataType:'jsonp',jsonp:'callback',timeout:CONFIG.JSONP_TIMEOUT,
          data:requestData,cache:false,success:resolve,
          error:(xhr,status,error)=>reject({status,error})
        });
      });
      
      if(resp.status==="success"){
        resolve(resp.data);
      }else{
        reject(new Error(resp.message||'ä¿å­˜å½±éŸ³å¤±æ•—'));
      }
    }catch(error){
      console.error('ä¿å­˜å½±éŸ³è«‹æ±‚å¤±æ•—:',error);
      reject(new Error('ä¿å­˜å½±éŸ³å¤±æ•—ï¼š'+(error.error||'ç¶²çµ¡éŒ¯èª¤')));
    }
  });
};

// ä¿å­˜æ–‡ä»¶åˆ°GAS
const saveFileToGAS=(fileData)=>{
  return new Promise(async(resolve,reject)=>{
    const requestData={
      action:fileData.id?'updateFile':'addFile',
      userId:appState.currentUser?.userId,
      file:fileData
    };
    
    try{
      const resp=await new Promise((resolve,reject)=>{
        $.ajax({
          url:CONFIG.GAS_URL,dataType:'jsonp',jsonp:'callback',timeout:CONFIG.JSONP_TIMEOUT,
          data:requestData,cache:false,success:resolve,
          error:(xhr,status,error)=>reject({status,error})
        });
      });
      
      if(resp.status==="success"){
        resolve(resp.data);
      }else{
        reject(new Error(resp.message||'ä¿å­˜æ–‡ä»¶å¤±æ•—'));
      }
    }catch(error){
      console.error('ä¿å­˜æ–‡ä»¶è«‹æ±‚å¤±æ•—:',error);
      reject(new Error('ä¿å­˜æ–‡ä»¶å¤±æ•—ï¼š'+(error.error||'ç¶²çµ¡éŒ¯èª¤')));
    }
  });
};

// åˆ é™¤è§†é¢‘/æ–‡ä»¶
const deleteContentFromGAS=(id,type)=>{
  return new Promise(async(resolve,reject)=>{
    const requestData={
      action:type==='video'?'deleteVideo':'deleteFile',
      userId:appState.currentUser?.userId,
      id:id
    };
    
    try{
      const resp=await new Promise((resolve,reject)=>{
        $.ajax({
          url:CONFIG.GAS_URL,dataType:'jsonp',jsonp:'callback',timeout:CONFIG.JSONP_TIMEOUT,
          data:requestData,cache:false,success:resolve,
          error:(xhr,status,error)=>reject({status,error})
        });
      });
      
      if(resp.status==="success"){
        resolve(true);
      }else{
        reject(new Error(resp.message||`åˆªé™¤${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—`));
      }
    }catch(error){
      console.error(`åˆªé™¤${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}è«‹æ±‚å¤±æ•—:`,error);
      reject(new Error(`åˆªé™¤${type==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š`+(error.error||'ç¶²çµ¡éŒ¯èª¤')));
    }
  });
};

// æ¸²æŸ“å†…å®¹åˆ—è¡¨
const renderContentList=(mode)=>{
  const isManageMode=mode==='manage';
  const videoContainer=utils.$('video-list-container');
  const fileContainer=utils.$('file-list-container');
  const contentSelect=utils.$('content-select');
  const emptyManageList=utils.$('empty-manage-list');
  const emptyManageText=utils.$('empty-manage-text');
  const emptyViewerList=utils.$('viewer-empty-list');
  const emptyViewerText=utils.$('viewer-empty-text');
  
  // æ¸…ç©ºå®¹å™¨
  if(videoContainer)videoContainer.innerHTML='';
  if(fileContainer)fileContainer.innerHTML='';
  if(contentSelect)contentSelect.innerHTML='<option value="">è«‹é¸æ“‡è¦æŸ¥çœ‹çš„å…§å®¹...</option>';
  
  // å¤„ç†ç®¡ç†æ¨¡å¼
  if(isManageMode){
    // æ¸²æŸ“è§†é¢‘åˆ—è¡¨
    if(appState.videoList.length){
      appState.videoList.forEach(video=>{
        const item=document.createElement('div');
        item.className='video-item bg-white p-3 rounded-xl shadow-elevation-1 flex items-center gap-3 border border-gray-100';
        item.dataset.id=video.id;
        item.dataset.type='video';
        item.draggable=isManageUser();
        
        item.innerHTML=`
          <div class="thumbnail-container">
            <img src="${getThumbnail(video.url,'video')}" class="thumbnail-img" alt="${video.name}">
          </div>
          <div class="flex-1 min-w-0">
            <h4 class="font-medium text-textPrimary truncate">${video.name}</h4>
            <p class="text-xs text-textSecondary mt-1 truncate">${video.url}</p>
            <p class="text-xs text-textSecondary/70 mt-1">æœ€å¾Œæ›´æ–°ï¼š${video.updated}</p>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="previewContent('${video.id}','video')" class="text-primary hover:text-[#007A69] p-2 rounded-full hover:bg-primary/5 transition-colors">
              <i class="fa fa-eye"></i>
            </button>
            <button onclick="editContent('${video.id}','video')" class="text-primary hover:text-[#007A69] p-2 rounded-full hover:bg-primary/5 transition-colors">
              <i class="fa fa-pencil"></i>
            </button>
            <button onclick="deleteContent('${video.id}','video')" class="text-red-500 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
        
        // æ·»åŠ æ‹–æ”¾äº‹ä»¶
        item.addEventListener('dragstart',dragHandlers.start);
        item.addEventListener('dragover',dragHandlers.over);
        item.addEventListener('dragleave',dragHandlers.leave);
        item.addEventListener('drop',dragHandlers.drop);
        item.addEventListener('dragend',dragHandlers.end);
        
        videoContainer?.appendChild(item);
      });
    }
    
    // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
    if(appState.fileList.length){
      appState.fileList.forEach(file=>{
        const item=document.createElement('div');
        item.className='video-item bg-white p-3 rounded-xl shadow-elevation-1 flex items-center gap-3 border border-gray-100';
        item.dataset.id=file.id;
        item.dataset.type='file';
        item.draggable=isManageUser();
        
        item.innerHTML=`
          <div class="thumbnail-container">
            <img src="${getThumbnail(file.url,'file')}" class="thumbnail-img" alt="${file.name}">
          </div>
          <div class="flex-1 min-w-0">
            <h4 class="font-medium text-textPrimary truncate">${file.name}</h4>
            <p class="text-xs text-textSecondary mt-1 truncate">${file.url}</p>
            <p class="text-xs text-textSecondary/70 mt-1">æœ€å¾Œæ›´æ–°ï¼š${file.updated}</p>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="previewContent('${file.id}','file')" class="text-primary hover:text-[#007A69] p-2 rounded-full hover:bg-primary/5 transition-colors">
              <i class="fa fa-eye"></i>
            </button>
            <button onclick="editContent('${file.id}','file')" class="text-primary hover:text-[#007A69] p-2 rounded-full hover:bg-primary/5 transition-colors">
              <i class="fa fa-pencil"></i>
            </button>
            <button onclick="deleteContent('${file.id}','file')" class="text-red-500 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
        
        // æ·»åŠ æ‹–æ”¾äº‹ä»¶
        item.addEventListener('dragstart',dragHandlers.start);
        item.addEventListener('dragover',dragHandlers.over);
        item.addEventListener('dragleave',dragHandlers.leave);
        item.addEventListener('drop',dragHandlers.drop);
        item.addEventListener('dragend',dragHandlers.end);
        
        fileContainer?.appendChild(item);
      });
    }
    
    // æ˜¾ç¤ºç©ºåˆ—è¡¨æç¤º
    if(emptyManageList&&emptyManageText){
      if(appState.currentContentType==='video'){
        emptyManageList.classList.toggle('hidden',appState.videoList.length>0);
        emptyManageText.textContent=appState.videoList.length>0?'':'å°šæœªæ·»åŠ ä»»ä½•å½±éŸ³';
      }else{
        emptyManageList.classList.toggle('hidden',appState.fileList.length>0);
        emptyManageText.textContent=appState.fileList.length>0?'':'å°šæœªæ·»åŠ ä»»ä½•æ–‡ä»¶';
      }
    }
  }else{
    // å¤„ç†æŸ¥çœ‹æ¨¡å¼
    if(appState.currentContentType==='video'){
      // å¡«å……è§†é¢‘ä¸‹æ‹‰é€‰æ‹©æ¡†
      if(appState.videoList.length){
        appState.videoList.forEach(video=>{
          const option=document.createElement('option');
          option.value=video.id;
          option.textContent=video.name;
          contentSelect?.appendChild(option);
        });
        
        // æ˜¾ç¤º/éšè—ç©ºåˆ—è¡¨æç¤º
        if(emptyViewerList&&emptyViewerText){
          emptyViewerList.classList.add('hidden');
          emptyViewerText.textContent='';
        }
      }else{
        // æ˜¾ç¤ºç©ºåˆ—è¡¨æç¤º
        if(emptyViewerList&&emptyViewerText){
          emptyViewerList.classList.remove('hidden');
          emptyViewerText.textContent='æš«ç„¡å¯æŸ¥çœ‹çš„å½±éŸ³';
        }
      }
    }else{
      // å¡«å……æ–‡ä»¶ä¸‹æ‹‰é€‰æ‹©æ¡†
      if(appState.fileList.length){
        appState.fileList.forEach(file=>{
          const option=document.createElement('option');
          option.value=file.id;
          option.textContent=file.name;
          contentSelect?.appendChild(option);
        });
        
        // æ˜¾ç¤º/éšè—ç©ºåˆ—è¡¨æç¤º
        if(emptyViewerList&&emptyViewerText){
          emptyViewerList.classList.add('hidden');
          emptyViewerText.textContent='';
        }
      }else{
        // æ˜¾ç¤ºç©ºåˆ—è¡¨æç¤º
        if(emptyViewerList&&emptyViewerText){
          emptyViewerList.classList.remove('hidden');
          emptyViewerText.textContent='æš«ç„¡å¯æŸ¥çœ‹çš„æ–‡ä»¶';
        }
      }
    }
  }
  
  // æ›´æ–°å†…å®¹è®¡æ•°
  updateContentCountDisplay();
};

// åˆ‡æ¢å†…å®¹ç±»å‹ï¼ˆè§†é¢‘/æ–‡ä»¶ï¼‰
const switchContentType=(type)=>{
  appState.currentContentType=type;
  
  // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
  const currentTypeText=utils.$('current-content-type');
  const viewerTitle=utils.$('viewer-section-title');
  const manageTitle=utils.$('manage-section-title');
  const emptyManageText=utils.$('empty-manage-text');
  const emptyManageTip=utils.$('empty-manage-tip');
  
  if(currentTypeText){
    currentTypeText.textContent=type==='video'?'å½±éŸ³åˆ—è¡¨':'æ–‡ä»¶åˆ—è¡¨';
  }
  
  if(viewerTitle){
    viewerTitle.innerHTML=type==='video'?
      '<i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å½±éŸ³åˆ—è¡¨':
      '<i class="fa fa-file text-primary mr-2 text-sm"></i> æ–‡ä»¶åˆ—è¡¨';
  }
  
  if(manageTitle){
    manageTitle.innerHTML=type==='video'?
      '<i class="fa fa-th-list text-primary mr-2 text-sm"></i> å½±éŸ³ç®¡ç†åˆ—è¡¨':
      '<i class="fa fa-th-list text-primary mr-2 text-sm"></i> æ–‡ä»¶ç®¡ç†åˆ—è¡¨';
  }
  
  if(emptyManageText){
    emptyManageText.textContent=type==='video'?'å°šæœªæ·»åŠ ä»»ä½•å½±éŸ³':'å°šæœªæ·»åŠ ä»»ä½•æ–‡ä»¶';
  }
  
  if(emptyManageTip){
    emptyManageTip.textContent=type==='video'?'é»æ“Šã€Œæ–°å¢å½±éŸ³ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ ':'é»æ“Šã€Œæ–°å¢æ–‡ä»¶ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ ';
  }
  
  // åˆ‡æ¢ç®¡ç†åˆ—è¡¨æ˜¾ç¤º
  const videoListContainer=utils.$('video-list-container');
  const fileListContainer=utils.$('file-list-container');
  
  if(videoListContainer&&fileListContainer){
    videoListContainer.classList.toggle('hidden',type!=='video');
    fileListContainer.classList.toggle('hidden',type!=='file');
  }
  
  // é‡æ–°æ¸²æŸ“åˆ—è¡¨
  renderContentList('viewer');
  renderContentList('manage');
  
  // é‡ç½®é€‰æ‹©
  appState.selectedContentId='';
  const contentSelect=utils.$('content-select');
  if(contentSelect)contentSelect.value='';
  
  // éšè—å†…å®¹é¢„è§ˆå’Œæ˜¾ç¤ºåŒºåŸŸ
  utils.$('selected-content-display')?.classList.add('hidden');
  utils.$('start-watch-btn')?.classList.add('hidden');
  
  // éšè—ç¼–è¾‘åŒºåŸŸ
  hideVideoEditSection();
  hideFileEditSection();
};

// é€‰æ‹©å†…å®¹
const selectContent=(id)=>{
  if(!id){
    appState.selectedContentId='';
    utils.$('selected-content-display')?.classList.add('hidden');
    utils.$('start-watch-btn')?.classList.add('hidden');
    return;
  }
  
  appState.selectedContentId=id;
  utils.$('start-watch-btn')?.classList.remove('hidden');
};

// å¼€å§‹è§‚çœ‹/æŸ¥çœ‹
const startWatch=()=>{
  if(!appState.selectedContentId)return;
  previewContent(appState.selectedContentId,appState.currentContentType);
};

// é¢„è§ˆå†…å®¹
const previewContent=(id,type)=>{
  let content=null;
  
  if(type==='video'){
    content=appState.videoList.find(v=>v.id===id);
  }else{
    content=appState.fileList.find(f=>f.id===id);
  }
  
  if(!content)return;
  
  appState.currentViewingId=id;
  appState.currentViewingType=type;
  
  // éšè—å…¶ä»–åŒºåŸŸ
  utils.$('status')?.classList.add('hidden');
  utils.$('content-viewer-section')?.classList.add('hidden');
  utils.$('content-manage-section')?.classList.add('hidden');
  utils.$('video-edit-section')?.classList.add('hidden');
  utils.$('file-edit-section')?.classList.add('hidden');
  
  // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
  const previewSection=utils.$('content-preview');
  const previewTitle=utils.$('preview-title');
  const previewUpdated=utils.$('preview-updated');
  const previewNote=utils.$('preview-note');
  const previewActionBtns=utils.$('preview-action-btns');
  
  if(previewSection)previewSection.classList.remove('hidden');
  if(previewTitle)previewTitle.textContent=content.name;
  if(previewUpdated)previewUpdated.textContent=content.updated;
  if(previewNote)previewNote.textContent=content.note||'- ç„¡å‚™æ³¨ -';
  
  // æ˜¾ç¤º/éšè—ç®¡ç†æŒ‰é’®
  if(previewActionBtns){
    previewActionBtns.classList.toggle('hidden',!isManageUser());
  }
  
  // é‡ç½®é¢„è§ˆå®¹å™¨
  const videoContainer=utils.$('video-container');
  const audioContainer=utils.$('audio-container');
  const unsupportedTip=utils.$('unsupported-tip');
  const filePreviewTip=utils.$('file-preview-tip');
  const directLinkBtn=utils.$('direct-link-btn');
  const filePreviewName=utils.$('file-preview-name');
  const filePreviewBtn=utils.$('file-preview-btn');
  
  // éšè—æ‰€æœ‰é¢„è§ˆç±»å‹
  videoContainer?.classList.add('hidden');
  audioContainer?.classList.add('hidden');
  unsupportedTip?.classList.add('hidden');
  filePreviewTip?.classList.add('hidden');
  
  // é‡ç½®åŠ è½½çŠ¶æ€
  utils.$('video-loading')?.classList.remove('hidden');
  utils.$('audio-loading')?.classList.remove('hidden');
  
  // å¤„ç†è§†é¢‘/éŸ³é¢‘é¢„è§ˆ
  if(type==='video'){
    const embedInfo=convertToEmbedUrl(content.url);
    
    if(embedInfo.type==='video'){
      if(videoContainer){
        videoContainer.classList.remove('hidden');
        const previewVideo=utils.$('preview-video');
        if(previewVideo){
          previewVideo.src=embedInfo.url;
          previewVideo.classList.remove('loaded');
        }
      }
    }else if(embedInfo.type==='audio'){
      if(audioContainer){
        audioContainer.classList.remove('hidden');
        const previewAudio=utils.$('preview-audio');
        if(previewAudio){
          previewAudio.src=embedInfo.url;
          previewAudio.classList.remove('loaded');
        }
      }
    }else{
      // ä¸æ”¯æŒçš„ç±»å‹
      if(unsupportedTip){
        unsupportedTip.classList.remove('hidden');
        if(directLinkBtn)directLinkBtn.href=content.url;
      }
    }
  }else{
    // å¤„ç†æ–‡ä»¶é¢„è§ˆ
    if(filePreviewTip){
      filePreviewTip.classList.remove('hidden');
      if(filePreviewName)filePreviewName.textContent=content.name;
      if(filePreviewBtn)filePreviewBtn.href=content.url;
    }
  }
};

// éšè—å†…å®¹é¢„è§ˆ
const hideContentPreview=()=>{
  utils.$('content-preview')?.classList.add('hidden');
  utils.$('content-viewer-section')?.classList.remove('hidden');
  
  // é‡ç½®é¢„è§ˆçŠ¶æ€
  const previewVideo=utils.$('preview-video');
  const previewAudio=utils.$('preview-audio');
  
  if(previewVideo){
    previewVideo.src='';
    previewVideo.classList.remove('loaded');
  }
  
  if(previewAudio){
    previewAudio.src='';
    previewAudio.classList.remove('loaded');
  }
  
  appState.currentViewingId=null;
  appState.currentViewingType=null;
};

// ç¼–è¾‘å†…å®¹
const editContent=(id,type)=>{
  if(!isManageUser())return;
  
  if(type==='video'){
    const video=appState.videoList.find(v=>v.id===id);
    if(!video)return;
    
    appState.currentEditingVideoId=id;
    
    // å¡«å……è¡¨å•
    utils.$('video-id').value=video.id;
    utils.$('video-name').value=video.name;
    utils.$('video-url').value=video.url;
    utils.$('video-note').value=video.note;
    
    // æ›´æ–°æ ‡é¢˜
    const videoEditTitle=utils.$('video-edit-title');
    if(videoEditTitle)videoEditTitle.innerHTML='<i class="fa fa-edit text-primary mr-2 text-sm"></i> ç·¨è¼¯å½±éŸ³';
    
    // æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
    showVideoEditSection();
  }else{
    const file=appState.fileList.find(f=>f.id===id);
    if(!file)return;
    
    appState.currentEditingFileId=id;
    
    // å¡«å……è¡¨å•
    utils.$('file-id-hidden').value=file.id;
    utils.$('file-name').value=file.name;
    utils.$('file-url').value=file.url;
    utils.$('file-note').value=file.note;
    
    // æ›´æ–°æ ‡é¢˜
    const fileEditTitle=utils.$('file-edit-title');
    if(fileEditTitle)fileEditTitle.innerHTML='<i class="fa fa-edit text-primary mr-2 text-sm"></i> ç·¨è¼¯æ–‡ä»¶';
    
    // æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
    showFileEditSection();
  }
};

// ç¼–è¾‘å½“å‰é¢„è§ˆçš„å†…å®¹
const editCurrentContent=()=>{
  if(appState.currentViewingId&&appState.currentViewingType){
    editContent(appState.currentViewingId,appState.currentViewingType);
    hideContentPreview();
  }
};

// åˆ é™¤å†…å®¹
const deleteContent=(id,type)=>{
  if(!isManageUser()||!confirm(`ç¢ºå®šè¦åˆªé™¤é€™${type==='video'?'å€‹å½±éŸ³':'å€‹æ–‡ä»¶'}å—ï¼Ÿ`))return;
  
  deleteContentFromGAS(id,type).then(async()=>{
    // ä»æœ¬åœ°åˆ—è¡¨ä¸­åˆ é™¤
    if(type==='video'){
      appState.videoList=appState.videoList.filter(v=>v.id!==id);
      storage.set('videoList',appState.videoList);
    }else{
      appState.fileList=appState.fileList.filter(f=>f.id!==id);
      storage.set('fileList',appState.fileList);
    }
    
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    renderContentList('manage');
    renderContentList('viewer');
    
    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é¢„è§ˆçš„å†…å®¹ï¼Œéšè—é¢„è§ˆ
    if(id===appState.currentViewingId){
      hideContentPreview();
    }
    
    showSuccess(type==='video'?'å½±éŸ³åˆªé™¤æˆåŠŸï¼':'æ–‡ä»¶åˆªé™¤æˆåŠŸï¼');
  }).catch(error=>{
    showError(error.message);
  });
};

// åˆ é™¤å½“å‰é¢„è§ˆçš„å†…å®¹
const deleteCurrentContent=()=>{
  if(appState.currentViewingId&&appState.currentViewingType){
    deleteContent(appState.currentViewingId,appState.currentViewingType);
  }
};

// æ˜¾ç¤ºè§†é¢‘ç¼–è¾‘åŒºåŸŸ
const showVideoEditSection=()=>{
  // éšè—å…¶ä»–åŒºåŸŸ
  utils.$('content-viewer-section')?.classList.add('hidden');
  utils.$('content-manage-section')?.classList.add('hidden');
  utils.$('file-edit-section')?.classList.add('hidden');
  utils.$('content-preview')?.classList.add('hidden');
  
  // æ˜¾ç¤ºè§†é¢‘ç¼–è¾‘åŒºåŸŸ
  const videoEditSection=utils.$('video-edit-section');
  if(videoEditSection)videoEditSection.classList.remove('hidden');
  
  // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
  setTimeout(()=>{
    utils.$('video-name')?.focus();
  },100);
};

// éšè—è§†é¢‘ç¼–è¾‘åŒºåŸŸ
const hideVideoEditSection=()=>{
  utils.$('video-edit-section')?.classList.add('hidden');
  utils.$('content-viewer-section')?.classList.remove('hidden');
  
  // é‡ç½®è¡¨å•
  if(!appState.isSubmitting){
    utils.$('video-form')?.reset();
    appState.currentEditingVideoId=null;
    const videoEditTitle=utils.$('video-edit-title');
    if(videoEditTitle)videoEditTitle.innerHTML='<i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢å½±éŸ³';
  }
};

// æ˜¾ç¤ºæ–‡ä»¶ç¼–è¾‘åŒºåŸŸ
const showFileEditSection=()=>{
  // éšè—å…¶ä»–åŒºåŸŸ
  utils.$('content-viewer-section')?.classList.add('hidden');
  utils.$('content-manage-section')?.classList.add('hidden');
  utils.$('video-edit-section')?.classList.add('hidden');
  utils.$('content-preview')?.classList.add('hidden');
  
  // æ˜¾ç¤ºæ–‡ä»¶ç¼–è¾‘åŒºåŸŸ
  const fileEditSection=utils.$('file-edit-section');
  if(fileEditSection)fileEditSection.classList.remove('hidden');
  
  // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
  setTimeout(()=>{
    utils.$('file-name')?.focus();
  },100);
};

// éšè—æ–‡ä»¶ç¼–è¾‘åŒºåŸŸ
const hideFileEditSection=()=>{
  utils.$('file-edit-section')?.classList.add('hidden');
  utils.$('content-viewer-section')?.classList.remove('hidden');
  
  // é‡ç½®è¡¨å•
  if(!appState.isSubmitting){
    utils.$('file-form')?.reset();
    appState.currentEditingFileId=null;
    const fileEditTitle=utils.$('file-edit-title');
    if(fileEditTitle)fileEditTitle.innerHTML='<i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢æ–‡ä»¶';
  }
};

// æ·»åŠ æ–°å†…å®¹
const addNewContent=()=>{
  if(appState.currentContentType==='video'){
    appState.currentEditingVideoId=null;
    utils.$('video-form')?.reset();
    const videoEditTitle=utils.$('video-edit-title');
    if(videoEditTitle)videoEditTitle.innerHTML='<i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢å½±éŸ³';
    showVideoEditSection();
  }else{
    appState.currentEditingFileId=null;
    utils.$('file-form')?.reset();
    const fileEditTitle=utils.$('file-edit-title');
    if(fileEditTitle)fileEditTitle.innerHTML='<i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢æ–‡ä»¶';
    showFileEditSection();
  }
};

// åˆ‡æ¢ç®¡ç†åŒºåŸŸ
const toggleManageSection=()=>{
  const manageSection=utils.$('content-manage-section');
  const viewerSection=utils.$('content-viewer-section');
  
  if(manageSection&&viewerSection){
    const isHidden=manageSection.classList.contains('hidden');
    
    manageSection.classList.toggle('hidden',!isHidden);
    viewerSection.classList.toggle('hidden',isHidden);
    
    // éšè—ç¼–è¾‘åŒºåŸŸ
    hideVideoEditSection();
    hideFileEditSection();
    
    // é‡æ–°æ¸²æŸ“ç®¡ç†åˆ—è¡¨
    if(isHidden){
      renderContentList('manage');
    }
  }
};

// ä¿å­˜è§†é¢‘
const saveVideo=(e)=>{
  e.preventDefault();
  
  if(appState.isSubmitting)return;
  
  const id=utils.$('video-id').value;
  const name=utils.$('video-name').value.trim();
  const url=utils.$('video-url').value.trim();
  const note=utils.$('video-note').value.trim();
  
  // éªŒè¯
  if(!name){
    alert('è«‹è¼¸å…¥å½±éŸ³åç¨±');
    utils.$('video-name').focus();
    return;
  }
  
  if(!url||!utils.isValidUrl(url)){
    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„URLéˆæ¥');
    utils.$('video-url').focus();
    return;
  }
  
  setVideoSubmitState(true);
  
  const videoData={
    id:id,
    name:name,
    url:url,
    note:note,
    updated:utils.convertUTCToTaiwanTime(),
    order:id?appState.videoList.find(v=>v.id===id)?.order||0:appState.videoList.length
  };
  
  saveVideoToGAS(videoData).then(async(savedData)=>{
    if(id){
      // æ›´æ–°ç°æœ‰è§†é¢‘
      const index=appState.videoList.findIndex(v=>v.id===id);
      if(index!==-1){
        appState.videoList[index]={...appState.videoList[index],...videoData};
      }
    }else{
      // æ·»åŠ æ–°è§†é¢‘
      appState.videoList.push({...videoData,id:savedData.id});
    }
    
    // ä¿å­˜åˆ°ç¼“å­˜
    storage.set('videoList',appState.videoList);
    
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    renderContentList('manage');
    renderContentList('viewer');
    
    // éšè—ç¼–è¾‘åŒºåŸŸ
    hideVideoEditSection();
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    showSuccess(id?'å½±éŸ³æ›´æ–°æˆåŠŸï¼':'å½±éŸ³æ–°å¢æˆåŠŸï¼');
    
    setVideoSubmitState(false);
  }).catch(error=>{
    showError(error.message);
    setVideoSubmitState(false);
  });
};

// ä¿å­˜æ–‡ä»¶
const saveFile=(e)=>{
  e.preventDefault();
  
  if(appState.isSubmitting)return;
  
  const id=utils.$('file-id-hidden').value;
  const name=utils.$('file-name').value.trim();
  const url=utils.$('file-url').value.trim();
  const note=utils.$('file-note').value.trim();
  
  // éªŒè¯
  if(!name){
    alert('è«‹è¼¸å…¥æ–‡ä»¶åç¨±');
    utils.$('file-name').focus();
    return;
  }
  
  if(!url||!utils.isValidUrl(url)){
    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„URLéˆæ¥');
    utils.$('file-url').focus();
    return;
  }
  
  setFileSubmitState(true);
  
  const fileData={
    id:id,
    name:name,
    url:url,
    note:note,
    updated:utils.convertUTCToTaiwanTime(),
    order:id?appState.fileList.find(f=>f.id===id)?.order||0:appState.fileList.length
  };
  
  saveFileToGAS(fileData).then(async(savedData)=>{
    if(id){
      // æ›´æ–°ç°æœ‰æ–‡ä»¶
      const index=appState.fileList.findIndex(f=>f.id===id);
      if(index!==-1){
        appState.fileList[index]={...appState.fileList[index],...fileData};
      }
    }else{
      // æ·»åŠ æ–°æ–‡ä»¶
      appState.fileList.push({...fileData,id:savedData.id});
    }
    
    // ä¿å­˜åˆ°ç¼“å­˜
    storage.set('fileList',appState.fileList);
    
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    renderContentList('manage');
    renderContentList('viewer');
    
    // éšè—ç¼–è¾‘åŒºåŸŸ
    hideFileEditSection();
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    showSuccess(id?'æ–‡ä»¶æ›´æ–°æˆåŠŸï¼':'æ–‡ä»¶æ–°å¢æˆåŠŸï¼');
    
    setFileSubmitState(false);
  }).catch(error=>{
    showError(error.message);
    setFileSubmitState(false);
  });
};

// åˆå§‹åŒ–LIFF
const initLIFF=async()=>{
  try{
    await liff.init({liffId:CONFIG.LIFF_ID});
    
    if(!liff.isLoggedIn()){
      liff.login();
      return;
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    const profile=await liff.getProfile();
    appState.currentUser={
      userId:profile.userId,
      displayName:profile.displayName,
      pictureUrl:profile.pictureUrl
    };
    
    // éªŒè¯ç”¨æˆ·æƒé™å¹¶åŠ è½½æ•°æ®
    await verifyUserPermission();
    await Promise.all([
      fetchVideoListFromGAS(),
      fetchFileListFromGAS()
    ]);
    
    // æ›´æ–°æ˜¾ç¤º
    updateUserInfoDisplay();
    updateContentCountDisplay();
    
    // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºå†…å®¹
    utils.$('status')?.classList.add('hidden');
    utils.$('result-card')?.classList.remove('hidden');
    utils.$('content-viewer-section')?.classList.remove('hidden');
    
    // æ¸²æŸ“åˆ—è¡¨
    renderContentList('viewer');
    renderContentList('manage');
    
    // æ˜¾ç¤ºç®¡ç†æŒ‰é’®ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
    const manageBtnContainer=utils.$('manage-content-btn-container');
    if(manageBtnContainer){
      manageBtnContainer.classList.toggle('hidden',!isManageUser());
    }
    
    appState.isFirstLoad=false;
  }catch(error){
    console.error('LIFFåˆå§‹åŒ–å¤±æ•—:',error);
    showError(`ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š${error.message||'ç„¡æ³•é€£æ¥è‡³LINEæœå‹™'}`);
  }
};

// åˆå§‹åŒ–å†…å®¹ç±»å‹åˆ‡æ¢ä¸‹æ‹‰èœå•
const initContentTypeToggle=()=>{
  const toggleBtn=utils.$('content-type-toggle');
  const dropdown=utils.$('content-type-dropdown');
  
  if(toggleBtn&&dropdown){
    toggleBtn.addEventListener('click',()=>{
      dropdown.classList.toggle('hidden');
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click',(e)=>{
      if(!toggleBtn.contains(e.target)&&!dropdown.contains(e.target)){
        dropdown.classList.add('hidden');
      }
    });
  }
};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded',()=>{
  // åˆå§‹åŒ–å†…å®¹ç±»å‹åˆ‡æ¢
  initContentTypeToggle();
  
  // åˆå§‹åŒ–LIFF
  initLIFF();
  
  // é”™è¯¯å¤„ç†ï¼šå¦‚æœLIFFåŠ è½½å¤±è´¥ï¼Œæä¾›åˆ·æ–°é€‰é¡¹
  setTimeout(()=>{
    if(appState.isFirstLoad&&utils.$('status')&&!utils.$('status').classList.contains('hidden')){
      utils.setStatus('åŠ è¼‰è¶…æ™‚ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é‡æ–°åŠ è¼‰');
      
      const statusEl=utils.$('status');
      if(statusEl){
        statusEl.innerHTML=`
          <div class="text-center">
            <div class="inline-block bg-primary/10 w-16 h-16 rounded-full flex items-center justify-center mb-4">
              <i class="fa fa-exclamation-triangle text-primary text-2xl"></i>
            </div>
            <p id="status-text" class="text-base font-medium mb-4">åŠ è¼‰è¶…æ™‚ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é‡æ–°åŠ è¼‰</p>
            <button onclick="window.location.reload()" class="mobile-btn primary-gradient text-white text-sm font-medium px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300">
              <i class="fa fa-refresh mr-2"></i> é‡æ–°åŠ è¼‰
            </button>
          </div>
        `;
      }
    }
  },CONFIG.JSONP_TIMEOUT+2000);
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<title>ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0"/>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
tailwind.config={theme:{extend:{colors:{
  primary:'#008C76',secondary:'#E8F9F7',accent:'#FFD700',gold:'#D4AF37',
  darkGold:'#B8860B',dark:'#1A202C',lightBg:'#F9FAFB',neutral:'#F3F4F6',
  cardBg:'#FFFFFF',textPrimary:'#1E293B',textSecondary:'#64748B',
  premiumBg:'#FFF8E6',premiumBorder:'#FFE082'
},fontFamily:{
  sans:['Noto Sans TC','sans-serif','system-ui'],
  display:['Noto Sans TC','sans-serif','system-ui']
},boxShadow:{
  'elevation-1':'0 2px 8px rgba(0,0,0,0.06)',
  'elevation-2':'0 4px 16px rgba(0,0,0,0.08)',
  'elevation-3':'0 8px 24px rgba(0,0,0,0.12)',
  'gold-hover':'0 4px 15px rgba(212, 175, 55, 0.25)',
  'primary-hover':'0 4px 15px rgba(0, 140, 118, 0.25)'
}}}};
</script>
<style type="text/tailwindcss">
@layer utilities{
  .fade-in{animation:fadeIn 0.6s cubic-bezier(0.4,0,0.2,1);}
  .pulse-subtle{animation:pulseSubtle 2s infinite;}
  .gradient-text{background-clip:text;-webkit-background-clip:text;color:transparent;}
  .slide-in{animation:slideIn 0.4s cubic-bezier(0.4,0,0.2,1);}
  .scale-in{animation:scaleIn 0.3s cubic-bezier(0.4,0,0.2,1);}
  .slide-up{animation:slideUp 0.3s ease-out;}
  .content-transition{transition:all 0.3s ease-in-out;}
  .gold-gradient{background:linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);}
  .primary-gradient{background:linear-gradient(135deg, #008C76 0%, #00A88D 100%);}
  .text-gold-gradient{background:linear-gradient(135deg, #B8860B 0%, #FFD700 100%);-webkit-background-clip:text;background-clip:text;color:transparent;}
}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes pulseSubtle{0%,100%{opacity:1;}50%{opacity:0.8;}}
@keyframes slideIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes scaleIn{from{transform:scale(0.95);opacity:0;}to{transform:scale(1);opacity:1;}}
@keyframes slideUp{from{transform:translateY(10px);opacity:0;}to{transform:translateY(0);opacity:1;}}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:#F1F5F9;border-radius:3px;}
::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:#94A3B8;}
body{font-feature-settings:"palt";letter-spacing:0.02em;background-color:#F5F7FA;}
.video-container,.audio-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;background-color:#0F172A;box-shadow:0 4px 20px rgba(0,0,0,0.15);}
.video-container{min-height:320px;}
.audio-container{padding-bottom:280px;min-height:280px;}
@media (max-width: 640px) {
  .audio-container {padding-bottom: 260px;min-height: 260px;}
  .video-container {min-height: 280px;}
}
@media (min-width: 641px) and (max-width: 1024px) {
  .audio-container {padding-bottom: 270px;min-height: 270px;}
  .video-container {min-height: 300px;}
}
@media (min-width: 1025px) {
  .audio-container {padding-bottom: 300px;min-height: 300px;}
  .video-container {min-height: 350px;}
}
.video-item{transition:all 0.3s ease;cursor:grab;border-radius:10px;}
.video-item:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.video-item.dragging{opacity:0.5;border:2px dashed #008C76;cursor:grabbing;}
.video-item.pro-user{cursor:pointer;}
.video-item.pro-user:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.drop-zone{border:2px dashed #008C76 !important;background-color:#E8F9F7 !important;}
.thumbnail-container{width:80px;height:50px;border-radius:6px;overflow:hidden;background:#f1f1f1;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.thumbnail-img{width:100%;height:100%;object-fit:cover;}
.viewer-card{transition:all 0.4s ease;border-radius:12px;overflow:hidden;}
.viewer-card:hover{transform:translateY(-5px);box-shadow:0 12px 25px rgba(0,0,0,0.12);}
.watch-btn{padding:8px 16px !important;font-size:14px !important;font-weight:600 !important;border-radius:8px !important;transition:all 0.3s ease !important;}
.watch-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0, 140, 118, 0.2) !important;}
.mobile-btn{min-height:48px !important;padding:12px 20px !important;font-size:16px !important;border-radius:12px !important;font-weight:600 !important;transition:all 0.3s ease !important;position:relative;overflow:hidden;}
.mobile-btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);transition:all 0.6s ease;}
.mobile-btn:hover::after{left:100%;}
.mobile-btn-sm{min-height:40px !important;padding:8px 16px !important;font-size:15px !important;border-radius:10px !important;font-weight:600 !important;transition:all 0.3s ease !important;}
.video-container iframe, .audio-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;opacity:0;transition:opacity 0.3s ease;border-radius:12px;}
.video-container iframe.loaded, .audio-container iframe.loaded{opacity:1;}
.btn-disabled{opacity:0.7;cursor:not-allowed;pointer-events:none;}
.dropdown-menu {
  @apply absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-elevation-2 border border-gray-100 z-50 content-transition rounded-xl overflow-hidden;
}
.dropdown-item {
  @apply block px-4 py-3 text-sm text-gray-700 hover:bg-primary/5 hover:text-primary cursor-pointer transition-colors font-medium;
}
.dropdown-item:hover {
  background:linear-gradient(135deg, #008C76 0%, #00A88D 100%);
  color:white !important;
}
.premium-badge{
  background:linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
  color:white;
  font-weight:bold;
  padding:2px 8px;
  border-radius:20px;
  font-size:11px;
  box-shadow:0 2px 8px rgba(212, 175, 55, 0.3);
}
.content-selector {
  @apply w-full bg-white border border-gray-200 rounded-xl p-3 text-textPrimary font-medium mb-4 shadow-elevation-1;
}
.content-selector select {
  @apply w-full border-none outline-none bg-transparent text-textPrimary font-medium;
}
.content-display-card {
  @apply bg-cardBg rounded-xl overflow-hidden shadow-elevation-1 slide-up mb-4;
}
.start-watch-btn {
  @apply w-full mt-3 mobile-btn gold-gradient text-white text-sm font-medium px-6 py-3 rounded-xl shadow-gold-hover transition-all duration-300 flex items-center justify-center border-none;
}
</style>
</head>
<body class="bg-lightBg min-h-screen flex flex-col p-2 md:p-4 pt-6 pb-6">
<div class="max-w-5xl w-full bg-cardBg rounded-2xl shadow-elevation-2 overflow-hidden fade-in self-center border border-gray-100">
  <div class="bg-gradient-to-r from-primary to-[#006658] p-4 md:p-6 text-white text-center relative overflow-hidden">
    <div class="absolute top-0 left-0 w-24 h-24 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/3"></div>
    <div class="absolute bottom-0 right-0 w-32 h-32 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3"></div>
    <div class="relative z-10">
      <div class="inline-flex items-center justify-center w-14 h-14 bg-white/10 backdrop-blur-sm rounded-full mb-3 pulse-subtle border border-white/20">
        <i class="fa fa-film text-2xl text-accent"></i>
      </div>
      <h1 class="text-2xl md:text-3xl font-bold mb-1 tracking-wide"> ğŸ¬ å¹¸ç¦ç³»çµ±_åŸç†æ•…äº‹ </h1>
      <p class="text-white/90 text-sm md:text-base font-light">å½¥å½¬_å¹¸ç¦ç³»çµ± <span class="text-accent font-medium">å°Šçˆµç”¨æˆ¶å°ˆå±¬</span></p>
    </div>
  </div>
  <div class="p-3 md:p-5">
    <div id="status" class="flex items-center justify-center py-8 text-textPrimary text-center">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-primary mb-3"></div>
        <p id="status-text" class="text-base font-medium">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±ï¼Œè«‹ç¨å€™...</p>
      </div>
    </div>
    <div id="error-message" class="hidden bg-red-50 border border-red-100 text-red-700 px-4 py-4 rounded-xl mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-exclamation-circle text-red-500 mt-1 mr-2 text-lg"></i>
        <div id="error-content" class="text-sm"></div>
      </div>
    </div>
    <div id="success-message" class="hidden bg-green-50 border border-green-100 text-green-700 px-4 py-4 rounded-xl mb-4 shadow-sm fade-in">
      <div class="flex items-start">
        <i class="fa fa-check-circle text-green-500 mt-1 mr-2 text-lg"></i>
        <div id="success-content" class="text-sm"></div>
      </div>
    </div>
    <div id="result-card" class="hidden bg-gradient-to-r from-premiumBg to-[#FFFAF0] border border-premiumBorder rounded-2xl p-5 mb-5 text-center fade-in relative overflow-hidden shadow-elevation-1">
      <div class="absolute top-0 right-0 w-20 h-20 bg-gold/5 rounded-full translate-x-1/2 -translate-y-1/2"></div>
      <div class="absolute bottom-0 left-0 w-16 h-16 bg-primary/5 rounded-full -translate-x-1/2 translate-y-1/2"></div>
      <div class="relative z-10">
        <div class="inline-block mb-3">
          <div class="gold-gradient w-16 h-16 rounded-full flex items-center justify-center shadow-gold-hover">
            <i class="fa fa-crown text-white text-2xl"></i>
          </div>
        </div>
        <div id="result-main" class="text-xl md:text-2xl font-bold mb-3 text-textPrimary text-gold-gradient"></div>
        <div id="result-details" class="text-sm text-textSecondary space-y-2 md:space-y-2">
          <div class="flex items-center justify-center">
            <span class="premium-badge mr-2">å°Šçˆµç”¨æˆ¶</span>
            <span id="user-role-display" class="font-medium"></span>
          </div>
          <div id="user-name-display" class="hidden">
            <i class="fa fa-user text-primary mr-1"></i> <span class="font-medium">ä½¿ç”¨è€…ï¼š</span> <span id="user-name"></span>
          </div>
          <div id="user-expiry-display" class="hidden">
            <i class="fa fa-calendar text-primary mr-1"></i> <span class="font-medium">ä½¿ç”¨æœŸé™ï¼š</span> <span id="expiry-date"></span> (<span id="remaining-days"></span>)
          </div>
        </div>
        <div id="content-count-display" class="mt-4 text-base font-semibold text-primary bg-white/50 rounded-lg py-2 px-4 inline-block">
          <i class="fa fa-play-circle mr-1"></i> å½±éŸ³æ•¸ï¼š<span id="video-count-num">0</span> | 
          <i class="fa fa-file mr-1"></i> æ–‡ä»¶æ•¸ï¼š<span id="file-count-num">0</span>
        </div>
        <div class="w-24 h-1 bg-gradient-to-r from-gold to-primary mx-auto my-4 rounded-full"></div>
      </div>
    </div>
    
    <div class="relative mb-5">
      <button id="content-type-toggle" class="mobile-btn w-full primary-gradient text-white text-sm font-medium px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-between border-none">
        <span id="current-content-type" class="font-semibold">å½±éŸ³åˆ—è¡¨</span>
        <i class="fa fa-chevron-down text-sm"></i>
      </button>
      <div id="content-type-dropdown" class="dropdown-menu hidden">
        <div class="dropdown-item" onclick="switchContentType('video')">
          <i class="fa fa-play-circle mr-2"></i>å½±éŸ³åˆ—è¡¨
        </div>
        <div class="dropdown-item" onclick="switchContentType('file')">
          <i class="fa fa-file mr-2"></i>æ–‡ä»¶åˆ—è¡¨
        </div>
      </div>
    </div>
    
    <div id="content-viewer-section" class="hidden bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="viewer-section-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å½±éŸ³åˆ—è¡¨
        </h2>
        <div id="manage-content-btn-container" class="flex gap-2 hidden">
          <button onclick="toggleManageSection()" class="mobile-btn-sm primary-gradient text-white text-sm font-medium px-4 py-2 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center gap-1">
            <i class="fa fa-cog text-sm"></i> å…§å®¹ç®¡ç†
          </button>
        </div>
      </div>
      
      <div class="content-selector" id="content-select-container">
        <select id="content-select" class="w-full" onchange="selectContent(this.value)">
          <option value="">è«‹é¸æ“‡è¦æŸ¥çœ‹çš„å…§å®¹...</option>
        </select>
      </div>
      
      <button id="start-watch-btn" class="start-watch-btn hidden" onclick="startWatch()">
        <i class="fa fa-play-circle mr-2"></i> é–‹å§‹è§€çœ‹
      </button>
      
      <div id="selected-content-display" class="hidden">
        <div class="content-display-card" id="viewer-content-card"></div>
      </div>
      
      <div id="viewer-empty-list" class="py-10 text-center text-textSecondary hidden">
        <div class="inline-block gold-gradient w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-gold-hover">
          <i class="fa fa-film text-white text-2xl"></i>
        </div>
        <p id="viewer-empty-text" class="text-lg font-medium">æš«ç„¡å¯æŸ¥çœ‹çš„å½±éŸ³</p>
        <p class="text-xs mt-2 text-textSecondary/70">è«‹è¯ç¹«ç®¡ç†å“¡æ·»åŠ å…§å®¹</p>
      </div>
    </div>
    
    <div id="content-manage-section" class="bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1 hidden">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
        <h2 id="manage-section-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-th-list text-primary mr-2 text-sm"></i> å½±éŸ³ç®¡ç†åˆ—è¡¨
        </h2>
        <div id="manage-action-buttons" class="flex gap-2 w-full md:w-auto">
          <button id="add-content-btn" onclick="addNewContent()" class="mobile-btn primary-gradient text-white text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-plus text-lg"></i> æ–°å¢å½±éŸ³
          </button>
          <button onclick="toggleManageSection()" class="mobile-btn bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium flex-1 md:flex-none px-6 py-3 rounded-xl shadow-elevation-1 transition-all duration-300 flex items-center justify-center gap-1">
            <i class="fa fa-arrow-left text-lg"></i> è¿”å›
          </button>
        </div>
      </div>
      <div id="video-list-container" class="space-y-3 mb-3 max-h-[600px] overflow-y-auto pr-2"></div>
      <div id="file-list-container" class="space-y-3 mb-3 max-h-[600px] overflow-y-auto pr-2 hidden"></div>
      <div id="empty-manage-list" class="py-8 text-center text-textSecondary hidden">
        <div class="inline-block gold-gradient w-14 h-14 rounded-full flex items-center justify-center mb-3 shadow-gold-hover">
          <i class="fa fa-film text-white text-xl"></i>
        </div>
        <p id="empty-manage-text" class="text-base font-medium">å°šæœªæ·»åŠ ä»»ä½•å½±éŸ³</p>
        <p id="empty-manage-tip" class="text-xs mt-2">é»æ“Šã€Œæ–°å¢å½±éŸ³ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ </p>
      </div>
    </div>
    
    <div id="video-edit-section" class="hidden bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="video-edit-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢å½±éŸ³
        </h2>
        <button onclick="hideVideoEditSection()" class="text-textSecondary hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/5 shadow-sm">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="video-form" onsubmit="saveVideo(event)">
        <input type="hidden" id="video-id" value="">
        <div class="space-y-4">
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> å½±éŸ³åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="video-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥å½±éŸ³åç¨±" required>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-link text-primary mr-2 text-xs"></i> è¦–é »/æ’­å®¢éˆæ¥ <span class="text-red-500">*</span>
            </label>
            <input type="url" id="video-url" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥YouTubeã€é¨°è¨Šè¦–é »ã€Spotifyã€Podcastæœ‰æ•ˆç¶²å€" required>
            <p class="text-xs text-textSecondary mt-1 bg-white/80 p-2 rounded-lg">
              <i class="fa fa-lightbulb-o text-accent mr-1"></i> æ”¯æ´YouTubeã€é¨°è¨Šè¦–é »ã€Spotifyã€Apple Podcastã€å„å¤§æ’­å®¢å¹³å°éˆæ¥
            </p>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="video-note" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm shadow-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-2 flex gap-3">
            <button type="button" onclick="hideVideoEditSection()" class="mobile-btn-sm w-1/3 bg-gray-100 hover:bg-gray-200 text-textPrimary font-medium px-3 py-2 rounded-xl transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="video-save-btn" class="mobile-btn-sm w-2/3 primary-gradient text-white font-medium px-3 py-2 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="video-save-btn-text">å„²å­˜å½±éŸ³</span>
              <div id="video-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    
    <div id="file-edit-section" class="hidden bg-neutral rounded-2xl p-3 md:p-5 mb-5 slide-in border border-gray-100 shadow-elevation-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="file-edit-title" class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-edit text-primary mr-2 text-sm"></i> æ–°å¢æ–‡ä»¶
        </h2>
        <button onclick="hideFileEditSection()" class="text-textSecondary hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/5 shadow-sm">
          <i class="fa fa-times-circle text-lg"></i>
        </button>
      </div>
      <form id="file-form" onsubmit="saveFile(event)">
        <input type="hidden" id="file-id-hidden" value="">
        <div class="space-y-4">
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-tag text-primary mr-2 text-xs"></i> æ–‡ä»¶åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" id="file-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥æ–‡ä»¶åç¨±" required>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-link text-primary mr-2 text-xs"></i> æ–‡ä»¶éˆæ¥ <span class="text-red-500">*</span>
            </label>
            <input type="url" id="file-url" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all text-sm shadow-sm" placeholder="è«‹è¼¸å…¥æ–‡ä»¶æœ‰æ•ˆç¶²å€" required>
            <p class="text-xs text-textSecondary mt-1 bg-white/80 p-2 rounded-lg">
              <i class="fa fa-lightbulb-o text-accent mr-1"></i> æ”¯æ´PDFã€Wordã€Excelç­‰å„é¡æ–‡ä»¶éˆæ¥
            </p>
          </div>
          <div class="space-y-2">
            <label class="block text-textPrimary font-medium text-xs md:text-sm">
              <i class="fa fa-sticky-note text-primary mr-2 text-xs"></i> å‚™æ³¨è³‡è¨Š (é¸å¡«)
            </label>
            <textarea id="file-note" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/10 outline-none transition-all resize-none text-sm shadow-sm" rows="2" placeholder="è«‹è¼¸å…¥å‚™æ³¨è³‡è¨Š"></textarea>
          </div>
          <div class="pt-2 flex gap-3">
            <button type="button" onclick="hideFileEditSection()" class="mobile-btn-sm w-1/3 bg-gray-100 hover:bg-gray-200 text-textPrimary font-medium px-3 py-2 rounded-xl transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-times text-sm"></i> å–æ¶ˆ
            </button>
            <button type="submit" id="file-save-btn" class="mobile-btn-sm w-2/3 primary-gradient text-white font-medium px-3 py-2 rounded-xl shadow-primary-hover transition-all duration-300 flex items-center justify-center gap-1 text-sm">
              <i class="fa fa-save text-sm"></i> 
              <span id="file-save-btn-text">å„²å­˜æ–‡ä»¶</span>
              <div id="file-save-loading" class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-white"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    
    <div id="content-preview" class="hidden bg-cardBg rounded-2xl p-3 md:p-5 mb-5 scale-in border border-primary/20 shadow-elevation-2">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-base md:text-xl font-bold text-textPrimary flex items-center">
          <i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å…§å®¹é è¦½
        </h2>
        <div id="preview-action-btns" class="flex gap-2 hidden">
          <button id="preview-edit-btn" onclick="editCurrentContent()" class="mobile-btn-sm gold-gradient text-white text-sm font-medium flex items-center gap-1 px-3 py-2 rounded-xl shadow-gold-hover">
            <i class="fa fa-pencil text-sm"></i> ç·¨è¼¯
          </button>
          <button id="preview-delete-btn" onclick="event.stopPropagation();deleteCurrentContent()" class="mobile-btn-sm bg-red-500 hover:bg-red-600 text-white text-sm font-medium flex items-center gap-1 px-3 py-2 rounded-xl shadow-md">
            <i class="fa fa-trash text-sm"></i> åˆªé™¤
          </button>
          <button onclick="hideContentPreview()" class="text-textSecondary hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/5 shadow-sm">
            <i class="fa fa-times-circle text-lg"></i>
          </button>
        </div>
      </div>
      <div id="preview-content" class="space-y-4">
        <h3 id="preview-title" class="text-sm md:text-base font-semibold text-textPrimary text-center mb-3 text-gold-gradient"></h3>
        <div id="preview-container" class="mb-4">
          <div id="video-container" class="video-container mb-4 flex items-center justify-center hidden">
            <div id="video-loading" class="absolute text-white/80">
              <div class="gold-gradient w-12 h-12 rounded-full flex items-center justify-center animate-spin">
                <i class="fa fa-spinner text-white text-xl"></i>
              </div>
              <p class="text-sm mt-2">è¼‰å…¥å½±ç‰‡ä¸­...</p>
            </div>
            <iframe id="preview-video" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" onload="this.classList.add('loaded'); document.getElementById('video-loading').classList.add('hidden');"></iframe>
          </div>
          <div id="audio-container" class="audio-container mb-4 flex items-center justify-center hidden">
            <div id="audio-loading" class="absolute text-white/80">
              <div class="gold-gradient w-12 h-12 rounded-full flex items-center justify-center animate-spin">
                <i class="fa fa-spinner text-white text-xl"></i>
              </div>
              <p class="text-sm mt-2">è¼‰å…¥æ’­å®¢ä¸­...</p>
            </div>
            <iframe id="preview-audio" src="" allow="encrypted-media; autoplay" onload="this.classList.add('loaded'); document.getElementById('audio-loading').classList.add('hidden');"></iframe>
          </div>
          <div id="unsupported-tip" class="py-10 text-center text-textSecondary hidden">
            <div class="inline-block bg-orange-500/10 w-16 h-16 rounded-full flex items-center justify-center mb-4">
              <i class="fa fa-exclamation-triangle text-3xl mb-3 text-orange-500"></i>
            </div>
            <p class="text-lg font-medium">ä¸æ”¯æ´çš„å…§å®¹é¡å‹</p>
            <p class="text-xs mt-2 text-textSecondary/70">åƒ…æ”¯æ´YouTubeã€é¨°è¨Šè¦–é »ã€Spotifyã€Apple Podcasté è¦½</p>
            <a id="direct-link-btn" href="" target="_blank" class="mt-4 inline-block primary-gradient text-white px-5 py-3 rounded-xl text-sm font-semibold shadow-primary-hover">
              <i class="fa fa-external-link mr-1"></i> ç›´æ¥æ‰“é–‹éˆæ¥
            </a>
          </div>
          <div id="file-preview-tip" class="py-10 text-center text-textSecondary hidden">
            <div class="inline-block bg-blue-500/10 w-16 h-16 rounded-full flex items-center justify-center mb-4">
              <i class="fa fa-file text-3xl mb-3 text-blue-500"></i>
            </div>
            <p class="text-lg font-medium" id="file-preview-name"></p>
            <p class="text-xs mt-2 text-textSecondary/70">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥çœ‹å…§å®¹</p>
            <a id="file-preview-btn" href="" target="_blank" class="mt-4 inline-block primary-gradient text-white px-5 py-3 rounded-xl text-sm font-semibold shadow-primary-hover">
              <i class="fa fa-external-link mr-1"></i> æŸ¥çœ‹å…§å®¹
            </a>
          </div>
        </div>
        <div class="bg-neutral rounded-xl p-4 text-xs md:text-sm text-textSecondary shadow-sm">
          <div class="grid grid-cols-1 gap-3 mb-3">
            <div>
              <span class="font-semibold text-textPrimary text-xs md:text-sm"><i class="fa fa-clock-o text-primary mr-1.5 text-xs"></i> æœ€å¾Œæ›´æ–°ï¼š</span>
              <p id="preview-updated" class="mt-1 text-xs md:text-sm bg-white/80 p-2 rounded-lg"></p>
            </div>
            <div>
              <span class="font-semibold text-textPrimary text-xs md:text-sm"><i class="fa fa-sticky-note text-primary mr-1.5 text-xs"></i> å‚™æ³¨ï¼š</span>
              <p id="preview-note" class="mt-1 text-xs md:text-sm bg-white/80 p-2 rounded-lg">- ç„¡å‚™æ³¨ -</p>
            </div>
          </div>
        </div>
        <div class="flex justify-center mt-3">
          <button onclick="hideContentPreview()" class="mobile-btn bg-gray-100 hover:bg-gray-200 text-textPrimary text-sm font-medium px-6 py-3 rounded-xl flex items-center justify-center gap-1 shadow-sm">
            <i class="fa fa-arrow-left text-sm"></i> è¿”å›åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// é…ç½®å¸¸é‡
const C={
  L:"2008578880-cOBTYud0",
  G:"https://script.google.com/macros/s/AKfycbyZMHC4c3QRgBnjFX3-4S1wI8-9x1519SQwwwxom8oDRupOpysz0SOlU4jO40frncXoIg/exec",
  T:8000,
  P:"9999/12/31",
  S:"yanbin_video_manager_",
  t:'video'
};

// æ‡‰ç”¨ç‹€æ…‹
let S={
  u:null,v:[],f:[],vid:null,vt:null,ev:null,ef:null,
  s:false,d:null,r:'',ei:{rd:0,ed:''},n:'',sid:''
};

// å·¥å…·å‡½æ•¸
const $=(id)=>document.getElementById(id);
const fmtTime=(u)=>{
  const o={timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'};
  return u?new Date(u).toLocaleString('zh-TW',o):new Date().toLocaleString('zh-TW',o);
};
const setStatus=(t)=>{$('status-text').textContent=t;};
const resetSubmit=()=>{setSubmit('video',false);setSubmit('file',false);};

// æç¤ºè¨Šæ¯
const showErr=(m)=>{
  [$('status'),$('result-card'),$('content-viewer-section'),$('content-manage-section'),
   $('video-edit-section'),$('file-edit-section'),$('content-preview'),$('success-message')].forEach(e=>e&&e.classList.add('hidden'));
  const e=$('error-message'),c=$('error-content');
  if(e&&c){
    c.innerHTML=`<p class="font-medium text-lg">${m}</p>
<div class="mt-2 flex justify-center gap-3">
  <button onclick="window.location.href='https://lihi.cc/DLihS'" class="text-primary hover:text-[#007A69] font-medium text-base px-6 py-3 rounded-lg bg-white border border-primary/20 hover:bg-primary/5 transition-all duration-300 flex items-center gap-2 shadow-sm hover:shadow-md">
    <i class="fa fa-user-circle"></i> è¯ç¹«<br>å½¥å½¬
  </button>
  <button onclick="window.location.reload()" class="text-primary hover:text-[#007A69] font-medium text-base px-6 py-3 rounded-lg bg-white border border-primary/20 hover:bg-primary/5 transition-all duration-300 flex items-center gap-2 shadow-sm hover:shadow-md">
    <i class="fa fa-refresh"></i> é‡æ–°<br>åŠ è¼‰
  </button>
</div>`;
    e.classList.remove('hidden');
  }
  resetSubmit();
};

const showSucc=(m)=>{
  const e=$('error-message');
  e&&e.classList.add('hidden');
  const s=$('success-message'),c=$('success-content');
  if(s&&c){
    c.innerHTML=`<p class="font-medium">${m}</p>`;
    s.classList.remove('hidden');
    setTimeout(()=>s&&s.classList.add('hidden'),4000);
  }
};

// æäº¤ç‹€æ…‹ç®¡ç†
const setSubmit=(t,is)=>{
  S.s=is;
  let b,bt,l,tx;
  if(t==='video'){
    b=$('video-save-btn');bt=$('video-save-btn-text');l=$('video-save-loading');
    tx=S.ev?"æ›´æ–°å½±éŸ³":"å„²å­˜å½±éŸ³";
  }else{
    b=$('file-save-btn');bt=$('file-save-btn-text');l=$('file-save-loading');
    tx=S.ef?"æ›´æ–°æ–‡ä»¶":"å„²å­˜æ–‡ä»¶";
  }
  if(is){
    b&&b.classList.add('btn-disabled');
    bt&&(bt.textContent="å„²å­˜ä¸­...");
    l&&l.classList.remove('hidden');
  }else{
    b&&b.classList.remove('btn-disabled');
    bt&&(bt.textContent=tx);
    l&&l.classList.add('hidden');
  }
};

// URLæª¢æŸ¥å·¥å…·
const uc={
  y:(u)=>u&&(u.toLowerCase().includes('youtube.com')||u.toLowerCase().includes('youtu.be')||u.toLowerCase().includes('youtube-nocookie.com')),
  t:(u)=>u&&u.toLowerCase().includes('v.qq.com'),
  s:(u)=>u&&(u.toLowerCase().includes('spotify.com')||u.toLowerCase().includes('open.spotify.com')),
  a:(u)=>u&&(u.toLowerCase().includes('podcasts.apple.com')||u.toLowerCase().includes('itunes.apple.com/podcast')),
  p:(u)=>u&&['podcast','pca.st','soundcloud.com','anchor.fm','mixcloud.com','castbox.fm','player.fm','listennotes.com'].some(d=>u.toLowerCase().includes(d)),
  v:(u)=>{try{new URL(u);return true;}catch(e){return false;}}
};

// è½‰æ›åµŒå…¥URL
const convEmbed=(u)=>{
  if(!u)return {t:'unsupported',u:''};
  
  if(uc.y(u)){
    const m=u.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/|live\/|playlist\?list=)|youtube-nocookie\.com\/embed\/)([\w-]+)/);
    if(m&&m[1]){
      const isShort=u.includes('shorts/');
      return {t:'video',u:`https://www.youtube.com/embed/${m[1]}?autoplay=0&rel=0${isShort?'&enablejsapi=1':''}`};
    }
    const vm=u.match(/[?&]v=([^&]+)/);
    if(vm&&vm[1])return {t:'video',u:`https://www.youtube.com/embed/${vm[1]}?autoplay=0&rel=0`};
  }
  
  else if(uc.t(u)){
    const rs=[/v\.qq\.com\/x\/page\/([a-zA-Z0-9_]+)\.html/,/v\.qq\.com\/x\/cover\/([a-zA-Z0-9_]+)\/([a-zA-Z0-9_]+)\.html/,
      /v\.qq\.com\/detail\/\w+\/([a-zA-Z0-9_]+)\.html/,/vid=([a-zA-Z0-9_]+)/];
    let vid='';
    for(let r of rs){const m=u.match(r);if(m){vid=m[2]||m[1]||'';break;}}
    if(vid)return {t:'video',u:`https://v.qq.com/txp/iframe/player.html?vid=${vid}&auto=0&show1080p=1`};
  }
  
  else if(uc.s(u)){
    const m=u.match(/spotify\.com\/(track|episode|playlist|album|show)\/([a-zA-Z0-9]+)/);
    if(m&&m[2]){
      return {t:'audio',u:`https://open.spotify.com/embed/${m[1]}/${m[2]}?utm_source=generator&autoplay=0`};
    }
    const im=u.match(/[a-zA-Z0-9]{22}/);
    if(im)return {t:'audio',u:`https://open.spotify.com/embed/track/${im[0]}?utm_source=generator&autoplay=0`};
  }
  
  else if(uc.a(u)){
    const sm=u.match(/podcasts\.apple\.com\/.+\/podcast\/.+\/id(\d+)/);
    if(sm&&sm[1]){
      return {t:'audio',u:`https://embed.podcasts.apple.com/us/podcast/id${sm[1]}?itsct=podcast_box&itscg=30200`};
    }
    const em=u.match(/\/id(\d+)\?i=(\d+)/);
    if(em&&em[2]){
      return {t:'audio',u:`https://embed.podcasts.apple.com/us/podcast/id${em[1]}?i=${em[2]}&itsct=podcast_box&itscg=30200`};
    }
  }
  
  else if(uc.p(u)){
    if(u.includes('soundcloud.com')){
      const m=u.match(/soundcloud\.com\/([^\/]+)\/([^\/]+)/);
      if(m)return {t:'audio',u:`https://w.soundcloud.com/player/?url=${encodeURIComponent(u)}&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&visual=true`};
    }
    else if(u.includes('anchor.fm')){
      const m=u.match(/anchor\.fm\/([^\/]+)\/episodes\/([^\/]+)/);
      if(m)return {t:'audio',u:`https://anchor.fm/${m[1]}/embed/episodes/${m[2]}?color=blue&autoplay=false`};
    }
    return {t:'audio',u:u};
  }
  
  try{
    const uo=new URL(u);
    const vd=['facebook.com','fb.watch','instagram.com','tiktok.com','douyin.com','bilibili.com','iqiyi.com','youku.com'];
    if(vd.some(d=>uo.host.includes(d))){
      return {t:'video',u:u};
    }
  }catch(e){}
  
  return {t:'unsupported',u:u};
};

// è¨ˆç®—å‰©é¤˜å¤©æ•¸
const calcDays=(e)=>{
  try{
    if(e===C.P)return{d:"æ°¸ä¹…æœ‰æ•ˆ",rd:"æ°¸ä¹…æœ‰æ•ˆ"};
    if(!/^\d{4}[-\/]\d{2}[-\/]\d{2}(?:\s+\d{1,2}:\d{1,2}(?::\d{1,2})?)?$/.test(e)){
      return{d:"æ ¼å¼éŒ¯èª¤",rd:"æ ¼å¼éŒ¯èª¤"};
    }
    const n=e.replace(/-/g,'/');
    let ed;
    if(n.includes(' ')){
      const [dp,tp]=n.split(' ');
      const [y,m,d]=dp.split('/').map(Number);
      const [h,mi,s]=tp.split(':').map(Number);
      ed=new Date(Date.UTC(y,m-1,d,h||0,mi||0,s||0));
    }else{
      const [y,m,d]=n.split('/').map(Number);
      ed=new Date(Date.UTC(y,m-1,d));
    }
    if(isNaN(ed.getTime()))return{d:"æ—¥æœŸç„¡æ•ˆ",rd:"æ—¥æœŸç„¡æ•ˆ"};
    const td=new Date();
    const to=8*60*60*1000;
    const tt=new Date(td.getTime()+to);
    const tu=new Date(Date.UTC(tt.getFullYear(),tt.getMonth(),tt.getDate()));
    const tdiff=ed-tu;
    const rd=Math.ceil(tdiff/(1000*3600*24));
    const fd=new Date(ed).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    let rt;
    if(rd<0)rt="<span class='text-red-500 font-medium'>å·²éæœŸ</span>";
    else if(rd===0)rt="<span class='text-orange-500 font-medium'>æœ€å¾Œ1å¤©</span>";
    else if(rd<=30)rt=`<span class='text-orange-500 font-medium'>${rd} å¤©</span>`;
    else rt=`${rd} å¤©`;
    return{d:fd,rd:rt};
  }catch(e){
    console.error("è¨ˆç®—å‰©é¤˜å¤©æ•¸å¤±æ•—ï¼š",e);
    return{d:"è¨ˆç®—éŒ¯èª¤",rd:"è¨ˆç®—éŒ¯èª¤"};
  }
};

// ç²å–é è¦½åœ–
const getThumb=(u,t)=>{
  if(!u)return 'https://via.placeholder.com/300x180?text=No+Preview';
  if(t==='video'){
    if(uc.y(u)){
      const m=u.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/))([\w-]+)/);
      return m&&m[1]?`https://img.youtube.com/vi/${m[1]}/mqdefault.jpg`:'https://via.placeholder.com/300x180?text=è¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(uc.t(u)){
      return 'https://via.placeholder.com/300x180?text=é¨°è¨Šè¦–é »&bgcolor=e8f9f7&color=008c76';
    }else if(uc.s(u)){
      return 'https://via.placeholder.com/300x180?text=Spotify&bgcolor=1DB954&color=ffffff';
    }else if(uc.a(u)){
      return 'https://via.placeholder.com/300x180?text=Apple Podcast&bgcolor=ffffff&color=000000';
    }else if(uc.p(u)){
      return 'https://via.placeholder.com/300x180?text=æ’­å®¢&bgcolor=7C3AED&color=ffffff';
    }
    return 'https://via.placeholder.com/300x180?text=å½±éŸ³&bgcolor=e8f9f7&color=008c76';
  }else if(t==='file'){
    const lu=u.toLowerCase();
    if(lu.endsWith('.pdf'))return 'https://via.placeholder.com/300x180?text=PDFæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lu.endsWith('.doc')||lu.endsWith('.docx'))return 'https://via.placeholder.com/300x180?text=Wordæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lu.endsWith('.xls')||lu.endsWith('.xlsx'))return 'https://via.placeholder.com/300x180?text=Excelæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else if(lu.endsWith('.ppt')||lu.endsWith('.pptx'))return 'https://via.placeholder.com/300x180?text=PPTæ–‡ä»¶&bgcolor=f0f7ff&color=3b82f6';
    else return 'https://via.placeholder.com/300x180?text=æ–‡ä»¶&bgcolor=f0f7ff&color=64748b';
  }
  return 'https://via.placeholder.com/300x180?text=å…§å®¹&bgcolor=f1f5f9&color=64748b';
};

// æ‹–æ”¾è™•ç†
const dh={
  s:(e)=>{
    if(!isAdmin())return;
    S.d=e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData('text/plain',JSON.stringify({id:e.target.dataset.id,type:e.target.dataset.type}));
    e.target.style.opacity='0.5';
  },
  o:(e)=>{
    if(!isAdmin())return;
    e.preventDefault();
    const i=e.target.closest('.video-item');
    if(i&&i!==S.d)i.classList.add('drop-zone');
  },
  l:(e)=>{
    if(!isAdmin())return;
    const i=e.target.closest('.video-item');
    i&&i.classList.remove('drop-zone');
  },
  d:(e)=>{
    if(!isAdmin())return;
    e.preventDefault();
    const dd=JSON.parse(e.dataTransfer.getData('text/plain'));
    const ti=e.target.closest('.video-item');
    if(!ti||ti.dataset.id===dd.id||ti.dataset.type!==dd.type)return;
    let di,ti;
    if(dd.type==='video'){
      di=S.v.findIndex(v=>v.id===dd.id);
      ti=S.v.findIndex(v=>v.id===ti.dataset.id);
      if(di!==-1&&ti!==-1){
        const [dr]=S.v.splice(di,1);
        S.v.splice(ti,0,dr);
        syncOrder('video');
        renderList('manage');
        renderList('viewer');
      }
    }else if(dd.type==='file'){
      di=S.f.findIndex(f=>f.id===dd.id);
      ti=S.f.findIndex(f=>f.id===ti.dataset.id);
      if(di!==-1&&ti!==-1){
        const [dr]=S.f.splice(di,1);
        S.f.splice(ti,0,dr);
        syncOrder('file');
        renderList('manage');
        renderList('viewer');
      }
    }
    ti.classList.remove('drop-zone');
    if(S.d){
      S.d.classList.remove('dragging');
      S.d.style.opacity='1';
    }
    S.d=null;
    showSucc('å…§å®¹é †åºå·²å³æ™‚æ›´æ–°ï¼');
  },
  e:(e)=>{
    if(!isAdmin())return;
    e.target.classList.remove('dragging');
    e.target.style.opacity='1';
    document.querySelectorAll('.video-item').forEach(i=>i.classList.remove('drop-zone'));
    S.d=null;
  }
};

// æ›´æ–°å…§å®¹è¨ˆæ•¸
const updateCount=()=>{
  const vc=$('video-count-num'),fc=$('file-count-num');
  vc&&(vc.textContent=S.v.length);
  fc&&(fc.textContent=S.f.length);
};

// æ¬Šé™åˆ¤æ–·
const isAdmin=()=>S.r==='admin';
const isPro=()=>S.r==='pro'||isAdmin();
const isManage=()=>isAdmin();

// å¸¶é‡è©¦çš„è«‹æ±‚å‡½æ•¸
const requestWithRetry=(url, data, timeout, retries=2)=>{
  return new Promise((resolve, reject)=>{
    const attempt=(remaining)=>{
      $.ajax({
        url:url,
        dataType:'jsonp',
        jsonp:'callback',
        timeout:timeout,
        data:data,
        cache:true,
        success:(resp)=>resolve(resp),
        error:(xhr,status,error)=>{
          if(remaining>0 && (status==='timeout'||status==='error')){
            console.log(`è«‹æ±‚å¤±æ•—ï¼Œå‰©é¤˜é‡è©¦æ¬¡æ•¸ï¼š${remaining}`);
            setTimeout(()=>attempt(remaining-1), 500);
          }else{
            reject({xhr,status,error});
          }
        }
      });
    };
    attempt(retries);
  });
};

// é©—è­‰ç”¨æˆ¶æ¬Šé™
const verifyUser=()=>{
  return new Promise(async (resolve, reject)=>{
    setStatus('é©—è­‰ç”¨æˆ¶æ¬Šé™...');
    if(!S.u)return reject(new Error('ç”¨æˆ¶ä¿¡æ¯ä¸å­˜åœ¨'));
    
    try{
      const resp=await requestWithRetry(C.G, {
        action:'verifyUser',
        userId:S.u.userId,
        displayName:S.u.displayName,
        writeToSheet:true,
        needExpiryDate:true
      }, C.T);
      
      if(resp.status==="success"&&resp.isAuthorized){
        S.r=resp.isAdmin?'admin':(resp.isPro?'pro':'user');
        S.ei={
          rd:resp.remainingDays||0,
          ed:resp.expiryDate||C.P
        };
        S.n=resp.nickname||S.u.displayName||'æœªçŸ¥ç”¨æˆ¶';
        resolve(true);
      }else{
        reject(new Error(resp.message||'ç”¨æˆ¶æœªæˆæ¬Šï¼Œè«‹è¯ç¹«ç®¡ç†å“¡é–‹é€š'));
      }
    }catch(err){
      console.error("ç”¨æˆ¶æ¬Šé™é©—è­‰å¤±æ•—ï¼š",err);
      const em=err.status==='timeout'
        ? 'æ¬Šé™é©—è­‰è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡è©¦'
        : (err.status==='abort'?'è«‹æ±‚å·²ä¸­æ–·':'ç¶²çµ¡éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰ç”¨æˆ¶æ¬Šé™');
      reject(new Error(em));
    }
  });
};

// ç²å–GASæ•¸æ“š
const fetchData=(t)=>{
  return new Promise(async (resolve, reject)=>{
    setStatus(`è¼‰å…¥${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}åˆ—è¡¨ä¸­...`);
    
    try{
      const resp=await requestWithRetry(C.G, {
        action:`get${t==='video'?'Video':'File'}List`
      }, C.T);
      
      if(resp.status==="success"&&Array.isArray(resp.data)){
        const lk=`${t}List`;
        const uk=t==='video'?'video':'file';
        S[t==='video'?'v':'f']=resp.data.map(item=>({
          id:item.id||`${t}_${Date.now()}_${Math.floor(Math.random()*1000)}`,
          name:item.name||'',
          url:item[uk]||'',
          note:item.note||'',
          updatedAt:fmtTime(item.updatedAt)||fmtTime(new Date().toISOString()),
          [`${t}Type`]:item[`${t}Type`]||''
        })).filter(item=>item.url&&item.id);
        resolve(true);
      }else{
        S[t==='video'?'v':'f']=[];
        resolve(false);
      }
    }catch(err){
      console.error(`ç²å–${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}åˆ—è¡¨å¤±æ•—ï¼š`,err);
      S[t==='video'?'v':'f']=[];
      reject(new Error(`ç²å–${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}åˆ—è¡¨å¤±æ•—`));
    }
  });
};

// åŒæ­¥æ•¸æ“šåˆ°GAS
const syncToGAS=(t,d,cb)=>{
  const a=`save${t==='video'?'Video':'File'}`;
  const k=t==='video'?'video':'file';
  requestWithRetry(C.G, {
    action:a,
    userId:S.u?.userId||'',
    displayName:S.u?.displayName||'',
    [`${t}Id`]:d.id,
    name:d.name,
    [k]:d.url,
    note:d.note,
    updatedAt:d.updatedAt
  }, C.T).then(resp=>{
    if(resp.status==="success"){
      cb&&cb(true);
    }else{
      showErr(`åŒæ­¥${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
      cb&&cb(false);
    }
  }).catch(err=>{
    console.error(`åŒæ­¥${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š`,err);
    showErr(`åŒæ­¥${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š${err.status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
    cb&&cb(false);
  });
};

// åˆªé™¤GASæ•¸æ“š
const deleteFromGAS=(t,id,cb)=>{
  const a=`delete${t==='video'?'Video':'File'}`;
  requestWithRetry(C.G, {
    action:a,
    userId:S.u?.userId||'',
    displayName:S.u?.displayName||'',
    [`${t}Id`]:id
  }, C.T).then(resp=>{
    if(resp.status==="success"){
      cb&&cb(true);
    }else{
      showErr(`åˆªé™¤${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`);
      cb&&cb(false);
    }
  }).catch(err=>{
    console.error(`åˆªé™¤${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š`,err);
    showErr(`åˆªé™¤${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}å¤±æ•—ï¼š${err.status==='timeout'?'è«‹æ±‚è¶…æ™‚':'ç¶²çµ¡éŒ¯èª¤'}`);
    cb&&cb(false);
  });
};

// åŒæ­¥åˆ—è¡¨é †åº
const syncOrder=(t)=>{
  const lk=t==='video'?'v':'f';
  const ids=S[lk].map(i=>i.id);
  requestWithRetry(C.G, {
    action:`update${t==='video'?'Video':'File'}Order`,
    userId:S.u?.userId||'',
    displayName:S.u?.displayName||'',
    [`${t}Ids`]:JSON.stringify(ids)
  }, C.T).then(resp=>{
    if(resp.status!=="success")console.warn(`åŒæ­¥${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}é †åºå¤±æ•—ï¼š`,resp.message);
  }).catch(err=>{
    console.error(`åŒæ­¥${t==='video'?'å½±éŸ³':'æ–‡ä»¶'}é †åºå¤±æ•—ï¼š`,err);
  });
};

// æ¸²æŸ“ç€è¦½åˆ—è¡¨
const renderViewerList=()=>{
  const t=C.t;
  const lk=t==='video'?'v':'f';
  const cs=$('content-select');
  const el=$('viewer-empty-list');
  const et=$('viewer-empty-text');
  const sd=$('selected-content-display');
  const sw=$('start-watch-btn');
  
  cs.innerHTML='<option value="">è«‹é¸æ“‡è¦æŸ¥çœ‹çš„å…§å®¹...</option>';
  sd.classList.add('hidden');
  el.classList.add('hidden');
  sw.classList.add('hidden');
  
  et.textContent=t==='video'?'æš«ç„¡å¯æŸ¥çœ‹çš„å½±éŸ³':'æš«ç„¡å¯æŸ¥çœ‹çš„æ–‡ä»¶';
  
  if(S[lk].length===0){
    el.classList.remove('hidden');
    return;
  }
  
  S[lk].forEach((i)=>{
    const o=document.createElement('option');
    o.value=i.id;
    o.textContent=i.name.length>50?i.name.substring(0,50)+'...':i.name;
    cs.appendChild(o);
  });
  
  sw.classList.remove('hidden');
  
  if(S.sid){
    const so=cs.querySelector(`option[value="${S.sid}"]`);
    if(so){
      so.selected=true;
      selectContent(S.sid);
    }
  }
};

// é–‹å§‹è§€çœ‹
const startWatch=()=>{
  const cs=$('content-select');
  const sid=cs.value;
  
  if(!sid){
    showErr('è«‹å…ˆé¸æ“‡è¦è§€çœ‹çš„å…§å®¹ï¼');
    return;
  }
  
  selectContent(sid);
};

// é¸æ“‡å…§å®¹
const selectContent=(id)=>{
  if(!id){
    $('selected-content-display').classList.add('hidden');
    S.sid='';
    return;
  }
  
  const t=C.t;
  const lk=t==='video'?'v':'f';
  const i=S[lk].find(i=>i.id===id);
  
  if(!i)return;
  
  S.sid=id;
  previewContent(id,t);
};

// æ¸²æŸ“ç®¡ç†åˆ—è¡¨
const renderList=(m)=>{
  const t=C.t;
  const lk=t==='video'?'v':'f';
  const cid=m==='manage'?(t==='video'?'video-list-container':'file-list-container'):null;
  const el=m==='manage'?$('empty-manage-list'):null;
  const et=m==='manage'?$('empty-manage-text'):null;
  
  if(m==='manage'&&cid){
    $('video-list-container').classList.add('hidden');
    $('file-list-container').classList.add('hidden');
    
    const c=$(cid);
    c.innerHTML='';
    el.classList.add('hidden');
    
    if(et){
      et.textContent=t==='video'?'å°šæœªæ·»åŠ ä»»ä½•å½±éŸ³':'å°šæœªæ·»åŠ ä»»ä½•æ–‡ä»¶';
    }
    
    if(S[lk].length===0){
      el.classList.remove('hidden');
      return;
    }
    
    c.classList.remove('hidden');
    
    S[lk].forEach((i)=>{
      const tn=getThumb(i.url,t);
      const ie=document.createElement('div');
      ie.className=`video-item ${isManage()?'':'pro-user'} bg-cardBg p-3 rounded-xl border border-gray-100 flex items-center gap-3 shadow-elevation-1`;
      ie.dataset.id=i.id;
      ie.dataset.type=t;
      
      if(isManage()){
        ie.draggable=true;
        ie.addEventListener('dragstart',dh.s);
        ie.addEventListener('dragover',dh.o);
        ie.addEventListener('dragleave',dh.l);
        ie.addEventListener('drop',dh.d);
        ie.addEventListener('dragend',dh.e);
      }
      
      ie.innerHTML=`
        <div class="thumbnail-container">
          <img src="${tn}" alt="${i.name}" class="thumbnail-img">
        </div>
        <div class="flex-1 min-w-0">
          <h4 class="font-semibold text-textPrimary text-sm truncate">${i.name}</h4>
          <p class="text-xs text-textSecondary mt-1 truncate">${i.url}</p>
          <p class="text-xs text-textSecondary/70 mt-1">æ›´æ–°æ™‚é–“ï¼š${i.updatedAt}</p>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="previewContent('${i.id}', '${t}')" class="p-2 text-primary hover:text-[#007A69] rounded-full hover:bg-primary/5 transition-colors">
            <i class="fa fa-eye"></i>
          </button>
          ${isManage()?`
            <button onclick="editContent('${i.id}', '${t}')" class="p-2 text-accent hover:text-darkGold rounded-full hover:bg-accent/5 transition-colors">
              <i class="fa fa-pencil"></i>
            </button>
            <button onclick="deleteContent('${i.id}', '${t}')" class="p-2 text-red-500 hover:text-red-600 rounded-full hover:bg-red-50 transition-colors">
              <i class="fa fa-trash"></i>
            </button>
          `:''}
        </div>
      `;
      
      c.appendChild(ie);
    });
  }
  
  if(m==='viewer'){
    renderViewerList();
  }
  
  updateCount();
};

// åˆ‡æ›å…§å®¹é¡å‹
const switchContentType=(t)=>{
  if(t===C.t)return;
  
  C.t=t;
  S.sid='';
  
  $('current-content-type').textContent=t==='video'?'å½±éŸ³åˆ—è¡¨':'æ–‡ä»¶åˆ—è¡¨';
  
  $('viewer-section-title').innerHTML=t==='video'
    ? '<i class="fa fa-play-circle text-primary mr-2 text-sm"></i> å½±éŸ³åˆ—è¡¨'
    : '<i class="fa fa-file text-primary mr-2 text-sm"></i> æ–‡ä»¶åˆ—è¡¨';
  $('manage-section-title').innerHTML=t==='video'
    ? '<i class="fa fa-th-list text-primary mr-2 text-sm"></i> å½±éŸ³ç®¡ç†åˆ—è¡¨'
    : '<i class="fa fa-th-list text-primary mr-2 text-sm"></i> æ–‡ä»¶ç®¡ç†åˆ—è¡¨';
  
  $('add-content-btn').innerHTML=t==='video'
    ? '<i class="fa fa-plus text-lg"></i> æ–°å¢å½±éŸ³'
    : '<i class="fa fa-plus text-lg"></i> æ–°å¢æ–‡ä»¶';
  
  // é‡æ–°æ¸²æŸ“åˆ—è¡¨
  renderList('manage');
  renderList('viewer');
  
  // éšè—ä¸‹æ‹‰èœå•
  $('content-type-dropdown').classList.add('hidden');
};

// é è¦½å…§å®¹
const previewContent=(id,t)=>{
  const lk=t==='video'?'v':'f';
  const i=S[lk].find(i=>i.id===id);
  
  if(!i)return;
  
  // éš±è—å…¶ä»–å€åŸŸï¼Œé¡¯ç¤ºé è¦½å€
  [$('status'),$('result-card'),$('content-viewer-section'),$('content-manage-section'),
   $('video-edit-section'),$('file-edit-section'),$('error-message'),$('success-message')].forEach(e=>e&&e.classList.add('hidden'));
  
  const cp=$('content-preview');
  cp.classList.remove('hidden');
  
  // è¨­ç½®é è¦½æ¨™é¡Œ
  $('preview-title').textContent=i.name;
  
  // é‡ç½®é è¦½å®¹å™¨
  const vc=$('video-container'),ac=$('audio-container'),
        ut=$('unsupported-tip'),fpt=$('file-preview-tip');
  
  [vc,ac,ut,fpt].forEach(e=>e.classList.add('hidden'));
  
  // è¨­ç½®æœ€å¾Œæ›´æ–°æ™‚é–“å’Œå‚™æ³¨
  $('preview-updated').textContent=i.updatedAt||'æœªçŸ¥æ™‚é–“';
  $('preview-note').textContent=i.note||'- ç„¡å‚™æ³¨ -';
  
  // å„²å­˜ç•¶å‰é è¦½çš„å…§å®¹IDå’Œé¡å‹
  S.vid=id;
  S.vt=t;
  
  // ç®¡ç†å“¡é¡¯ç¤ºç·¨è¼¯/åˆªé™¤æŒ‰éˆ•
  const pab=$('preview-action-btns');
  pab.classList[isManage()?'remove':'add']('hidden');
  
  if(t==='video'){
    // è™•ç†å½±éŸ³é è¦½
    const ce=convEmbed(i.url);
    
    if(ce.t==='video'){
      vc.classList.remove('hidden');
      const pv=$('preview-video');
      pv.src=ce.u;
      pv.classList.remove('loaded');
      $('video-loading').classList.remove('hidden');
    }else if(ce.t==='audio'){
      ac.classList.remove('hidden');
      const pa=$('preview-audio');
      pa.src=ce.u;
      pa.classList.remove('loaded');
      $('audio-loading').classList.remove('hidden');
    }else{
      ut.classList.remove('hidden');
      $('direct-link-btn').href=i.url;
    }
  }else if(t==='file'){
    // è™•ç†æ–‡ä»¶é è¦½
    fpt.classList.remove('hidden');
    $('file-preview-name').textContent=i.name;
    $('file-preview-btn').href=i.url;
  }
};

// éš±è—å…§å®¹é è¦½
const hideContentPreview=()=>{
  $('content-preview').classList.add('hidden');
  
  // æ ¹æ“šç•¶å‰ç‹€æ…‹é¡¯ç¤ºå°æ‡‰å€åŸŸ
  if(isManage()){
    $('content-manage-section').classList.remove('hidden');
  }else{
    $('content-viewer-section').classList.remove('hidden');
  }
  
  // é‡ç½®iframeé˜²æ­¢è‡ªå‹•æ’­æ”¾
  $('preview-video').src='';
  $('preview-audio').src='';
};

// ç·¨è¼¯ç•¶å‰é è¦½çš„å…§å®¹
const editCurrentContent=()=>{
  if(S.vid&&S.vt){
    editContent(S.vid,S.vt);
  }
};

// åˆªé™¤ç•¶å‰é è¦½çš„å…§å®¹
const deleteCurrentContent=()=>{
  if(S.vid&&S.vt){
    deleteContent(S.vid,S.vt);
  }
};

// ç·¨è¼¯å…§å®¹
const editContent=(id,t)=>{
  if(!isManage())return;
  
  const lk=t==='video'?'v':'f';
  const i=S[lk].find(i=>i.id===id);
  
  if(!i)return;
  
  // éš±è—å…¶ä»–å€åŸŸ
  [$('status'),$('result-card'),$('content-viewer-section'),$('content-manage-section'),
   $('content-preview'),$('error-message'),$('success-message')].forEach(e=>e&&e.classList.add('hidden'));
  
  if(t==='video'){
    // ç·¨è¼¯å½±éŸ³
    S.ev=i;
    $('video-edit-section').classList.remove('hidden');
    $('video-edit-title').textContent='ç·¨è¼¯å½±éŸ³';
    $('video-id').value=i.id;
    $('video-name').value=i.name;
    $('video-url').value=i.url;
    $('video-note').value=i.note;
    $('video-save-btn-text').textContent='æ›´æ–°å½±éŸ³';
  }else{
    // ç·¨è¼¯æ–‡ä»¶
    S.ef=i;
    $('file-edit-section').classList.remove('hidden');
    $('file-edit-title').textContent='ç·¨è¼¯æ–‡ä»¶';
    $('file-id-hidden').value=i.id;
    $('file-name').value=i.name;
    $('file-url').value=i.url;
    $('file-note').value=i.note;
    $('file-save-btn-text').textContent='æ›´æ–°æ–‡ä»¶';
  }
};

// åˆªé™¤å…§å®¹
const deleteContent=(id,t)=>{
  if(!isManage()||!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å…§å®¹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼'))return;
  
  const lk=t==='video'?'v':'f';
  const idx=S[lk].findIndex(i=>i.id===id);
  
  if(idx===-1)return;
  
  // å¾æœ¬åœ°åˆ—è¡¨ç§»é™¤
  S[lk].splice(idx,1);
  
  // åŒæ­¥åˆ°GAS
  deleteFromGAS(t,id,(success)=>{
    if(success){
      showSucc(t==='video'?'å½±éŸ³å·²æˆåŠŸåˆªé™¤ï¼':'æ–‡ä»¶å·²æˆåŠŸåˆªé™¤ï¼');
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderList('manage');
      renderList('viewer');
      
      // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é è¦½çš„å…§å®¹ï¼Œéš±è—é è¦½
      if(id===S.vid&&t===S.vt){
        hideContentPreview();
        S.vid=null;
        S.vt=null;
        S.sid='';
      }
    }
  });
};

// æ–°å¢å…§å®¹
const addNewContent=()=>{
  if(!isManage())return;
  
  const t=C.t;
  
  // éš±è—å…¶ä»–å€åŸŸ
  [$('status'),$('result-card'),$('content-viewer-section'),$('content-preview'),
   $('error-message'),$('success-message')].forEach(e=>e&&e.classList.add('hidden'));
  
  if(t==='video'){
    // æ–°å¢å½±éŸ³
    S.ev=null;
    $('video-edit-section').classList.remove('hidden');
    $('video-edit-title').textContent='æ–°å¢å½±éŸ³';
    $('video-form').reset();
    $('video-id').value='';
    $('video-save-btn-text').textContent='å„²å­˜å½±éŸ³';
  }else{
    // æ–°å¢æ–‡ä»¶
    S.ef=null;
    $('file-edit-section').classList.remove('hidden');
    $('file-edit-title').textContent='æ–°å¢æ–‡ä»¶';
    $('file-form').reset();
    $('file-id-hidden').value='';
    $('file-save-btn-text').textContent='å„²å­˜æ–‡ä»¶';
  }
  
  $('content-manage-section').classList.remove('hidden');
};

// éš±è—å½±éŸ³ç·¨è¼¯å€
const hideVideoEditSection=()=>{
  $('video-edit-section').classList.add('hidden');
  S.ev=null;
  resetSubmit();
  
  // é¡¯ç¤ºç®¡ç†å€
  $('content-manage-section').classList.remove('hidden');
};

// éš±è—æ–‡ä»¶ç·¨è¼¯å€
const hideFileEditSection=()=>{
  $('file-edit-section').classList.add('hidden');
  S.ef=null;
  resetSubmit();
  
  // é¡¯ç¤ºç®¡ç†å€
  $('content-manage-section').classList.remove('hidden');
};

// å„²å­˜å½±éŸ³
const saveVideo=(e)=>{
  e.preventDefault();
  
  if(S.s)return;
  
  const id=$('video-id').value;
  const name=$('video-name').value.trim();
  const url=$('video-url').value.trim();
  const note=$('video-note').value.trim();
  
  if(!name){
    showErr('è«‹è¼¸å…¥å½±éŸ³åç¨±ï¼');
    return;
  }
  
  if(!url||!uc.v(url)){
    showErr('è«‹è¼¸å…¥æœ‰æ•ˆçš„URLåœ°å€ï¼');
    return;
  }
  
  setSubmit('video',true);
  
  const videoData={
    id:id||`video_${Date.now()}_${Math.floor(Math.random()*1000)}`,
    name:name,
    url:url,
    note:note,
    updatedAt:fmtTime(new Date().toISOString())
  };
  
  // æ›´æ–°æœ¬åœ°åˆ—è¡¨
  if(S.ev){
    // ç·¨è¼¯ç¾æœ‰å½±éŸ³
    const idx=S.v.findIndex(v=>v.id===id);
    if(idx!==-1){
      S.v[idx]=videoData;
    }
  }else{
    // æ–°å¢å½±éŸ³
    S.v.push(videoData);
    syncOrder('video'); // åŒæ­¥é †åº
  }
  
  // åŒæ­¥åˆ°GAS
  syncToGAS('video',videoData,(success)=>{
    setSubmit('video',false);
    
    if(success){
      showSucc(S.ev?'å½±éŸ³å·²æˆåŠŸæ›´æ–°ï¼':'å½±éŸ³å·²æˆåŠŸæ–°å¢ï¼');
      hideVideoEditSection();
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderList('manage');
      renderList('viewer');
    }
  });
};

// å„²å­˜æ–‡ä»¶
const saveFile=(e)=>{
  e.preventDefault();
  
  if(S.s)return;
  
  const id=$('file-id-hidden').value;
  const name=$('file-name').value.trim();
  const url=$('file-url').value.trim();
  const note=$('file-note').value.trim();
  
  if(!name){
    showErr('è«‹è¼¸å…¥æ–‡ä»¶åç¨±ï¼');
    return;
  }
  
  if(!url||!uc.v(url)){
    showErr('è«‹è¼¸å…¥æœ‰æ•ˆçš„URLåœ°å€ï¼');
    return;
  }
  
  setSubmit('file',true);
  
  const fileData={
    id:id||`file_${Date.now()}_${Math.floor(Math.random()*1000)}`,
    name:name,
    url:url,
    note:note,
    updatedAt:fmtTime(new Date().toISOString())
  };
  
  // æ›´æ–°æœ¬åœ°åˆ—è¡¨
  if(S.ef){
    // ç·¨è¼¯ç¾æœ‰æ–‡ä»¶
    const idx=S.f.findIndex(f=>f.id===id);
    if(idx!==-1){
      S.f[idx]=fileData;
    }
  }else{
    // æ–°å¢æ–‡ä»¶
    S.f.push(fileData);
    syncOrder('file'); // åŒæ­¥é †åº
  }
  
  // åŒæ­¥åˆ°GAS
  syncToGAS('file',fileData,(success)=>{
    setSubmit('file',false);
    
    if(success){
      showSucc(S.ef?'æ–‡ä»¶å·²æˆåŠŸæ›´æ–°ï¼':'æ–‡ä»¶å·²æˆåŠŸæ–°å¢ï¼');
      hideFileEditSection();
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderList('manage');
      renderList('viewer');
    }
  });
};

// åˆ‡æ›ç®¡ç†å€åŸŸ
const toggleManageSection=()=>{
  if(!isManage())return;
  
  const cms=$('content-manage-section');
  const cvs=$('content-viewer-section');
  
  if(cms.classList.contains('hidden')){
    // é¡¯ç¤ºç®¡ç†å€
    cms.classList.remove('hidden');
    cvs.classList.add('hidden');
    $('manage-content-btn-container').classList.add('hidden');
    
    // æ¸²æŸ“ç®¡ç†åˆ—è¡¨
    renderList('manage');
  }else{
    // é¡¯ç¤ºç€è¦½å€
    cms.classList.add('hidden');
    cvs.classList.remove('hidden');
    $('manage-content-btn-container').classList.remove('hidden');
  }
};

// åˆå§‹åŒ–LIFF
const initLIFF=()=>{
  return new Promise((resolve, reject)=>{
    setStatus('åˆå§‹åŒ–LINEç’°å¢ƒ...');
    
    if(!window.liff){
      return reject(new Error('LIFF SDKåŠ è¼‰å¤±æ•—'));
    }
    
    liff.init({
      liffId:C.L
    }).then(()=>{
      if(liff.isLoggedIn()){
        // å·²ç™»å…¥ï¼Œç²å–ç”¨æˆ¶ä¿¡æ¯
        liff.getProfile().then(profile=>{
          S.u={
            userId:profile.userId,
            displayName:profile.displayName,
            pictureUrl:profile.pictureUrl
          };
          resolve(true);
        }).catch(err=>{
          console.error('ç²å–ç”¨æˆ¶ä¿¡æ¯å¤±æ•—ï¼š',err);
          reject(new Error('ç„¡æ³•ç²å–ç”¨æˆ¶ä¿¡æ¯'));
        });
      }else{
        // æœªç™»å…¥ï¼Œå¼•å°ç™»å…¥
        liff.login();
        reject(new Error('è«‹å…ˆç™»å…¥LINEå¸³è™Ÿ'));
      }
    }).catch(err=>{
      console.error('LIFFåˆå§‹åŒ–å¤±æ•—ï¼š',err);
      reject(new Error('LINEç’°å¢ƒåˆå§‹åŒ–å¤±æ•—'));
    });
  });
};

// åˆå§‹åŒ–é é¢
const initPage=async ()=>{
  try{
    // åˆå§‹åŒ–LIFF
    await initLIFF();
    
    // é©—è­‰ç”¨æˆ¶æ¬Šé™
    await verifyUser();
    
    // ç²å–å½±éŸ³åˆ—è¡¨
    await fetchData('video');
    
    // ç²å–æ–‡ä»¶åˆ—è¡¨
    await fetchData('file');
    
    // éš±è—åŠ è¼‰ç‹€æ…‹
    $('status').classList.add('hidden');
    
    // é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯å¡ç‰‡
    $('result-card').classList.remove('hidden');
    $('user-role-display').textContent=S.r==='admin'?'ç®¡ç†å“¡':(S.r==='pro'?'å°Šçˆµç”¨æˆ¶':'æ™®é€šç”¨æˆ¶');
    
    // é¡¯ç¤ºç”¨æˆ¶åç¨±
    $('user-name-display').classList.remove('hidden');
    $('user-name').textContent=S.n;
    
    // é¡¯ç¤ºä½¿ç”¨æœŸé™
    $('user-expiry-display').classList.remove('hidden');
    const cd=calcDays(S.ei.ed);
    $('expiry-date').textContent=cd.d;
    $('remaining-days').textContent=cd.rd;
    
    // æ›´æ–°å…§å®¹è¨ˆæ•¸
    updateCount();
    
    // æ ¹æ“šæ¬Šé™é¡¯ç¤ºå°æ‡‰å€åŸŸ
    if(isManage()){
      // ç®¡ç†å“¡é¡¯ç¤ºç®¡ç†æŒ‰éˆ•
      $('manage-content-btn-container').classList.remove('hidden');
      $('content-manage-section').classList.remove('hidden');
      renderList('manage');
    }else{
      // æ™®é€šç”¨æˆ¶åªé¡¯ç¤ºç€è¦½å€
      $('content-viewer-section').classList.remove('hidden');
      renderList('viewer');
    }
    
    // ç¶å®šå…§å®¹é¡å‹åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
    $('content-type-toggle').addEventListener('click',()=>{
      const ctd=$('content-type-dropdown');
      ctd.classList.toggle('hidden');
    });
    
    // é»æ“Šå…¶ä»–å€åŸŸé—œé–‰ä¸‹æ‹‰èœå–®
    document.addEventListener('click',(e)=>{
      const ctd=$('content-type-dropdown');
      const ctt=$('content-type-toggle');
      
      if(!ctd.classList.contains('hidden') && 
         !ctt.contains(e.target) && 
         !ctd.contains(e.target)){
        ctd.classList.add('hidden');
      }
    });
    
  }catch(err){
    console.error('åˆå§‹åŒ–å¤±æ•—ï¼š',err);
    showErr(err.message||'ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
};

// é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded',()=>{
  // é˜²æ­¢è¡¨å–®è‡ªå‹•æäº¤
  document.querySelectorAll('form').forEach(form=>{
    form.addEventListener('submit',(e)=>e.preventDefault());
  });
  
  // åˆå§‹åŒ–æ‡‰ç”¨
  initPage();
});

// è™•ç†è¦–çª—é—œé–‰äº‹ä»¶ï¼Œç¢ºä¿æ•¸æ“šåŒæ­¥
window.addEventListener('beforeunload',()=>{
  if(isManage()){
    syncOrder('video');
    syncOrder('file');
  }
});
</script>
</body>
</html>
